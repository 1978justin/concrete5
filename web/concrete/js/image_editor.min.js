/**
 * KineticJS JavaScript Framework v4.4.3
 * http://www.kineticjs.com/
 * Copyright 2013, Eric Rowell
 * Licensed under the MIT or GPL Version 2 licenses.
 * Date: Apr 14 2013
 *
 * Copyright (C) 2011 - 2013 by Eric Rowell
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *//** 
 * @namespace 
 */var Kinetic={};(function(){Kinetic.version="4.4.3";Kinetic.Filters={};Kinetic.DD={};Kinetic.Global={stages:[],idCounter:0,ids:{},names:{},shapes:{},isDragging:function(){var e=Kinetic.DD;return e?e.isDragging:!1},isDragReady:function(){var e=Kinetic.DD;return e?!!e.node:!1},warn:function(e){window.console&&console.warn&&console.warn("Kinetic warning: "+e)},extend:function(e,t){for(var n in t.prototype)n in e.prototype||(e.prototype[n]=t.prototype[n])},_addId:function(e,t){t!==undefined&&(this.ids[t]=e)},_removeId:function(e){e!==undefined&&delete this.ids[e]},_addName:function(e,t){if(t!==undefined){this.names[t]===undefined&&(this.names[t]=[]);this.names[t].push(e)}},_removeName:function(e,t){if(e!==undefined){var n=this.names[e];if(n!==undefined){for(var r=0;r<n.length;r++){var i=n[r];i._id===t&&n.splice(r,1)}n.length===0&&delete this.names[e]}}}}})();(function(e,t){typeof exports=="object"?module.exports=t():typeof define=="function"&&define.amd?define(t):e.returnExports=t()})(this,function(){return Kinetic});(function(){var e="canvas",t="2d",n="[object Array]",r="[object Number]",i="[object String]",s=Math.PI/180,o=180/Math.PI;Kinetic.Type={_isElement:function(e){return!!e&&e.nodeType==1},_isFunction:function(e){return!!(e&&e.constructor&&e.call&&e.apply)},_isObject:function(e){return!!e&&e.constructor==Object},_isArray:function(e){return Object.prototype.toString.call(e)==n},_isNumber:function(e){return Object.prototype.toString.call(e)==r},_isString:function(e){return Object.prototype.toString.call(e)==i},_hasMethods:function(e){var t=[],n;for(n in e)this._isFunction(e[n])&&t.push(n);return t.length>0},_isInDocument:function(e){while(e=e.parentNode)if(e==document)return!0;return!1},_getXY:function(e){if(this._isNumber(e))return{x:e,y:e};if(this._isArray(e)){if(e.length===1){var t=e[0];if(this._isNumber(t))return{x:t,y:t};if(this._isArray(t))return{x:t[0],y:t[1]};if(this._isObject(t))return t}else if(e.length>=2)return{x:e[0],y:e[1]}}else if(this._isObject(e))return e;return null},_getSize:function(e){if(this._isNumber(e))return{width:e,height:e};if(this._isArray(e))if(e.length===1){var t=e[0];if(this._isNumber(t))return{width:t,height:t};if(this._isArray(t)){if(t.length>=4)return{width:t[2],height:t[3]};if(t.length>=2)return{width:t[0],height:t[1]}}else if(this._isObject(t))return t}else{if(e.length>=4)return{width:e[2],height:e[3]};if(e.length>=2)return{width:e[0],height:e[1]}}else if(this._isObject(e))return e;return null},_getPoints:function(e){if(e===undefined)return[];if(this._isArray(e[0])){var t=[];for(var n=0;n<e.length;n++)t.push({x:e[n][0],y:e[n][1]});return t}if(this._isObject(e[0]))return e;var t=[];for(var n=0;n<e.length;n+=2)t.push({x:e[n],y:e[n+1]});return t},_getImage:function(n,r){var i,s,o,u;if(!n)r(null);else if(this._isElement(n))r(n);else if(this._isString(n)){i=new Image;i.onload=function(){r(i)};i.src=n}else if(n.data){s=document.createElement(e);s.width=n.width;s.height=n.height;o=s.getContext(t);o.putImageData(n,0,0);u=s.toDataURL();i=new Image;i.onload=function(){r(i)};i.src=u}else r(null)},_rgbToHex:function(e,t,n){return((1<<24)+(e<<16)+(t<<8)+n).toString(16).slice(1)},_hexToRgb:function(e){var t=parseInt(e,16);return{r:t>>16&255,g:t>>8&255,b:t&255}},_getRandomColorKey:function(){var e=(Math.random()*16777215<<0).toString(16);while(e.length<6)e="0"+e;return e},_merge:function(e,t){var n=this._clone(t);for(var r in e)this._isObject(e[r])?n[r]=this._merge(e[r],n[r]):n[r]=e[r];return n},_clone:function(e){var t={};for(var n in e)this._isObject(e[n])?t[n]=this._clone(e[n]):t[n]=e[n];return t},_degToRad:function(e){return e*s},_radToDeg:function(e){return e*o},_capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)}}})();(function(){var e=document.createElement("canvas"),t=e.getContext("2d"),n=window.devicePixelRatio||1,r=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,i=n/r;Kinetic.Canvas=function(e){this.init(e)};Kinetic.Canvas.prototype={init:function(e){var e=e||{},t=e.width||0,n=e.height||0,r=e.pixelRatio||i,s=e.contextType||"2d";this.pixelRatio=r;this.width=t;this.height=n;this.element=document.createElement("canvas");this.element.style.padding=0;this.element.style.margin=0;this.element.style.border=0;this.element.style.background="transparent";this.context=this.element.getContext(s);this.setSize(t,n)},getElement:function(){return this.element},getContext:function(){return this.context},setWidth:function(e){this.width=e;this.element.width=e*this.pixelRatio;this.element.style.width=e+"px"},setHeight:function(e){this.height=e;this.element.height=e*this.pixelRatio;this.element.style.height=e+"px"},getWidth:function(){return this.width},getHeight:function(){return this.height},setSize:function(e,t){this.setWidth(e);this.setHeight(t)}};Kinetic.Canvas2D=function(e){Kinetic.Canvas.call(this,e)};Kinetic.Canvas2D.prototype={clear:function(){var e=this.getContext(),t=this.getElement();e.clearRect(0,0,t.width,t.height)},toDataURL:function(e,t){try{return this.element.toDataURL(e,t)}catch(n){try{return this.element.toDataURL()}catch(n){Kinetic.Global.warn("Unable to get data URL. "+n.message);return""}}},fill:function(e){e.getFillEnabled()&&this._fill(e)},stroke:function(e){e.getStrokeEnabled()&&this._stroke(e)},fillStroke:function(e){var t=e.getFillEnabled();t&&this._fill(e);e.getStrokeEnabled()&&this._stroke(e,e.hasShadow()&&e.hasFill()&&t)},applyShadow:function(e,t){var n=this.context;n.save();this._applyShadow(e);t();n.restore();t()},_applyLineCap:function(e){var t=e.getLineCap();t&&(this.context.lineCap=t)},_applyOpacity:function(e){var t=e.getAbsoluteOpacity();t!==1&&(this.context.globalAlpha=t)},_applyLineJoin:function(e){var t=e.getLineJoin();t&&(this.context.lineJoin=t)},_applyAncestorTransforms:function(e){var t=this.context;e._eachAncestorReverse(function(e){var n=e.getTransform(),r=n.getMatrix();t.transform(r[0],r[1],r[2],r[3],r[4],r[5])},!0)},_clip:function(e){var t=this.getContext();t.save();this._applyAncestorTransforms(e);t.beginPath();e.getClipFunc()(this);t.clip();t.setTransform(1,0,0,1,0,0)}};Kinetic.Global.extend(Kinetic.Canvas2D,Kinetic.Canvas);Kinetic.SceneCanvas=function(e){Kinetic.Canvas2D.call(this,e)};Kinetic.SceneCanvas.prototype={setWidth:function(e){var t=this.pixelRatio;Kinetic.Canvas.prototype.setWidth.call(this,e);this.context.scale(t,t)},setHeight:function(e){var t=this.pixelRatio;Kinetic.Canvas.prototype.setHeight.call(this,e);this.context.scale(t,t)},_fillColor:function(e){var t=this.context,n=e.getFill();t.fillStyle=n;e._fillFunc(t)},_fillPattern:function(e){var t=this.context,n=e.getFillPatternImage(),r=e.getFillPatternX(),i=e.getFillPatternY(),s=e.getFillPatternScale(),o=e.getFillPatternRotation(),u=e.getFillPatternOffset(),a=e.getFillPatternRepeat();(r||i)&&t.translate(r||0,i||0);o&&t.rotate(o);s&&t.scale(s.x,s.y);u&&t.translate(-1*u.x,-1*u.y);t.fillStyle=t.createPattern(n,a||"repeat");t.fill()},_fillLinearGradient:function(e){var t=this.context,n=e.getFillLinearGradientStartPoint(),r=e.getFillLinearGradientEndPoint(),i=e.getFillLinearGradientColorStops(),s=t.createLinearGradient(n.x,n.y,r.x,r.y);for(var o=0;o<i.length;o+=2)s.addColorStop(i[o],i[o+1]);t.fillStyle=s;t.fill()},_fillRadialGradient:function(e){var t=this.context,n=e.getFillRadialGradientStartPoint(),r=e.getFillRadialGradientEndPoint(),i=e.getFillRadialGradientStartRadius(),s=e.getFillRadialGradientEndRadius(),o=e.getFillRadialGradientColorStops(),u=t.createRadialGradient(n.x,n.y,i,r.x,r.y,s);for(var a=0;a<o.length;a+=2)u.addColorStop(o[a],o[a+1]);t.fillStyle=u;t.fill()},_fill:function(e,t){var n=this.context,r=e.getFill(),i=e.getFillPatternImage(),s=e.getFillLinearGradientStartPoint(),o=e.getFillRadialGradientStartPoint(),u=e.getFillPriority();n.save();!t&&e.hasShadow()&&this._applyShadow(e);r&&u==="color"?this._fillColor(e):i&&u==="pattern"?this._fillPattern(e):s&&u==="linear-gradient"?this._fillLinearGradient(e):o&&u==="radial-gradient"?this._fillRadialGradient(e):r?this._fillColor(e):i?this._fillPattern(e):s?this._fillLinearGradient(e):o&&this._fillRadialGradient(e);n.restore();!t&&e.hasShadow()&&this._fill(e,!0)},_stroke:function(e,t){var n=this.context,r=e.getStroke(),i=e.getStrokeWidth(),s=e.getDashArray();if(r||i){n.save();e.getStrokeScaleEnabled()||n.setTransform(1,0,0,1,0,0);this._applyLineCap(e);s&&e.getDashArrayEnabled()&&(n.setLineDash?n.setLineDash(s):"mozDash"in n?n.mozDash=s:"webkitLineDash"in n&&(n.webkitLineDash=s));!t&&e.hasShadow()&&this._applyShadow(e);n.lineWidth=i||2;n.strokeStyle=r||"black";e._strokeFunc(n);n.restore();!t&&e.hasShadow()&&this._stroke(e,!0)}},_applyShadow:function(e){var t=this.context;if(e.hasShadow()&&e.getShadowEnabled()){var n=e.getAbsoluteOpacity(),r=e.getShadowColor()||"black",i=e.getShadowBlur()||5,s=e.getShadowOffset()||{x:0,y:0};e.getShadowOpacity()&&(t.globalAlpha=e.getShadowOpacity()*n);t.shadowColor=r;t.shadowBlur=i;t.shadowOffsetX=s.x;t.shadowOffsetY=s.y}}};Kinetic.Global.extend(Kinetic.SceneCanvas,Kinetic.Canvas2D);Kinetic.HitCanvas=function(e){Kinetic.Canvas2D.call(this,e)};Kinetic.HitCanvas.prototype={_fill:function(e){var t=this.context;t.save();t.fillStyle="#"+e.colorKey;e._fillFuncHit(t);t.restore()},_stroke:function(e){var t=this.context,n=e.getStroke(),r=e.getStrokeWidth();if(n||r){this._applyLineCap(e);t.save();t.lineWidth=r||2;t.strokeStyle="#"+e.colorKey;e._strokeFuncHit(t);t.restore()}}};Kinetic.Global.extend(Kinetic.HitCanvas,Kinetic.Canvas2D)})();(function(){Kinetic.Tween=function(e,t,n,r,i){this._listeners=[];this.addListener(this);this.propFunc=e;this.begin=n;this._pos=n;this.setDuration(i);this.isPlaying=!1;this._change=0;this.prevTime=0;this.prevPos=0;this.looping=!1;this._time=0;this._position=0;this._startTime=0;this._finish=0;this.name="";this.func=t;this.setFinish(r)};Kinetic.Tween.prototype={setTime:function(e){this.prevTime=this._time;if(e>this.getDuration())if(this.looping){this.rewind(e-this._duration);this.update();this.broadcastMessage("onLooped",{target:this,type:"onLooped"})}else{this._time=this._duration;this.update();this.stop();this.broadcastMessage("onFinished",{target:this,type:"onFinished"})}else if(e<0){this.rewind();this.update()}else{this._time=e;this.update()}},getTime:function(){return this._time},setDuration:function(e){this._duration=e===null||e<=0?1e5:e},getDuration:function(){return this._duration},setPosition:function(e){this.prevPos=this._pos;this.propFunc(e);this._pos=e;this.broadcastMessage("onChanged",{target:this,type:"onChanged"})},getPosition:function(e){e===undefined&&(e=this._time);return this.func(e,this.begin,this._change,this._duration)},setFinish:function(e){this._change=e-this.begin},getFinish:function(){return this.begin+this._change},start:function(){this.rewind();this.startEnterFrame();this.broadcastMessage("onStarted",{target:this,type:"onStarted"})},rewind:function(e){this.stop();this._time=e===undefined?0:e;this.fixTime();this.update()},fforward:function(){this._time=this._duration;this.fixTime();this.update()},update:function(){this.setPosition(this.getPosition(this._time))},startEnterFrame:function(){this.stopEnterFrame();this.isPlaying=!0;this.onEnterFrame()},onEnterFrame:function(){this.isPlaying&&this.nextFrame()},nextFrame:function(){this.setTime((this.getTimer()-this._startTime)/1e3)},stop:function(){this.stopEnterFrame();this.broadcastMessage("onStopped",{target:this,type:"onStopped"})},stopEnterFrame:function(){this.isPlaying=!1},continueTo:function(e,t){this.begin=this._pos;this.setFinish(e);this._duration!==undefined&&this.setDuration(t);this.start()},resume:function(){this.fixTime();this.startEnterFrame();this.broadcastMessage("onResumed",{target:this,type:"onResumed"})},yoyo:function(){this.continueTo(this.begin,this._time)},addListener:function(e){this.removeListener(e);return this._listeners.push(e)},removeListener:function(e){var t=this._listeners,n=t.length;while(n--)if(t[n]==e){t.splice(n,1);return!0}return!1},broadcastMessage:function(){var e=[];for(var t=0;t<arguments.length;t++)e.push(arguments[t]);var n=e.shift(),r=this._listeners,i=r.length;for(var t=0;t<i;t++)r[t][n]&&r[t][n].apply(r[t],e)},fixTime:function(){this._startTime=this.getTimer()-this._time*1e3},getTimer:function(){return(new Date).getTime()-this._time}};Kinetic.Tweens={"back-ease-in":function(e,t,n,r,i,s){var o=1.70158;return n*(e/=r)*e*((o+1)*e-o)+t},"back-ease-out":function(e,t,n,r,i,s){var o=1.70158;return n*((e=e/r-1)*e*((o+1)*e+o)+1)+t},"back-ease-in-out":function(e,t,n,r,i,s){var o=1.70158;return(e/=r/2)<1?n/2*e*e*(((o*=1.525)+1)*e-o)+t:n/2*((e-=2)*e*(((o*=1.525)+1)*e+o)+2)+t},"elastic-ease-in":function(e,t,n,r,i,s){var o=0;if(e===0)return t;if((e/=r)==1)return t+n;s||(s=r*.3);if(!i||i<Math.abs(n)){i=n;o=s/4}else o=s/(2*Math.PI)*Math.asin(n/i);return-(i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s))+t},"elastic-ease-out":function(e,t,n,r,i,s){var o=0;if(e===0)return t;if((e/=r)==1)return t+n;s||(s=r*.3);if(!i||i<Math.abs(n)){i=n;o=s/4}else o=s/(2*Math.PI)*Math.asin(n/i);return i*Math.pow(2,-10*e)*Math.sin((e*r-o)*2*Math.PI/s)+n+t},"elastic-ease-in-out":function(e,t,n,r,i,s){var o=0;if(e===0)return t;if((e/=r/2)==2)return t+n;s||(s=r*.3*1.5);if(!i||i<Math.abs(n)){i=n;o=s/4}else o=s/(2*Math.PI)*Math.asin(n/i);return e<1?-0.5*i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)+t:i*Math.pow(2,-10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)*.5+n+t},"bounce-ease-out":function(e,t,n,r){return(e/=r)<1/2.75?n*7.5625*e*e+t:e<2/2.75?n*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?n*(7.5625*(e-=2.25/2.75)*e+.9375)+t:n*(7.5625*(e-=2.625/2.75)*e+.984375)+t},"bounce-ease-in":function(e,t,n,r){return n-Kinetic.Tweens["bounce-ease-out"](r-e,0,n,r)+t},"bounce-ease-in-out":function(e,t,n,r){return e<r/2?Kinetic.Tweens["bounce-ease-in"](e*2,0,n,r)*.5+t:Kinetic.Tweens["bounce-ease-out"](e*2-r,0,n,r)*.5+n*.5+t},"ease-in":function(e,t,n,r){return n*(e/=r)*e+t},"ease-out":function(e,t,n,r){return-n*(e/=r)*(e-2)+t},"ease-in-out":function(e,t,n,r){return(e/=r/2)<1?n/2*e*e+t:-n/2*(--e*(e-2)-1)+t},"strong-ease-in":function(e,t,n,r){return n*(e/=r)*e*e*e*e+t},"strong-ease-out":function(e,t,n,r){return n*((e=e/r-1)*e*e*e*e+1)+t},"strong-ease-in-out":function(e,t,n,r){return(e/=r/2)<1?n/2*e*e*e*e*e+t:n/2*((e-=2)*e*e*e*e+2)+t},linear:function(e,t,n,r){return n*e/r+t}}})();(function(){Kinetic.Transform=function(){this.m=[1,0,0,1,0,0]};Kinetic.Transform.prototype={translate:function(e,t){this.m[4]+=this.m[0]*e+this.m[2]*t;this.m[5]+=this.m[1]*e+this.m[3]*t},scale:function(e,t){this.m[0]*=e;this.m[1]*=e;this.m[2]*=t;this.m[3]*=t},rotate:function(e){var t=Math.cos(e),n=Math.sin(e),r=this.m[0]*t+this.m[2]*n,i=this.m[1]*t+this.m[3]*n,s=this.m[0]*-n+this.m[2]*t,o=this.m[1]*-n+this.m[3]*t;this.m[0]=r;this.m[1]=i;this.m[2]=s;this.m[3]=o},getTranslation:function(){return{x:this.m[4],y:this.m[5]}},multiply:function(e){var t=this.m[0]*e.m[0]+this.m[2]*e.m[1],n=this.m[1]*e.m[0]+this.m[3]*e.m[1],r=this.m[0]*e.m[2]+this.m[2]*e.m[3],i=this.m[1]*e.m[2]+this.m[3]*e.m[3],s=this.m[0]*e.m[4]+this.m[2]*e.m[5]+this.m[4],o=this.m[1]*e.m[4]+this.m[3]*e.m[5]+this.m[5];this.m[0]=t;this.m[1]=n;this.m[2]=r;this.m[3]=i;this.m[4]=s;this.m[5]=o},invert:function(){var e=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),t=this.m[3]*e,n=-this.m[1]*e,r=-this.m[2]*e,i=this.m[0]*e,s=e*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),o=e*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=t;this.m[1]=n;this.m[2]=r;this.m[3]=i;this.m[4]=s;this.m[5]=o},getMatrix:function(){return this.m}}})();(function(){Kinetic.Collection=function(){var e=[].slice.call(arguments),t=e.length,n=0;this.length=t;for(;n<t;n++)this[n]=e[n];return this};Kinetic.Collection.prototype=new Array;Kinetic.Collection.prototype.each=function(e){for(var t=0;t<this.length;t++)e(this[t],t)};Kinetic.Collection.mapMethods=function(e){var t=e.length,n;for(n=0;n<t;n++)(function(t){var n=e[t];Kinetic.Collection.prototype[n]=function(){var e=this.length,t;args=[].slice.call(arguments);for(t=0;t<e;t++)this[t][n].apply(this[t],args)}})(n)}})();(function(){Kinetic.Filters.Grayscale=function(e,t){var n=e.data;for(var r=0;r<n.length;r+=4){var i=.34*n[r]+.5*n[r+1]+.16*n[r+2];n[r]=i;n[r+1]=i;n[r+2]=i}}})();(function(){Kinetic.Filters.Brighten=function(e,t){var n=t.val||0,r=e.data;for(var i=0;i<r.length;i+=4){r[i]+=n;r[i+1]+=n;r[i+2]+=n}}})();(function(){Kinetic.Filters.Invert=function(e,t){var n=e.data;for(var r=0;r<n.length;r+=4){n[r]=255-n[r];n[r+1]=255-n[r+1];n[r+2]=255-n[r+2]}}})();(function(e){function t(){this.r=0;this.g=0;this.b=0;this.a=0;this.next=null}function i(e,i){var s=e.data,o=e.width,u=e.height,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_=i+i+1,D=o-1,P=u-1,H=i+1,B=H*(H+1)/2,j=new t,F=j,I=null,q=null,R=n[i],U=r[i];for(l=1;l<_;l++){F=F.next=new t;if(l==H)var z=F}F.next=j;d=p=0;for(f=0;f<u;f++){x=T=N=C=v=m=g=y=0;b=H*(k=s[p]);w=H*(L=s[p+1]);E=H*(A=s[p+2]);S=H*(O=s[p+3]);v+=B*k;m+=B*L;g+=B*A;y+=B*O;F=j;for(l=0;l<H;l++){F.r=k;F.g=L;F.b=A;F.a=O;F=F.next}for(l=1;l<H;l++){c=p+((D<l?D:l)<<2);v+=(F.r=k=s[c])*(M=H-l);m+=(F.g=L=s[c+1])*M;g+=(F.b=A=s[c+2])*M;y+=(F.a=O=s[c+3])*M;x+=k;T+=L;N+=A;C+=O;F=F.next}I=j;q=z;for(a=0;a<o;a++){s[p+3]=O=y*R>>U;if(O!=0){O=255/O;s[p]=(v*R>>U)*O;s[p+1]=(m*R>>U)*O;s[p+2]=(g*R>>U)*O}else s[p]=s[p+1]=s[p+2]=0;v-=b;m-=w;g-=E;y-=S;b-=I.r;w-=I.g;E-=I.b;S-=I.a;c=d+((c=a+i+1)<D?c:D)<<2;x+=I.r=s[c];T+=I.g=s[c+1];N+=I.b=s[c+2];C+=I.a=s[c+3];v+=x;m+=T;g+=N;y+=C;I=I.next;b+=k=q.r;w+=L=q.g;E+=A=q.b;S+=O=q.a;x-=k;T-=L;N-=A;C-=O;q=q.next;p+=4}d+=o}for(a=0;a<o;a++){T=N=C=x=m=g=y=v=0;p=a<<2;b=H*(k=s[p]);w=H*(L=s[p+1]);E=H*(A=s[p+2]);S=H*(O=s[p+3]);v+=B*k;m+=B*L;g+=B*A;y+=B*O;F=j;for(l=0;l<H;l++){F.r=k;F.g=L;F.b=A;F.a=O;F=F.next}h=o;for(l=1;l<=i;l++){p=h+a<<2;v+=(F.r=k=s[p])*(M=H-l);m+=(F.g=L=s[p+1])*M;g+=(F.b=A=s[p+2])*M;y+=(F.a=O=s[p+3])*M;x+=k;T+=L;N+=A;C+=O;F=F.next;l<P&&(h+=o)}p=a;I=j;q=z;for(f=0;f<u;f++){c=p<<2;s[c+3]=O=y*R>>U;if(O>0){O=255/O;s[c]=(v*R>>U)*O;s[c+1]=(m*R>>U)*O;s[c+2]=(g*R>>U)*O}else s[c]=s[c+1]=s[c+2]=0;v-=b;m-=w;g-=E;y-=S;b-=I.r;w-=I.g;E-=I.b;S-=I.a;c=a+((c=f+H)<P?c:P)*o<<2;v+=x+=I.r=s[c];m+=T+=I.g=s[c+1];g+=N+=I.b=s[c+2];y+=C+=I.a=s[c+3];I=I.next;b+=k=q.r;w+=L=q.g;E+=A=q.b;S+=O=q.a;x-=k;T-=L;N-=A;C-=O;q=q.next;p+=o}}}var n=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],r=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];e=e||{};e.Filters=e.Filters||{};e.Filters.Blur=function(e,t){var n=t.radius;n|=0;i(e,n)};window.Kinetic=e})(Kinetic);(function(e){function t(e,t,n){var r=(n*e.width+t)*4,i=[];i.push(e.data[r++],e.data[r++],e.data[r++],e.data[r++]);return i}function n(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}function r(e){var t=[0,0,0];for(var n=0;n<e.length;n++){t[0]+=e[n][0];t[1]+=e[n][1];t[2]+=e[n][2]}t[0]/=e.length;t[1]/=e.length;t[2]/=e.length;return t}function i(e,i){var s=t(e,0,0),o=t(e,e.width-1,0),u=t(e,0,e.height-1),a=t(e,e.width-1,e.height-1),f=i&&i.threshold?i.threshold:10;if(n(s,o)<f&&n(o,a)<f&&n(a,u)<f&&n(u,s)<f){var l=r([o,s,a,u]),c=[];for(var h=0;h<e.width*e.height;h++){var p=n(l,[e.data[h*4],e.data[h*4+1],e.data[h*4+2]]);c[h]=p<f?0:255}return c}}function s(e,t){for(var n=0;n<e.width*e.height;n++)e.data[4*n+3]=t[n]}function o(e,t,n){var r=[1,1,1,1,0,1,1,1,1],i=Math.round(Math.sqrt(r.length)),s=Math.floor(i/2),o=[];for(var u=0;u<n;u++)for(var a=0;a<t;a++){var f=u*t+a,l=0;for(var c=0;c<i;c++)for(var h=0;h<i;h++){var p=u+c-s,d=a+h-s;if(p>=0&&p<n&&d>=0&&d<t){var v=p*t+d,m=r[c*i+h];l+=e[v]*m}}o[f]=l===2040?255:0}return o}function u(e,t,n){var r=[1,1,1,1,1,1,1,1,1],i=Math.round(Math.sqrt(r.length)),s=Math.floor(i/2),o=[];for(var u=0;u<n;u++)for(var a=0;a<t;a++){var f=u*t+a,l=0;for(var c=0;c<i;c++)for(var h=0;h<i;h++){var p=u+c-s,d=a+h-s;if(p>=0&&p<n&&d>=0&&d<t){var v=p*t+d,m=r[c*i+h];l+=e[v]*m}}o[f]=l>=1020?255:0}return o}function a(e,t,n){var r=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],i=Math.round(Math.sqrt(r.length)),s=Math.floor(i/2),o=[];for(var u=0;u<n;u++)for(var a=0;a<t;a++){var f=u*t+a,l=0;for(var c=0;c<i;c++)for(var h=0;h<i;h++){var p=u+c-s,d=a+h-s;if(p>=0&&p<n&&d>=0&&d<t){var v=p*t+d,m=r[c*i+h];l+=e[v]*m}}o[f]=l}return o}e=e||{};e.Filters=e.Filters||{};e.Filters.Mask=function(e,t){var n=i(e,t);if(n){n=o(n,e.width,e.height);n=u(n,e.width,e.height);n=a(n,e.width,e.height);s(e,n)}return e};window.Kinetic=e})(Kinetic);(function(){var e=" ",t="",n=".",r="get",i="set",s="Shape",o="Stage",u="x",a="y",f="kinetic",l="before",c="Change",h="id",p="name",d="mouseenter",v="mouseleave",m="Deg",g="on",y="off",b="beforeDraw",w="draw";Kinetic.Node=function(e){this._nodeInit(e)};Kinetic.Node.prototype={_nodeInit:function(e){this._id=Kinetic.Global.idCounter++;this.eventListeners={};this.setAttrs(e)},on:function(r,i){var s=r.split(e),o=s.length,u,a,f,l,c,h;for(u=0;u<o;u++){a=s[u];f=a;l=f.split(n);c=l[0];h=l.length>1?l[1]:t;this.eventListeners[c]||(this.eventListeners[c]=[]);this.eventListeners[c].push({name:h,handler:i})}return this},off:function(t){var r=t.split(e),i=r.length,s,o,u,a,f;for(s=0;s<i;s++){o=r[s];u=o;a=u.split(n);f=a[0];if(a.length>1)if(f)this.eventListeners[f]&&this._off(f,a[1]);else for(var o in this.eventListeners)this._off(o,a[1]);else delete this.eventListeners[f]}return this},remove:function(){var e=this.getParent();if(e&&e.children){e.children.splice(this.index,1);e._setChildrenIndices()}delete this.parent},destroy:function(){var e=this.getParent(),t=this.getStage(),n=Kinetic.DD,r=Kinetic.Global;while(this.children&&this.children.length>0)this.children[0].destroy();r._removeId(this.getId());r._removeName(this.getName(),this._id);this.trans&&this.trans.stop();this.remove()},getAttr:function(e){var t=r+Kinetic.Type._capitalize(e);return this[t]()},getAttrs:function(){return this.attrs||{}},createAttrs:function(){this.attrs===undefined&&(this.attrs={})},setAttrs:function(e){var t,n;if(e)for(t in e){n=i+Kinetic.Type._capitalize(t);Kinetic.Type._isFunction(this[n])?this[n](e[t]):this.setAttr(t,e[t])}},getVisible:function(){var e=this.attrs.visible,t=this.getParent();e===undefined&&(e=!0);return e&&t&&!t.getVisible()?!1:e},getListening:function(){var e=this.attrs.listening,t=this.getParent();e===undefined&&(e=!0);return e&&t&&!t.getListening()?!1:e},show:function(){this.setVisible(!0)},hide:function(){this.setVisible(!1)},getZIndex:function(){return this.index||0},getAbsoluteZIndex:function(){function l(t){i=[];u=t.length;for(a=0;a<u;a++){f=t[a];r++;f.nodeType!==s&&(i=i.concat(f.getChildren()));f._id===n._id&&(a=u)}i.length>0&&i[0].getLevel()<=e&&l(i)}var e=this.getLevel(),t=this.getStage(),n=this,r=0,i,u,a,f;n.nodeType!==o&&l(n.getStage().getChildren());return r},getLevel:function(){var e=0,t=this.parent;while(t){e++;t=t.parent}return e},setPosition:function(){var e=Kinetic.Type._getXY([].slice.call(arguments));this.setAttr(u,e.x);this.setAttr(a,e.y)},getPosition:function(){return{x:this.getX(),y:this.getY()}},getAbsolutePosition:function(){var e=this.getAbsoluteTransform(),t=this.getOffset();e.translate(t.x,t.y);return e.getTranslation()},setAbsolutePosition:function(){var e=Kinetic.Type._getXY([].slice.call(arguments)),t=this._clearTransform(),n;this.attrs.x=t.x;this.attrs.y=t.y;delete t.x;delete t.y;n=this.getAbsoluteTransform();n.invert();n.translate(e.x,e.y);e={x:this.attrs.x+n.getTranslation().x,y:this.attrs.y+n.getTranslation().y};this.setPosition(e.x,e.y);this._setTransform(t)},move:function(){var e=Kinetic.Type._getXY([].slice.call(arguments)),t=this.getX(),n=this.getY();e.x!==undefined&&(t+=e.x);e.y!==undefined&&(n+=e.y);this.setPosition(t,n)},_eachAncestorReverse:function(e,t){var n=[],r=this.getParent(),i,s;t&&n.unshift(this);while(r){n.unshift(r);r=r.parent}i=n.length;for(s=0;s<i;s++)e(n[s])},rotate:function(e){this.setRotation(this.getRotation()+e)},rotateDeg:function(e){this.setRotation(this.getRotation()+Kinetic.Type._degToRad(e))},moveToTop:function(){var e=this.index;this.parent.children.splice(e,1);this.parent.children.push(this);this.parent._setChildrenIndices();return!0},moveUp:function(){var e=this.index,t=this.parent.getChildren().length;if(e<t-1){this.parent.children.splice(e,1);this.parent.children.splice(e+1,0,this);this.parent._setChildrenIndices();return!0}},moveDown:function(){var e=this.index;if(e>0){this.parent.children.splice(e,1);this.parent.children.splice(e-1,0,this);this.parent._setChildrenIndices();return!0}},moveToBottom:function(){var e=this.index;if(e>0){this.parent.children.splice(e,1);this.parent.children.unshift(this);this.parent._setChildrenIndices();return!0}},setZIndex:function(e){var t=this.index;this.parent.children.splice(t,1);this.parent.children.splice(e,0,this);this.parent._setChildrenIndices()},getAbsoluteOpacity:function(){var e=this.getOpacity();this.getParent()&&(e*=this.getParent().getAbsoluteOpacity());return e},moveTo:function(e){Kinetic.Node.prototype.remove.call(this);e.add(this)},toObject:function(){var e=Kinetic.Type,t={},n=this.getAttrs(),r,i;t.attrs={};for(r in n){i=n[r];!e._isFunction(i)&&!e._isElement(i)&&(!e._isObject(i)||!e._hasMethods(i))&&(t.attrs[r]=i)}t.nodeType=this.nodeType;t.shapeType=this.shapeType;return t},toJSON:function(){return JSON.stringify(this.toObject())},getParent:function(){return this.parent},getLayer:function(){return this.getParent().getLayer()},getStage:function(){return this.getParent()?this.getParent().getStage():undefined},fire:function(e,t,n){n?this._executeHandlers(e,t||{}):this._handleEvent(e,t||{})},getAbsoluteTransform:function(){var e=new Kinetic.Transform,t;this._eachAncestorReverse(function(n){t=n.getTransform();e.multiply(t)},!0);return e},getTransform:function(){var e=new Kinetic.Transform,t=this.getX(),n=this.getY(),r=this.getRotation(),i=this.getScale(),s=i.x,o=i.y,u=this.getOffset(),a=u.x,f=u.y;(t!==0||n!==0)&&e.translate(t,n);r!==0&&e.rotate(r);(s!==1||o!==1)&&e.scale(s,o);(a!==0||f!==0)&&e.translate(-1*a,-1*f);return e},clone:function(e){var t=this.shapeType||this.nodeType,n=new Kinetic[t](this.attrs),r,i,s,o,u;for(r in this.eventListeners){i=this.eventListeners[r];s=i.length;for(o=0;o<s;o++){u=i[o];if(u.name.indexOf(f)<0){n.eventListeners[r]||(n.eventListeners[r]=[]);n.eventListeners[r].push(u)}}}n.setAttrs(e);return n},toDataURL:function(e){var e=e||{},t=e.mimeType||null,n=e.quality||null,r=this.getStage(),i=e.x||0,s=e.y||0,o=new Kinetic.SceneCanvas({width:e.width||r.getWidth(),height:e.height||r.getHeight(),pixelRatio:1}),u=o.getContext();u.save();(i||s)&&u.translate(-1*i,-1*s);this.drawScene(o);u.restore();return o.toDataURL(t,n)},toImage:function(e){Kinetic.Type._getImage(this.toDataURL(e),function(t){e.callback(t)})},setSize:function(){var e=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setWidth(e.width);this.setHeight(e.height)},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function(){return this.attrs.width||0},getHeight:function(){return this.attrs.height||0},_get:function(e){return this.nodeType===e?[this]:[]},_off:function(e,t){var n=this.eventListeners[e],r;for(r=0;r<n.length;r++)if(n[r].name===t){n.splice(r,1);if(n.length===0){delete this.eventListeners[e];break}r--}},_clearTransform:function(){var e=this.getScale(),t=this.getOffset(),n={x:this.getX(),y:this.getY(),rotation:this.getRotation(),scale:{x:e.x,y:e.y},offset:{x:t.x,y:t.y}};this.attrs.x=0;this.attrs.y=0;this.attrs.rotation=0;this.attrs.scale={x:1,y:1};this.attrs.offset={x:0,y:0};return n},_setTransform:function(e){var t;for(t in e)this.attrs[t]=e[t]},_fireBeforeChangeEvent:function(e,t,n){this._handleEvent(l+Kinetic.Type._capitalize(e)+c,{oldVal:t,newVal:n})},_fireChangeEvent:function(e,t,n){this._handleEvent(e+c,{oldVal:t,newVal:n})},setId:function(e){var t=this.getId(),n=this.getStage(),r=Kinetic.Global;r._removeId(t);r._addId(this,e);this.setAttr(h,e)},setName:function(e){var t=this.getName(),n=this.getStage(),r=Kinetic.Global;r._removeName(t,this._id);r._addName(this,e);this.setAttr(p,e)},getNodeType:function(){return this.nodeType},setAttr:function(e,t){var n;if(t!==undefined){n=this.attrs[e];this._fireBeforeChangeEvent(e,n,t);this.attrs[e]=t;this._fireChangeEvent(e,n,t)}},_handleEvent:function(e,t,n){t&&this.nodeType===s&&(t.targetNode=this);var r=this.getStage(),i=this.eventListeners,o=!0;e===d&&n&&this._id===n._id?o=!1:e===v&&n&&this._id===n._id&&(o=!1);if(o){this._executeHandlers(e,t);t&&!t.cancelBubble&&this.parent&&(n&&n.parent?this._handleEvent.call(this.parent,e,t,n.parent):this._handleEvent.call(this.parent,e,t))}},_executeHandlers:function(e,t){var n=this.eventListeners[e],r,i;if(n){r=n.length;for(i=0;i<r;i++)n[i].handler.apply(this,[t])}},draw:function(){var e={node:this};this.fire(b,e);this.drawScene();this.drawHit();this.fire(w,e)},shouldDrawHit:function(){return this.isVisible()&&this.isListening()&&!Kinetic.Global.isDragging()}};Kinetic.Node.addGetterSetter=function(e,t,n){this.addGetter(e,t,n);this.addSetter(e,t)};Kinetic.Node.addPointGetterSetter=function(e,t,n){this.addGetter(e,t,n);this.addPointSetter(e,t)};Kinetic.Node.addRotationGetterSetter=function(e,t,n){this.addRotationGetter(e,t,n);this.addRotationSetter(e,t)};Kinetic.Node.addSetter=function(e,t){var n=this,r=i+Kinetic.Type._capitalize(t);e.prototype[r]=function(e){this.setAttr(t,e)}};Kinetic.Node.addPointSetter=function(e,t){var n=this,r=i+Kinetic.Type._capitalize(t);e.prototype[r]=function(){var e=Kinetic.Type._getXY([].slice.call(arguments));this.attrs[t]||(this.attrs[t]={x:1,y:1});e&&e.x===undefined&&(e.x=this.attrs[t].x);e&&e.y===undefined&&(e.y=this.attrs[t].y);this.setAttr(t,e)}};Kinetic.Node.addRotationSetter=function(e,t){var n=this,r=i+Kinetic.Type._capitalize(t);e.prototype[r]=function(e){this.setAttr(t,e)};e.prototype[r+m]=function(e){this.setAttr(t,Kinetic.Type._degToRad(e))}};Kinetic.Node.addGetter=function(e,t,n){var i=this,s=r+Kinetic
.Type._capitalize(t);e.prototype[s]=function(e){var r=this.attrs[t];r===undefined&&(r=n);return r}};Kinetic.Node.addRotationGetter=function(e,t,n){var i=this,s=r+Kinetic.Type._capitalize(t);e.prototype[s]=function(){var e=this.attrs[t];e===undefined&&(e=n);return e};e.prototype[s+m]=function(){var e=this.attrs[t];e===undefined&&(e=n);return Kinetic.Type._radToDeg(e)}};Kinetic.Node.create=function(e,t){return this._createNode(JSON.parse(e),t)};Kinetic.Node._createNode=function(e,t){var n,r,i,o;e.nodeType===s?e.shapeType===undefined?n=s:n=e.shapeType:n=e.nodeType;t&&(e.attrs.container=t);r=new Kinetic[n](e.attrs);if(e.children){i=e.children.length;for(o=0;o<i;o++)r.add(this._createNode(e.children[o]))}return r};Kinetic.Node.addGetterSetter(Kinetic.Node,"x",0);Kinetic.Node.addGetterSetter(Kinetic.Node,"y",0);Kinetic.Node.addGetterSetter(Kinetic.Node,"opacity",1);Kinetic.Node.addGetter(Kinetic.Node,"name");Kinetic.Node.addGetter(Kinetic.Node,"id");Kinetic.Node.addRotationGetterSetter(Kinetic.Node,"rotation",0);Kinetic.Node.addPointGetterSetter(Kinetic.Node,"scale",{x:1,y:1});Kinetic.Node.addPointGetterSetter(Kinetic.Node,"offset",{x:0,y:0});Kinetic.Node.addSetter(Kinetic.Node,"width");Kinetic.Node.addSetter(Kinetic.Node,"height");Kinetic.Node.addSetter(Kinetic.Node,"listening");Kinetic.Node.addSetter(Kinetic.Node,"visible");Kinetic.Node.prototype.isListening=Kinetic.Node.prototype.getListening;Kinetic.Node.prototype.isVisible=Kinetic.Node.prototype.getVisible;Kinetic.Collection.mapMethods(["on","off"])})();(function(){Kinetic.Animation=function(e,t){this.func=e;this.node=t;this.id=Kinetic.Animation.animIdCounter++;this.frame={time:0,timeDiff:0,lastTime:(new Date).getTime()}};Kinetic.Animation.prototype={isRunning:function(){var e=Kinetic.Animation,t=e.animations;for(var n=0;n<t.length;n++)if(t[n].id===this.id)return!0;return!1},start:function(){this.stop();this.frame.timeDiff=0;this.frame.lastTime=(new Date).getTime();Kinetic.Animation._addAnimation(this)},stop:function(){Kinetic.Animation._removeAnimation(this)},_updateFrameObject:function(e){this.frame.timeDiff=e-this.frame.lastTime;this.frame.lastTime=e;this.frame.time+=this.frame.timeDiff;this.frame.frameRate=1e3/this.frame.timeDiff}};Kinetic.Animation.animations=[];Kinetic.Animation.animIdCounter=0;Kinetic.Animation.animRunning=!1;Kinetic.Animation.fixedRequestAnimFrame=function(e){window.setTimeout(e,1e3/60)};Kinetic.Animation._addAnimation=function(e){this.animations.push(e);this._handleAnimation()};Kinetic.Animation._removeAnimation=function(e){var t=e.id,n=this.animations,r=n.length;for(var i=0;i<r;i++)if(n[i].id===t){this.animations.splice(i,1);break}};Kinetic.Animation._runFrames=function(){var e={},t=this.animations;for(var n=0;n<t.length;n++){var r=t[n],i=r.node,s=r.func;r._updateFrameObject((new Date).getTime());i&&i._id!==undefined&&(e[i._id]=i);s&&s(r.frame)}for(var o in e)e[o].draw()};Kinetic.Animation._animationLoop=function(){var e=this;if(this.animations.length>0){this._runFrames();Kinetic.Animation.requestAnimFrame(function(){e._animationLoop()})}else this.animRunning=!1};Kinetic.Animation._handleAnimation=function(){var e=this;if(!this.animRunning){this.animRunning=!0;e._animationLoop()}};RAF=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||Kinetic.Animation.fixedRequestAnimFrame}();Kinetic.Animation.requestAnimFrame=function(e){var t=Kinetic.DD&&Kinetic.DD.isDragging?this.fixedRequestAnimFrame:RAF;t(e)};var e=Kinetic.Node.prototype.moveTo;Kinetic.Node.prototype.moveTo=function(t){e.call(this,t)}})();(function(){Kinetic.DD={anim:new Kinetic.Animation,isDragging:!1,offset:{x:0,y:0},node:null,_drag:function(e){var t=Kinetic.DD,n=t.node;if(n){var r=n.getStage().getPointerPosition(),i=n.getDragBoundFunc(),s={x:r.x-t.offset.x,y:r.y-t.offset.y};i!==undefined&&(s=i.call(n,s,e));n.setAbsolutePosition(s);if(!t.isDragging){t.isDragging=!0;n._handleEvent("dragstart",e)}n._handleEvent("dragmove",e)}},_endDragBefore:function(e){var t=Kinetic.DD,n=t.node,r,i;if(n){r=n.nodeType,i=n.getLayer();t.anim.stop();if(t.isDragging){t.isDragging=!1;e&&(e.dragEndNode=n)}delete t.node;(i||n).draw()}},_endDragAfter:function(e){var e=e||{},t=e.dragEndNode;e&&t&&t._handleEvent("dragend",e)}};Kinetic.Node.prototype.startDrag=function(){var e=Kinetic.DD,t=this,n=this.getStage(),r=this.getLayer(),i=n.getPointerPosition(),s=this.getTransform().getTranslation(),o=this.getAbsolutePosition(),u=r||this;if(i){e.node&&e.node.stopDrag();e.node=this;e.offset.x=i.x-o.x;e.offset.y=i.y-o.y;e.anim.node=u;e.anim.start()}};Kinetic.Node.prototype.stopDrag=function(){var e=Kinetic.DD,t={};e._endDragBefore(t);e._endDragAfter(t)};Kinetic.Node.prototype.setDraggable=function(e){this.setAttr("draggable",e);this._dragChange()};var e=Kinetic.Node.prototype.destroy;Kinetic.Node.prototype.destroy=function(){var t=Kinetic.DD;t.node&&t.node._id===this._id&&this.stopDrag();e.call(this)};Kinetic.Node.prototype.isDragging=function(){var e=Kinetic.DD;return e.node&&e.node._id===this._id&&e.isDragging};Kinetic.Node.prototype._listenDrag=function(){this._dragCleanup();var e=this;this.on("mousedown.kinetic touchstart.kinetic",function(t){Kinetic.DD.node||e.startDrag(t)})};Kinetic.Node.prototype._dragChange=function(){if(this.attrs.draggable)this._listenDrag();else{this._dragCleanup();var e=this.getStage(),t=Kinetic.DD;e&&t.node&&t.node._id===this._id&&t.node.stopDrag()}};Kinetic.Node.prototype._dragCleanup=function(){this.off("mousedown.kinetic");this.off("touchstart.kinetic")};Kinetic.Node.addGetterSetter(Kinetic.Node,"dragBoundFunc");Kinetic.Node.addGetterSetter(Kinetic.Node,"dragOnTop",!0);Kinetic.Node.addGetter(Kinetic.Node,"draggable",!1);Kinetic.Node.prototype.isDraggable=Kinetic.Node.prototype.getDraggable;var t=document.getElementsByTagName("html")[0];t.addEventListener("mouseup",Kinetic.DD._endDragBefore,!0);t.addEventListener("touchend",Kinetic.DD._endDragBefore,!0);t.addEventListener("mouseup",Kinetic.DD._endDragAfter,!1);t.addEventListener("touchend",Kinetic.DD._endDragAfter,!1)})();(function(){function e(e,t,n,r,i,s){var o=new Kinetic.Tween(function(n){e[t]=n},n,r,i,s);return o}Kinetic.Transition=function(t,n){var r=this,i=n.easing||"linear",s=Kinetic.Tweens[i],o=n.duration||0,u=null,a=0,f={},l=0,c=0;this.tweens=[];this.attrs={};this.node=t;for(var h in n)if(h!=="duration"&&h!=="easing"&&h!=="callback"){u=n[h];f=t.getAttr(h);if(Kinetic.Type._isObject(f)){configValX=u.x;configValY=u.y;this.attrs[h]={};configValX!==undefined&&r.tweens.push(e(this.attrs[h],"x",s,f.x,configValX,o));configValY!==undefined&&r.tweens.push(e(this.attrs[h],"y",s,f.y,configValY,o))}else r.tweens.push(e(this.attrs,h,s,t.getAttr(h),u,o))}a=this.tweens.length-1;this.tweens[a].onStarted=function(){};this.tweens[a].onStopped=function(){t.transAnim.stop()};this.tweens[a].onResumed=function(){t.transAnim.start()};this.tweens[a].onLooped=function(){};this.tweens[a].onChanged=function(){};this.tweens[a].onFinished=function(){var e={};for(var r in n)r!=="duration"&&r!=="easing"&&r!=="callback"&&(e[r]=n[r]);t.transAnim.stop();t.setAttrs(e);n.callback&&n.callback.call(t)}};Kinetic.Transition.prototype={start:function(){for(var e=0;e<this.tweens.length;e++)this.tweens[e].start()},stop:function(){for(var e=0;e<this.tweens.length;e++)this.tweens[e].stop()},resume:function(){for(var e=0;e<this.tweens.length;e++)this.tweens[e].resume()},_onEnterFrame:function(){for(var e=0;e<this.tweens.length;e++)this.tweens[e].onEnterFrame();this.node.setAttrs(this.attrs)},_add:function(e){this.tweens.push(e)}};Kinetic.Node.prototype.transitionTo=function(e){var t=this,n=new Kinetic.Transition(this,e);this.transAnim||(this.transAnim=new Kinetic.Animation);this.transAnim.func=function(){n._onEnterFrame()};this.transAnim.node=this.nodeType==="Stage"?this:this.getLayer();n.start();this.transAnim.start();this.trans=n;return n}})();(function(){Kinetic.Container=function(e){this._containerInit(e)};Kinetic.Container.prototype={_containerInit:function(e){this.children=[];Kinetic.Node.call(this,e)},getChildren:function(){return this.children},removeChildren:function(){while(this.children.length>0)this.children[0].remove()},add:function(e){var t=Kinetic.Global,n=this.children;e.index=n.length;e.parent=this;n.push(e);return this},get:function(e){var t=new Kinetic.Collection;if(e.charAt(0)==="#"){var n=this._getNodeById(e.slice(1));n&&t.push(n)}else if(e.charAt(0)==="."){var r=this._getNodesByName(e.slice(1));Kinetic.Collection.apply(t,r)}else{var i=[],s=this.getChildren(),o=s.length;for(var u=0;u<o;u++)i=i.concat(s[u]._get(e));Kinetic.Collection.apply(t,i)}return t},_getNodeById:function(e){var t=this.getStage(),n=Kinetic.Global,r=n.ids[e];return r!==undefined&&this.isAncestorOf(r)?r:null},_getNodesByName:function(e){var t=Kinetic.Global,n=t.names[e]||[];return this._getDescendants(n)},_get:function(e){var t=Kinetic.Node.prototype._get.call(this,e),n=this.getChildren(),r=n.length;for(var i=0;i<r;i++)t=t.concat(n[i]._get(e));return t},toObject:function(){var e=Kinetic.Node.prototype.toObject.call(this);e.children=[];var t=this.getChildren(),n=t.length;for(var r=0;r<n;r++){var i=t[r];e.children.push(i.toObject())}return e},_getDescendants:function(e){var t=[],n=e.length;for(var r=0;r<n;r++){var i=e[r];this.isAncestorOf(i)&&t.push(i)}return t},isAncestorOf:function(e){var t=e.getParent();while(t){if(t._id===this._id)return!0;t=t.getParent()}return!1},clone:function(e){var t=Kinetic.Node.prototype.clone.call(this,e);for(var n in this.children)t.add(this.children[n].clone());return t},getIntersections:function(){var e=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),t=[],n=this.get("Shape"),r=n.length;for(var i=0;i<r;i++){var s=n[i];s.isVisible()&&s.intersects(e)&&t.push(s)}return t},_setChildrenIndices:function(){var e=this.children,t=e.length;for(var n=0;n<t;n++)e[n].index=n},drawScene:function(e){var t=this.getLayer(),n=!!this.getClipFunc(),r=this.getStage(),i,s;!e&&t&&(e=t.getCanvas());if(this.isVisible()){n&&e._clip(this);i=this.children;s=i.length;for(var o=0;o<s;o++)i[o].drawScene(e);n&&e.getContext().restore()}},drawHit:function(){var e=!!this.getClipFunc()&&this.nodeType!=="Stage",t=0,n=0,r=[],i;if(this.shouldDrawHit()){if(e){i=this.getLayer().hitCanvas;i._clip(this)}r=this.children;n=r.length;for(t=0;t<n;t++)r[t].drawHit();e&&i.getContext().restore()}}};Kinetic.Global.extend(Kinetic.Container,Kinetic.Node);Kinetic.Node.addGetterSetter(Kinetic.Container,"clipFunc")})();(function(){function e(e){e.fill()}function t(e){e.stroke()}function n(e){e.fill()}function r(e){e.stroke()}Kinetic.Shape=function(e){this._initShape(e)};Kinetic.Shape.prototype={_initShape:function(i){this.nodeType="Shape";this._fillFunc=e;this._strokeFunc=t;this._fillFuncHit=n;this._strokeFuncHit=r;var s=Kinetic.Global.shapes,o;for(;;){o=Kinetic.Type._getRandomColorKey();if(o&&!(o in s))break}this.colorKey=o;s[o]=this;this.createAttrs();Kinetic.Node.call(this,i)},getContext:function(){return this.getLayer().getContext()},getCanvas:function(){return this.getLayer().getCanvas()},hasShadow:function(){return!!(this.getShadowColor()||this.getShadowBlur()||this.getShadowOffset())},hasFill:function(){return!!(this.getFill()||this.getFillPatternImage()||this.getFillLinearGradientStartPoint()||this.getFillRadialGradientStartPoint())},_get:function(e){return this.nodeType===e||this.shapeType===e?[this]:[]},intersects:function(){var e=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),t=this.getStage(),n=t.hitCanvas;n.clear();this.drawScene(n);var r=n.context.getImageData(e.x|0,e.y|0,1,1).data;return r[3]>0},enableFill:function(){this.setAttr("fillEnabled",!0)},disableFill:function(){this.setAttr("fillEnabled",!1)},enableStroke:function(){this.setAttr("strokeEnabled",!0)},disableStroke:function(){this.setAttr("strokeEnabled",!1)},enableStrokeScale:function(){this.setAttr("strokeScaleEnabled",!0)},disableStrokeScale:function(){this.setAttr("strokeScaleEnabled",!1)},enableShadow:function(){this.setAttr("shadowEnabled",!0)},disableShadow:function(){this.setAttr("shadowEnabled",!1)},enableDashArray:function(){this.setAttr("dashArrayEnabled",!0)},disableDashArray:function(){this.setAttr("dashArrayEnabled",!1)},getShapeType:function(){return this.shapeType},destroy:function(){Kinetic.Node.prototype.destroy.call(this);delete Kinetic.Global.shapes[this.colorKey]},drawScene:function(e){var t=this.getAttrs(),n=t.drawFunc,e=e||this.getLayer().getCanvas(),r=e.getContext();if(n&&this.isVisible()){r.save();e._applyOpacity(this);e._applyLineJoin(this);e._applyAncestorTransforms(this);n.call(this,e);r.restore()}},drawHit:function(){var e=this.getAttrs(),t=e.drawHitFunc||e.drawFunc,n=this.getLayer().hitCanvas,r=n.getContext();if(t&&this.shouldDrawHit()){r.save();n._applyLineJoin(this);n._applyAncestorTransforms(this);t.call(this,n);r.restore()}},_setDrawFuncs:function(){!this.attrs.drawFunc&&this.drawFunc&&this.setDrawFunc(this.drawFunc);!this.attrs.drawHitFunc&&this.drawHitFunc&&this.setDrawHitFunc(this.drawHitFunc)}};Kinetic.Global.extend(Kinetic.Shape,Kinetic.Node);Kinetic.Node.addGetterSetter(Kinetic.Shape,"stroke");Kinetic.Node.addGetterSetter(Kinetic.Shape,"lineJoin");Kinetic.Node.addGetterSetter(Kinetic.Shape,"lineCap");Kinetic.Node.addGetterSetter(Kinetic.Shape,"strokeWidth");Kinetic.Node.addGetterSetter(Kinetic.Shape,"drawFunc");Kinetic.Node.addGetterSetter(Kinetic.Shape,"drawHitFunc");Kinetic.Node.addGetterSetter(Kinetic.Shape,"dashArray");Kinetic.Node.addGetterSetter(Kinetic.Shape,"shadowColor");Kinetic.Node.addGetterSetter(Kinetic.Shape,"shadowBlur");Kinetic.Node.addGetterSetter(Kinetic.Shape,"shadowOpacity");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillPatternImage");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fill");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillPatternX");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillPatternY");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillLinearGradientColorStops");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillRadialGradientStartRadius");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillRadialGradientEndRadius");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillRadialGradientColorStops");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillPatternRepeat");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillEnabled",!0);Kinetic.Node.addGetterSetter(Kinetic.Shape,"strokeEnabled",!0);Kinetic.Node.addGetterSetter(Kinetic.Shape,"shadowEnabled",!0);Kinetic.Node.addGetterSetter(Kinetic.Shape,"dashArrayEnabled",!0);Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillPriority","color");Kinetic.Node.addGetterSetter(Kinetic.Shape,"strokeScaleEnabled",!0);Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"fillPatternOffset");Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"fillPatternScale");Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"fillLinearGradientStartPoint");Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"fillLinearGradientEndPoint");Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"fillRadialGradientStartPoint");Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"fillRadialGradientEndPoint");Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"shadowOffset");Kinetic.Node.addRotationGetterSetter(Kinetic.Shape,"fillPatternRotation",0)})();(function(){function p(e,t){e.content.addEventListener(t,function(n){e["_"+t](n)},!1)}var e="Stage",t="string",n="px",r="mouseout",i="mouseleave",r="mouseout",s="mouseover",o="mouseenter",u="mousemove",a="mousedown",f="mouseup",l="click",c="dblclick",h="touchstart";TOUCHEND="touchend";TAP="tap",DBL_TAP="dbltap",TOUCHMOVE="touchmove",DIV="div",RELATIVE="relative",INLINE_BLOCK="inline-block",KINETICJS_CONTENT="kineticjs-content",SPACE=" ",CONTAINER="container",EVENTS=[a,u,f,r,h,TOUCHMOVE,TOUCHEND],eventsLength=EVENTS.length;Kinetic.Stage=function(e){this._initStage(e)};Kinetic.Stage.prototype={_initStage:function(t){this.createAttrs();Kinetic.Container.call(this,t);this.nodeType=e;this.dblClickWindow=400;this._id=Kinetic.Global.idCounter++;this._buildDOM();this._bindContentEvents();Kinetic.Global.stages.push(this)},setContainer:function(e){typeof e===t&&(e=document.getElementById(e));this.setAttr(CONTAINER,e)},draw:function(){var e=this.getChildren(),t=e.length,n,r;for(n=0;n<t;n++){r=e[n];if(r.getClearBeforeDraw()){r.getCanvas().clear();r.getHitCanvas().clear()}}Kinetic.Node.prototype.draw.call(this)},setHeight:function(e){Kinetic.Node.prototype.setHeight.call(this,e);this._resizeDOM()},setWidth:function(e){Kinetic.Node.prototype.setWidth.call(this,e);this._resizeDOM()},clear:function(){var e=this.children,t=e.length,n;for(n=0;n<t;n++)e[n].clear()},remove:function(){var e=this.content;Kinetic.Node.prototype.remove.call(this);e&&Kinetic.Type._isInDocument(e)&&this.getContainer().removeChild(e)},getMousePosition:function(){return this.mousePos},getTouchPosition:function(){return this.touchPos},getPointerPosition:function(){return this.getTouchPosition()||this.getMousePosition()},getStage:function(){return this},getContent:function(){return this.content},toDataURL:function(e){function a(r){var i=u[r],f=i.toDataURL(),l=new Image;l.onload=function(){o.drawImage(l,0,0);r<u.length-1?a(r+1):e.callback(s.toDataURL(t,n))};l.src=f}var e=e||{},t=e.mimeType||null,n=e.quality||null,r=e.x||0,i=e.y||0,s=new Kinetic.SceneCanvas({width:e.width||this.getWidth(),height:e.height||this.getHeight(),pixelRatio:1}),o=s.getContext(),u=this.children;(r||i)&&o.translate(-1*r,-1*i);a(0)},toImage:function(e){var t=e.callback;e.callback=function(e){Kinetic.Type._getImage(e,function(e){t(e)})};this.toDataURL(e)},getIntersection:function(){var e=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),t=this.getChildren(),n=t.length,r=n-1,i,s;for(i=r;i>=0;i--){s=t[i].getIntersection(e);if(s)return s}return null},_resizeDOM:function(){if(this.content){var e=this.getWidth(),t=this.getHeight(),r=this.getChildren(),i=r.length,s;this.content.style.width=e+n;this.content.style.height=t+n;this.bufferCanvas.setSize(e,t,1);this.hitCanvas.setSize(e,t);for(s=0;s<i;s++){layer=r[s];layer.getCanvas().setSize(e,t);layer.hitCanvas.setSize(e,t);layer.draw()}}},add:function(e){Kinetic.Container.prototype.add.call(this,e);e.canvas.setSize(this.attrs.width,this.attrs.height);e.hitCanvas.setSize(this.attrs.width,this.attrs.height);e.draw();this.content.appendChild(e.canvas.element);return this},getParent:function(){return null},getLayer:function(){return null},_setPointerPosition:function(e){e||(e=window.event);this._setMousePosition(e);this._setTouchPosition(e)},_bindContentEvents:function(){var e=this,t;for(t=0;t<eventsLength;t++)p(this,EVENTS[t])},_mouseout:function(e){this._setPointerPosition(e);var t=Kinetic.Global,n=this.targetShape;if(n&&!t.isDragging()){n._handleEvent(r,e);n._handleEvent(i,e);this.targetShape=null}this.mousePos=undefined},_mousemove:function(e){this._setPointerPosition(e);var t=Kinetic.Global,n=Kinetic.DD,a=this.getIntersection(this.getPointerPosition()),f;if(a){f=a.shape;if(f)if(!t.isDragging()&&a.pixel[3]===255&&(!this.targetShape||this.targetShape._id!==f._id)){if(this.targetShape){this.targetShape._handleEvent(r,e,f);this.targetShape._handleEvent(i,e,f)}f._handleEvent(s,e,this.targetShape);f._handleEvent(o,e,this.targetShape);this.targetShape=f}else f._handleEvent(u,e)}else if(this.targetShape&&!t.isDragging()){this.targetShape._handleEvent(r,e);this.targetShape._handleEvent(i,e);this.targetShape=null}n&&n._drag(e)},_mousedown:function(e){this._setPointerPosition(e);var t=Kinetic.Global,n=this.getIntersection(this.getPointerPosition()),r;if(n&&n.shape){r=n.shape;this.clickStart=!0;this.clickStartShape=r;r._handleEvent(a,e)}this.isDraggable()&&!t.isDragReady()&&this.startDrag(e)},_mouseup:function(e){this._setPointerPosition(e);var t=this,n=Kinetic.Global,r=this.getIntersection(this.getPointerPosition()),i;if(r&&r.shape){i=r.shape;i._handleEvent(f,e);if(this.clickStart&&!n.isDragging()&&i._id===this.clickStartShape._id){i._handleEvent(l,e);this.inDoubleClickWindow&&i._handleEvent(c,e);this.inDoubleClickWindow=!0;setTimeout(function(){t.inDoubleClickWindow=!1},this.dblClickWindow)}}this.clickStart=!1},_touchstart:function(e){this._setPointerPosition(e);var t=Kinetic.Global,n=this.getIntersection(this.getPointerPosition()),r;e.preventDefault();if(n&&n.shape){r=n.shape;this.tapStart=!0;this.tapStartShape=r;r._handleEvent(h,e)}this.isDraggable()&&!t.isDragReady()&&this.startDrag(e)},_touchend:function(e){this._setPointerPosition(e);var t=this,n=Kinetic.Global,r=this.getIntersection(this.getPointerPosition()),i;if(r&&r.shape){i=r.shape;i._handleEvent(TOUCHEND,e);if(this.tapStart&&!n.isDragging()&&i._id===this.tapStartShape._id){i._handleEvent(TAP,e);this.inDoubleClickWindow&&i._handleEvent(DBL_TAP,e);this.inDoubleClickWindow=!0;setTimeout(function(){t.inDoubleClickWindow=!1},this.dblClickWindow)}}this.tapStart=!1},_touchmove:function(e){this._setPointerPosition(e);var t=Kinetic.DD,n=this.getIntersection(this.getPointerPosition()),r;e.preventDefault();if(n&&n.shape){r=n.shape;r._handleEvent(TOUCHMOVE,e)}t&&t._drag(e)},_setMousePosition:function(e){var t=e.clientX-this._getContentPosition().left,n=e.clientY-this._getContentPosition().top;this.mousePos={x:t,y:n}},_setTouchPosition:function(e){var t,n,r;if(e.touches!==undefined&&e.touches.length===1){t=e.touches[0];n=t.clientX-this._getContentPosition().left;r=t.clientY-this._getContentPosition().top;this.touchPos={x:n,y:r}}},_getContentPosition:function(){var e=this.content.getBoundingClientRect();return{top:e.top,left:e.left}},_buildDOM:function(){this.content=document.createElement(DIV);this.content.style.position=RELATIVE;this.content.style.display=INLINE_BLOCK;this.content.className=KINETICJS_CONTENT;this.attrs.container.appendChild(this.content);this.bufferCanvas=new Kinetic.SceneCanvas;this.hitCanvas=new Kinetic.HitCanvas;this._resizeDOM()},_onContent:function(e,t){var n=e.split(SPACE),r=n.length,i,s;for(i=0;i<r;i++){s=n[i];this.content.addEventListener(s,t,!1)}}};Kinetic.Global.extend(Kinetic.Stage,Kinetic.Container);Kinetic.Node.addGetter(Kinetic.Stage,"container")})();(function(){Kinetic.Layer=function(e){this._initLayer(e)};Kinetic.Layer.prototype={_initLayer:function(e){this.nodeType="Layer";this.createAttrs();Kinetic.Container.call(this,e);this.canvas=new Kinetic.SceneCanvas;this.canvas.getElement().style.position="absolute";this.hitCanvas=new Kinetic.HitCanvas},getIntersection:function(){var e=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),t,n,r;if(this.isVisible()&&this.isListening()){t=this.hitCanvas.context.getImageData(e.x|0,e.y|0,1,1).data;if(t[3]===255){n=Kinetic.Type._rgbToHex(t[0],t[1],t[2]);r=Kinetic.Global.shapes[n];return{shape:r,pixel:t}}if(t[0]>0||t[1]>0||t[2]>0||t[3]>0)return{pixel:t}}return null},drawScene:function(e){var e=e||this.getCanvas();this.getClearBeforeDraw()&&e.clear();Kinetic.Container.prototype.drawScene.call(this,e)},drawHit:function(){var e=this.getLayer();e&&e.getClearBeforeDraw()&&e.getHitCanvas().clear();Kinetic.Container.prototype.drawHit.call(this)},getCanvas:function(){return this.canvas},getHitCanvas:function(){return this.hitCanvas},getContext:function(){return this.getCanvas().getContext()},clear:function(){this.getCanvas().clear()},setVisible:function(e){Kinetic.Node.prototype.setVisible.call(this,e);if(e){this.getCanvas().element.style.display="block";this.hitCanvas.element.style.display="block"}else{this.getCanvas().element.style.display="none";this.hitCanvas.element.style.display="none"}},setZIndex:function(e){Kinetic.Node.prototype.setZIndex.call(this,e);var t=this.getStage();if(t){t.content.removeChild(this.getCanvas().element);e<t.getChildren().length-1?t.content.insertBefore(this.getCanvas().element,t.getChildren()[e+1].getCanvas().element):t.content.appendChild(this.getCanvas().element)}},moveToTop:function(){Kinetic.Node.prototype.moveToTop.call(this);var e=this.getStage();if(e){e.content.removeChild(this.getCanvas().element);e.content.appendChild(this.getCanvas().element)}},moveUp:function(){if(Kinetic.Node.prototype.moveUp.call(this)){var e=this.getStage();if(e){e.content.removeChild(this.getCanvas().element);this.index<e.getChildren().length-1?e.content.insertBefore(this.getCanvas().element,e.getChildren()[this.index+1].getCanvas().element):e.content.appendChild(this.getCanvas().element)}}},moveDown:function(){if(Kinetic.Node.prototype.moveDown.call(this)){var e=this.getStage();if(e){var t=e.getChildren();e.content.removeChild(this.getCanvas().element);e.content.insertBefore(this.getCanvas().element,t[this.index+1].getCanvas().element)}}},moveToBottom:function(){if(Kinetic.Node.prototype.moveToBottom.call(this)){var e=this.getStage();if(e){var t=e.getChildren();e.content.removeChild(this.getCanvas().element);e.content.insertBefore(this.getCanvas().element,t[1].getCanvas().element)}}},getLayer:function(){return this},remove:function(){var e=this.getStage(),t=this.getCanvas(),n=t.element;Kinetic.Node.prototype.remove.call(this);e&&t&&Kinetic.Type._isInDocument(n)&&e.content.removeChild(n)}};Kinetic.Global.extend(Kinetic.Layer,Kinetic.Container);Kinetic.Node.addGetterSetter(Kinetic.Layer,"clearBeforeDraw",!0)})();(function(){Kinetic.Group=function(e){this._initGroup(e)};Kinetic.Group.prototype={_initGroup:function(e){this.nodeType="Group";this.createAttrs();Kinetic.Container.call(this,e)}};Kinetic.Global.extend(Kinetic.Group,Kinetic.Container)})();(function(){Kinetic.Rect=function(e){this._initRect(e)};Kinetic.Rect.prototype={_initRect:function(e){this.createAttrs();Kinetic.Shape.call(this,e);this.shapeType="Rect";this._setDrawFuncs()},drawFunc:function(e){var t=e.getContext(),n=this.getCornerRadius(),r=this.getWidth(),i=this.getHeight();t.beginPath();if(!n)t.rect(0,0,r,i);else{t.moveTo(n,0);t.lineTo(r-n,0);t.arc(r-n,n,n,Math.PI*3/2,0,!1);t.lineTo(r,i-n);t.arc(r-n,i-n,n,0,Math.PI/2,!1);t.lineTo(n,i);t.arc(n,i-n,n,Math.PI/2,Math.PI,!1);t.lineTo(0,n);t.arc(n,n,n,Math.PI,Math.PI*3/2,!1)}t.closePath();e.fillStroke(this)}};Kinetic.Global.extend(Kinetic.Rect,Kinetic.Shape);Kinetic.Node.addGetterSetter(Kinetic.Rect,"cornerRadius",0)})();(function(){Kinetic.Circle=function(e){this._initCircle(e)};Kinetic.Circle.prototype={_initCircle:function(e){this.createAttrs();Kinetic.Shape.call(this,e);this.shapeType="Circle";this._setDrawFuncs()},drawFunc:function(e){var t=e.getContext();t.beginPath();t.arc(0,0,this.getRadius(),0,Math.PI*2,!0);t.closePath();e.fillStroke(this)},getWidth:function(){return this.getRadius()*2},getHeight:function(){return this.getRadius()*2},setWidth:function(e){Kinetic.Node.prototype.setWidth.call(this,e);this.setRadius(e/2)},setHeight:function(e){Kinetic.Node.prototype.setHeight.call(this,e);this.setRadius(e/2)}};Kinetic.Global.extend(Kinetic.Circle,Kinetic.Shape);Kinetic.Node.addGetterSetter(Kinetic.Circle,"radius",0)})();(function(){Kinetic.Wedge=function(e){this._initWedge(e)};Kinetic.Wedge.prototype={_initWedge:function(e){this.createAttrs();Kinetic.Shape.call(this,e);this.shapeType="Wedge";this._setDrawFuncs()},drawFunc:function(e){var t=e.getContext();t.beginPath();t.arc(0,0,this.getRadius(),0,this.getAngle(),this.getClockwise());t.lineTo(0,0);t.closePath();e.fillStroke(this)},setAngleDeg:function(e){this.setAngle(Kinetic.Type._degToRad(e))},getAngleDeg:function(){return Kinetic.Type._radToDeg(this.getAngle())}};Kinetic.Global.extend(Kinetic.Wedge,Kinetic.Shape);Kinetic.Node.addGetterSetter(Kinetic.Wedge,"radius",0);Kinetic.Node.addGetterSetter(Kinetic.Wedge,"angle",0);Kinetic.Node.addGetterSetter(Kinetic.Wedge,"clockwise",!1)})();(function(){Kinetic.Ellipse=function(e){this._initEllipse(e)};Kinetic.Ellipse.prototype={_initEllipse:function(e){this.createAttrs();Kinetic.Shape.call(this,e);this.shapeType="Ellipse";this._setDrawFuncs()},drawFunc:function(e){var t=e.getContext(),n=this.getRadius();t.beginPath();t.save();n.x!==n.y&&t.scale(1,n.y/n.x);t.arc(0,0,n.x,0,Math.PI*2,!0);t.restore();t.closePath();e.fillStroke(this)},getWidth:function(){return this.getRadius().x*2},getHeight:function(){return this.getRadius().y*2},setWidth:function(e){Kinetic.Node.prototype.setWidth.call(this,e);this.setRadius({x:e/2})},setHeight:function(e){Kinetic.Node.prototype.setHeight.call(this,e);this.setRadius({y:e/2})}};Kinetic.Global.extend(Kinetic.Ellipse,Kinetic.Shape);Kinetic.Node.addPointGetterSetter(Kinetic.Ellipse,"radius",{x:0,y:0})})();(function(){var e="Image",t="crop";Kinetic.Image=function(e){this._initImage(e)};Kinetic.Image.prototype={_initImage:function(t){var n=this;Kinetic.Shape.call(this,t);this.shapeType=e;this._setDrawFuncs()},drawFunc:function(e){var t=this.getWidth(),n=this.getHeight(),r,i=this,s=e.getContext(),o=this.getImage(),u=this.getCrop(),a,f,l,c;s.beginPath();s.rect(0,0,t,n);s.closePath();e.fillStroke(this);if(o){if(u){a=u.x||0;f=u.y||0;l=u.width||0;c=u.height||0;r=[o,a,f,l,c,0,0,t,n]}else r=[o,0,0,t,n];this.hasShadow()?e.applyShadow(this,function(){i._drawImage(s,r)}):this._drawImage(s,r)}},drawHitFunc:function(e){var t=this.getWidth(),n=this.getHeight(),r=this.imageHitRegion,i=e.getContext();if(r){i.drawImage(r,0,0,t,n);i.beginPath();i.rect(0,0,t,n);i.closePath();e.stroke(this)}else{i.beginPath();i.rect(0,0,t,n);i.closePath();e.fillStroke(this)}},applyFilter:function(e,t,n){var r=this.getImage(),i=new Kinetic.Canvas({width:r.width,height:r.height}),s=i.getContext(),o=this;s.drawImage(r,0,0);try{var u=s.getImageData(0,0,i.getWidth(),i.getHeight());e(u,t);Kinetic.Type._getImage(u,function(e){o.setImage(e);n&&n()})}catch(a){Kinetic.Global.warn("Unable to apply filter. "+a.message)}},setCrop:function(){var e=[].slice.call(arguments),n=Kinetic.Type._getXY(e),r=Kinetic.Type._getSize(e),i=Kinetic.Type._merge(n,r);this.setAttr(t,Kinetic.Type._merge(i,this.getCrop()))},createImageHitRegion:function(e){var t=this,n=this.getWidth(),r=this.getHeight(),i=new Kinetic.Canvas({width:n,height:r}),s=i.getContext(),o=this.getImage(),u,a,f,l,c;s.drawImage(o,0,0);try{u=s.getImageData(0,0,n,r);a=u.data;f=Kinetic.Type._hexToRgb(this.colorKey);for(l=0,c=a.length;l<c;l+=4)if(a[l+3]>0){a[l]=f.r;a[l+1]=f.g;a[l+2]=f.b}Kinetic.Type._getImage(u,function(n){t.imageHitRegion=n;e&&e()})}catch(h){Kinetic.Global.warn("Unable to create image hit region. "+h.message)}},clearImageHitRegion:function(){delete this.imageHitRegion},getWidth:function(){var e=this.getImage();return this.attrs.width||(e?e.width:0)},getHeight:function(){var e=this.getImage();return this.attrs.height||(e?e.height:0)},_drawImage:function(e,t){t.length===5?e.drawImage(t[0],t[1],t[2],t[3],t[4]):t.length===9&&e.drawImage(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])}};Kinetic.Global.extend(Kinetic.Image,Kinetic.Shape);Kinetic.Node.addGetterSetter(Kinetic.Image,"image");Kinetic.Node.addGetter(Kinetic.Image,"crop")})();(function(){Kinetic.Polygon=function(e){this._initPolygon(e)};Kinetic.Polygon.prototype={_initPolygon:function(e){this.createAttrs();Kinetic.Shape.call(this,e);this.shapeType="Polygon";this._setDrawFuncs()},drawFunc:function(e){var t=e.getContext(),n=this.getPoints(),r=n.length;t.beginPath();t.moveTo(n[0].x,n[0].y);for(var i=1;i<r;i++)t.lineTo(n[i].x,n[i].y);t.closePath();e.fillStroke(this)},setPoints:function(e){this.setAttr("points",Kinetic.Type._getPoints(e))},getPoints:function(){return this.attrs.points||[]}};Kinetic.Global.extend(Kinetic.Polygon,Kinetic.Shape)})();(function(){function T(e){e.fillText(this.partialText,0,0)}function N(e){e.strokeText(this.partialText,0,0)}var e="auto",t="Calibri",n="canvas",r="center",i="Change.kinetic",s="2d",o="-",u="",a="left",f="\n",l="text",c="Text",h="top",p="middle",d="normal",v="px ",m=" ",g="right",y="word",b="char",w="none",E=["fontFamily","fontSize","fontStyle","padding","align","lineHeight","text","width","height","wrap"],S=E.length,x=document.createElement(n).getContext(s);Kinetic.Text=function(e){this._initText(e)};Kinetic.Text.prototype={_initText:function(t){var n=this;this.createAttrs();this.attrs.width=e;this.attrs.height=e;Kinetic.Shape.call(this,t);this.shapeType=l;this._fillFunc=T;this._strokeFunc=N;this.shapeType=c;this._setDrawFuncs();for(var r=0;r<S;r++)this.on(E[r]+i,n._setTextData);this._setTextData()},drawFunc:function(e){var t=e.getContext(),n=this.getPadding(),i=this.getFontStyle(),s=this.getFontSize(),o=this.getFontFamily(),u=this.getTextHeight(),f=this.getLineHeight()*u,l=this.textArr,c=l.length,h=this.getWidth();t.font=this._getContextFont();t.textBaseline=p;t.textAlign=a;t.save();t.translate(n,0);t.translate(0,n+u/2);for(var d=0;d<c;d++){var v=l[d],m=v.text,y=v.width;t.save();this.getAlign()===g?t.translate(h-y-n*2,0):this.getAlign()===r&&t.translate((h-y-n*2)/2,0);this.partialText=m;e.fillStroke(this);t.restore();t.translate(0,f)}t.restore()},drawHitFunc:function(e){var t=e.getContext(),n=this.getWidth
(),r=this.getHeight();t.beginPath();t.rect(0,0,n,r);t.closePath();e.fillStroke(this)},setText:function(e){var t=Kinetic.Type._isString(e)?e:e.toString();this.setAttr(l,t)},getWidth:function(){return this.attrs.width===e?this.getTextWidth()+this.getPadding()*2:this.attrs.width},getHeight:function(){return this.attrs.height===e?this.getTextHeight()*this.textArr.length*this.getLineHeight()+this.getPadding()*2:this.attrs.height},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},_getTextSize:function(e){var t=x,n=this.getFontSize(),r;t.save();t.font=this._getContextFont();r=t.measureText(e);t.restore();return{width:r.width,height:parseInt(n,10)}},_getContextFont:function(){return this.getFontStyle()+m+this.getFontSize()+v+this.getFontFamily()},_addTextLine:function(e,t,n){return this.textArr.push({text:e,width:t})},_getTextWidth:function(e){return x.measureText(e).width},_setTextData:function(){var t=this.getText().split("\n"),n=+this.getFontSize(),r=0,i=this.getLineHeight()*n,s=this.attrs.width,u=this.attrs.height,a=s!==e,f=u!==e,l=this.getPadding(),c=s-l*2,h=u-l*2,p=0,d=this.getWrap(),g=d!==w,y=d!==b&&g;this.textArr=[];x.save();x.font=this.getFontStyle()+m+n+v+this.getFontFamily();for(var E=0,S=t.length;E<S;++E){var T=t[E],N=this._getTextWidth(T);if(a&&N>c)while(T.length>0){var C=0,k=T.length,L="",A=0;while(C<k){var O=C+k>>>1,M=T.slice(0,O+1),_=this._getTextWidth(M);if(_<=c){C=O+1;L=M;A=_}else k=O}if(!L)break;if(y){var D=Math.max(L.lastIndexOf(m),L.lastIndexOf(o))+1;if(D>0){C=D;L=L.slice(0,C);A=this._getTextWidth(L)}}this._addTextLine(L,A);p+=i;if(!g||f&&p+i>h)break;T=T.slice(C);if(T.length>0){N=this._getTextWidth(T);if(N<=c){this._addTextLine(T,N);p+=i;break}}}else{this._addTextLine(T,N);p+=i;r=Math.max(r,N)}if(f&&p+i>h)break}x.restore();this.textHeight=n;this.textWidth=r}};Kinetic.Global.extend(Kinetic.Text,Kinetic.Shape);Kinetic.Node.addGetterSetter(Kinetic.Text,"fontFamily",t);Kinetic.Node.addGetterSetter(Kinetic.Text,"fontSize",12);Kinetic.Node.addGetterSetter(Kinetic.Text,"fontStyle",d);Kinetic.Node.addGetterSetter(Kinetic.Text,"padding",0);Kinetic.Node.addGetterSetter(Kinetic.Text,"align",a);Kinetic.Node.addGetterSetter(Kinetic.Text,"lineHeight",1);Kinetic.Node.addGetterSetter(Kinetic.Text,"wrap",y);Kinetic.Node.addGetter(Kinetic.Text,l,u);Kinetic.Node.addSetter(Kinetic.Text,"width");Kinetic.Node.addSetter(Kinetic.Text,"height")})();(function(){Kinetic.Line=function(e){this._initLine(e)};Kinetic.Line.prototype={_initLine:function(e){this.createAttrs();Kinetic.Shape.call(this,e);this.shapeType="Line";this._setDrawFuncs()},drawFunc:function(e){var t=this.getPoints(),n=t.length,r=e.getContext();r.beginPath();r.moveTo(t[0].x,t[0].y);for(var i=1;i<n;i++){var s=t[i];r.lineTo(s.x,s.y)}e.stroke(this)},setPoints:function(e){this.setAttr("points",Kinetic.Type._getPoints(e))},getPoints:function(){return this.attrs.points||[]}};Kinetic.Global.extend(Kinetic.Line,Kinetic.Shape)})();(function(){Kinetic.Spline=function(e){this._initSpline(e)};Kinetic.Spline._getControlPoints=function(e,t,n,r){var i=e.x,s=e.y,o=t.x,u=t.y,a=n.x,f=n.y,l=Math.sqrt(Math.pow(o-i,2)+Math.pow(u-s,2)),c=Math.sqrt(Math.pow(a-o,2)+Math.pow(f-u,2)),h=r*l/(l+c),p=r*c/(l+c),d=o-h*(a-i),v=u-h*(f-s),m=o+p*(a-i),g=u+p*(f-s);return[{x:d,y:v},{x:m,y:g}]};Kinetic.Spline.prototype={_initSpline:function(e){this.createAttrs();Kinetic.Line.call(this,e);this.shapeType="Spline"},drawFunc:function(e){var t=this.getPoints(),n=t.length,r=e.getContext(),i=this.getTension();r.beginPath();r.moveTo(t[0].x,t[0].y);if(i!==0&&n>2){var s=this.allPoints,o=s.length;r.quadraticCurveTo(s[0].x,s[0].y,s[1].x,s[1].y);var u=2;while(u<o-1)r.bezierCurveTo(s[u].x,s[u++].y,s[u].x,s[u++].y,s[u].x,s[u++].y);r.quadraticCurveTo(s[o-1].x,s[o-1].y,t[n-1].x,t[n-1].y)}else for(var u=1;u<n;u++){var a=t[u];r.lineTo(a.x,a.y)}e.stroke(this)},setPoints:function(e){Kinetic.Line.prototype.setPoints.call(this,e);this._setAllPoints()},setTension:function(e){this.setAttr("tension",e);this._setAllPoints()},_setAllPoints:function(){var e=this.getPoints(),t=e.length,n=this.getTension(),r=[];for(var i=1;i<t-1;i++){var s=Kinetic.Spline._getControlPoints(e[i-1],e[i],e[i+1],n);r.push(s[0]);r.push(e[i]);r.push(s[1])}this.allPoints=r}};Kinetic.Global.extend(Kinetic.Spline,Kinetic.Line);Kinetic.Node.addGetter(Kinetic.Spline,"tension",1)})();(function(){Kinetic.Blob=function(e){this._initBlob(e)};Kinetic.Blob.prototype={_initBlob:function(e){Kinetic.Spline.call(this,e);this.shapeType="Blob"},drawFunc:function(e){var t=this.getPoints(),n=t.length,r=e.getContext(),i=this.getTension();r.beginPath();r.moveTo(t[0].x,t[0].y);if(i!==0&&n>2){var s=this.allPoints,o=s.length,u=0;while(u<o-1)r.bezierCurveTo(s[u].x,s[u++].y,s[u].x,s[u++].y,s[u].x,s[u++].y)}else for(var u=1;u<n;u++){var a=t[u];r.lineTo(a.x,a.y)}r.closePath();e.fillStroke(this)},_setAllPoints:function(){var e=this.getPoints(),t=e.length,n=this.getTension(),r=Kinetic.Spline._getControlPoints(e[t-1],e[0],e[1],n),i=Kinetic.Spline._getControlPoints(e[t-2],e[t-1],e[0],n);Kinetic.Spline.prototype._setAllPoints.call(this);this.allPoints.unshift(r[1]);this.allPoints.push(i[0]);this.allPoints.push(e[t-1]);this.allPoints.push(i[1]);this.allPoints.push(r[0]);this.allPoints.push(e[0])}};Kinetic.Global.extend(Kinetic.Blob,Kinetic.Spline)})();(function(){Kinetic.Sprite=function(e){this._initSprite(e)};Kinetic.Sprite.prototype={_initSprite:function(e){this.createAttrs();Kinetic.Shape.call(this,e);this.shapeType="Sprite";this._setDrawFuncs();this.anim=new Kinetic.Animation;var t=this;this.on("animationChange",function(){t.setIndex(0)})},drawFunc:function(e){var t=this.getAnimation(),n=this.getIndex(),r=this.getAnimations()[t][n],i=e.getContext(),s=this.getImage();s&&i.drawImage(s,r.x,r.y,r.width,r.height,0,0,r.width,r.height)},drawHitFunc:function(e){var t=this.getAnimation(),n=this.getIndex(),r=this.getAnimations()[t][n],i=e.getContext();i.beginPath();i.rect(0,0,r.width,r.height);i.closePath();e.fill(this)},start:function(){var e=this,t=this.getLayer();this.anim.node=t;this.interval=setInterval(function(){var t=e.getIndex();e._updateIndex();if(e.afterFrameFunc&&t===e.afterFrameIndex){e.afterFrameFunc();delete e.afterFrameFunc;delete e.afterFrameIndex}},1e3/this.getFrameRate());this.anim.start()},stop:function(){this.anim.stop();clearInterval(this.interval)},afterFrame:function(e,t){this.afterFrameIndex=e;this.afterFrameFunc=t},_updateIndex:function(){var e=this.getIndex(),t=this.getAnimation(),n=this.getAnimations(),r=n[t],i=r.length;e<i-1?this.setIndex(e+1):this.setIndex(0)}};Kinetic.Global.extend(Kinetic.Sprite,Kinetic.Shape);Kinetic.Node.addGetterSetter(Kinetic.Sprite,"animation");Kinetic.Node.addGetterSetter(Kinetic.Sprite,"animations");Kinetic.Node.addGetterSetter(Kinetic.Sprite,"image");Kinetic.Node.addGetterSetter(Kinetic.Sprite,"index",0);Kinetic.Node.addGetterSetter(Kinetic.Sprite,"frameRate",17)})();(function(){Kinetic.Path=function(e){this._initPath(e)};Kinetic.Path.prototype={_initPath:function(e){this.dataArray=[];var t=this;Kinetic.Shape.call(this,e);this.shapeType="Path";this._setDrawFuncs();this.dataArray=Kinetic.Path.parsePathData(this.getData());this.on("dataChange",function(){t.dataArray=Kinetic.Path.parsePathData(this.getData())})},drawFunc:function(e){var t=this.dataArray,n=e.getContext();n.beginPath();for(var r=0;r<t.length;r++){var i=t[r].command,s=t[r].points;switch(i){case"L":n.lineTo(s[0],s[1]);break;case"M":n.moveTo(s[0],s[1]);break;case"C":n.bezierCurveTo(s[0],s[1],s[2],s[3],s[4],s[5]);break;case"Q":n.quadraticCurveTo(s[0],s[1],s[2],s[3]);break;case"A":var o=s[0],u=s[1],a=s[2],f=s[3],l=s[4],c=s[5],h=s[6],p=s[7],d=a>f?a:f,v=a>f?1:a/f,m=a>f?f/a:1;n.translate(o,u);n.rotate(h);n.scale(v,m);n.arc(0,0,d,l,l+c,1-p);n.scale(1/v,1/m);n.rotate(-h);n.translate(-o,-u);break;case"z":n.closePath()}}e.fillStroke(this)}};Kinetic.Global.extend(Kinetic.Path,Kinetic.Shape);Kinetic.Path.getLineLength=function(e,t,n,r){return Math.sqrt((n-e)*(n-e)+(r-t)*(r-t))};Kinetic.Path.getPointOnLine=function(e,t,n,r,i,s,o){s===undefined&&(s=t);o===undefined&&(o=n);var u=(i-n)/(r-t+1e-8),a=Math.sqrt(e*e/(1+u*u));r<t&&(a*=-1);var f=u*a,l;if((o-n)/(s-t+1e-8)===u)l={x:s+a,y:o+f};else{var c,h,p=this.getLineLength(t,n,r,i);if(p<1e-8)return undefined;var d=(s-t)*(r-t)+(o-n)*(i-n);d/=p*p;c=t+d*(r-t);h=n+d*(i-n);var v=this.getLineLength(s,o,c,h),m=Math.sqrt(e*e-v*v);a=Math.sqrt(m*m/(1+u*u));r<t&&(a*=-1);f=u*a;l={x:c+a,y:h+f}}return l};Kinetic.Path.getPointOnCubicBezier=function(e,t,n,r,i,s,o,u,a){function f(e){return e*e*e}function l(e){return 3*e*e*(1-e)}function c(e){return 3*e*(1-e)*(1-e)}function h(e){return(1-e)*(1-e)*(1-e)}var p=u*f(e)+s*l(e)+r*c(e)+t*h(e),d=a*f(e)+o*l(e)+i*c(e)+n*h(e);return{x:p,y:d}};Kinetic.Path.getPointOnQuadraticBezier=function(e,t,n,r,i,s,o){function u(e){return e*e}function a(e){return 2*e*(1-e)}function f(e){return(1-e)*(1-e)}var l=s*u(e)+r*a(e)+t*f(e),c=o*u(e)+i*a(e)+n*f(e);return{x:l,y:c}};Kinetic.Path.getPointOnEllipticalArc=function(e,t,n,r,i,s){var o=Math.cos(s),u=Math.sin(s),a={x:n*Math.cos(i),y:r*Math.sin(i)};return{x:e+(a.x*o-a.y*u),y:t+(a.x*u+a.y*o)}};Kinetic.Path.parsePathData=function(e){if(!e)return[];var t=e,n=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];t=t.replace(new RegExp(" ","g"),",");for(var r=0;r<n.length;r++)t=t.replace(new RegExp(n[r],"g"),"|"+n[r]);var i=t.split("|"),s=[],o=0,u=0;for(var r=1;r<i.length;r++){var a=i[r],f=a.charAt(0);a=a.slice(1);a=a.replace(new RegExp(",-","g"),"-");a=a.replace(new RegExp("-","g"),",-");a=a.replace(new RegExp("e,-","g"),"e-");var l=a.split(",");l.length>0&&l[0]===""&&l.shift();for(var c=0;c<l.length;c++)l[c]=parseFloat(l[c]);while(l.length>0){if(isNaN(l[0]))break;var h=null,p=[],d=o,v=u;switch(f){case"l":o+=l.shift();u+=l.shift();h="L";p.push(o,u);break;case"L":o=l.shift();u=l.shift();p.push(o,u);break;case"m":o+=l.shift();u+=l.shift();h="M";p.push(o,u);f="l";break;case"M":o=l.shift();u=l.shift();h="M";p.push(o,u);f="L";break;case"h":o+=l.shift();h="L";p.push(o,u);break;case"H":o=l.shift();h="L";p.push(o,u);break;case"v":u+=l.shift();h="L";p.push(o,u);break;case"V":u=l.shift();h="L";p.push(o,u);break;case"C":p.push(l.shift(),l.shift(),l.shift(),l.shift());o=l.shift();u=l.shift();p.push(o,u);break;case"c":p.push(o+l.shift(),u+l.shift(),o+l.shift(),u+l.shift());o+=l.shift();u+=l.shift();h="C";p.push(o,u);break;case"S":var m=o,g=u,y=s[s.length-1];if(y.command==="C"){m=o+(o-y.points[2]);g=u+(u-y.points[3])}p.push(m,g,l.shift(),l.shift());o=l.shift();u=l.shift();h="C";p.push(o,u);break;case"s":var m=o,g=u,y=s[s.length-1];if(y.command==="C"){m=o+(o-y.points[2]);g=u+(u-y.points[3])}p.push(m,g,o+l.shift(),u+l.shift());o+=l.shift();u+=l.shift();h="C";p.push(o,u);break;case"Q":p.push(l.shift(),l.shift());o=l.shift();u=l.shift();p.push(o,u);break;case"q":p.push(o+l.shift(),u+l.shift());o+=l.shift();u+=l.shift();h="Q";p.push(o,u);break;case"T":var m=o,g=u,y=s[s.length-1];if(y.command==="Q"){m=o+(o-y.points[0]);g=u+(u-y.points[1])}o=l.shift();u=l.shift();h="Q";p.push(m,g,o,u);break;case"t":var m=o,g=u,y=s[s.length-1];if(y.command==="Q"){m=o+(o-y.points[0]);g=u+(u-y.points[1])}o+=l.shift();u+=l.shift();h="Q";p.push(m,g,o,u);break;case"A":var b=l.shift(),w=l.shift(),E=l.shift(),S=l.shift(),x=l.shift(),T=o,N=u;o=l.shift(),u=l.shift();h="A";p=this.convertEndpointToCenterParameterization(T,N,o,u,S,x,b,w,E);break;case"a":var b=l.shift(),w=l.shift(),E=l.shift(),S=l.shift(),x=l.shift(),T=o,N=u;o+=l.shift(),u+=l.shift();h="A";p=this.convertEndpointToCenterParameterization(T,N,o,u,S,x,b,w,E)}s.push({command:h||f,points:p,start:{x:d,y:v},pathLength:this.calcLength(d,v,h||f,p)})}(f==="z"||f==="Z")&&s.push({command:"z",points:[],start:undefined,pathLength:0})}return s};Kinetic.Path.calcLength=function(e,n,r,i){var s,o,u,a=Kinetic.Path;switch(r){case"L":return a.getLineLength(e,n,i[0],i[1]);case"C":s=0;o=a.getPointOnCubicBezier(0,e,n,i[0],i[1],i[2],i[3],i[4],i[5]);for(t=.01;t<=1;t+=.01){u=a.getPointOnCubicBezier(t,e,n,i[0],i[1],i[2],i[3],i[4],i[5]);s+=a.getLineLength(o.x,o.y,u.x,u.y);o=u}return s;case"Q":s=0;o=a.getPointOnQuadraticBezier(0,e,n,i[0],i[1],i[2],i[3]);for(t=.01;t<=1;t+=.01){u=a.getPointOnQuadraticBezier(t,e,n,i[0],i[1],i[2],i[3]);s+=a.getLineLength(o.x,o.y,u.x,u.y);o=u}return s;case"A":s=0;var f=i[4],l=i[5],c=i[4]+l,h=Math.PI/180;Math.abs(f-c)<h&&(h=Math.abs(f-c));o=a.getPointOnEllipticalArc(i[0],i[1],i[2],i[3],f,0);if(l<0)for(t=f-h;t>c;t-=h){u=a.getPointOnEllipticalArc(i[0],i[1],i[2],i[3],t,0);s+=a.getLineLength(o.x,o.y,u.x,u.y);o=u}else for(t=f+h;t<c;t+=h){u=a.getPointOnEllipticalArc(i[0],i[1],i[2],i[3],t,0);s+=a.getLineLength(o.x,o.y,u.x,u.y);o=u}u=a.getPointOnEllipticalArc(i[0],i[1],i[2],i[3],c,0);s+=a.getLineLength(o.x,o.y,u.x,u.y);return s}return 0};Kinetic.Path.convertEndpointToCenterParameterization=function(e,t,n,r,i,s,o,u,a){var f=a*(Math.PI/180),l=Math.cos(f)*(e-n)/2+Math.sin(f)*(t-r)/2,c=-1*Math.sin(f)*(e-n)/2+Math.cos(f)*(t-r)/2,h=l*l/(o*o)+c*c/(u*u);if(h>1){o*=Math.sqrt(h);u*=Math.sqrt(h)}var p=Math.sqrt((o*o*u*u-o*o*c*c-u*u*l*l)/(o*o*c*c+u*u*l*l));i==s&&(p*=-1);isNaN(p)&&(p=0);var d=p*o*c/u,v=p*-u*l/o,m=(e+n)/2+Math.cos(f)*d-Math.sin(f)*v,g=(t+r)/2+Math.sin(f)*d+Math.cos(f)*v,y=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])},b=function(e,t){return(e[0]*t[0]+e[1]*t[1])/(y(e)*y(t))},w=function(e,t){return(e[0]*t[1]<e[1]*t[0]?-1:1)*Math.acos(b(e,t))},E=w([1,0],[(l-d)/o,(c-v)/u]),S=[(l-d)/o,(c-v)/u],x=[(-1*l-d)/o,(-1*c-v)/u],T=w(S,x);b(S,x)<=-1&&(T=Math.PI);b(S,x)>=1&&(T=0);s===0&&T>0&&(T-=2*Math.PI);s==1&&T<0&&(T+=2*Math.PI);return[m,g,o,u,E,T,f,s]};Kinetic.Node.addGetterSetter(Kinetic.Path,"data")})();(function(){function r(e){e.fillText(this.partialText,0,0)}function i(e){e.strokeText(this.partialText,0,0)}var e="",t="Calibri",n="normal";Kinetic.TextPath=function(e){this._initTextPath(e)};Kinetic.TextPath.prototype={_initTextPath:function(e){var t=this;this.createAttrs();this.dummyCanvas=document.createElement("canvas");this.dataArray=[];Kinetic.Shape.call(this,e);this._fillFunc=r;this._strokeFunc=i;this.shapeType="TextPath";this._setDrawFuncs();this.dataArray=Kinetic.Path.parsePathData(this.attrs.data);this.on("dataChange",function(){t.dataArray=Kinetic.Path.parsePathData(this.attrs.data)});var n=["text","textStroke","textStrokeWidth"];for(var s=0;s<n.length;s++){var o=n[s];this.on(o+"Change",t._setTextData)}t._setTextData()},drawFunc:function(e){var t=this.charArr,n=e.getContext();n.font=this._getContextFont();n.textBaseline="middle";n.textAlign="left";n.save();var r=this.glyphInfo;for(var i=0;i<r.length;i++){n.save();var s=r[i].p0,o=r[i].p1,u=parseFloat(this.attrs.fontSize);n.translate(s.x,s.y);n.rotate(r[i].rotation);this.partialText=r[i].text;e.fillStroke(this);n.restore()}n.restore()},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},setText:function(e){Kinetic.Text.prototype.setText.call(this,e)},_getTextSize:function(e){var t=this.dummyCanvas,n=t.getContext("2d");n.save();n.font=this._getContextFont();var r=n.measureText(e);n.restore();return{width:r.width,height:parseInt(this.attrs.fontSize,10)}},_setTextData:function(){var e=this,t=this._getTextSize(this.attrs.text);this.textWidth=t.width;this.textHeight=t.height;this.glyphInfo=[];var n=this.attrs.text.split(""),r,i,s,o=-1,u=0,a=function(){u=0;var t=e.dataArray;for(var n=o+1;n<t.length;n++){if(t[n].pathLength>0){o=n;return t[n]}t[n].command=="M"&&(r={x:t[n].points[0],y:t[n].points[1]})}return{}},f=function(t,n){var o=e._getTextSize(t).width,f=0,l=0,c=!1;i=undefined;while(Math.abs(o-f)/o>.01&&l<25){l++;var h=f;while(s===undefined){s=a();if(s&&h+s.pathLength<o){h+=s.pathLength;s=undefined}}if(s==={}||r===undefined)return undefined;var p=!1;switch(s.command){case"L":Kinetic.Path.getLineLength(r.x,r.y,s.points[0],s.points[1])>o?i=Kinetic.Path.getPointOnLine(o,r.x,r.y,s.points[0],s.points[1],r.x,r.y):s=undefined;break;case"A":var d=s.points[4],v=s.points[5],m=s.points[4]+v;u===0?u=d+1e-8:o>f?u+=Math.PI/180*v/Math.abs(v):u-=Math.PI/360*v/Math.abs(v);if(Math.abs(u)>Math.abs(m)){u=m;p=!0}i=Kinetic.Path.getPointOnEllipticalArc(s.points[0],s.points[1],s.points[2],s.points[3],u,s.points[6]);break;case"C":u===0?o>s.pathLength?u=1e-8:u=o/s.pathLength:o>f?u+=(o-f)/s.pathLength:u-=(f-o)/s.pathLength;if(u>1){u=1;p=!0}i=Kinetic.Path.getPointOnCubicBezier(u,s.start.x,s.start.y,s.points[0],s.points[1],s.points[2],s.points[3],s.points[4],s.points[5]);break;case"Q":u===0?u=o/s.pathLength:o>f?u+=(o-f)/s.pathLength:u-=(f-o)/s.pathLength;if(u>1){u=1;p=!0}i=Kinetic.Path.getPointOnQuadraticBezier(u,s.start.x,s.start.y,s.points[0],s.points[1],s.points[2],s.points[3])}i!==undefined&&(f=Kinetic.Path.getLineLength(r.x,r.y,i.x,i.y));if(p){p=!1;s=undefined}}};for(var l=0;l<n.length;l++){f(n[l]);if(r===undefined||i===undefined)break;var c=Kinetic.Path.getLineLength(r.x,r.y,i.x,i.y),h=0,p=Kinetic.Path.getPointOnLine(h+c/2,r.x,r.y,i.x,i.y),d=Math.atan2(i.y-r.y,i.x-r.x);this.glyphInfo.push({transposeX:p.x,transposeY:p.y,text:n[l],rotation:d,p0:r,p1:i});r=i}}};Kinetic.TextPath.prototype._getContextFont=Kinetic.Text.prototype._getContextFont;Kinetic.Global.extend(Kinetic.TextPath,Kinetic.Shape);Kinetic.Node.addGetterSetter(Kinetic.TextPath,"fontFamily",t);Kinetic.Node.addGetterSetter(Kinetic.TextPath,"fontSize",12);Kinetic.Node.addGetterSetter(Kinetic.TextPath,"fontStyle",n);Kinetic.Node.addGetter(Kinetic.TextPath,"text",e)})();(function(){Kinetic.RegularPolygon=function(e){this._initRegularPolygon(e)};Kinetic.RegularPolygon.prototype={_initRegularPolygon:function(e){this.createAttrs();Kinetic.Shape.call(this,e);this.shapeType="RegularPolygon";this._setDrawFuncs()},drawFunc:function(e){var t=e.getContext(),n=this.attrs.sides,r=this.attrs.radius;t.beginPath();t.moveTo(0,0-r);for(var i=1;i<n;i++){var s=r*Math.sin(i*2*Math.PI/n),o=-1*r*Math.cos(i*2*Math.PI/n);t.lineTo(s,o)}t.closePath();e.fillStroke(this)}};Kinetic.Global.extend(Kinetic.RegularPolygon,Kinetic.Shape);Kinetic.Node.addGetterSetter(Kinetic.RegularPolygon,"radius",0);Kinetic.Node.addGetterSetter(Kinetic.RegularPolygon,"sides",0)})();(function(){Kinetic.Star=function(e){this._initStar(e)};Kinetic.Star.prototype={_initStar:function(e){this.createAttrs();Kinetic.Shape.call(this,e);this.shapeType="Star";this._setDrawFuncs()},drawFunc:function(e){var t=e.getContext(),n=this.attrs.innerRadius,r=this.attrs.outerRadius,i=this.attrs.numPoints;t.beginPath();t.moveTo(0,0-this.attrs.outerRadius);for(var s=1;s<i*2;s++){var o=s%2===0?r:n,u=o*Math.sin(s*Math.PI/i),a=-1*o*Math.cos(s*Math.PI/i);t.lineTo(u,a)}t.closePath();e.fillStroke(this)}};Kinetic.Global.extend(Kinetic.Star,Kinetic.Shape);Kinetic.Node.addGetterSetter(Kinetic.Star,"numPoints",0);Kinetic.Node.addGetterSetter(Kinetic.Star,"innerRadius",0);Kinetic.Node.addGetterSetter(Kinetic.Star,"outerRadius",0)})();(function(){var e=["fontFamily","fontSize","fontStyle","padding","lineHeight","text"],t="Change.kinetic",n="none",r="up",i="right",s="down",o="left",u=e.length;Kinetic.Label=function(e){this._initLabel(e)};Kinetic.Label.prototype={_initLabel:function(n){var r=this,i=null;this.innerGroup=new Kinetic.Group;this.createAttrs();Kinetic.Group.call(this,n);i=new Kinetic.Text(n.text);this.setText(i);this.setRect(new Kinetic.LabelRect(n.rect));this.innerGroup.add(this.getRect());this.innerGroup.add(i);this.add(this.innerGroup);this._setGroupOffset();for(var s=0;s<u;s++)i.on(e[s]+t,function(){r._setGroupOffset()})},getWidth:function(){return this.getText().getWidth()},getHeight:function(){return this.getText().getHeight()},_setGroupOffset:function(){var e=this.getText(),t=e.getWidth(),n=e.getHeight(),u=this.getRect(),a=u.getPointerDirection(),f=u.getPointerWidth(),l=u.getPointerHeight(),c=0,h=0;switch(a){case r:c=t/2;h=-1*l;break;case i:c=t+f;h=n/2;break;case s:c=t/2;h=n+l;break;case o:c=-1*f;h=n/2}this.setOffset({x:c,y:h})}};Kinetic.Global.extend(Kinetic.Label,Kinetic.Group);Kinetic.Node.addGetterSetter(Kinetic.Label,"text");Kinetic.Node.addGetterSetter(Kinetic.Label,"rect");Kinetic.LabelRect=function(e){this._initLabelRect(e)};Kinetic.LabelRect.prototype={_initLabelRect:function(e){this.createAttrs();Kinetic.Shape.call(this,e);this.shapeType="LabelRect";this._setDrawFuncs()},drawFunc:function(e){var t=this.getParent().getParent(),n=e.getContext(),u=t.getWidth(),a=t.getHeight(),f=this.getPointerDirection(),l=this.getPointerWidth(),c=this.getPointerHeight(),h=this.getCornerRadius();n.beginPath();n.moveTo(0,0);if(f===r){n.lineTo((u-l)/2,0);n.lineTo(u/2,-1*c);n.lineTo((u+l)/2,0)}n.lineTo(u,0);if(f===i){n.lineTo(u,(a-c)/2);n.lineTo(u+l,a/2);n.lineTo(u,(a+c)/2)}n.lineTo(u,a);if(f===s){n.lineTo((u+l)/2,a);n.lineTo(u/2,a+c);n.lineTo((u-l)/2,a)}n.lineTo(0,a);if(f===o){n.lineTo(0,(a+c)/2);n.lineTo(-1*l,a/2);n.lineTo(0,(a-c)/2)}n.closePath();e.fillStroke(this)}};Kinetic.Global.extend(Kinetic.LabelRect,Kinetic.Shape);Kinetic.Node.addGetterSetter(Kinetic.LabelRect,"pointerDirection",n);Kinetic.Node.addGetterSetter(Kinetic.LabelRect,"pointerWidth",0);Kinetic.Node.addGetterSetter(Kinetic.LabelRect,"pointerHeight",0);Kinetic.Node.addGetterSetter(Kinetic.LabelRect,"cornerRadius",0)})();Kinetic.Node.prototype.closest=function(e){var t=this.parent;while(t!==undefined){if(t.nodeType===e)return t;t=t.parent}return!1};Kinetic.Stage.prototype.createCopy=function(){var e=[],t=this.getChildren(),n;for(n=0;n<t.length;n++)e.push(t[n].clone());return e};Kinetic.Stage.prototype.getScaledWidth=function(){return Math.ceil(this.getWidth()/this.getScale().x)};Kinetic.Stage.prototype.getScaledHeight=function(){return Math.ceil(this.getHeight()/this.getScale().y)};Kinetic.Stage.prototype.getSaveWidth=function(){return this.im.saveWidth};Kinetic.Stage.prototype.getSaveHeight=function(){return this.im.saveHeight};Kinetic.Stage.prototype.getTotalDimensions=function(){var e=(this.getSaveHeight()/2-this.im.center.y)*this.getScale().y,t=e+this.getHeight()-this.getSaveHeight()*this.getScale().y,n=(this.getSaveWidth()/2-this.im.center.x)*this.getScale().x,r=n+this.getWidth()-this.getSaveWidth()*this.getScale().x;return{min:{x:n,y:e},max:{x:r,y:t},width:this.getScaledWidth(),height:this.getScaledHeight(),visibleWidth:Math.max(this.getSaveWidth(),this.getScaledWidth()*2-this.getSaveWidth()),visibleHeight:Math.max(this.getSaveHeight(),this.getScaledHeight()*2-this.getSaveHeight())}};Kinetic.Stage.prototype.loadCopy=function(e){var t;this.removeChildren();for(t=0;t<e.length;t++)this.add(e[t]);this.draw()};Kinetic.Stage.prototype.elementType="stage";Kinetic.Image.prototype.getImageData=function(){var e=new Kinetic.Canvas(this.attrs.image.width,this.attrs.image.height),t=e.getContext();t.drawImage(this.attrs.image,0,0);try{var n=t.getImageData(0,0,e.getWidth(),e.getHeight());return n}catch(r){Kinetic.Global.warn("Unable to get imageData.")}};Kinetic.Layer.prototype._cacheddraw=(new Kinetic.Layer).draw;Kinetic.Layer.prototype.draw=function(){if(typeof im=="undefined"||typeof im.trigger=="undefined")return this._cacheddraw();var e=this._cacheddraw();return e};Kinetic.Layer.prototype.elementType="layer";Kinetic.Group.prototype.elementType="group";Kinetic.Text.prototype.rasterize=function(e){var t=this.parent,n=this;this.toImage({callback:function(r){var i=new Kinetic.Image({image:r,x:n.getPosition().x,y:n.getPosition().y});n.remove();t.add(i).draw();e.callback(i)}})};Kinetic.Global.extend(Kinetic.Container,Kinetic.Node);Kinetic.Global.extend(Kinetic.Shape,Kinetic.Node);Kinetic.Global.extend(Kinetic.Group,Kinetic.Container);Kinetic.Global.extend(Kinetic.Layer,Kinetic.Container);Kinetic.Global.extend(Kinetic.Stage,Kinetic.Container);Kinetic.Global.extend(Kinetic.Circle,Kinetic.Shape);Kinetic.Global.extend(Kinetic.Ellipse,Kinetic.Shape);Kinetic.Global.extend(Kinetic.Image,Kinetic.Shape);Kinetic.Global.extend(Kinetic.Line,Kinetic.Shape);Kinetic.Global.extend(Kinetic.Path,Kinetic.Shape);Kinetic.Global.extend(Kinetic.Polygon,Kinetic.Shape);Kinetic.Global.extend(Kinetic.Rect,Kinetic.Shape);Kinetic.Global.extend(Kinetic.RegularPolygon,Kinetic.Shape);Kinetic.Global.extend(Kinetic.Sprite,Kinetic.Shape);Kinetic.Global.extend(Kinetic.Star,Kinetic.Shape);Kinetic.Global.extend(Kinetic.Text,Kinetic.Shape);Kinetic.Global.extend(Kinetic.TextPath,Kinetic.Shape);Kinetic.Global.extend(Kinetic.Wedge,Kinetic.Shape);var ImageEditor=function(settings){"use strict";if(settings===undefined)return this;settings.pixelRatio=1;var im=this,x,round=function(e){return Math.round(e)};im.width=settings.width;im.height=settings.height;im.saveWidth=settings.saveWidth||round(im.width/2);im.saveHeight=settings.saveHeight||round(im.height/2);im.strictSize=settings.saveWidth!==undefined?!0:!1;im.stage=new Kinetic.Stage(settings);im.namespaces={};im.controlSets={};im.components={};im.settings=settings;im.filters={};im.scale=1;im.crosshair=new Image;im.uniqid=im.stage.getContainer().id;im.editorContext=$(im.stage.getContainer()).parent();im.domContext=im.editorContext.parent();im.controlContext=im.domContext.children("div.controls");im.showLoader=$.fn.dialog.showLoader;im.hideLoader=$.fn.dialog.hideLoader;im.stage.im=im;im.stage.elementType="stage";im.crosshair.src="/concrete/images/image_editor/crosshair.png";im.center={x:Math.round(im.width/2),y:Math.round(im.height/2)};im.centerOffset={x:im.center.x,y:im.center.y};var getElem=function(e){return $(e,im.domContext)},log=function(){if(settings.debug===!0&&console!==undefined){var e=arguments;e.length==1&&(e=e[0]);console.log(e)}},warn=function(){if(settings.debug===!0&&console!==undefined){var e=arguments;e.length==1&&(e=e[0]);console.warn(e)}},error=function(){if(console!==undefined){var e=arguments;e.length==1&&(e=e[0]);console.error("Image Editor Error: "+e)}};im.stage._setDraggable=im.stage.setDraggable;im.stage.setDraggable=function(e){warn("setting draggable to "+e);return im.stage._setDraggable(e)};var History=function(){var e=this;e.history=[];e.pointer=-1;e.save=function(){im.fire("beforehistorysave");e.history=e.history.slice(0,e.pointer+1);e.history.push(im.stage.createCopy());e.movePointer(1);im.fire("historysave")};e.movePointer=function(t){e.pointer+=t;e.pointer<0&&(e.pointer=0);e.pointer>=e.history.length&&(e.pointer=e.history.length-1);return e.pointer};e.render=function(){im.fire("beforehistoryrender");im.stage.loadCopy(e.history[e.pointer]);im.fire("historyrender")};e.undo=function(){im.fire("beforehistoryundo");e.movePointer(-1);e.render();im.fire("historyundo")};e.redo=function(){im.fire("beforehistoryredo");e.movePointer(1);e.render();im.fire("historyredo")}};im.history=new History;im.bindEvent=im.bind=im.on=function(e,t,n){var r=n||im.stage.getContainer();r instanceof jQuery&&(r=r[0]);ccm_event.sub(e,t,r)};im.fireEvent=im.fire=im.trigger=function(e,t,n){var r=n||im.stage.getContainer();r instanceof jQuery&&(r=r[0]);ccm_event.pub(e,t,r)};im.addElement=function(e,t){var n=new Kinetic.Layer;n.elementType=n;n.add(e);e.setOffset([e.getWidth()/2,e.getHeight()/2]);n.setOffset([-e.getWidth()/2,-e.getHeight()/2]);e.setX(im.center.x-Math.round(e.getWidth()/2));e.setY(im.center.y-Math.round(e.getHeight()/2));e.doppelganger=e.clone();t=="image"&&e.doppelganger.setImage("");e.doppelganger.doppelganger=e;e.doppelganger.drawHitFunc=e.doppelganger.attrs.drawHitFunc=function(){return!1};e.doppelganger.setFill("transparent");e.doppelganger.elementType="StokeClone";e.doppelganger.setStroke("blue");e.doppelganger._drawFunc=e.getDrawFunc();e.doppelganger.setListening(!1);e.doppelganger.setDrawFunc(function(e){if(typeof this._drawFunc=="function"){this.setStrokeWidth(1/im.scale);this.setFill("transparent");t=="image"&&(this.attrs.image="");this._drawFunc(e)}});e.elementType=t;e.on("click",function(){im.fire("ClickedElement",this)});e._drawFunc=e.getDrawFunc();e.setDrawFunc(function(e){for(var t in this.attrs){if(t=="drawFunc"||t=="drawHitFunc"||t=="strokeWidth"||t=="fill"||t=="listening")continue;this.doppelganger.attrs[t]=this.attrs[t]}var n=this.getOffset();this.doppelganger.setX(this.getX()+n.x);this.doppelganger.setY(this.getY()+n.y);this.doppelganger.setOffset(this.getOffset());this.doppelganger.setSize(this.getSize());im.foreground.draw();this._drawFunc(e)});e.on("mouseover",function(){this.hovered=!0;im.setCursor("pointer")});e.on("mouseout",function(){if(this.hovered==1){im.setCursor("");this.hovered=!1}});im.stage.add(n);im.fire("newObject",{object:e,type:t});im.foreground.moveToTop();im.stage.draw()};im.on("backgroundBuilt",function(){if(im.activeElement!==undefined&&im.activeElement.doppelganger!==undefined){im.foreground.add(im.activeElement.doppelganger);im.activeElement.doppelganger.setPosition(im.activeElement.getPosition())}});im.setActiveElement=function(e){if(im.activeElement==e)return;im.activeElement!==undefined&&im.activeElement.doppelganger!==undefined&&im.activeElement.doppelganger.remove();if(e===im.stage||e.nodeType=="Stage"){im.trigger("ChangeActiveAction","ControlSet_Position");$("div.control-sets",im.controlContext).find("h4.active").removeClass("active")}else if(e.doppelganger!==undefined){im.foreground.add(e.doppelganger);im.foreground.draw()}im.trigger("beforeChangeActiveElement",im.activeElement);im.alterCore("activeElement",e);im.trigger("changeActiveElement",e);im.stage.draw()};im.bind("ClickedElement",function(e){im.setActiveElement(e.eventData)});im.bind("stageChanged",function(e){(im.activeElement.getWidth()>im.stage.getScaledWidth()||im.activeElement.getHeight()>im.stage.getScaledHeight())&&im.setActiveElement(im.stage)});var controlBar=getElem(im.stage.getContainer()).parent().children(".bottomBar");controlBar.attr("unselectable","on").css("user-select","none").on("selectstart",!1);var zoom={};zoom.in=getElem("<div class='bottombarbutton plus'><i class='icon-plus'></i></div>");zoom.out=getElem("<div class='bottombarbutton'><i class='icon-minus'></i></div>");zoom.in.appendTo(controlBar);zoom.out.appendTo(controlBar);zoom.in.click(function(e){im.fire("zoomInClick",e)});zoom.out.click(function(e){im.fire("zoomOutClick",e)});var scale=getElem("<div></div>").addClass("scale").text("100%");im.on("scaleChange",function(e){scale.text(Math.round(im.scale*1e4)/100+"%")});scale.click(function(){im.scale=1;im.stage.setScale(im.scale);var e=im.stage.getDragBoundFunc()({x:im.stage.getX(),y:im.stage.getY()});im.stage.setX(e.x);im.stage.setY(e.y);im.fire("scaleChange");im.buildBackground();im.stage.draw()});scale.appendTo(controlBar);var minScale=0,maxScale=3e3,stepScale=5/6;im.on("zoomInClick",function(e){var t=(-im.stage.getX()+im.stage.getWidth()/2)/im.scale,n=(-im.stage.getY()+im.stage.getHeight()/2)/im.scale;im.scale/=stepScale;im.scale=Math.round(im.scale*1e3)/1e3;im.alterCore("scale",im.scale);var r=(-im.stage.getX()+im.stage.getWidth()/2)/im.scale,i=(-im.stage.getY()+im.stage.getHeight()/2)/im.scale;im.stage.setX(im.stage.getX()-(t-r)*im.scale);im.stage.setY(im.stage.getY()-(n-i)*im.scale);im.stage.setScale(im.scale);var s=im.stage.getDragBoundFunc()({x:im.stage.getX(),y:im.stage.getY()});im.stage.setX(s.x);im.stage.setY(s.y);im.fire("scaleChange");im.buildBackground();im.stage.draw()});im.on("zoomOutClick",function(e){var t=(-im.stage.getX()+im.stage.getWidth()/2)/im.scale,n=(-im.stage.getY()+im.stage.getHeight()/2)/im.scale;im.scale*=stepScale;im.scale=Math.round(im.scale*1e3)/1e3;im.alterCore("scale",im.scale);var r=(-im.stage.getX()+im.stage.getWidth()/2)/im.scale,i=(-im.stage.getY()+im.stage.getHeight()/2)/im.scale;im.stage.setX(im.stage.getX()-(t-r)*im.scale);im.stage.setY(im.stage.getY()-(n-i)*im.scale);im.stage.setScale(im.scale);var s=im.stage.getDragBoundFunc()({x:im.stage.getX(),y:im.stage.getY()});im.stage.setX(s.x);im.stage.setY(s.y);im.fire("scaleChange");im.buildBackground();im.stage.draw()});var saveSize={};saveSize.width=getElem("<span/>").addClass("saveWidth");saveSize.height=getElem("<span/>").addClass("saveHeight");saveSize.crop=getElem('<div><i class="icon-resize-full"/></div>').addClass("bottombarbutton").addClass("crop");saveSize.both=saveSize.height.add(saveSize.width).width(32).attr("contenteditable",!0);saveSize.area=getElem("<span/>").css({"float":"right"});saveSize.crop.appendTo(saveSize.area);saveSize.width.appendTo($("<div>w </div>").addClass("saveWidth").appendTo(saveSize.area));saveSize.height.appendTo($("<div>h </div>").addClass("saveHeight").appendTo(saveSize.area));saveSize.area.appendTo(controlBar);im.on("adjustedsavers",function(){saveSize.width.text(im.saveWidth);saveSize.height.text(im.saveHeight)});saveSize.crop.click(function(){im.adjustSavers()});im.strictSize?saveSize.both.attr("disabled","true"):saveSize.both.keyup(function(e){im.fire("editedSize",e)});im.bind("editedSize",function(e){im.saveWidth=parseInt(saveSize.width.text());im.saveHeight=parseInt(saveSize.height.text());isNaN(im.saveWidth)&&(im.saveWidth=0);isNaN(im.saveHeight)&&(im.saveHeight=0
);im.buildBackground()});im.bind("saveSizeChange",function(){saveSize.width.text(im.saveWidth);saveSize.height.text(im.saveHeight)});im.setCursor=function(e){$(im.stage.getContainer()).css("cursor",e)};im.save=function(){im.background.hide();im.activeElement!==undefined&&typeof im.activeElement.releaseStroke=="function"&&im.activeElement.releaseStroke();im.stage.setScale(1);im.setActiveElement(im.stage);im.fire("ChangeActiveAction");im.fire("changeActiveComponent");im.background.hide();im.foreground.hide();$(im.stage.getContainer()).hide();var e=Math.round(im.center.x-im.saveWidth/2),t=Math.round(im.center.y-im.saveHeight/2),n=im.stage.getX(),r=im.stage.getY(),i=im.stage.getWidth(),s=im.stage.getHeight();im.stage.setX(-e);im.stage.setY(-t);im.stage.setWidth(Math.max(im.stage.getWidth(),im.saveWidth));im.stage.setHeight(Math.max(im.stage.getHeight(),im.saveHeight));im.stage.draw();im.showLoader("Saving..");im.stage.toDataURL({width:im.saveWidth,height:im.saveHeight,callback:function(e){var t=$("<img/>").attr("src",e);$.fn.dialog.open({element:$(t).width(250)});im.hideLoader();im.background.show();im.foreground.show();im.stage.setX(n);im.stage.setY(r);im.stage.setWidth(i);im.stage.setHeight(s);im.stage.setScale(im.scale);im.stage.draw();$(im.stage.getContainer()).show()}})};im.adjustSavers=function(){im.foreground.autoCrop=!1;im.background.autoCrop=!1;var e,t,n=im.stage.getChildren(),r=n.length,i={min:{x:!1,y:!1},max:{x:!1,y:!1}};for(e=0;e<r;e++){if(n[e].autoCrop===!1)continue;for(t in n[e].children){var s=n[e].children[t].getPosition(),o=n[e].children[t].getSize(),u={x:s.x+o.width/2,y:s.y+o.height/2};if(i.min.x===!1){i.min.x=s.x;i.min.y=s.y;i.max.x=s.x-o.width;i.max.y=s.y+o.height}i.min.x>s.x&&(i.min.x=s.x);i.min.y>s.y&&(i.min.y=s.y);i.max.x<s.x+o.width&&(i.max.x=s.x+o.width);i.max.y<s.y+o.height&&(i.max.y=s.y+o.height)}}var a={x:(i.min.x+i.max.x)/2,y:(i.min.y+i.max.y)/2},f={x:Math.round(a.x-im.center.x),y:Math.round(a.y-im.center.y)};if(f.x!==0||f.y!==0){for(e=0;e<r;e++){if(n[e].autoCrop===!1)continue;for(t in n[e].children){n[e].children[t].attrs.x-=f.x;n[e].children[t].attrs.y-=f.y}}return im.adjustSavers()}var o={width:i.max.x-i.min.x,height:i.max.y-i.min.y};console.log(o);im.alterCore("saveWidth",Math.round(o.width));im.alterCore("saveHeight",Math.round(o.height));im.buildBackground();im.fire("adjustedsavers");im.stage.draw()};im.extend=function(e,t){this[e]=t};im.alterCore=function(e,t){var n=im,r="core",i;if(im.namespace){var r=n.namespace;n=im.realIm}im[e]=t;for(i in im.controlSets)im.controlSets[i].im.extend(e,t);for(i in im.filters)im.filters[i].im.extend(e,t);for(i in im.components)im.components[i].im.extend(e,t)};im.clone=function(e){var t=new ImageEditor,n;t.realIm=im;for(n in im)t[n]=im[n];t.namespace=e;return t};im.addControlSet=function(ns,js,elem){jQuery&&elem instanceof jQuery&&(elem=elem[0]);elem.controlSet=function(im,js){im.disable=function(){im.enabled=!1;$(elem).parent().parent().addClass("disabled")};im.enable=function(){im.enabled=!0;$(elem).parent().parent().removeClass("disabled")};this.im=im;warn("Loading ControlSet",im);try{eval(js)}catch(e){var pos=e.stack.replace(/[\S\s]+at HTMLDivElement.eval.+?<anonymous>:(\d+:\d+)[\S\s]+/,"$1").split(":");if(pos[1]&&!isNaN(parseInt(pos[1]))){var jsstack=js.split("\n"),msg="Parse error at line #"+pos[0]+" char #"+pos[1]+" within "+ns;msg+="\n"+jsstack[parseInt(pos[0])-1];msg+="\n"+(new Array(parseInt(pos[1]))).join(" ")+"^";error(msg)}else error('"'+e.message+'" in "'+im.namespace+'"')}return this};var newim=im.clone(ns),nso=elem.controlSet.call(elem,newim,js);im.controlSets[ns]=nso;return nso};im.addFilter=function(ns,js){var filter=function(im,js){this.im=im;try{eval(js)}catch(e){error(e);window.lastError=e;var pos=e.stack.replace(/[\S\s]+at HTMLDivElement.eval.+?<anonymous>:(\d+:\d+)[\S\s]+/,"$1").split(":");if(pos.length!=2){error(e.message);error(e.stack)}else{var jsstack=js.split("\n"),msg="Parse error at line #"+pos[0]+" char #"+pos[1]+" within "+ns;msg+="\n"+jsstack[parseInt(pos[0])-1];msg+="\n"+(new Array(parseInt(pos[1])||0)).join(" ")+"^";error(msg)}}return this},newim=im.clone(ns),nso=new filter(newim,js);im.filters[ns]=nso;return nso};im.addComponent=function(ns,js,elem){jQuery&&elem instanceof jQuery&&(elem=elem[0]);elem.component=function(im,js){im.disable=function(){$(this).parent().parent().addClass("disabled")};im.enable=function(){$(this).parent().parent().removeClass("disabled")};this.im=im;warn("Loading component",im);try{eval(js)}catch(e){var pos=e.stack.replace(/[\S\s]+at HTMLDivElement.eval.+?<anonymous>:(\d+:\d+)[\S\s]+/,"$1").split(":");if(pos[1]&&!isNaN(parseInt(pos[1]))){var jsstack=js.split("\n"),msg="Parse error at line #"+pos[0]+" char #"+pos[1]+" within "+ns;msg+="\n"+jsstack[parseInt(pos[0])-1];msg+="\n"+(new Array(parseInt(pos[1]))).join(" ")+"^";error(msg)}else error('"'+e.message+'" in "'+im.namespace+'"')}return this};var newim=im.clone(ns),nso=elem.component.call(elem,newim,js);im.components[ns]=nso;return nso};im.background=new Kinetic.Layer;im.foreground=new Kinetic.Layer;im.stage.add(im.background);im.stage.add(im.foreground);im.bgimage=new Image;im.saveArea=new Kinetic.Rect;im.bgimage.onload=function(){im.saveArea.setFillPatternImage(im.bgimage);im.saveArea.setFillPatternOffset([-(im.saveWidth/2),-(im.saveHeight/2)]);im.saveArea.setFillPatternScale(1/im.scale);im.saveArea.setFillPatternX(0);im.saveArea.setFillPatternY(0);im.saveArea.setFillPatternRepeat("repeat");im.background.add(im.saveArea);im.background.on("click",function(){im.setActiveElement(im.stage)})};im.bgimage.src="/concrete/images/testbg.png";im.buildBackground=function(){var e=(new Date).getTime(),t=im.stage.getTotalDimensions(),n=(t.max.x+t.visibleHeight+t.visibleWidth)*2;im.saveArea.setFillPatternOffset([-(im.saveWidth/2)*im.scale,-(im.saveHeight/2)*im.scale]);im.saveArea.setX(Math.floor(im.center.x-im.saveWidth/2));im.saveArea.setY(Math.floor(im.center.y-im.saveHeight/2));im.saveArea.setFillPatternScale(1/im.scale);im.saveArea.setWidth(im.saveWidth);im.saveArea.setHeight(im.saveHeight);im.foreground&&im.foreground.destroy();im.foreground=new Kinetic.Layer;im.stage.add(im.foreground);if(!im.coverLayer){im.coverLayer=new Kinetic.Rect;im.coverLayer.setStroke("rgba(150,150,150,.5)");im.coverLayer.setFill("transparent");im.coverLayer.setDrawHitFunc(function(){});im.coverLayer.setStrokeWidth(Math.max(t.width,t.height,500))}var r=Math.max(t.width,t.height)*2;im.coverLayer.attrs.width=im.saveArea.attrs.width+r;im.coverLayer.attrs.height=im.saveArea.attrs.height+r;im.coverLayer.attrs.x=im.saveArea.attrs.x-r/2;im.coverLayer.attrs.y=im.saveArea.attrs.y-r/2;im.coverLayer.setStrokeWidth(r);im.foreground.add(im.coverLayer);im.fire("backgroundBuilt");im.background.draw();im.foreground.draw();im.activeElement&&im.activeElement.elementType!="stage"&&im.activeElement.parent&&im.activeElement.parent.draw()};im.buildBackground();im.on("stageChanged",im.buildBackground);im.stage.setDragBoundFunc(function(e){var t=im.stage.getTotalDimensions(),n=Math.max(t.max.x,t.min.x)-1,r=Math.min(t.max.x,t.min.x)+1,i=Math.max(t.max.y,t.min.y)-1,s=Math.min(t.max.y,t.min.y)+1;e.x=Math.floor(e.x);e.y=Math.floor(e.y);e.x>n&&(e.x=n);e.x<r&&(e.x=r);e.y>i&&(e.y=i);e.y<s&&(e.y=s);e.x=Math.floor(e.x);e.y=Math.floor(e.y);return e});im.setActiveElement(im.stage);im.stage.setDraggable(!0);im.autoCrop=!0;im.on("imageLoad",function(){var e=100,t=im.stage.getWidth()-e*2,n=im.stage.getHeight()-e*2;if(im.saveWidth<t&&im.saveHeight<n)return;var r=Math.max(im.saveWidth/t,im.saveHeight/n);im.stage.setX((im.stage.getWidth()-im.stage.getWidth()*im.stage.getScale().x)/2);im.stage.setY((im.stage.getHeight()-im.stage.getHeight()*im.stage.getScale().y)/2);var i=im.stage.getDragBoundFunc()({x:im.stage.getX(),y:im.stage.getY()});im.stage.setX(i.x);im.stage.setY(i.y);im.fire("scaleChange");im.fire("stageChanged");im.buildBackground()});im.fit=function(e,t){if(t===!1)return{width:im.saveWidth,height:im.saveHeight};var n=e.height,r=e.width;if(r>im.saveWidth){n/=r/im.saveWidth;r=im.saveWidth}if(n>im.saveHeight){r/=n/im.saveHeight;n=im.saveHeight}return{width:r,height:n}};if(settings.src){im.showLoader("Loading Image..");var img=new Image;img.src=settings.src;img.onload=function(){if(!im.strictSize){im.saveWidth=img.width;im.saveHeight=img.height;im.fire("saveSizeChange");im.buildBackground()}var e={x:Math.floor(im.center.x-img.width/2),y:Math.floor(im.center.y-img.height/2)},t=new Kinetic.Image({image:img,x:Math.floor(e.x),y:Math.floor(e.y)});im.fire("imageload");im.addElement(t,"image")}}else im.fire("imageload");im.bind("imageload",function(){var e=settings.controlsets||{},t=settings.filters||{},n,r,i=0;log("Loading ControlSets");im.showLoader("Loading Control Sets..");im.fire("LoadingControlSets");for(n in e){var s="ControlSet_"+n;$.ajax(e[n].src,{dataType:"text",cache:!1,namespace:n,myns:s,beforeSend:function(){i++},success:function(t){i--;var n=im.addControlSet(this.myns,t,e[this.namespace].element);log(n);im.fire("controlSetLoad",n);0==i&&im.trigger("ControlSetsLoaded")},error:function(e,t,n){i--;0==i&&im.trigger("ControlSetsLoaded")}})}});im.bind("ControlSetsLoaded",function(){im.fire("LoadingComponents");im.showLoader("Loading Components..");var e=settings.components||{},t,n=0;log("Loading Components");for(t in e){var r="Component_"+t;$.ajax(e[t].src,{dataType:"text",cache:!1,namespace:t,myns:r,beforeSend:function(){n++},success:function(t){n--;var r=im.addComponent(this.myns,t,e[this.namespace].element);log(r);im.fire("ComponentLoad",r);0==n&&im.trigger("ComponentsLoaded")},error:function(e,t,r){n--;0==n&&im.trigger("ComponentsLoaded")}})}});im.bind("ComponentsLoaded",function(){log("Loading Filters");im.showLoader("Loading Filters..");var e=settings.filters||{},t,n,r,i=0;im.fire("LoadingFilters");for(t in e){var s="Filter_"+t,o=e[t].name;n||(n=s);i++;$.ajax(e[t].src,{dataType:"text",cache:!1,namespace:t,myns:s,name:o,success:function(e){var t=im.addFilter(this.myns,e);t.name=this.name;im.fire("filterLoad",t);i--;0==i&&im.trigger("FiltersLoaded")},error:function(e,t,n){i--;0==i&&im.trigger("FiltersLoaded")}})}});im.bind("ChangeActiveAction",function(e){var t=e.eventData;if(t===im.activeControlSet)return;for(var n in im.controlSets){getElem(im.controlSets[n]);n!==t&&getElem(im.controlSets[n]).slideUp()}im.activeControlSet=t;im.alterCore("activeControlSet",t);if(!t){$("div.control-sets",im.controlContext).find("h4.active").removeClass("active");return}var r=$(im.controlSets[t]),i=r.show().height();if(r.length==0)return;r.hide().height(i).slideDown(function(){$(this).height("")})});im.bind("ChangeActiveComponent",function(e){var t=e.eventData;if(t===im.activeComponent)return;for(var n in im.components)n!==t&&getElem(im.components[n]).slideUp();im.activeComponent=t;im.alterCore("activeComponent",t);if(!t)return;var r=$(im.components[t]),i=r.show().height();if(r.length==0)return;r.hide().height(i).slideDown(function(){$(this).height("")})});im.bind("ChangeNavTab",function(e){log("changenavtab",e);im.trigger("ChangeActiveAction",e.eventData);im.trigger("ChangeActiveComponent",e.eventData);var t=getElem("div.editorcontrols");switch(e.eventData){case"add":t.children("div.control-sets").hide();t.children("div.components").show();break;case"edit":t.children("div.components").hide();t.children("div.control-sets").show()}});im.bind("FiltersLoaded",function(){im.hideLoader()});im.slideOut=$("<div/>").addClass("slideOut").css({width:0,"float":"right",height:"100%","overflow-x":"hidden",right:im.controlContext.width()-1,position:"absolute",background:"white","box-shadow":"black -20px 0 20px -25px"});im.slideOutContents=$("<div/>").appendTo(im.slideOut).width(300);im.showSlideOut=function(e,t){im.hideSlideOut(function(){im.slideOut.empty();im.slideOutContents=e.width(300);im.slideOut.append(im.slideOutContents);im.slideOut.addClass("active").addClass("sliding");im.slideOut.stop(1).slideOut(300,function(){im.slideOut.removeClass("sliding");typeof t=="function"&&t()})})};im.hideSlideOut=function(e){im.slideOut.addClass("sliding");im.slideOut.slideIn(300,function(){im.slideOut.css("border-right","0");im.slideOut.removeClass("active").removeClass("sliding");typeof e=="function"&&e()})};im.controlContext.after(im.slideOut);im.setActiveElement(im.stage);window.c5_image_editor=im;window.im=im;return im};$.fn.ImageEditor=function(e){e===undefined&&(e={});e.imageload=$.fn.dialog.hideLoader;var t=$(this);e.container=t[0];if(t.height()==0){setTimeout(function(){t.ImageEditor(e)},50);return}t.closest(".ui-dialog").find(".ui-resizable-handle").hide();t.height("-=30");$("div.editorcontrols").height(t.height()-130);t.width("-=330").parent().width("-=330").children("div.bottomBar").width("-=330");e.width===undefined&&(e.width=t.width());e.height===undefined&&(e.height=t.height());$.fn.dialog.showLoader();var n=new ImageEditor(e),r=n.domContext;n.on("ChangeActiveAction",function(e){e.eventData||$("h4.active",r).removeClass("active")});n.on("ChangeActiveComponent",function(e){e.eventData||$("h4.active",r).removeClass("active")});$("div.controls > div.controlscontainer",r).children("div.save").children("button.save").click(function(){n.save()}).end().children("button.cancel").click(function(){confirm("Are you certain?")&&$.fn.dialog.closeTop()});$("div.controls > div.controlscontainer",r).children("ul.nav").children().click(function(){if($(this).hasClass("active"))return!1;$("div.controls > div.controlscontainer",r).children("ul.nav").children().removeClass("active");$(this).addClass("active");n.trigger("ChangeNavTab",$(this).text().toLowerCase());return!1});$("div.controlset",r).find("div.control").children("div.contents").slideUp(0).end().end().find("h4").click(function(){if($(this).parent().hasClass("disabled"))return;$(this).addClass("active");$("div.controlset",r).find("h4").not($(this)).removeClass("active");var e=$(this).parent().attr("data-namespace");n.trigger("ChangeActiveAction","ControlSet_"+e)});$("div.component",r).find("div.control").children("div.contents").slideUp(0).hide().end().end().find("h4").click(function(){if($(this).hasClass("active"))return!1;$(this).addClass("active");$("div.component",r).children("h4").not($(this)).removeClass("active");var e=$(this).parent().attr("data-namespace");n.trigger("ChangeActiveComponent","Component_"+e)});$("div.components").hide();n.bind("imageload",$.fn.dialog.hideLoader);return n};$.fn.slideOut=function(e,t){var n=$(this),r=n.width(),i=300;n.css("overflow-y","auto");if(r==i){n.animate({width:i},0,t);return this}n.width(r).animate({width:i},e||300,t||function(){});return this};$.fn.slideIn=function(e,t){var n=$(this);n.css("overflow-y","hidden");if(n.width()===0){n.animate({width:0},0,t);return this}n.animate({width:0},e||300,t||function(){});return this};ImageEditor.prototype=ImageEditor.fn={filter:{grayscale:Kinetic.Filters.Grayscale,sepia:function(e){var t,n=e.data;for(t=0;t<n.length;t+=4){n[t]=n[t]*.393+n[t+1]*.769+n[t+2]*.189;n[t+1]=n[t]*.349+n[t+1]*.686+n[t+2]*.168;n[t+2]=n[t]*.272+n[t+1]*.534+n[t+2]*.131}},brightness:function(e,t){var n=t.level,r=e.data;for(var i=0;i<r.length;i+=4){r[i]+=n;r[i+1]+=n;r[i+2]+=n}},invert:function(e,t){var n=e.data;for(var r=0;r<n.length;r+=4){n[r]=255-n[r];n[r+1]=255-n[r+1];n[r+2]=255-n[r+2]}},restore:function(e,t){var n=t.level,r=e.data,i=t.imageData.data;for(var s=0;s<r.length;s+=4){r[s]=i[s];r[s+1]=i[s+1];r[s+2]=i[s+2]}}}};