/*
 * KineticJS JavaScript Framework v4.7.2
 * http://www.kineticjs.com/
 * Copyright 2013, Eric Rowell
 * Licensed under the MIT or GPL Version 2 licenses.
 * Date: 2013-09-29
 *
 * Copyright (C) 2011 - 2013 by Eric Rowell
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *//**
 * @namespace Kinetic
 */var Kinetic={};(function(){Kinetic={version:"4.7.2",stages:[],idCounter:0,ids:{},names:{},shapes:{},listenClickTap:!1,inDblClickWindow:!1,enableTrace:!1,traceArrMax:100,dblClickWindow:400,pixelRatio:undefined,UA:function(){var e=navigator.userAgent.toLowerCase(),t=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];return{browser:t[1]||"",version:t[2]||"0"}}(),Filters:{},Node:function(e){this._init(e)},Shape:function(e){this.__init(e)},Container:function(e){this.__init(e)},Stage:function(e){this.___init(e)},Layer:function(e){this.___init(e)},Group:function(e){this.___init(e)},isDragging:function(){var e=Kinetic.DD;return e?e.isDragging:!1},isDragReady:function(){var e=Kinetic.DD;return e?!!e.node:!1},_addId:function(e,t){t!==undefined&&(this.ids[t]=e)},_removeId:function(e){e!==undefined&&delete this.ids[e]},_addName:function(e,t){if(t!==undefined){this.names[t]===undefined&&(this.names[t]=[]);this.names[t].push(e)}},_removeName:function(e,t){if(e!==undefined){var n=this.names[e];if(n!==undefined){for(var r=0;r<n.length;r++){var i=n[r];i._id===t&&n.splice(r,1)}n.length===0&&delete this.names[e]}}}}})();(function(e,t){typeof exports=="object"?module.exports=t():typeof define=="function"&&define.amd?define(t):e.returnExports=t()})(this,function(){return Kinetic});(function(){Kinetic.Collection=function(){var e=[].slice.call(arguments),t=e.length,n=0;this.length=t;for(;n<t;n++)this[n]=e[n];return this};Kinetic.Collection.prototype=[];Kinetic.Collection.prototype.each=function(e){for(var t=0;t<this.length;t++)e(this[t],t)};Kinetic.Collection.prototype.toArray=function(){var e=[],t=this.length,n;for(n=0;n<t;n++)e.push(this[n]);return e};Kinetic.Collection.toCollection=function(e){var t=new Kinetic.Collection,n=e.length,r;for(r=0;r<n;r++)t.push(e[r]);return t};Kinetic.Collection.mapMethods=function(e){var t=e.length,n;for(n=0;n<t;n++)(function(t){var n=e[t];Kinetic.Collection.prototype[n]=function(){var e=this.length,t;args=[].slice.call(arguments);for(t=0;t<e;t++)this[t][n].apply(this[t],args)}})(n)};Kinetic.Transform=function(){this.m=[1,0,0,1,0,0]};Kinetic.Transform.prototype={translate:function(e,t){this.m[4]+=this.m[0]*e+this.m[2]*t;this.m[5]+=this.m[1]*e+this.m[3]*t},scale:function(e,t){this.m[0]*=e;this.m[1]*=e;this.m[2]*=t;this.m[3]*=t},rotate:function(e){var t=Math.cos(e),n=Math.sin(e),r=this.m[0]*t+this.m[2]*n,i=this.m[1]*t+this.m[3]*n,s=this.m[0]*-n+this.m[2]*t,o=this.m[1]*-n+this.m[3]*t;this.m[0]=r;this.m[1]=i;this.m[2]=s;this.m[3]=o},getTranslation:function(){return{x:this.m[4],y:this.m[5]}},skew:function(e,t){var n=this.m[0]+this.m[2]*t,r=this.m[1]+this.m[3]*t,i=this.m[2]+this.m[0]*e,s=this.m[3]+this.m[1]*e;this.m[0]=n;this.m[1]=r;this.m[2]=i;this.m[3]=s},multiply:function(e){var t=this.m[0]*e.m[0]+this.m[2]*e.m[1],n=this.m[1]*e.m[0]+this.m[3]*e.m[1],r=this.m[0]*e.m[2]+this.m[2]*e.m[3],i=this.m[1]*e.m[2]+this.m[3]*e.m[3],s=this.m[0]*e.m[4]+this.m[2]*e.m[5]+this.m[4],o=this.m[1]*e.m[4]+this.m[3]*e.m[5]+this.m[5];this.m[0]=t;this.m[1]=n;this.m[2]=r;this.m[3]=i;this.m[4]=s;this.m[5]=o},invert:function(){var e=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),t=this.m[3]*e,n=-this.m[1]*e,r=-this.m[2]*e,i=this.m[0]*e,s=e*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),o=e*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=t;this.m[1]=n;this.m[2]=r;this.m[3]=i;this.m[4]=s;this.m[5]=o},getMatrix:function(){return this.m},setAbsolutePosition:function(e,t){var n=this.m[0],r=this.m[1],i=this.m[2],s=this.m[3],o=this.m[4],u=this.m[5],a=(n*(t-u)-r*(e-o))/(n*s-r*i),f=(e-o-i*a)/n;this.translate(f,a)}};var e="canvas",t="2d",n="[object Array]",r="[object Number]",i="[object String]",s=Math.PI/180,o=180/Math.PI,u="#",a="",f="0",l="Kinetic warning: ",c="Kinetic error: ",h="rgb(",p={aqua:[0,255,255],lime:[0,255,0],silver:[192,192,192],black:[0,0,0],maroon:[128,0,0],teal:[0,128,128],blue:[0,0,255],navy:[0,0,128],white:[255,255,255],fuchsia:[255,0,255],olive:[128,128,0],yellow:[255,255,0],orange:[255,165,0],gray:[128,128,128],purple:[128,0,128],green:[0,128,0],red:[255,0,0],pink:[255,192,203],cyan:[0,255,255],transparent:[255,255,255,0]},d=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/;Kinetic.Util={_isElement:function(e){return!!e&&e.nodeType==1},_isFunction:function(e){return!!(e&&e.constructor&&e.call&&e.apply)},_isObject:function(e){return!!e&&e.constructor==Object},_isArray:function(e){return Object.prototype.toString.call(e)==n},_isNumber:function(e){return Object.prototype.toString.call(e)==r},_isString:function(e){return Object.prototype.toString.call(e)==i},_hasMethods:function(e){var t=[],n;for(n in e)this._isFunction(e[n])&&t.push(n);return t.length>0},_isInDocument:function(e){while(e=e.parentNode)if(e==document)return!0;return!1},_simplifyArray:function(e){var t=[],n=e.length,r=Kinetic.Util,i,s;for(i=0;i<n;i++){s=e[i];r._isNumber(s)?s=Math.round(s*1e3)/1e3:r._isString(s)||(s=s.toString());t.push(s)}return t},_getXY:function(e){if(this._isNumber(e))return{x:e,y:e};if(this._isArray(e)){if(e.length===1){var t=e[0];if(this._isNumber(t))return{x:t,y:t};if(this._isArray(t))return{x:t[0],y:t[1]};if(this._isObject(t))return t}else if(e.length>=2)return{x:e[0],y:e[1]}}else if(this._isObject(e))return e;return null},_getSize:function(e){if(this._isNumber(e))return{width:e,height:e};if(this._isArray(e))if(e.length===1){var t=e[0];if(this._isNumber(t))return{width:t,height:t};if(this._isArray(t)){if(t.length>=4)return{width:t[2],height:t[3]};if(t.length>=2)return{width:t[0],height:t[1]}}else if(this._isObject(t))return t}else{if(e.length>=4)return{width:e[2],height:e[3]};if(e.length>=2)return{width:e[0],height:e[1]}}else if(this._isObject(e))return e;return null},_getPoints:function(e){var t=[],n,r;if(e===undefined)return[];r=e.length;if(this._isArray(e[0])){for(n=0;n<r;n++)t.push({x:e[n][0],y:e[n][1]});return t}if(this._isObject(e[0]))return e;for(n=0;n<r;n+=2)t.push({x:e[n],y:e[n+1]});return t},_getImage:function(n,r){var i,s,o,u;if(!n)r(null);else if(this._isElement(n))r(n);else if(this._isString(n)){i=new Image;i.onload=function(){r(i)};i.src=n}else if(n.data){s=document.createElement(e);s.width=n.width;s.height=n.height;_context=s.getContext(t);_context.putImageData(n,0,0);u=s.toDataURL();i=new Image;i.onload=function(){r(i)};i.src=u}else r(null)},_rgbToHex:function(e,t,n){return((1<<24)+(e<<16)+(t<<8)+n).toString(16).slice(1)},_hexToRgb:function(e){e=e.replace(u,a);var t=parseInt(e,16);return{r:t>>16&255,g:t>>8&255,b:t&255}},getRandomColor:function(){var e=(Math.random()*16777215<<0).toString(16);while(e.length<6)e=f+e;return u+e},get:function(e,t){return e===undefined?t:e},getRGB:function(e){var t;if(e in p){t=p[e];return{r:t[0],g:t[1],b:t[2]}}if(e[0]===u)return this._hexToRgb(e.substring(1));if(e.substr(0,4)===h){t=d.exec(e.replace(/ /g,""));return{r:parseInt(t[1],10),g:parseInt(t[2],10),b:parseInt(t[3],10)}}return{r:0,g:0,b:0}},_merge:function(e,t){var n=this._clone(t);for(var r in e)this._isObject(e[r])?n[r]=this._merge(e[r],n[r]):n[r]=e[r];return n},_clone:function(e){var t={};for(var n in e)this._isObject(e[n])?t[n]=this._clone(e[n]):t[n]=e[n];return t},_degToRad:function(e){return e*s},_radToDeg:function(e){return e*o},_capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},error:function(e){throw new Error(c+e)},warn:function(e){window.console&&console.warn&&console.warn(l+e)},extend:function(e,t){for(var n in t.prototype)n in e.prototype||(e.prototype[n]=t.prototype[n])},addMethods:function(e,t){var n;for(n in t)e.prototype[n]=t[n]},_getControlPoints:function(e,t,n,r){var i=e.x,s=e.y,o=t.x,u=t.y,a=n.x,f=n.y,l=Math.sqrt(Math.pow(o-i,2)+Math.pow(u-s,2)),c=Math.sqrt(Math.pow(a-o,2)+Math.pow(f-u,2)),h=r*l/(l+c),p=r*c/(l+c),d=o-h*(a-i),v=u-h*(f-s),m=o+p*(a-i),g=u+p*(f-s);return[{x:d,y:v},{x:m,y:g}]},_expandPoints:function(e,t){var n=e.length,r=[],i,s;for(i=1;i<n-1;i++){s=Kinetic.Util._getControlPoints(e[i-1],e[i],e[i+1],t);r.push(s[0]);r.push(e[i]);r.push(s[1])}return r},_removeLastLetter:function(e){return e.substring(0,e.length-1)}}})();(function(){var e=document.createElement("canvas"),t=e.getContext("2d"),n=window.devicePixelRatio||1,r=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,i=n/r;Kinetic.Canvas=function(e){this.init(e)};Kinetic.Canvas.prototype={init:function(e){e=e||{};var t=e.pixelRatio||Kinetic.pixelRatio||i;this.pixelRatio=t;this._canvas=document.createElement("canvas");this._canvas.style.padding=0;this._canvas.style.margin=0;this._canvas.style.border=0;this._canvas.style.background="transparent";this._canvas.style.position="absolute";this._canvas.style.top=0;this._canvas.style.left=0},getContext:function(){return this.context},getPixelRatio:function(){return this.pixelRatio},setPixelRatio:function(e){this.pixelRatio=e;this.setSize(this.getWidth(),this.getHeight())},setWidth:function(e){this.width=this._canvas.width=e*this.pixelRatio;this._canvas.style.width=e+"px"},setHeight:function(e){this.height=this._canvas.height=e*this.pixelRatio;this._canvas.style.height=e+"px"},getWidth:function(){return this.width},getHeight:function(){return this.height},setSize:function(e,t){this.setWidth(e);this.setHeight(t)},toDataURL:function(e,t){try{return this._canvas.toDataURL(e,t)}catch(n){try{return this._canvas.toDataURL()}catch(r){Kinetic.Util.warn("Unable to get data URL. "+r.message);return""}}}};Kinetic.SceneCanvas=function(e){e=e||{};var t=e.width||0,n=e.height||0;Kinetic.Canvas.call(this,e);this.context=new Kinetic.SceneContext(this);this.setSize(t,n)};Kinetic.SceneCanvas.prototype={setWidth:function(e){var t=this.pixelRatio,n=this.getContext()._context;Kinetic.Canvas.prototype.setWidth.call(this,e);n.scale(t,t)},setHeight:function(e){var t=this.pixelRatio,n=this.getContext()._context;Kinetic.Canvas.prototype.setHeight.call(this,e);n.scale(t,t)}};Kinetic.Util.extend(Kinetic.SceneCanvas,Kinetic.Canvas);Kinetic.HitCanvas=function(e){e=e||{};var t=e.width||0,n=e.height||0;Kinetic.Canvas.call(this,e);this.context=new Kinetic.HitContext(this);this.setSize(t,n)};Kinetic.Util.extend(Kinetic.HitCanvas,Kinetic.Canvas)})();(function(){var e=",",t="(",n=")",r="([",i="])",s=";",o="()",u="",a="=",f="set",l=["arc","arcTo","beginPath","bezierCurveTo","clearRect","clip","closePath","createLinearGradient","createPattern","createRadialGradient","drawImage","fill","fillText","getImageData","lineTo","moveTo","putImageData","quadraticCurveTo","rect","restore","rotate","save","scale","setLineDash","setTransform","stroke","strokeText","transform","translate"];Kinetic.Context=function(e){this.init(e)};Kinetic.Context.prototype={init:function(e){this.canvas=e;this._context=e._canvas.getContext("2d");if(Kinetic.enableTrace){this.traceArr=[];this._enableTrace()}},fillShape:function(e){e.getFillEnabled()&&this._fill(e)},strokeShape:function(e){e.getStrokeEnabled()&&this._stroke(e)},fillStrokeShape:function(e){var t=e.getFillEnabled();t&&this._fill(e);e.getStrokeEnabled()&&this._stroke(e)},getTrace:function(u){var f=this.traceArr,l=f.length,c="",h,p,d,v;for(h=0;h<l;h++){p=f[h];d=p.method;if(d){v=p.args;c+=d;u?c+=o:Kinetic.Util._isArray(v[0])?c+=r+v.join(e)+i:c+=t+v.join(e)+n}else{c+=p.property;u||(c+=a+p.val)}c+=s}return c},clearTrace:function(){this.traceArr=[]},_trace:function(e){var t=this.traceArr,n;t.push(e);n=t.length;n>=Kinetic.traceArrMax&&t.shift()},reset:function(){var e=this.getCanvas().getPixelRatio();this.setTransform(1*e,0,0,1*e,0,0)},getCanvas:function(){return this.canvas},clear:function(){var e=[].slice.call(arguments),t=this.getCanvas(),n,r;if(e.length){n=Kinetic.Util._getXY(e);r=Kinetic.Util._getSize(e);this.clearRect(n.x||0,n.y||0,r.width,r.height)}else this.clearRect(0,0,t.getWidth(),t.getHeight())},_applyLineCap:function(e){var t=e.getLineCap();t&&this.setAttr("lineCap",t)},_applyOpacity:function(e){var t=e.getAbsoluteOpacity();t!==1&&this.setAttr("globalAlpha",t)},_applyLineJoin:function(e){var t=e.getLineJoin();t&&this.setAttr("lineJoin",t)},_applyAncestorTransforms:function(e){var t=e.getAbsoluteTransform().getMatrix();this.transform(t[0],t[1],t[2],t[3],t[4],t[5])},_clip:function(e){var t=e.getClipX()||0,n=e.getClipY()||0,r=e.getClipWidth(),i=e.getClipHeight();this.save();this._applyAncestorTransforms(e);this.beginPath();this.rect(t,n,r,i);this.clip();this.reset();e._drawChildren(this.getCanvas());this.restore()},setAttr:function(e,t){this._context[e]=t},arc:function(){var e=arguments;this._context.arc(e[0],e[1],e[2],e[3],e[4],e[5])},beginPath:function(){this._context.beginPath()},bezierCurveTo:function(){var e=arguments;this._context.bezierCurveTo(e[0],e[1],e[2],e[3],e[4],e[5])},clearRect:function(){var e=arguments;this._context.clearRect(e[0],e[1],e[2],e[3])},clip:function(){this._context.clip()},closePath:function(){this._context.closePath()},createLinearGradient:function(){var e=arguments;return this._context.createLinearGradient(e[0],e[1],e[2],e[3])},createPattern:function(){var e=arguments;return this._context.createPattern(e[0],e[1])},createRadialGradient:function(){var e=arguments;return this._context.createRadialGradient(e[0],e[1],e[2],e[3],e[4],e[5])},drawImage:function(){var e=arguments,t=this._context;e.length===3?t.drawImage(e[0],e[1],e[2]):e.length===5?t.drawImage(e[0],e[1],e[2],e[3],e[4]):e.length===9&&t.drawImage(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])},fill:function(){this._context.fill()},fillText:function(){var e=arguments;this._context.fillText(e[0],e[1],e[2])},getImageData:function(){var e=arguments;return this._context.getImageData(e[0],e[1],e[2],e[3])},lineTo:function(){var e=arguments;this._context.lineTo(e[0],e[1])},moveTo:function(){var e=arguments;this._context.moveTo(e[0],e[1])},rect:function(){var e=arguments;this._context.rect(e[0],e[1],e[2],e[3])},putImageData:function(){var e=arguments;this._context.putImageData(e[0],e[1],e[2])},quadraticCurveTo:function(){var e=arguments;this._context.quadraticCurveTo(e[0],e[1],e[2],e[3])},restore:function(){this._context.restore()},rotate:function(){var e=arguments;this._context.rotate(e[0])},save:function(){this._context.save()},scale:function(){var e=arguments;this._context.scale(e[0],e[1])},setLineDash:function(){var e=arguments,t=this._context;this._context.setLineDash?t.setLineDash(e[0]):"mozDash"in t?t.mozDash=e[0]:"webkitLineDash"in t&&(t.webkitLineDash=e[0])},setTransform:function(){var e=arguments;this._context.setTransform(e[0],e[1],e[2],e[3],e[4],e[5])},stroke:function(){this._context.stroke()},strokeText:function(){var e=arguments;this._context.strokeText(e[0],e[1],e[2])},transform:function(){var e=arguments;this._context.transform(e[0],e[1],e[2],e[3],e[4],e[5])},translate:function(){var e=arguments;this._context.translate(e[0],e[1])},_enableTrace:function(){var e=this,t=l.length,n=Kinetic.Util._simplifyArray,r=this.setAttr,i,s;for(i=0;i<t;i++)(function(t){var r=e[t],i;e[t]=function(){s=n(Array.prototype.slice.call(arguments,0));i=r.apply(e,arguments);e._trace({method:t,args:s});return i}})(l[i]);e.setAttr=function(){r.apply(e,arguments);e._trace({property:arguments[0],val:arguments[1]})}}};Kinetic.SceneContext=function(e){Kinetic.Context.call(this,e)};Kinetic.SceneContext.prototype={_fillColor:function(e){var t=e.getFill();this.setAttr("fillStyle",t);e._fillFunc(this)},_fillPattern:function(e){var t=e.getFillPatternImage(),n=e.getFillPatternX(),r=e.getFillPatternY(),i=e.getFillPatternScale(),s=e.getFillPatternRotation(),o=e.getFillPatternOffset(),u=e.getFillPatternRepeat();(n||r)&&this.translate(n||0,r||0);s&&this.rotate(s);i&&this.scale(i.x,i.y);o&&this.translate(-1*o.x,-1*o.y);this.setAttr("fillStyle",this.createPattern(t,u||"repeat"));this.fill()},_fillLinearGradient:function(e){var t=e.getFillLinearGradientStartPoint(),n=e.getFillLinearGradientEndPoint(),r=e.getFillLinearGradientColorStops(),i=this.createLinearGradient(t.x,t.y,n.x,n.y);if(r){for(var s=0;s<r.length;s+=2)i.addColorStop(r[s],r[s+1]);this.setAttr("fillStyle",i);this.fill()}},_fillRadialGradient:function(e){var t=e.getFillRadialGradientStartPoint(),n=e.getFillRadialGradientEndPoint(),r=e.getFillRadialGradientStartRadius(),i=e.getFillRadialGradientEndRadius(),s=e.getFillRadialGradientColorStops(),o=this.createRadialGradient(t.x,t.y,r,n.x,n.y,i);for(var u=0;u<s.length;u+=2)o.addColorStop(s[u],s[u+1]);this.setAttr("fillStyle",o);this.fill()},_fill:function(e){var t=e.getFill(),n=e.getFillPatternImage(),r=e.getFillLinearGradientColorStops(),i=e.getFillRadialGradientColorStops(),s=e.getFillPriority();t&&s==="color"?this._fillColor(e):n&&s==="pattern"?this._fillPattern(e):r&&s==="linear-gradient"?this._fillLinearGradient(e):i&&s==="radial-gradient"?this._fillRadialGradient(e):t?this._fillColor(e):n?this._fillPattern(e):r?this._fillLinearGradient(e):i&&this._fillRadialGradient(e)},_stroke:function(e){var t=e.getStroke(),n=e.getStrokeWidth(),r=e.getDashArray(),i=e.getStrokeScaleEnabled();if(e.hasStroke()){if(!i){this.save();this.setTransform(1,0,0,1,0,0)}this._applyLineCap(e);r&&e.getDashArrayEnabled()&&this.setLineDash(r);this.setAttr("lineWidth",n||2);this.setAttr("strokeStyle",t||"black");e._strokeFunc(this);i||this.restore()}},_applyShadow:function(e){var t=Kinetic.Util,n=e.getAbsoluteOpacity(),r=t.get(e.getShadowColor(),"black"),i=t.get(e.getShadowBlur(),5),s=t.get(e.getShadowOpacity(),0),o=t.get(e.getShadowOffset(),{x:0,y:0});s&&this.setAttr("globalAlpha",s*n);this.setAttr("shadowColor",r);this.setAttr("shadowBlur",i);this.setAttr("shadowOffsetX",o.x);this.setAttr("shadowOffsetY",o.y)}};Kinetic.Util.extend(Kinetic.SceneContext,Kinetic.Context);Kinetic.HitContext=function(e){Kinetic.Context.call(this,e)};Kinetic.HitContext.prototype={_fill:function(e){this.save();this.setAttr("fillStyle",e.colorKey);e._fillFuncHit(this);this.restore()},_stroke:function(e){var t=e.getStroke(),n=e.getStrokeWidth();if(t||n){this._applyLineCap(e);this.setAttr("lineWidth",n||2);this.setAttr("strokeStyle",e.colorKey);e._strokeFuncHit(this)}}};Kinetic.Util.extend(Kinetic.HitContext,Kinetic.Context)})();(function(){var e="absoluteOpacity",t="absoluteTransform",n="add",r="b",i="before",s="black",o="Change",u="children",a="Deg",f=".",l="",c="g",h="get",p="#",d="id",v="kinetic",m="listening",g="mouseenter",y="mouseleave",b="name",w="off",E="on",S="_get",x="r",T="RGB",N="set",C="Shape",k=" ",L="Stage",A="transform",O="B",M="G",_="Height",D="R",P="Width",H="X",B="Y",j="visible",F="x",I="y";Kinetic.Factory={addGetterSetter:function(e,t,n){this.addGetter(e,t,n);this.addSetter(e,t)},addPointGetterSetter:function(e,t,n){this.addPointGetter(e,t,n);this.addPointSetter(e,t);this.addGetter(e,t+H,n);this.addGetter(e,t+B,n);this.addSetter(e,t+H);this.addSetter(e,t+B)},addBoxGetterSetter:function(e,t,n){this.addBoxGetter(e,t,n);this.addBoxSetter(e,t);this.addGetter(e,t+H,n);this.addGetter(e,t+B,n);this.addGetter(e,t+P,n);this.addGetter(e,t+_,n);this.addSetter(e,t+H);this.addSetter(e,t+B);this.addSetter(e,t+P);this.addSetter(e,t+_)},addPointsGetterSetter:function(e,t){this.addPointsGetter(e,t);this.addPointsSetter(e,t);this.addPointAdder(e,t)},addRotationGetterSetter:function(e,t,n){this.addRotationGetter(e,t,n);this.addRotationSetter(e,t)},addColorGetterSetter:function(e,t){this.addGetter(e,t);this.addSetter(e,t);this.addColorRGBGetter(e,t);this.addColorComponentGetter(e,t,x);this.addColorComponentGetter(e,t,c);this.addColorComponentGetter(e,t,r);this.addColorRGBSetter(e,t);this.addColorComponentSetter(e,t,x);this.addColorComponentSetter(e,t,c);this.addColorComponentSetter(e,t,r)},addColorRGBGetter:function(e,t){var n=h+Kinetic.Util._capitalize(t)+T;e.prototype[n]=function(){return Kinetic.Util.getRGB(this.attrs[t])}},addColorComponentGetter:function(e,t,n){var r=h+Kinetic.Util._capitalize(t),i=r+Kinetic.Util._capitalize(n);e.prototype[i]=function(){return this[r+T]()[n]}},addPointsGetter:function(e,t){var n=this,r=h+Kinetic.Util._capitalize(t);e.prototype[r]=function(){var e=this.attrs[t];return e===undefined?[]:e}},addGetter:function(e,t,n){var r=this,i=h+Kinetic.Util._capitalize(t);e.prototype[i]=function(){var e=this.attrs[t];return e===undefined?n:e}},addPointGetter:function(e,t){var n=this,r=h+Kinetic.Util._capitalize(t);e.prototype[r]=function(){var e=this;return{x:e[r+H](),y:e[r+B]()}}},addBoxGetter:function(e,t){var n=this,r=h+Kinetic.Util._capitalize(t);e.prototype[r]=function(){var e=this;return{x:e[r+H](),y:e[r+B](),width:e[r+P](),height:e[r+_]()}}},addRotationGetter:function(e,t,n){var r=this,i=h+Kinetic.Util._capitalize(t);e.prototype[i]=function(){var e=this.attrs[t];e===undefined&&(e=n);return e};e.prototype[i+a]=function(){var e=this.attrs[t];e===undefined&&(e=n);return Kinetic.Util._radToDeg(e)}},addColorRGBSetter:function(e,t){var n=N+Kinetic.Util._capitalize(t)+T;e.prototype[n]=function(e){var n=e&&e.r!==undefined?e.r|0:this.getAttr(t+D),r=e&&e.g!==undefined?e.g|0:this.getAttr(t+M),i=e&&e.b!==undefined?e.b|0:this.getAttr(t+O);this._setAttr(t,p+Kinetic.Util._rgbToHex(n,r,i))}},addColorComponentSetter:function(e,t,n){var r=N+Kinetic.Util._capitalize(t),i=r+Kinetic.Util._capitalize(n);e.prototype[i]=function(e){var t={};t[n]=e;this[r+T](t)}},addPointsSetter:function(e,t){var n=N+Kinetic.Util._capitalize(t);e.prototype[n]=function(e){var t=Kinetic.Util._getPoints(e);this._setAttr("points",t)}},addSetter:function(e,t){var n=N+Kinetic.Util._capitalize(t);e.prototype[n]=function(e){this._setAttr(t,e)}},addPointSetter:function(e,t){var n=this,r=N+Kinetic.Util._capitalize(t);e.prototype[r]=function(){var e=Kinetic.Util._getXY([].slice.call(arguments)),n=this.attrs[t],i=0,s=0;if(e){i=e.x;s=e.y;this._fireBeforeChangeEvent(t,n,e);i!==undefined&&this[r+H](i);s!==undefined&&this[r+B](s);this._fireChangeEvent(t,n,e)}}},addBoxSetter:function(e,t){var n=this,r=N+Kinetic.Util._capitalize(t);e.prototype[r]=function(){var e=[].slice.call(arguments),n=Kinetic.Util._getXY(e),i=Kinetic.Util._getSize(e),s=Kinetic.Util._merge(n,i),o=this.attrs[t],u,a,f,l;if(s){u=s.x;a=s.y;f=s.width;l=s.height;this._fireBeforeChangeEvent(t,o,s);u!==undefined&&this[r+H](u);a!==undefined&&this[r+B](a);f!==undefined&&this[r+P](f);l!==undefined&&this[r+_](l);this._fireChangeEvent(t,o,s)}}},addRotationSetter:function(e,t){var n=this,r=N+Kinetic.Util._capitalize(t);e.prototype[r]=function(e){this._setAttr(t,e)};e.prototype[r+a]=function(e){this._setAttr(t,Kinetic.Util._degToRad(e))}},addPointAdder:function(e,t){var r=this,i=n+Kinetic.Util._removeLastLetter(Kinetic.Util._capitalize(t));e.prototype[i]=function(){var e=Kinetic.Util._getXY([].slice.call(arguments)),n=this.attrs[t];if(e){this._fireBeforeChangeEvent(t,n,e);this.attrs[t].push(e);this._fireChangeEvent(t,n,e)}}}}})();(function(){var e="absoluteOpacity",t="absoluteTransform",n="add",r="b",i="before",s="black",o="Change",u="children",a="Deg",f=".",l="",c="g",h="get",p="#",d="id",v="kinetic",m="listening",g="mouseenter",y="mouseleave",b="name",w="off",E="on",S="_get",x="r",T="RGB",N="set",C="Shape",k=" ",L="stage",A="transform",O="B",M="G",_="Height",D="R",P="Stage",H="Width",B="X",j="Y",F="visible",I="x",q="y",R=["xChange.kinetic","yChange.kinetic","scaleXChange.kinetic","scaleYChange.kinetic","skewXChange.kinetic","skewYChange.kinetic","rotationChange.kinetic","offsetXChange.kinetic","offsetYChange.kinetic"].join(k);Kinetic.Util.addMethods(Kinetic.Node,{_init:function(n){var r=this;this._id=Kinetic.idCounter++;this.eventListeners={};this.attrs={};this.cache={};this.setAttrs(n);this.on(R,function(){this._clearCache(A);r._clearSelfAndChildrenCache(t)});this.on("visibleChange.kinetic",function(){r._clearSelfAndChildrenCache(F)});this.on("listeningChange.kinetic",function(){r._clearSelfAndChildrenCache(m)});this.on("opacityChange.kinetic",function(){r._clearSelfAndChildrenCache(e)})},clearCache:function(){this.cache={}},_clearCache:function(e){delete this.cache[e]},_getCache:function(e,t){var n=this.cache[e];n===undefined&&(this.cache[e]=t.call(this));return this.cache[e]},_clearSelfAndChildrenCache:function(e){var t=this;this._clearCache(e);this.children&&this.getChildren().each(function(t){t._clearSelfAndChildrenCache(e)})},on:function(e,t){var n=e.split(k),r=n.length,i,s,o,u,a;for(i=0;i<r;i++){s=n[i];o=s.split(f);u=o[0];a=o[1]||l;this.eventListeners[u]||(this.eventListeners[u]=[]);this.eventListeners[u].push({name:a,handler:t})}return this},off:function(e){var t=e.split(k),n=t.length,r,i,s,o,u,a,l;for(r=0;r<n;r++){o=t[r];u=o.split(f);a=u[0];l=u[1];if(a)this.eventListeners[a]&&this._off(a,l);else for(s in this.eventListeners)this._off(s,l)}return this},remove:function(){var n=this.getParent();if(n&&n.children){n.children.splice(this.index,1);n._setChildrenIndices();delete this.parent}this._clearSelfAndChildrenCache(L);this._clearSelfAndChildrenCache(t);this._clearSelfAndChildrenCache(F);this._clearSelfAndChildrenCache(m);this._clearSelfAndChildrenCache(e);return this},destroy:function(){Kinetic._removeId(this.getId());Kinetic._removeName(this.getName(),this._id);this.remove()},getAttr:function(e){var t=h+Kinetic.Util._capitalize(e);return Kinetic.Util._isFunction(this[t])?this[t]():this.attrs[e]},getAncestors:function(){var e=this.getParent(),t=new Kinetic.Collection;while(e){t.push(e);e=e.getParent()}return t},setAttr:function(){var e=Array.prototype.slice.call(arguments),t=e[0],n=N+Kinetic.Util._capitalize(t),r=this[n];e.shift();Kinetic.Util._isFunction(r)?r.apply(this,e):this.attrs[t]=e[0];return this},getAttrs:function(){return this.attrs||{}},setAttrs:function(e){var t,n;if(e)for(t in e)if(t!==u){n=N+Kinetic.Util._capitalize(t);Kinetic.Util._isFunction(this[n])?this[n](e[t]):this._setAttr(t,e[t])}return this},isListening:function(){return this._getCache(m,this._isListening)},_isListening:function(){var e=this.getListening(),t=this.getParent();return e&&t&&!t.isListening()?!1:e},isVisible:function(){return this._getCache(F,this._isVisible)},_isVisible:function(){var e=this.getVisible(),t=this.getParent();return e&&t&&!t.isVisible()?!1:e},show:function(){this.setVisible(!0);return this},hide:function(){this.setVisible(!1);return this},getZIndex:function(){return this.index||0},getAbsoluteZIndex:function(){function u(a){r=[];i=a.length;for(s=0;s<i;s++){o=a[s];n++;o.nodeType!==C&&(r=r.concat(o.getChildren().toArray()));o._id===t._id&&(s=i)}r.length>0&&r[0].getLevel()<=e&&u(r)}var e=this.getLevel(),t=this,n=0,r,i,s,o;t.nodeType!==P&&u(t.getStage().getChildren());return n},getLevel:function(){var e=0,t=this.parent;while(t){e++;t=t.parent}return e},setPosition:function(){var e=Kinetic.Util._getXY([].slice.call(arguments));this.setX(e.x);this.setY(e.y);return this},getPosition:function(){return{x:this.getX(),y:this.getY()}},getAbsolutePosition:function(){var e=this.getAbsoluteTransform().getMatrix(),t=new Kinetic.Transform,n=this.getOffset();t.m=e.slice();t.translate(n.x,n.y);return t.getTranslation()},setAbsolutePosition:function(){var e=Kinetic.Util._getXY([].slice.call(arguments)),t=this._clearTransform(),n;this.attrs.x=t.x;this.attrs.y=t.y;delete t.x;delete t.y;n=this.getAbsoluteTransform();n.invert();n.translate(e.x,e.y);e={x:this.attrs.x+n.getTranslation().x,y:this.attrs.y+n.getTranslation().y};this.setPosition(e.x,e.y);this._setTransform(t);return this},_setTransform:function(e){var n;for(n in e)this.attrs[n]=e[n];this._clearCache(A);this._clearSelfAndChildrenCache(t)},_clearTransform:function(){var e={x:this.getX(),y:this.getY(),rotation:this.getRotation(),scaleX:this.getScaleX(),scaleY:this.getScaleY(),offsetX:this.getOffsetX(),offsetY:this.getOffsetY(),skewX:this.getSkewX(),skewY:this.getSkewY()};this.attrs.x=0;this.attrs.y=0;this.attrs.rotation=0;this.attrs.scaleX=1;this.attrs.scaleY=1;this.attrs.offsetX=0;this.attrs.offsetY=0;this.attrs.skewX=0;this.attrs.skewY=0;this._clearCache(A);this._clearSelfAndChildrenCache(t);return e},move:function(){var e=Kinetic.Util._getXY([].slice.call(arguments)),t=this.getX(),n=this.getY();e.x!==undefined&&(t+=e.x);e.y!==undefined&&(n+=e.y);this.setPosition(t,n);return this},_eachAncestorReverse:function(e,t){var n=[],r=this.getParent(),i,s;t&&n.unshift(this);while(r){n.unshift(r);r=r.parent}i=n.length;for(s=0;s<i;s++)e(n[s])},rotate:function(e){this.setRotation(this.getRotation()+e);return this},rotateDeg:function(e){this.setRotation(this.getRotation()+Kinetic.Util._degToRad(e));return this},moveToTop:function(){var e=this.index;this.parent.children.splice(e,1);this.parent.children.push(this);this.parent._setChildrenIndices();return!0},moveUp:function(){var e=this.index,t=this.parent.getChildren().length;if(e<t-1){this.parent.children.splice(e,1);this.parent.children.splice(e+1,0,this);this.parent._setChildrenIndices();return!0}return!1},moveDown:function(){var e=this.index;if(e>0){this.parent.children.splice(e,1);this.parent.children.splice(e-1,0,this);this.parent._setChildrenIndices();return!0}return!1},moveToBottom:function(){var e=this.index;if(e>0){this.parent.children.splice(e,1);this.parent.children.unshift(this);this.parent._setChildrenIndices();return!0}return!1},setZIndex:function(e){var t=this.index;this.parent.children.splice(t,1);this.parent.children.splice(e,0,this);this.parent._setChildrenIndices();return this},getAbsoluteOpacity:function(){return this._getCache(e,this._getAbsoluteOpacity)},_getAbsoluteOpacity:function(){var e=this.getOpacity();this.getParent()&&(e*=this.getParent().getAbsoluteOpacity());return e},moveTo:function(e){Kinetic.Node.prototype.remove.call(this);e.add(this);return this},toObject:function(){var e=Kinetic.Util,t={},n=this.getAttrs(),r,i;t.attrs={};for(r in n){i=n[r];!e._isFunction(i)&&!e._isElement(i)&&(!e._isObject(i)||!e._hasMethods(i))&&(t.attrs[r]=i)}t.className=this.getClassName();return t},toJSON:function(){return JSON.stringify(this.toObject())},getParent:function(){return this.parent},getLayer:function(){return this.getParent().getLayer()},getStage:function(){return this._getCache(L,this._getStage)},_getStage:function(){var e=this.getParent();return e?e.getStage():undefined},fire:function(e,t,n){n?this._fireAndBubble(e,t||{}):this._fire(e,t||{});return this},getAbsoluteTransform:function(){return this._getCache(t,this._getAbsoluteTransform)},_getAbsoluteTransform:function(){var e=new Kinetic.Transform,t;this._eachAncestorReverse(function(n){t=n.getTransform();e.multiply(t)},!0);return e},_getTransform:function(){var e=new Kinetic.Transform,t=this.getX(),n=this.getY(),r=this.getRotation(),i=this.getScaleX(),s=this.getScaleY(),o=this.getSkewX(),u=this.getSkewY(),a=this.getOffsetX(),f=this.getOffsetY();(t!==0||n!==0)&&e.translate(t,n);r!==0&&e.rotate(r);(o!==0||u!==0)&&e.skew(o,u);(i!==1||s!==1)&&e.scale(i,s);(a!==0||f!==0)&&e.translate(-1*a,-1*f);return e},clone:function(e){var t=this.getClassName(),n=new Kinetic[t](this.attrs),r,i,s,o,u;for(r in this.eventListeners){i=this.eventListeners[r];s=i.length;for(o=0;o<s;o++){u=i[o];if(u.name.indexOf(v)<0){n.eventListeners[r]||(n.eventListeners[r]=[]);n.eventListeners[r].push(u)}}}n.setAttrs(e);return n},toDataURL:function(e){e=e||{};var t=e.mimeType||null,n=e.quality||null,r=this.getStage(),i=e.x||0,s=e.y||0,o=new Kinetic.SceneCanvas({width:e.width||r.getWidth(),height:e.height||r.getHeight(),pixelRatio:1}),u=o.getContext();u.save();(i||s)&&u.translate(-1*i,-1*s);this.drawScene(o);u.restore();return o.toDataURL(t,n)},toImage:function(e){Kinetic.Util._getImage(this.toDataURL(e),function(t){e.callback(t)})},setSize:
function(){var e=Kinetic.Util._getSize(Array.prototype.slice.call(arguments));this.setWidth(e.width);this.setHeight(e.height);return this},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function(){return this.attrs.width||0},getHeight:function(){return this.attrs.height||0},getClassName:function(){return this.className||this.nodeType},getType:function(){return this.nodeType},_get:function(e){return this.nodeType===e?[this]:[]},_off:function(e,t){var n=this.eventListeners[e],r,i;for(r=0;r<n.length;r++){i=n[r].name;if((i!=="kinetic"||t==="kinetic")&&(!t||i===t)){n.splice(r,1);if(n.length===0){delete this.eventListeners[e];break}r--}}},_fireBeforeChangeEvent:function(e,t,n){this._fire(i+Kinetic.Util._capitalize(e)+o,{oldVal:t,newVal:n})},_fireChangeEvent:function(e,t,n){this._fire(e+o,{oldVal:t,newVal:n})},setId:function(e){var t=this.getId();Kinetic._removeId(t);Kinetic._addId(this,e);this._setAttr(d,e);return this},setName:function(e){var t=this.getName();Kinetic._removeName(t,this._id);Kinetic._addName(this,e);this._setAttr(b,e);return this},_setAttr:function(e,t){var n;if(t!==undefined){n=this.attrs[e];this._fireBeforeChangeEvent(e,n,t);this.attrs[e]=t;this._fireChangeEvent(e,n,t)}},_fireAndBubble:function(e,t,n){var r=!0;t&&this.nodeType===C&&(t.targetNode=this);e===g&&n&&this._id===n._id?r=!1:e===y&&n&&this._id===n._id&&(r=!1);if(r){this._fire(e,t);t&&!t.cancelBubble&&this.parent&&(n&&n.parent?this._fireAndBubble.call(this.parent,e,t,n.parent):this._fireAndBubble.call(this.parent,e,t))}},_fire:function(e,t){var n=this.eventListeners[e],r,i;if(n){r=n.length;for(i=0;i<r;i++)n[i].handler.call(this,t)}},draw:function(){this.drawScene();this.drawHit();return this},shouldDrawHit:function(){return this.isListening()&&this.isVisible()&&!Kinetic.isDragging()},isDraggable:function(){return!1},getTransform:function(){return this._getCache(A,this._getTransform)}});Kinetic.Node.create=function(e,t){return this._createNode(JSON.parse(e),t)};Kinetic.Node._createNode=function(e,t){var n=Kinetic.Node.prototype.getClassName.call(e),r=e.children,i,s,o;t&&(e.attrs.container=t);i=new Kinetic[n](e.attrs);if(r){s=r.length;for(o=0;o<s;o++)i.add(this._createNode(r[o]))}return i};Kinetic.Factory.addGetterSetter(Kinetic.Node,"x",0);Kinetic.Factory.addGetterSetter(Kinetic.Node,"y",0);Kinetic.Factory.addGetterSetter(Kinetic.Node,"opacity",1);Kinetic.Factory.addGetter(Kinetic.Node,"name");Kinetic.Factory.addGetter(Kinetic.Node,"id");Kinetic.Factory.addRotationGetterSetter(Kinetic.Node,"rotation",0);Kinetic.Factory.addPointGetterSetter(Kinetic.Node,"scale",1);Kinetic.Factory.addPointGetterSetter(Kinetic.Node,"skew",0);Kinetic.Factory.addPointGetterSetter(Kinetic.Node,"offset",0);Kinetic.Factory.addSetter(Kinetic.Node,"width");Kinetic.Factory.addSetter(Kinetic.Node,"height");Kinetic.Factory.addGetterSetter(Kinetic.Node,"listening",!0);Kinetic.Factory.addGetterSetter(Kinetic.Node,"visible",!0);Kinetic.Collection.mapMethods(["on","off","remove","destroy","show","hide","move","rotate","moveToTop","moveUp","moveDown","moveToBottom","moveTo","fire","draw"])})();(function(){function t(e){window.setTimeout(e,1e3/60)}var e=500;Kinetic.Animation=function(e,t){this.func=e;this.setLayers(t);this.id=Kinetic.Animation.animIdCounter++;this.frame={time:0,timeDiff:0,lastTime:(new Date).getTime()}};Kinetic.Animation.prototype={setLayers:function(e){var t=[];e?e.length>0?t=e:t=[e]:t=[];this.layers=t},getLayers:function(){return this.layers},addLayer:function(e){var t=this.layers,n,r;if(t){n=t.length;for(r=0;r<n;r++)if(t[r]._id===e._id)return!1}else this.layers=[];this.layers.push(e);return!0},isRunning:function(){var e=Kinetic.Animation,t=e.animations;for(var n=0;n<t.length;n++)if(t[n].id===this.id)return!0;return!1},start:function(){this.stop();this.frame.timeDiff=0;this.frame.lastTime=(new Date).getTime();Kinetic.Animation._addAnimation(this)},stop:function(){Kinetic.Animation._removeAnimation(this)},_updateFrameObject:function(e){this.frame.timeDiff=e-this.frame.lastTime;this.frame.lastTime=e;this.frame.time+=this.frame.timeDiff;this.frame.frameRate=1e3/this.frame.timeDiff}};Kinetic.Animation.animations=[];Kinetic.Animation.animIdCounter=0;Kinetic.Animation.animRunning=!1;Kinetic.Animation._addAnimation=function(e){this.animations.push(e);this._handleAnimation()};Kinetic.Animation._removeAnimation=function(e){var t=e.id,n=this.animations,r=n.length;for(var i=0;i<r;i++)if(n[i].id===t){this.animations.splice(i,1);break}};Kinetic.Animation._runFrames=function(){var e={},t=this.animations,n,r,i,s,o,u,a,f;for(s=0;s<t.length;s++){n=t[s];r=n.layers;i=n.func;n._updateFrameObject((new Date).getTime());u=r.length;for(o=0;o<u;o++){a=r[o];a._id!==undefined&&(e[a._id]=a)}i&&i.call(n,n.frame)}for(f in e)e[f].draw()};Kinetic.Animation._animationLoop=function(){var e=this;if(this.animations.length>0){this._runFrames();Kinetic.Animation.requestAnimFrame(function(){e._animationLoop()})}else this.animRunning=!1};Kinetic.Animation._handleAnimation=function(){var e=this;if(!this.animRunning){this.animRunning=!0;e._animationLoop()}};RAF=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||t}();Kinetic.Animation.requestAnimFrame=function(e){var n=Kinetic.DD&&Kinetic.DD.isDragging?t:RAF;n(e)};var n=Kinetic.Node.prototype.moveTo;Kinetic.Node.prototype.moveTo=function(e){n.call(this,e)};Kinetic.Layer.prototype.batchDraw=function(){var t=this;this.batchAnim||(this.batchAnim=new Kinetic.Animation(function(){t.lastBatchDrawTime&&(new Date).getTime()-t.lastBatchDrawTime>e&&t.batchAnim.stop()},this));this.lastBatchDrawTime=(new Date).getTime();if(!this.batchAnim.isRunning()){this.draw();this.batchAnim.start()}};Kinetic.Stage.prototype.batchDraw=function(){this.getChildren().each(function(e){e.batchDraw()})}})();(function(){var e={node:1,duration:1,easing:1,onFinish:1,yoyo:1},t=1,n=2,r=3,i=0;Kinetic.Tween=function(t){var n=this,r=t.node,o=r._id,u=t.duration||1,a=t.easing||Kinetic.Easings.Linear,f=!!t.yoyo,l,c,h,p;this.node=r;this._id=i++;this.anim=new Kinetic.Animation(function(){n.tween.onEnterFrame()},r.getLayer()||r.getLayers());this.tween=new s(l,function(e){n._tweenFunc(e)},a,0,1,u*1e3,f);this._addListeners();Kinetic.Tween.attrs[o]||(Kinetic.Tween.attrs[o]={});Kinetic.Tween.attrs[o][this._id]||(Kinetic.Tween.attrs[o][this._id]={});Kinetic.Tween.tweens[o]||(Kinetic.Tween.tweens[o]={});for(l in t)e[l]===undefined&&this._addAttr(l,t[l]);this.reset();this.onFinish=t.onFinish;this.onReset=t.onReset};Kinetic.Tween.attrs={};Kinetic.Tween.tweens={};Kinetic.Tween.prototype={_addAttr:function(e,t){var n=this.node,r=n._id,i,s,o,u,a,f,l;o=Kinetic.Tween.tweens[r][e];o&&delete Kinetic.Tween.attrs[r][o][e];i=n.getAttr(e);if(Kinetic.Util._isArray(t)){t=Kinetic.Util._getPoints(t);s=[];a=t.length;for(u=0;u<a;u++){f=i[u];l=t[u];s.push({x:l.x-f.x,y:l.y-f.y})}}else s=t-i;Kinetic.Tween.attrs[r][this._id][e]={start:i,diff:s};Kinetic.Tween.tweens[r][e]=this._id},_tweenFunc:function(e){var t=this.node,n=Kinetic.Tween.attrs[t._id][this._id],r,i,s,o,u,a,f,l,c;for(r in n){i=n[r];s=i.start;o=i.diff;if(Kinetic.Util._isArray(s)){u=[];f=s.length;for(a=0;a<f;a++){l=s[a];c=o[a];u.push({x:l.x+c.x*e,y:l.y+c.y*e})}}else u=s+o*e;t.setAttr(r,u)}},_addListeners:function(){var e=this;this.tween.onPlay=function(){e.anim.start()};this.tween.onReverse=function(){e.anim.start()};this.tween.onPause=function(){e.anim.stop()};this.tween.onFinish=function(){e.onFinish&&e.onFinish()};this.tween.onReset=function(){e.onReset&&e.onReset()}},play:function(){this.tween.play();return this},reverse:function(){this.tween.reverse();return this},reset:function(){var e=this.node;this.tween.reset();(e.getLayer()||e.getLayers()).draw();return this},seek:function(e){var t=this.node;this.tween.seek(e*1e3);(t.getLayer()||t.getLayers()).draw();return this},pause:function(){this.tween.pause();return this},finish:function(){var e=this.node;this.tween.finish();(e.getLayer()||e.getLayers()).draw();return this},destroy:function(){var e=this.node._id,t=this._id,n=Kinetic.Tween.tweens[e],r;this.pause();for(r in n)delete Kinetic.Tween.tweens[e][r];delete Kinetic.Tween.attrs[e][t]}};var s=function(e,t,n,r,i,s,o){this.prop=e;this.propFunc=t;this.begin=r;this._pos=r;this.duration=s;this._change=0;this.prevPos=0;this.yoyo=o;this._time=0;this._position=0;this._startTime=0;this._finish=0;this.func=n;this._change=i-this.begin;this.pause()};s.prototype={fire:function(e){var t=this[e];t&&t()},setTime:function(e){if(e>this.duration)if(this.yoyo){this._time=this.duration;this.reverse()}else this.finish();else if(e<0)if(this.yoyo){this._time=0;this.play()}else this.reset();else{this._time=e;this.update()}},getTime:function(){return this._time},setPosition:function(e){this.prevPos=this._pos;this.propFunc(e);this._pos=e},getPosition:function(e){e===undefined&&(e=this._time);return this.func(e,this.begin,this._change,this.duration)},play:function(){this.state=n;this._startTime=this.getTimer()-this._time;this.onEnterFrame();this.fire("onPlay")},reverse:function(){this.state=r;this._time=this.duration-this._time;this._startTime=this.getTimer()-this._time;this.onEnterFrame();this.fire("onReverse")},seek:function(e){this.pause();this._time=e;this.update();this.fire("onSeek")},reset:function(){this.pause();this._time=0;this.update();this.fire("onReset")},finish:function(){this.pause();this._time=this.duration;this.update();this.fire("onFinish")},update:function(){this.setPosition(this.getPosition(this._time))},onEnterFrame:function(){var e=this.getTimer()-this._startTime;this.state===n?this.setTime(e):this.state===r&&this.setTime(this.duration-e)},pause:function(){this.state=t;this.fire("onPause")},getTimer:function(){return(new Date).getTime()}};Kinetic.Easings={BackEaseIn:function(e,t,n,r,i,s){var o=1.70158;return n*(e/=r)*e*((o+1)*e-o)+t},BackEaseOut:function(e,t,n,r,i,s){var o=1.70158;return n*((e=e/r-1)*e*((o+1)*e+o)+1)+t},BackEaseInOut:function(e,t,n,r,i,s){var o=1.70158;return(e/=r/2)<1?n/2*e*e*(((o*=1.525)+1)*e-o)+t:n/2*((e-=2)*e*(((o*=1.525)+1)*e+o)+2)+t},ElasticEaseIn:function(e,t,n,r,i,s){var o=0;if(e===0)return t;if((e/=r)==1)return t+n;s||(s=r*.3);if(!i||i<Math.abs(n)){i=n;o=s/4}else o=s/(2*Math.PI)*Math.asin(n/i);return-(i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s))+t},ElasticEaseOut:function(e,t,n,r,i,s){var o=0;if(e===0)return t;if((e/=r)==1)return t+n;s||(s=r*.3);if(!i||i<Math.abs(n)){i=n;o=s/4}else o=s/(2*Math.PI)*Math.asin(n/i);return i*Math.pow(2,-10*e)*Math.sin((e*r-o)*2*Math.PI/s)+n+t},ElasticEaseInOut:function(e,t,n,r,i,s){var o=0;if(e===0)return t;if((e/=r/2)==2)return t+n;s||(s=r*.3*1.5);if(!i||i<Math.abs(n)){i=n;o=s/4}else o=s/(2*Math.PI)*Math.asin(n/i);return e<1?-0.5*i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)+t:i*Math.pow(2,-10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)*.5+n+t},BounceEaseOut:function(e,t,n,r){return(e/=r)<1/2.75?n*7.5625*e*e+t:e<2/2.75?n*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?n*(7.5625*(e-=2.25/2.75)*e+.9375)+t:n*(7.5625*(e-=2.625/2.75)*e+.984375)+t},BounceEaseIn:function(e,t,n,r){return n-Kinetic.Easings.BounceEaseOut(r-e,0,n,r)+t},BounceEaseInOut:function(e,t,n,r){return e<r/2?Kinetic.Easings.BounceEaseIn(e*2,0,n,r)*.5+t:Kinetic.Easings.BounceEaseOut(e*2-r,0,n,r)*.5+n*.5+t},EaseIn:function(e,t,n,r){return n*(e/=r)*e+t},EaseOut:function(e,t,n,r){return-n*(e/=r)*(e-2)+t},EaseInOut:function(e,t,n,r){return(e/=r/2)<1?n/2*e*e+t:-n/2*(--e*(e-2)-1)+t},StrongEaseIn:function(e,t,n,r){return n*(e/=r)*e*e*e*e+t},StrongEaseOut:function(e,t,n,r){return n*((e=e/r-1)*e*e*e*e+1)+t},StrongEaseInOut:function(e,t,n,r){return(e/=r/2)<1?n/2*e*e*e*e*e+t:n/2*((e-=2)*e*e*e*e+2)+t},Linear:function(e,t,n,r){return n*e/r+t}}})();(function(){Kinetic.DD={anim:new Kinetic.Animation,isDragging:!1,offset:{x:0,y:0},node:null,_drag:function(e){var t=Kinetic.DD,n=t.node;if(n){n._setDragPosition(e);if(!t.isDragging){t.isDragging=!0;n.fire("dragstart",e,!0)}n.fire("dragmove",e,!0)}},_endDragBefore:function(e){var t=Kinetic.DD,n=t.node,r,i;if(n){r=n.nodeType,i=n.getLayer();t.anim.stop();if(t.isDragging){t.isDragging=!1;Kinetic.listenClickTap=!1;e&&(e.dragEndNode=n)}delete t.node;(i||n).draw()}},_endDragAfter:function(e){e=e||{};var t=e.dragEndNode;e&&t&&t.fire("dragend",e,!0)}};Kinetic.Node.prototype.startDrag=function(){var e=Kinetic.DD,t=this.getStage(),n=this.getLayer(),r=t.getPointerPosition(),i=this.getAbsolutePosition();if(r){e.node&&e.node.stopDrag();e.node=this;e.offset.x=r.x-i.x;e.offset.y=r.y-i.y;e.anim.setLayers(n||this.getLayers());e.anim.start();this._setDragPosition()}};Kinetic.Node.prototype._setDragPosition=function(e){var t=Kinetic.DD,n=this.getStage().getPointerPosition(),r=this.getDragBoundFunc(),i={x:n.x-t.offset.x,y:n.y-t.offset.y};r!==undefined&&(i=r.call(this,i,e));this.setAbsolutePosition(i)};Kinetic.Node.prototype.stopDrag=function(){var e=Kinetic.DD,t={};e._endDragBefore(t);e._endDragAfter(t)};Kinetic.Node.prototype.setDraggable=function(e){this._setAttr("draggable",e);this._dragChange()};var e=Kinetic.Node.prototype.destroy;Kinetic.Node.prototype.destroy=function(){var t=Kinetic.DD;t.node&&t.node._id===this._id&&this.stopDrag();e.call(this)};Kinetic.Node.prototype.isDragging=function(){var e=Kinetic.DD;return e.node&&e.node._id===this._id&&e.isDragging};Kinetic.Node.prototype._listenDrag=function(){var e=this;this._dragCleanup();this.getClassName()==="Stage"?this.on("contentMousedown.kinetic contentTouchstart.kinetic",function(t){Kinetic.DD.node||e.startDrag(t)}):this.on("mousedown.kinetic touchstart.kinetic",function(t){Kinetic.DD.node||e.startDrag(t)})};Kinetic.Node.prototype._dragChange=function(){if(this.attrs.draggable)this._listenDrag();else{this._dragCleanup();var e=this.getStage(),t=Kinetic.DD;e&&t.node&&t.node._id===this._id&&t.node.stopDrag()}};Kinetic.Node.prototype._dragCleanup=function(){this.off("mousedown.kinetic");this.off("touchstart.kinetic")};Kinetic.Factory.addGetterSetter(Kinetic.Node,"dragBoundFunc");Kinetic.Factory.addGetter(Kinetic.Node,"draggable",!1);Kinetic.Node.prototype.isDraggable=Kinetic.Node.prototype.getDraggable;var t=document.getElementsByTagName("html")[0];t.addEventListener("mouseup",Kinetic.DD._endDragBefore,!0);t.addEventListener("touchend",Kinetic.DD._endDragBefore,!0);t.addEventListener("mouseup",Kinetic.DD._endDragAfter,!1);t.addEventListener("touchend",Kinetic.DD._endDragAfter,!1)})();(function(){Kinetic.Util.addMethods(Kinetic.Container,{__init:function(e){this.children=new Kinetic.Collection;Kinetic.Node.call(this,e)},getChildren:function(){return this.children},hasChildren:function(){return this.getChildren().length>0},removeChildren:function(){var e=this.children,t;while(e.length>0){t=e[0];t.hasChildren()&&t.removeChildren();t.remove()}return this},destroyChildren:function(){var e=this.children;while(e.length>0)e[0].destroy();return this},add:function(e){var t=this.children;this._validateAdd(e);e.index=t.length;e.parent=this;t.push(e);this._fire("add",{child:e});return this},destroy:function(){this.hasChildren()&&this.destroyChildren();Kinetic.Node.prototype.destroy.call(this)},find:function(e){var t=[],n=e.replace(/ /g,"").split(","),r=n.length,i,s,o,u,a,f,l;for(i=0;i<r;i++){o=n[i];if(o.charAt(0)==="#"){a=this._getNodeById(o.slice(1));a&&t.push(a)}else if(o.charAt(0)==="."){u=this._getNodesByName(o.slice(1));t=t.concat(u)}else{f=this.getChildren();l=f.length;for(s=0;s<l;s++)t=t.concat(f[s]._get(o))}}return Kinetic.Collection.toCollection(t)},_getNodeById:function(e){var t=Kinetic.ids[e];return t!==undefined&&this.isAncestorOf(t)?t:null},_getNodesByName:function(e){var t=Kinetic.names[e]||[];return this._getDescendants(t)},_get:function(e){var t=Kinetic.Node.prototype._get.call(this,e),n=this.getChildren(),r=n.length;for(var i=0;i<r;i++)t=t.concat(n[i]._get(e));return t},toObject:function(){var e=Kinetic.Node.prototype.toObject.call(this);e.children=[];var t=this.getChildren(),n=t.length;for(var r=0;r<n;r++){var i=t[r];e.children.push(i.toObject())}return e},_getDescendants:function(e){var t=[],n=e.length;for(var r=0;r<n;r++){var i=e[r];this.isAncestorOf(i)&&t.push(i)}return t},isAncestorOf:function(e){var t=e.getParent();while(t){if(t._id===this._id)return!0;t=t.getParent()}return!1},clone:function(e){var t=Kinetic.Node.prototype.clone.call(this,e);this.getChildren().each(function(e){t.add(e.clone())});return t},getAllIntersections:function(){var e=Kinetic.Util._getXY(Array.prototype.slice.call(arguments)),t=[],n=this.find("Shape"),r=n.length;for(var i=0;i<r;i++){var s=n[i];s.isVisible()&&s.intersects(e)&&t.push(s)}return t},_setChildrenIndices:function(){this.children.each(function(e,t){e.index=t})},drawScene:function(e){var t=this.getLayer(),n=this.getClipWidth()&&this.getClipHeight(),r,i,s;!e&&t&&(e=t.getCanvas());this.isVisible()&&(n?e.getContext()._clip(this):this._drawChildren(e));return this},_drawChildren:function(e){this.children.each(function(t){t.drawScene(e)})},drawHit:function(){var e=this.getClipWidth()&&this.getClipHeight()&&this.nodeType!=="Stage",t=0,n=0,r=[],i;if(this.shouldDrawHit()){if(e){i=this.getLayer().hitCanvas;i.getContext()._clip(this)}r=this.children;n=r.length;for(t=0;t<n;t++)r[t].drawHit();e&&i.getContext()._context.restore()}return this}});Kinetic.Util.extend(Kinetic.Container,Kinetic.Node);Kinetic.Container.prototype.get=Kinetic.Container.prototype.find;Kinetic.Factory.addBoxGetterSetter(Kinetic.Container,"clip")})();(function(){function t(e){e.fill()}function n(e){e.stroke()}function r(e){e.fill()}function i(e){e.stroke()}function s(){this._clearCache(e)}var e="hasShadow";Kinetic.Util.addMethods(Kinetic.Shape,{__init:function(e){this.nodeType="Shape";this._fillFunc=t;this._strokeFunc=n;this._fillFuncHit=r;this._strokeFuncHit=i;var o=Kinetic.shapes,u;for(;;){u=Kinetic.Util.getRandomColor();if(u&&!(u in o))break}this.colorKey=u;o[u]=this;Kinetic.Node.call(this,e);this._setDrawFuncs();this.on("shadowColorChange.kinetic shadowBlurChange.kinetic shadowOffsetChange.kinetic shadowOpacityChange.kinetic",s)},hasChildren:function(){return!1},getChildren:function(){return[]},getContext:function(){return this.getLayer().getContext()},getCanvas:function(){return this.getLayer().getCanvas()},hasShadow:function(){return this._getCache(e,this._hasShadow)},_hasShadow:function(){return this.getShadowEnabled()&&this.getShadowOpacity()!==0&&!!(this.getShadowColor()||this.getShadowBlur()||this.getShadowOffsetX()||this.getShadowOffsetY())},hasFill:function(){return!!(this.getFill()||this.getFillPatternImage()||this.getFillLinearGradientColorStops()||this.getFillRadialGradientColorStops())},hasStroke:function(){return!!this.getStroke()||!!this.getStrokeWidth()},_get:function(e){return this.className===e||this.nodeType===e?[this]:[]},intersects:function(){var e=Kinetic.Util._getXY(Array.prototype.slice.call(arguments)),t=this.getStage(),n=t.bufferHitCanvas,r;n.getContext().clear();this.drawScene(n);r=n.context.getImageData(e.x|0,e.y|0,1,1).data;return r[3]>0},enableFill:function(){this._setAttr("fillEnabled",!0);return this},disableFill:function(){this._setAttr("fillEnabled",!1);return this},enableStroke:function(){this._setAttr("strokeEnabled",!0);return this},disableStroke:function(){this._setAttr("strokeEnabled",!1);return this},enableStrokeScale:function(){this._setAttr("strokeScaleEnabled",!0);return this},disableStrokeScale:function(){this._setAttr("strokeScaleEnabled",!1);return this},enableShadow:function(){this._setAttr("shadowEnabled",!0);return this},disableShadow:function(){this._setAttr("shadowEnabled",!1);return this},enableDashArray:function(){this._setAttr("dashArrayEnabled",!0);return this},disableDashArray:function(){this._setAttr("dashArrayEnabled",!1);return this},destroy:function(){Kinetic.Node.prototype.destroy.call(this);delete Kinetic.shapes[this.colorKey];return this},_useBufferCanvas:function(){return(this.hasShadow()||this.getAbsoluteOpacity()!==1)&&this.hasFill()&&this.hasStroke()},drawScene:function(e){var t=e||this.getLayer().getCanvas(),n=t.getContext(),r=this.getDrawFunc(),i=this.hasShadow(),s,o,u;if(r&&this.isVisible())if(this._useBufferCanvas()){s=this.getStage();o=s.bufferCanvas;u=o.getContext();u.clear();u.save();u._applyLineJoin(this);u._applyAncestorTransforms(this);r.call(this,u);u.restore();n.save();if(i){n.save();n._applyShadow(this);n.drawImage(o._canvas,0,0);n.restore()}n._applyOpacity(this);n.drawImage(o._canvas,0,0);n.restore()}else{n.save();n._applyLineJoin(this);n._applyAncestorTransforms(this);if(i){n.save();n._applyShadow(this);r.call(this,n);n.restore()}n._applyOpacity(this);r.call(this,n);n.restore()}return this},drawHit:function(){var e=this.getAttrs(),t=e.drawHitFunc||e.drawFunc,n=this.getLayer().hitCanvas,r=n.getContext();if(t&&this.shouldDrawHit()){r.save();r._applyLineJoin(this);r._applyAncestorTransforms(this);t.call(this,r);r.restore()}return this},_setDrawFuncs:function(){!this.attrs.drawFunc&&this.drawFunc&&this.setDrawFunc(this.drawFunc);!this.attrs.drawHitFunc&&this.drawHitFunc&&this.setDrawHitFunc(this.drawHitFunc)}});Kinetic.Util.extend(Kinetic.Shape,Kinetic.Node);Kinetic.Factory.addColorGetterSetter(Kinetic.Shape,"stroke");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"lineJoin");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"lineCap");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"strokeWidth");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"drawFunc");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"drawHitFunc");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"dashArray");Kinetic.Factory.addColorGetterSetter(Kinetic.Shape,"shadowColor");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowBlur");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowOpacity");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternImage");Kinetic.Factory.addColorGetterSetter(Kinetic.Shape,"fill");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternX");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternY");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillLinearGradientColorStops");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillRadialGradientStartRadius");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillRadialGradientEndRadius");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillRadialGradientColorStops");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternRepeat");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillEnabled",!0);Kinetic.Factory.addGetterSetter(Kinetic.Shape,"strokeEnabled",!0);Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowEnabled",!0);Kinetic.Factory.addGetterSetter(Kinetic.Shape,"dashArrayEnabled",!0);Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPriority","color");Kinetic.Factory.addGetterSetter(Kinetic.Shape,"strokeScaleEnabled",!0);Kinetic.Factory.addPointGetterSetter(Kinetic.Shape,"fillPatternOffset",0);Kinetic.Factory.addPointGetterSetter(Kinetic.Shape,"fillPatternScale",1);Kinetic.Factory.addPointGetterSetter(Kinetic.Shape,"fillLinearGradientStartPoint",0);Kinetic.Factory.addPointGetterSetter(Kinetic.Shape,"fillLinearGradientEndPoint",0);Kinetic.Factory.addPointGetterSetter(Kinetic.Shape,"fillRadialGradientStartPoint",0);Kinetic.Factory.addPointGetterSetter(Kinetic.Shape,"fillRadialGradientEndPoint",0);Kinetic.Factory.addPointGetterSetter(Kinetic.Shape,"shadowOffset",0);Kinetic.Factory.addRotationGetterSetter(Kinetic.Shape,"fillPatternRotation",0)})();(function(){function R(e,t){e.content.addEventListener(t,function(n){e[B+t](n)},!1)}var e="Stage",t="string",n="px",r="mouseout",i="mouseleave",s="mouseover",o="mouseenter",u="mousemove",a="mousedown",f="mouseup",l="click",c="dblclick",h="touchstart",p="touchend",d="tap",v="dbltap",m="touchmove",g="contentMouseout",y="contentMouseleave",b="contentMouseover",w="contentMouseenter",E="contentMousemove",S="contentMousedown",x="contentMouseup",T="contentClick",N="contentDblclick",C="contentTouchstart",k="contentTouchend",L="contentTap",A="contentDbltap",O="contentTouchmove",M="div",_="relative",D="inline-block",P="kineticjs-content",H=" ",B="_",j="container",F="",I=[a,u,f,r,h,m,p,s],q=I.length;Kinetic.Util.addMethods(Kinetic.Stage,{___init:function(t){this.nodeType=e;Kinetic.Container.call(this,t);this._id=Kinetic.idCounter++;this._buildDOM();this._bindContentEvents();Kinetic.stages.push(this)},_validateAdd:function(e){e.getType()!=="Layer"&&Kinetic.Util.error("You may only add layers to the stage.")},setContainer:function(e){typeof e===t&&(e=document.getElementById(e));this._setAttr(j,e);return this},draw:function(){Kinetic.Node.prototype.draw.call(this);return this},setHeight:function(e){Kinetic.Node.prototype.setHeight.call(this,e);this._resizeDOM();return this},setWidth:function(e){Kinetic.Node.prototype.setWidth.call(this,e);this._resizeDOM();return this},clear:function(){var e=this.children,t=e.length,n;for(n=0;n<t;n++)e[n].clear();return this},destroy:function(){var e=this.content;Kinetic.Container.prototype.destroy.call(this);e&&Kinetic.Util._isInDocument(e)&&this.getContainer().removeChild(e)},getMousePosition:function(){return this.mousePos},getTouchPosition:function(){return this.touchPos},getPointerPosition:function(){return this.getTouchPosition()||this.getMousePosition()},getStage:function(){return this},getContent:function(){return this.content},toDataURL:function(e){function a(r){var i=u[r],f=i.toDataURL(),l=new Image;l.onload=function(){o.drawImage(l,0,0);r<u.length-1?a(r+1):e.callback(s.toDataURL(t,n))};l.src=f}e=e||{};var t=e.mimeType||null,n=e.quality||null,r=e.x||0,i=e.y||0,s=new Kinetic.SceneCanvas({width:e.width||this.getWidth(),height:e.height||this.getHeight(),pixelRatio:1}),o=s.getContext()._context,u=this.children;(r||i)&&o.translate(-1*r,-1*i);a(0)},toImage:function(e){var t=e.callback;e.callback=function(e){Kinetic.Util._getImage(e,function(e){t(e)})};this.toDataURL(e)},getIntersection:function(){var e=Kinetic.Util._getXY(Array.prototype.slice.call(arguments)),t=this.getChildren(),n=t.length,r=n-1,i,s;for(i=r;i>=0;i--){s=t[i].getIntersection(e);if(s)return s}return null},_resizeDOM:function(){if(this.content){var e=this.getWidth(),t=this.getHeight(),r=this.getChildren(),i=r.length,s,o;this.content.style.width=e+n;this.content.style.height=t+n;this.bufferCanvas.setSize(e,t);this.bufferHitCanvas.setSize(e,t);for(s=0;s<i;s++){o=r[s];o.getCanvas().setSize(e,t);o.hitCanvas.setSize(e,t);o.draw()}}},add:function(e){Kinetic.Container.prototype.add.call(this,e);e.canvas.setSize(this.attrs.width,this.attrs.height);e.hitCanvas.setSize(this.attrs.width,this.attrs.height);e.draw();this.content.appendChild(e.canvas._canvas);return this},getParent:function(){return null},getLayer:function(){return null},getLayers:function(){return this.getChildren()},_setPointerPosition:function(e){e||(e=window.event);this._setMousePosition(e);this._setTouchPosition(e)},_bindContentEvents:function(){var e=this,t;for(t=0;t<q;t++)R(this,I[t])},_mouseover:function(e){this._fire(b,e)},_mouseout:function(e){this._setPointerPosition(e);var t=this.targetShape;if(t&&!Kinetic.isDragging()){t._fireAndBubble(r,e);t._fireAndBubble(i,e);this.targetShape=null}this.mousePos=undefined;this._fire(g,e)},_mousemove:function(e){this._setPointerPosition(e);var t=Kinetic.DD,n=this.getIntersection(this.getPointerPosition()),a=n&&n.shape?n.shape:undefined;if(a)if(!Kinetic.isDragging()&&n.pixel[3]===255&&(!this.targetShape||this.targetShape._id!==a._id)){if(this.targetShape){this.targetShape._fireAndBubble(r,e,a);this.targetShape._fireAndBubble(i,e,a)}a._fireAndBubble(s,e,this.targetShape);a._fireAndBubble(o,e,this.targetShape);this.targetShape=a}else a._fireAndBubble(u,e);else if(this.targetShape&&!Kinetic.isDragging()){this.targetShape._fireAndBubble(r,e);this.targetShape._fireAndBubble(i,e);this.targetShape=null}this._fire(E,e);t&&t._drag(e);e.preventDefault&&e.preventDefault()},_mousedown:function(e){this._setPointerPosition(e);var t=this.getIntersection(this.getPointerPosition()),n=t&&t.shape?t.shape:undefined;Kinetic.listenClickTap=!0;if(n){this.clickStartShape=n;n._fireAndBubble(a,e)}this._fire(S);e.preventDefault&&e.preventDefault()},_mouseup:function(e){this._setPointerPosition(e);var t=this,n=this.getIntersection(this.getPointerPosition()),r=n&&n.shape?n.shape:undefined,i=!1;if(Kinetic.inDblClickWindow){i=!0;Kinetic.inDblClickWindow=!1}else Kinetic.inDblClickWindow=!0;setTimeout(function(){Kinetic.inDblClickWindow=!1},Kinetic.dblClickWindow);if(r){r._fireAndBubble(f,e);if(Kinetic.listenClickTap&&r._id===this.clickStartShape._id){r._fireAndBubble(l,e);i&&r._fireAndBubble(c,e)}}this._fire(x);if(Kinetic.listenClickTap){this._fire(T,e);i&&this._fire(N,e)}Kinetic.listenClickTap=!1;e.preventDefault&&e.preventDefault()},_touchstart:function(e){this._setPointerPosition(e);var t=this.getIntersection(this.getPointerPosition()),n=t&&t.shape?t.shape:undefined;Kinetic.listenClickTap=!0;if(n){this.tapStartShape=n;n._fireAndBubble(h,e);n.isListening()&&e.preventDefault&&e.preventDefault()}this._fire(C,e)},_touchend:function(e){this._setPointerPosition(e);var t=this,n=this.getIntersection(this.getPointerPosition()),r=n&&n.shape?n.shape:undefined,i=!1;if(Kinetic.inDblClickWindow){i=!0;Kinetic.inDblClickWindow=!1}else Kinetic.inDblClickWindow=!0;setTimeout(function(){Kinetic.inDblClickWindow=!1},Kinetic.dblClickWindow);if(r){r._fireAndBubble(p,e);if(Kinetic.listenClickTap&&r._id===this.tapStartShape._id){r._fireAndBubble(d,e);i&&r._fireAndBubble(v,e)}r.isListening()&&e.preventDefault&&e.preventDefault()}if(Kinetic.listenClickTap){this._fire(k,e);i&&this._fire(A,e)}Kinetic.listenClickTap=!1},_touchmove:function(e){this._setPointerPosition(e);var t=Kinetic.DD,n=this.getIntersection(this.getPointerPosition()),r=n&&n.shape?n.shape:undefined;if(r){r._fireAndBubble(m,e);r.isListening()&&e.preventDefault&&e.preventDefault()}this._fire(O,e);t&&t._drag(e)},_setMousePosition:function(e){var t=this._getContentPosition(),n=e.offsetX,r=e.clientX,i=0,s=0;if(n!==undefined){i=n;s=e.offsetY}else if(Kinetic.UA.browser==="mozilla"){i=e.layerX;s=e.layerY}else if(r!==undefined&&t){i=r-t.left;s=e.clientY-t.top}this.mousePos={x:i,y:s}},_setTouchPosition:function(e){var t=this._getContentPosition(),n,r,i;if(e.touches!==undefined&&e.touches.length===1){n=e.touches[0];r=n.clientX-t.left;i=n.clientY-t.top;this.touchPos={x:r,y:i}}},_getContentPosition:function(){var e=this.content.getBoundingClientRect();return{top:e.top,left:e.left}},_buildDOM:function(){var e=this.getContainer();e.innerHTML=F;this.content=document.createElement(M);this.content.style.position=_;this.content.style.display=D;this.content.className=P;e.appendChild(this.content);this.bufferCanvas=new Kinetic.SceneCanvas;this.bufferHitCanvas=new Kinetic.HitCanvas;this._resizeDOM()},_onContent:function(e,t){var n=e.split(H),r=n.length,i,s;for(i=0;i<r;i++){s=n[i];this.content.addEventListener(s,t,!1)}}});Kinetic.Util.extend(Kinetic.Stage,Kinetic.Container);Kinetic.Factory.addGetter(Kinetic.Stage,"container")})();(function(){var e="#",t="beforeDraw",n="draw";Kinetic.Util.addMethods(Kinetic.Layer,{___init:function(e){this.nodeType="Layer";this.canvas=new Kinetic.SceneCanvas;this.hitCanvas=new Kinetic.HitCanvas;Kinetic.Container.call(this,e)},_validateAdd:function(e){var t=e.getType();t!=="Group"&&t!=="Shape"&&Kinetic.Util.error("You may only add groups and shapes to a layer.")},getIntersection:function(){var t=Kinetic.Util._getXY(Array.prototype.slice.call(arguments)),n,r,i;if(this.isVisible()&&this.isListening()){n=this.hitCanvas.context._context.getImageData(t.x|0,t.y|0,1,1).data;if(n[3]===255){r=Kinetic.Util._rgbToHex(n[0],n[1],n[2]);i=Kinetic.shapes[e+r];return{shape:i,pixel:n}}if(n[0]>0||n[1]>0||n[2]>0||n[3]>0)return{pixel:n}}return null},drawScene:function(e){e=e||this.getCanvas();this._fire(t,{node:this});this.getClearBeforeDraw()&&e.getContext().clear();Kinetic.Container.prototype.drawScene.call(this,e);this._fire(n,{node:this});return this},drawHit:function(){var e=this.getLayer();e&&e.getClearBeforeDraw()&&e.getHitCanvas().getContext().clear();Kinetic.Container.prototype.drawHit.call(this);return this},getCanvas:function(){return this.canvas},getHitCanvas:function(){return this.hitCanvas},getContext:function(){return this.getCanvas().getContext()},clear:function(){var e=this.getContext(),t=this.getHitCanvas().getContext();e.clear.apply(e,arguments);t.clear.apply(t,arguments);return this},setVisible:function(e){Kinetic.Node.prototype.setVisible.call(this,e);if(e){this.getCanvas()._canvas.style.display="block";this.hitCanvas._canvas.style.display="block"}else{this.getCanvas()._canvas.style.display="none";this.hitCanvas._canvas.style.display="none"}return this},setZIndex:function(e){Kinetic.Node.prototype.setZIndex.call(this,e);var t=this.getStage();if(t){t.content.removeChild
(this.getCanvas()._canvas);e<t.getChildren().length-1?t.content.insertBefore(this.getCanvas()._canvas,t.getChildren()[e+1].getCanvas()._canvas):t.content.appendChild(this.getCanvas()._canvas)}return this},moveToTop:function(){Kinetic.Node.prototype.moveToTop.call(this);var e=this.getStage();if(e){e.content.removeChild(this.getCanvas()._canvas);e.content.appendChild(this.getCanvas()._canvas)}},moveUp:function(){if(Kinetic.Node.prototype.moveUp.call(this)){var e=this.getStage();if(e){e.content.removeChild(this.getCanvas()._canvas);this.index<e.getChildren().length-1?e.content.insertBefore(this.getCanvas()._canvas,e.getChildren()[this.index+1].getCanvas()._canvas):e.content.appendChild(this.getCanvas()._canvas)}}},moveDown:function(){if(Kinetic.Node.prototype.moveDown.call(this)){var e=this.getStage();if(e){var t=e.getChildren();e.content.removeChild(this.getCanvas()._canvas);e.content.insertBefore(this.getCanvas()._canvas,t[this.index+1].getCanvas()._canvas)}}},moveToBottom:function(){if(Kinetic.Node.prototype.moveToBottom.call(this)){var e=this.getStage();if(e){var t=e.getChildren();e.content.removeChild(this.getCanvas()._canvas);e.content.insertBefore(this.getCanvas()._canvas,t[1].getCanvas()._canvas)}}},getLayer:function(){return this},remove:function(){var e=this.getStage(),t=this.getCanvas(),n=t._canvas;Kinetic.Node.prototype.remove.call(this);e&&n&&Kinetic.Util._isInDocument(n)&&e.content.removeChild(n);return this},getStage:function(){return this.parent}});Kinetic.Util.extend(Kinetic.Layer,Kinetic.Container);Kinetic.Factory.addGetterSetter(Kinetic.Layer,"clearBeforeDraw",!0)})();(function(){Kinetic.Util.addMethods(Kinetic.Group,{___init:function(e){this.nodeType="Group";Kinetic.Container.call(this,e)},_validateAdd:function(e){var t=e.getType();t!=="Group"&&t!=="Shape"&&Kinetic.Util.error("You may only add groups and shapes to groups.")}});Kinetic.Util.extend(Kinetic.Group,Kinetic.Container)})();(function(){Kinetic.Rect=function(e){this.___init(e)};Kinetic.Rect.prototype={___init:function(e){Kinetic.Shape.call(this,e);this.className="Rect"},drawFunc:function(e){var t=this.getCornerRadius(),n=this.getWidth(),r=this.getHeight();e.beginPath();if(!t)e.rect(0,0,n,r);else{e.moveTo(t,0);e.lineTo(n-t,0);e.arc(n-t,t,t,Math.PI*3/2,0,!1);e.lineTo(n,r-t);e.arc(n-t,r-t,t,0,Math.PI/2,!1);e.lineTo(t,r);e.arc(t,r-t,t,Math.PI/2,Math.PI,!1);e.lineTo(0,t);e.arc(t,t,t,Math.PI,Math.PI*3/2,!1)}e.closePath();e.fillStrokeShape(this)}};Kinetic.Util.extend(Kinetic.Rect,Kinetic.Shape);Kinetic.Factory.addGetterSetter(Kinetic.Rect,"cornerRadius",0)})();(function(){var e=Math.PI*2-1e-4,t="Circle";Kinetic.Circle=function(e){this.___init(e)};Kinetic.Circle.prototype={___init:function(e){Kinetic.Shape.call(this,e);this.className=t},drawFunc:function(t){t.beginPath();t.arc(0,0,this.getRadius(),0,e,!1);t.closePath();t.fillStrokeShape(this)},getWidth:function(){return this.getRadius()*2},getHeight:function(){return this.getRadius()*2},setWidth:function(e){Kinetic.Node.prototype.setWidth.call(this,e);this.setRadius(e/2)},setHeight:function(e){Kinetic.Node.prototype.setHeight.call(this,e);this.setRadius(e/2)}};Kinetic.Util.extend(Kinetic.Circle,Kinetic.Shape);Kinetic.Factory.addGetterSetter(Kinetic.Circle,"radius",0)})();(function(){var e=Math.PI*2-1e-4,t="Ellipse";Kinetic.Ellipse=function(e){this.___init(e)};Kinetic.Ellipse.prototype={___init:function(e){Kinetic.Shape.call(this,e);this.className=t},drawFunc:function(t){var n=this.getRadius();t.beginPath();t.save();n.x!==n.y&&t.scale(1,n.y/n.x);t.arc(0,0,n.x,0,e,!1);t.restore();t.closePath();t.fillStrokeShape(this)},getWidth:function(){return this.getRadius().x*2},getHeight:function(){return this.getRadius().y*2},setWidth:function(e){Kinetic.Node.prototype.setWidth.call(this,e);this.setRadius({x:e/2})},setHeight:function(e){Kinetic.Node.prototype.setHeight.call(this,e);this.setRadius({y:e/2})}};Kinetic.Util.extend(Kinetic.Ellipse,Kinetic.Shape);Kinetic.Factory.addPointGetterSetter(Kinetic.Ellipse,"radius",0)})();(function(){Kinetic.Wedge=function(e){this.___init(e)};Kinetic.Wedge.prototype={___init:function(e){Kinetic.Shape.call(this,e);this.className="Wedge"},drawFunc:function(e){e.beginPath();e.arc(0,0,this.getRadius(),0,this.getAngle(),this.getClockwise());e.lineTo(0,0);e.closePath();e.fillStrokeShape(this)}};Kinetic.Util.extend(Kinetic.Wedge,Kinetic.Shape);Kinetic.Factory.addGetterSetter(Kinetic.Wedge,"radius",0);Kinetic.Factory.addRotationGetterSetter(Kinetic.Wedge,"angle",0);Kinetic.Factory.addGetterSetter(Kinetic.Wedge,"clockwise",!1)})();(function(){var e="Image",t="crop",n="set";Kinetic.Image=function(e){this.___init(e)};Kinetic.Image.prototype={___init:function(t){var n=this;Kinetic.Shape.call(this,t);this.className=e},_useBufferCanvas:function(){return(this.hasShadow()||this.getAbsoluteOpacity()!==1)&&this.hasStroke()},drawFunc:function(e){var t=this.getWidth(),n=this.getHeight(),r=this,i,s,o;if(this.getFilter()&&this._applyFilter){this.applyFilter();this._applyFilter=!1}if(this.filterCanvas){o=this.filterCanvas._canvas;s=[o,0,0,t,n]}else{o=this.getImage();if(o){i=this.getCrop();if(i){i.x=i.x||0;i.y=i.y||0;i.width=i.width||o.width-i.x;i.height=i.height||o.height-i.y;s=[o,i.x,i.y,i.width,i.height,0,0,t,n]}else s=[o,0,0,t,n]}}e.beginPath();e.rect(0,0,t,n);e.closePath();e.fillStrokeShape(this);o&&e.drawImage.apply(e,s)},drawHitFunc:function(e){var t=this.getWidth(),n=this.getHeight(),r=this.imageHitRegion;if(r){e.drawImage(r,0,0,t,n);e.beginPath();e.rect(0,0,t,n);e.closePath();e.strokeShape(this)}else{e.beginPath();e.rect(0,0,t,n);e.closePath();e.fillStrokeShape(this)}},applyFilter:function(){var e=this.getImage(),t=this,n=this.getWidth(),r=this.getHeight(),i=this.getFilter(),s=this.getCrop()||{},o,u,a;s.x=s.x||0;s.y=s.y||0;s.width=s.width||e.width-s.x;s.height=s.height||e.height-s.y;if(this.filterCanvas&&this.filterCanvas.getWidth()===s.width&&this.filterCanvas.getHeight()===s.height){o=this.filterCanvas;o.getContext().clear()}else o=this.filterCanvas=new Kinetic.SceneCanvas({width:s.width,height:s.height,pixelRatio:1});u=o.getContext();try{u.drawImage(e,s.x,s.y,s.width,s.height,0,0,s.width,s.height);a=u.getImageData(0,0,s.width,s.height);i.call(this,a);u.putImageData(a,0,0)}catch(f){this.clearFilter();Kinetic.Util.warn("Unable to apply filter. "+f.message)}},clearFilter:function(){this.filterCanvas=null;this._applyFilter=!1},createImageHitRegion:function(e){var t=this,n=this.getWidth(),r=this.getHeight(),i=new Kinetic.SceneCanvas({width:n,height:r}),s=i.getContext()._context,o=this.getImage(),u,a,f,l,c;s.drawImage(o,0,0);try{u=s.getImageData(0,0,n,r);a=u.data;c=a.length;f=Kinetic.Util._hexToRgb(this.colorKey);for(l=0;l<c;l+=4)if(a[l+3]>0){a[l]=f.r;a[l+1]=f.g;a[l+2]=f.b}Kinetic.Util._getImage(u,function(n){t.imageHitRegion=n;e&&e()})}catch(h){Kinetic.Util.warn("Unable to create image hit region. "+h.message)}},clearImageHitRegion:function(){delete this.imageHitRegion},getWidth:function(){var e=this.getImage();return this.attrs.width||(e?e.width:0)},getHeight:function(){var e=this.getImage();return this.attrs.height||(e?e.height:0)}};Kinetic.Util.extend(Kinetic.Image,Kinetic.Shape);Kinetic.Factory.addFilterGetterSetter=function(e,t,n){this.addGetter(e,t,n);this.addFilterSetter(e,t)};Kinetic.Factory.addFilterSetter=function(e,t){var r=this,i=n+Kinetic.Util._capitalize(t);e.prototype[i]=function(e){this._setAttr(t,e);this._applyFilter=!0}};Kinetic.Factory.addGetterSetter(Kinetic.Image,"image");Kinetic.Factory.addBoxGetterSetter(Kinetic.Image,"crop");Kinetic.Factory.addFilterGetterSetter(Kinetic.Image,"filter")})();(function(){Kinetic.Polygon=function(e){this.___init(e)};Kinetic.Polygon.prototype={___init:function(e){Kinetic.Shape.call(this,e);this.className="Polygon"},drawFunc:function(e){var t=this.getPoints(),n=t.length;e.beginPath();e.moveTo(t[0].x,t[0].y);for(var r=1;r<n;r++)e.lineTo(t[r].x,t[r].y);e.closePath();e.fillStrokeShape(this)}};Kinetic.Util.extend(Kinetic.Polygon,Kinetic.Shape);Kinetic.Factory.addPointsGetterSetter(Kinetic.Polygon,"points")})();(function(){function T(e){e.fillText(this.partialText,0,0)}function N(e){e.strokeText(this.partialText,0,0)}var e="auto",t="Calibri",n="canvas",r="center",i="Change.kinetic",s="2d",o="-",u="",a="left",f="\n",l="text",c="Text",h="top",p="middle",d="normal",v="px ",m=" ",g="right",y="word",b="char",w="none",E=["fontFamily","fontSize","fontStyle","padding","align","lineHeight","text","width","height","wrap"],S=E.length,x=document.createElement(n).getContext(s);Kinetic.Text=function(e){this.___init(e)};Kinetic.Text.prototype={___init:function(t){var n=this;t.width===undefined&&(t.width=e);t.height===undefined&&(t.height=e);Kinetic.Shape.call(this,t);this._fillFunc=T;this._strokeFunc=N;this.className=c;for(var r=0;r<S;r++)this.on(E[r]+i,n._setTextData);this._setTextData()},drawFunc:function(e){var t=this.getPadding(),n=this.getFontStyle(),i=this.getFontSize(),s=this.getFontFamily(),o=this.getTextHeight(),u=this.getLineHeight()*o,f=this.textArr,l=f.length,c=this.getWidth();e.setAttr("font",this._getContextFont());e.setAttr("textBaseline",p);e.setAttr("textAlign",a);e.save();e.translate(t,0);e.translate(0,t+o/2);for(var h=0;h<l;h++){var d=f[h],v=d.text,m=d.width;e.save();this.getAlign()===g?e.translate(c-m-t*2,0):this.getAlign()===r&&e.translate((c-m-t*2)/2,0);this.partialText=v;e.fillStrokeShape(this);e.restore();e.translate(0,u)}e.restore()},drawHitFunc:function(e){var t=this.getWidth(),n=this.getHeight();e.beginPath();e.rect(0,0,t,n);e.closePath();e.fillStrokeShape(this)},setText:function(e){var t=Kinetic.Util._isString(e)?e:e.toString();this._setAttr(l,t)},getWidth:function(){return this.attrs.width===e?this.getTextWidth()+this.getPadding()*2:this.attrs.width},getHeight:function(){return this.attrs.height===e?this.getTextHeight()*this.textArr.length*this.getLineHeight()+this.getPadding()*2:this.attrs.height},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},_getTextSize:function(e){var t=x,n=this.getFontSize(),r;t.save();t.font=this._getContextFont();r=t.measureText(e);t.restore();return{width:r.width,height:parseInt(n,10)}},_getContextFont:function(){return this.getFontStyle()+m+this.getFontSize()+v+this.getFontFamily()},_addTextLine:function(e,t,n){return this.textArr.push({text:e,width:t})},_getTextWidth:function(e){return x.measureText(e).width},_setTextData:function(){var t=this.getText().split("\n"),n=+this.getFontSize(),r=0,i=this.getLineHeight()*n,s=this.attrs.width,u=this.attrs.height,a=s!==e,f=u!==e,l=this.getPadding(),c=s-l*2,h=u-l*2,p=0,d=this.getWrap(),g=d!==w,y=d!==b&&g;this.textArr=[];x.save();x.font=this.getFontStyle()+m+n+v+this.getFontFamily();for(var E=0,S=t.length;E<S;++E){var T=t[E],N=this._getTextWidth(T);if(a&&N>c)while(T.length>0){var C=0,k=T.length,L="",A=0;while(C<k){var O=C+k>>>1,M=T.slice(0,O+1),_=this._getTextWidth(M);if(_<=c){C=O+1;L=M;A=_}else k=O}if(!L)break;if(y){var D=Math.max(L.lastIndexOf(m),L.lastIndexOf(o))+1;if(D>0){C=D;L=L.slice(0,C);A=this._getTextWidth(L)}}this._addTextLine(L,A);p+=i;if(!g||f&&p+i>h)break;T=T.slice(C);if(T.length>0){N=this._getTextWidth(T);if(N<=c){this._addTextLine(T,N);p+=i;break}}}else{this._addTextLine(T,N);p+=i;r=Math.max(r,N)}if(f&&p+i>h)break}x.restore();this.textHeight=n;this.textWidth=r}};Kinetic.Util.extend(Kinetic.Text,Kinetic.Shape);Kinetic.Factory.addGetterSetter(Kinetic.Text,"fontFamily",t);Kinetic.Factory.addGetterSetter(Kinetic.Text,"fontSize",12);Kinetic.Factory.addGetterSetter(Kinetic.Text,"fontStyle",d);Kinetic.Factory.addGetterSetter(Kinetic.Text,"padding",0);Kinetic.Factory.addGetterSetter(Kinetic.Text,"align",a);Kinetic.Factory.addGetterSetter(Kinetic.Text,"lineHeight",1);Kinetic.Factory.addGetterSetter(Kinetic.Text,"wrap",y);Kinetic.Factory.addGetter(Kinetic.Text,l,u);Kinetic.Factory.addSetter(Kinetic.Text,"width");Kinetic.Factory.addSetter(Kinetic.Text,"height")})();(function(){Kinetic.Line=function(e){this.___init(e)};Kinetic.Line.prototype={___init:function(e){Kinetic.Shape.call(this,e);this.className="Line"},drawFunc:function(e){var t=this.getPoints(),n=t.length,r,i;e.beginPath();e.moveTo(t[0].x,t[0].y);for(r=1;r<n;r++){i=t[r];e.lineTo(i.x,i.y)}e.strokeShape(this)}};Kinetic.Util.extend(Kinetic.Line,Kinetic.Shape);Kinetic.Factory.addPointsGetterSetter(Kinetic.Line,"points")})();(function(){Kinetic.Spline=function(e){this.___init(e)};Kinetic.Spline.prototype={___init:function(e){var t=this;Kinetic.Shape.call(this,e);this.className="Spline";this.on("pointsChange.kinetic tensionChange.kinetic",function(){t._setAllPoints()});this._setAllPoints()},drawFunc:function(e){var t=this.getPoints(),n=t.length,r=this.getTension(),i,s,o,u;e.beginPath();e.moveTo(t[0].x,t[0].y);if(r!==0&&n>2){i=this.allPoints;s=i.length;o=2;e.quadraticCurveTo(i[0].x,i[0].y,i[1].x,i[1].y);while(o<s-1)e.bezierCurveTo(i[o].x,i[o++].y,i[o].x,i[o++].y,i[o].x,i[o++].y);e.quadraticCurveTo(i[s-1].x,i[s-1].y,t[n-1].x,t[n-1].y)}else for(o=1;o<n;o++){u=t[o];e.lineTo(u.x,u.y)}e.strokeShape(this)},_setAllPoints:function(){this.allPoints=Kinetic.Util._expandPoints(this.getPoints(),this.getTension())}};Kinetic.Util.extend(Kinetic.Spline,Kinetic.Shape);Kinetic.Factory.addGetterSetter(Kinetic.Spline,"tension",1);Kinetic.Factory.addPointsGetterSetter(Kinetic.Spline,"points")})();(function(){Kinetic.Blob=function(e){this.___init(e)};Kinetic.Blob.prototype={___init:function(e){var t=this;Kinetic.Shape.call(this,e);this.className="Blob";this.on("pointsChange.kinetic tensionChange.kinetic",function(){t._setAllPoints()});this._setAllPoints()},drawFunc:function(e){var t=this.getPoints(),n=t.length,r=this.getTension(),i,s,o,u;e.beginPath();e.moveTo(t[0].x,t[0].y);if(r!==0&&n>2){i=this.allPoints;s=i.length;o=0;while(o<s-1)e.bezierCurveTo(i[o].x,i[o++].y,i[o].x,i[o++].y,i[o].x,i[o++].y)}else for(o=1;o<n;o++){u=t[o];e.lineTo(u.x,u.y)}e.closePath();e.fillStrokeShape(this)},_setAllPoints:function(){var e=this.getPoints(),t=e.length,n=this.getTension(),r=Kinetic.Util,i=r._getControlPoints(e[t-1],e[0],e[1],n),s=r._getControlPoints(e[t-2],e[t-1],e[0],n);this.allPoints=Kinetic.Util._expandPoints(this.getPoints(),this.getTension());this.allPoints.unshift(i[1]);this.allPoints.push(s[0]);this.allPoints.push(e[t-1]);this.allPoints.push(s[1]);this.allPoints.push(i[0]);this.allPoints.push(e[0])}};Kinetic.Util.extend(Kinetic.Blob,Kinetic.Shape);Kinetic.Factory.addGetterSetter(Kinetic.Blob,"tension",1);Kinetic.Factory.addPointsGetterSetter(Kinetic.Blob,"points")})();(function(){Kinetic.Sprite=function(e){this.___init(e)};Kinetic.Sprite.prototype={___init:function(e){Kinetic.Shape.call(this,e);this.className="Sprite";this.anim=new Kinetic.Animation;var t=this;this.on("animationChange.kinetic",function(){t.setIndex(0)})},drawFunc:function(e){var t=this.getAnimation(),n=this.getIndex(),r=this.getAnimations()[t][n],i=this.getImage();i&&e.drawImage(i,r.x,r.y,r.width,r.height,0,0,r.width,r.height)},drawHitFunc:function(e){var t=this.getAnimation(),n=this.getIndex(),r=this.getAnimations()[t][n];e.beginPath();e.rect(0,0,r.width,r.height);e.closePath();e.fillShape(this)},_useBufferCanvas:function(){return(this.hasShadow()||this.getAbsoluteOpacity()!==1)&&this.hasStroke()},start:function(){var e=this,t=this.getLayer();this.anim.setLayers(t);this.interval=setInterval(function(){var t=e.getIndex();e._updateIndex();if(e.afterFrameFunc&&t===e.afterFrameIndex){e.afterFrameFunc();delete e.afterFrameFunc;delete e.afterFrameIndex}},1e3/this.getFrameRate());this.anim.start()},stop:function(){this.anim.stop();clearInterval(this.interval)},afterFrame:function(e,t){this.afterFrameIndex=e;this.afterFrameFunc=t},_updateIndex:function(){var e=this.getIndex(),t=this.getAnimation(),n=this.getAnimations(),r=n[t],i=r.length;e<i-1?this.setIndex(e+1):this.setIndex(0)}};Kinetic.Util.extend(Kinetic.Sprite,Kinetic.Shape);Kinetic.Factory.addGetterSetter(Kinetic.Sprite,"animation");Kinetic.Factory.addGetterSetter(Kinetic.Sprite,"animations");Kinetic.Factory.addGetterSetter(Kinetic.Sprite,"image");Kinetic.Factory.addGetterSetter(Kinetic.Sprite,"index",0);Kinetic.Factory.addGetterSetter(Kinetic.Sprite,"frameRate",17)})();(function(){Kinetic.Path=function(e){this.___init(e)};Kinetic.Path.prototype={___init:function(e){this.dataArray=[];var t=this;Kinetic.Shape.call(this,e);this.className="Path";this.dataArray=Kinetic.Path.parsePathData(this.getData());this.on("dataChange.kinetic",function(){t.dataArray=Kinetic.Path.parsePathData(this.getData())})},drawFunc:function(e){var t=this.dataArray,n=!1;e.beginPath();for(var r=0;r<t.length;r++){var i=t[r].command,s=t[r].points;switch(i){case"L":e.lineTo(s[0],s[1]);break;case"M":e.moveTo(s[0],s[1]);break;case"C":e.bezierCurveTo(s[0],s[1],s[2],s[3],s[4],s[5]);break;case"Q":e.quadraticCurveTo(s[0],s[1],s[2],s[3]);break;case"A":var o=s[0],u=s[1],a=s[2],f=s[3],l=s[4],c=s[5],h=s[6],p=s[7],d=a>f?a:f,v=a>f?1:a/f,m=a>f?f/a:1;e.translate(o,u);e.rotate(h);e.scale(v,m);e.arc(0,0,d,l,l+c,1-p);e.scale(1/v,1/m);e.rotate(-h);e.translate(-o,-u);break;case"z":e.closePath();n=!0}}n?e.fillStrokeShape(this):e.strokeShape(this)}};Kinetic.Util.extend(Kinetic.Path,Kinetic.Shape);Kinetic.Path.getLineLength=function(e,t,n,r){return Math.sqrt((n-e)*(n-e)+(r-t)*(r-t))};Kinetic.Path.getPointOnLine=function(e,t,n,r,i,s,o){s===undefined&&(s=t);o===undefined&&(o=n);var u=(i-n)/(r-t+1e-8),a=Math.sqrt(e*e/(1+u*u));r<t&&(a*=-1);var f=u*a,l;if(r===t)l={x:s,y:o+f};else if((o-n)/(s-t+1e-8)===u)l={x:s+a,y:o+f};else{var c,h,p=this.getLineLength(t,n,r,i);if(p<1e-8)return undefined;var d=(s-t)*(r-t)+(o-n)*(i-n);d/=p*p;c=t+d*(r-t);h=n+d*(i-n);var v=this.getLineLength(s,o,c,h),m=Math.sqrt(e*e-v*v);a=Math.sqrt(m*m/(1+u*u));r<t&&(a*=-1);f=u*a;l={x:c+a,y:h+f}}return l};Kinetic.Path.getPointOnCubicBezier=function(e,t,n,r,i,s,o,u,a){function f(e){return e*e*e}function l(e){return 3*e*e*(1-e)}function c(e){return 3*e*(1-e)*(1-e)}function h(e){return(1-e)*(1-e)*(1-e)}var p=u*f(e)+s*l(e)+r*c(e)+t*h(e),d=a*f(e)+o*l(e)+i*c(e)+n*h(e);return{x:p,y:d}};Kinetic.Path.getPointOnQuadraticBezier=function(e,t,n,r,i,s,o){function u(e){return e*e}function a(e){return 2*e*(1-e)}function f(e){return(1-e)*(1-e)}var l=s*u(e)+r*a(e)+t*f(e),c=o*u(e)+i*a(e)+n*f(e);return{x:l,y:c}};Kinetic.Path.getPointOnEllipticalArc=function(e,t,n,r,i,s){var o=Math.cos(s),u=Math.sin(s),a={x:n*Math.cos(i),y:r*Math.sin(i)};return{x:e+(a.x*o-a.y*u),y:t+(a.x*u+a.y*o)}};Kinetic.Path.parsePathData=function(e){if(!e)return[];var t=e,n=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];t=t.replace(new RegExp(" ","g"),",");for(var r=0;r<n.length;r++)t=t.replace(new RegExp(n[r],"g"),"|"+n[r]);var i=t.split("|"),s=[],o=0,u=0;for(r=1;r<i.length;r++){var a=i[r],f=a.charAt(0);a=a.slice(1);a=a.replace(new RegExp(",-","g"),"-");a=a.replace(new RegExp("-","g"),",-");a=a.replace(new RegExp("e,-","g"),"e-");var l=a.split(",");l.length>0&&l[0]===""&&l.shift();for(var c=0;c<l.length;c++)l[c]=parseFloat(l[c]);while(l.length>0){if(isNaN(l[0]))break;var h=null,p=[],d=o,v=u,m,g,y,b,w,E,S,x,T,N;switch(f){case"l":o+=l.shift();u+=l.shift();h="L";p.push(o,u);break;case"L":o=l.shift();u=l.shift();p.push(o,u);break;case"m":o+=l.shift();u+=l.shift();h="M";p.push(o,u);f="l";break;case"M":o=l.shift();u=l.shift();h="M";p.push(o,u);f="L";break;case"h":o+=l.shift();h="L";p.push(o,u);break;case"H":o=l.shift();h="L";p.push(o,u);break;case"v":u+=l.shift();h="L";p.push(o,u);break;case"V":u=l.shift();h="L";p.push(o,u);break;case"C":p.push(l.shift(),l.shift(),l.shift(),l.shift());o=l.shift();u=l.shift();p.push(o,u);break;case"c":p.push(o+l.shift(),u+l.shift(),o+l.shift(),u+l.shift());o+=l.shift();u+=l.shift();h="C";p.push(o,u);break;case"S":g=o,y=u;m=s[s.length-1];if(m.command==="C"){g=o+(o-m.points[2]);y=u+(u-m.points[3])}p.push(g,y,l.shift(),l.shift());o=l.shift();u=l.shift();h="C";p.push(o,u);break;case"s":g=o,y=u;m=s[s.length-1];if(m.command==="C"){g=o+(o-m.points[2]);y=u+(u-m.points[3])}p.push(g,y,o+l.shift(),u+l.shift());o+=l.shift();u+=l.shift();h="C";p.push(o,u);break;case"Q":p.push(l.shift(),l.shift());o=l.shift();u=l.shift();p.push(o,u);break;case"q":p.push(o+l.shift(),u+l.shift());o+=l.shift();u+=l.shift();h="Q";p.push(o,u);break;case"T":g=o,y=u;m=s[s.length-1];if(m.command==="Q"){g=o+(o-m.points[0]);y=u+(u-m.points[1])}o=l.shift();u=l.shift();h="Q";p.push(g,y,o,u);break;case"t":g=o,y=u;m=s[s.length-1];if(m.command==="Q"){g=o+(o-m.points[0]);y=u+(u-m.points[1])}o+=l.shift();u+=l.shift();h="Q";p.push(g,y,o,u);break;case"A":b=l.shift(),w=l.shift(),E=l.shift(),S=l.shift(),x=l.shift();T=o,N=u;o=l.shift(),u=l.shift();h="A";p=this.convertEndpointToCenterParameterization(T,N,o,u,S,x,b,w,E);break;case"a":b=l.shift(),w=l.shift(),E=l.shift(),S=l.shift(),x=l.shift();T=o,N=u;o+=l.shift(),u+=l.shift();h="A";p=this.convertEndpointToCenterParameterization(T,N,o,u,S,x,b,w,E)}s.push({command:h||f,points:p,start:{x:d,y:v},pathLength:this.calcLength(d,v,h||f,p)})}(f==="z"||f==="Z")&&s.push({command:"z",points:[],start:undefined,pathLength:0})}return s};Kinetic.Path.calcLength=function(e,n,r,i){var s,o,u,a=Kinetic.Path;switch(r){case"L":return a.getLineLength(e,n,i[0],i[1]);case"C":s=0;o=a.getPointOnCubicBezier(0,e,n,i[0],i[1],i[2],i[3],i[4],i[5]);for(t=.01;t<=1;t+=.01){u=a.getPointOnCubicBezier(t,e,n,i[0],i[1],i[2],i[3],i[4],i[5]);s+=a.getLineLength(o.x,o.y,u.x,u.y);o=u}return s;case"Q":s=0;o=a.getPointOnQuadraticBezier(0,e,n,i[0],i[1],i[2],i[3]);for(t=.01;t<=1;t+=.01){u=a.getPointOnQuadraticBezier(t,e,n,i[0],i[1],i[2],i[3]);s+=a.getLineLength(o.x,o.y,u.x,u.y);o=u}return s;case"A":s=0;var f=i[4],l=i[5],c=i[4]+l,h=Math.PI/180;Math.abs(f-c)<h&&(h=Math.abs(f-c));o=a.getPointOnEllipticalArc(i[0],i[1],i[2],i[3],f,0);if(l<0)for(t=f-h;t>c;t-=h){u=a.getPointOnEllipticalArc(i[0],i[1],i[2],i[3],t,0);s+=a.getLineLength(o.x,o.y,u.x,u.y);o=u}else for(t=f+h;t<c;t+=h){u=a.getPointOnEllipticalArc(i[0],i[1],i[2],i[3],t,0);s+=a.getLineLength(o.x,o.y,u.x,u.y);o=u}u=a.getPointOnEllipticalArc(i[0],i[1],i[2],i[3],c,0);s+=a.getLineLength(o.x,o.y,u.x,u.y);return s}return 0};Kinetic.Path.convertEndpointToCenterParameterization=function(e,t,n,r,i,s,o,u,a){var f=a*(Math.PI/180),l=Math.cos(f)*(e-n)/2+Math.sin(f)*(t-r)/2,c=-1*Math.sin(f)*(e-n)/2+Math.cos(f)*(t-r)/2,h=l*l/(o*o)+c*c/(u*u);if(h>1){o*=Math.sqrt(h);u*=Math.sqrt(h)}var p=Math.sqrt((o*o*u*u-o*o*c*c-u*u*l*l)/(o*o*c*c+u*u*l*l));i==s&&(p*=-1);isNaN(p)&&(p=0);var d=p*o*c/u,v=p*-u*l/o,m=(e+n)/2+Math.cos(f)*d-Math.sin(f)*v,g=(t+r)/2+Math.sin(f)*d+Math.cos(f)*v,y=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])},b=function(e,t){return(e[0]*t[0]+e[1]*t[1])/(y(e)*y(t))},w=function(e,t){return(e[0]*t[1]<e[1]*t[0]?-1:1)*Math.acos(b(e,t))},E=w([1,0],[(l-d)/o,(c-v)/u]),S=[(l-d)/o,(c-v)/u],x=[(-1*l-d)/o,(-1*c-v)/u],T=w(S,x);b(S,x)<=-1&&(T=Math.PI);b(S,x)>=1&&(T=0);s===0&&T>0&&(T-=2*Math.PI);s==1&&T<0&&(T+=2*Math.PI);return[m,g,o,u,E,T,f,s]};Kinetic.Factory.addGetterSetter(Kinetic.Path,"data")})();(function(){function r(e){e.fillText(this.partialText,0,0)}function i(e){e.strokeText(this.partialText,0,0)}var e="",t="Calibri",n="normal";Kinetic.TextPath=function(e){this.___init(e)};Kinetic.TextPath.prototype={___init:function(e){var t=this;this.dummyCanvas=document.createElement("canvas");this.dataArray=[];Kinetic.Shape.call(this,e);this._fillFunc=r;this._strokeFunc=i;this.className="TextPath";this.dataArray=Kinetic.Path.parsePathData(this.attrs.data);this.on("dataChange.kinetic",function(){t.dataArray=Kinetic.Path.parsePathData(this.attrs.data)});this.on("textChange.kinetic textStroke.kinetic textStrokeWidth.kinetic",t._setTextData);t._setTextData()},drawFunc:function(e){var t=this.charArr;e.setAttr("font",this._getContextFont());e.setAttr("textBaseline","middle");e.setAttr("textAlign","left");e.save();var n=this.glyphInfo;for(var r=0;r<n.length;r++){e.save();var i=n[r].p0,s=n[r].p1,o=parseFloat(this.attrs.fontSize);e.translate(i.x,i.y);e.rotate(n[r].rotation);this.partialText=n[r].text;e.fillStrokeShape(this);e.restore()}e.restore()},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},setText:function(e){Kinetic.Text.prototype.setText.call(this,e)},_getTextSize:function(e){var t=this.dummyCanvas,n=t.getContext("2d");n.save();n.font=this._getContextFont();var r=n.measureText(e);n.restore();return{width:r.width,height:parseInt(this.attrs.fontSize,10)}},_setTextData:function(){var e=this,t=this._getTextSize(this.attrs.text);this.textWidth=t.width;this.textHeight=t.height;this.glyphInfo=[];var n=this.attrs.text.split(""),r,i,s,o=-1,u=0,a=function(){u=0;var t=e.dataArray;for(var n=o+1;n<t.length;n++){if(t[n].pathLength>0){o=n;return t[n]}t[n].command=="M"&&(r={x:t[n].points[0],y:t[n].points[1]})}return{}},f=function(t,n){var o=e._getTextSize(t).width,f=0,l=0,c=!1;i=undefined;while(Math.abs(o-f)/o>.01&&l<25){l++;var h=f;while(s===undefined){s=a();if(s&&h+s.pathLength<o){h+=s.pathLength;s=undefined}}if(s==={}||r===undefined)return undefined;var p=!1;switch(s.command){case"L":Kinetic.Path.getLineLength(r.x,r.y,s.points[0],s.points[1])>o?i=Kinetic.Path.getPointOnLine(o,r.x,r.y,s.points[0],s.points[1],r.x,r.y):s=undefined;break;case"A":var d=s.points[4],v=s.points[5],m=s.points[4]+v;u===0?u=d+1e-8:o>f?u+=Math.PI/180*v/Math.abs(v):u-=Math.PI/360*v/Math.abs(v);if(v<0&&u<m||v>=0&&u>m){u=m;p=!0}i=Kinetic.Path.getPointOnEllipticalArc(s.points[0],s.points[1],s.points[2],s.points[3],u,s.points[6]);break;case"C":u===0?o>s.pathLength?u=1e-8:u=o/s.pathLength:o>f?u+=(o-f)/s.pathLength:u-=(f-o)/s.pathLength;if(u>1){u=1;p=!0}i=Kinetic.Path.getPointOnCubicBezier(u,s.start.x,s.start.y,s.points[0],s.points[1],s.points[2],s.points[3],s.points[4],s.points[5]);break;case"Q":u===0?u=o/s.pathLength:o>f?u+=(o-f)/s.pathLength:u-=(f-o)/s.pathLength;if(u>1){u=1;p=!0}i=Kinetic.Path.getPointOnQuadraticBezier(u,s.start.x,s.start.y,s.points[0],s.points[1],s.points[2],s.points[3])}i!==undefined&&(f=Kinetic.Path.getLineLength(r.x,r.y,i.x,i.y));if(p){p=!1;s=undefined}}};for(var l=0;l<n.length;l++){f(n[l]);if(r===undefined||i===undefined)break;var c=Kinetic.Path.getLineLength(r.x,r.y,i.x,i.y),h=0,p=Kinetic.Path.getPointOnLine(h+c/2,r.x,r.y,i.x,i.y),d=Math.atan2(i.y-r.y,i.x-r.x);this.glyphInfo.push({transposeX:p.x,transposeY:p.y,text:n[l],rotation:d,p0:r,p1:i});r=i}}};Kinetic.TextPath.prototype._getContextFont=Kinetic.Text.prototype._getContextFont;Kinetic.Util.extend(Kinetic.TextPath,Kinetic.Shape);Kinetic.Factory.addGetterSetter(Kinetic.TextPath,"fontFamily",t);Kinetic.Factory.addGetterSetter(Kinetic.TextPath,"fontSize",12);Kinetic.Factory.addGetterSetter(Kinetic.TextPath,"fontStyle",n);Kinetic.Factory.addGetter(Kinetic.TextPath,"text",e)})();(function(){Kinetic.RegularPolygon=function(e){this.___init(e)};Kinetic.RegularPolygon.prototype={___init:function(e){Kinetic.Shape.call(this,e);this.className="RegularPolygon"},drawFunc:function(e){var t=this.attrs.sides,n=this.attrs.radius,r,i,s;e.beginPath();e.moveTo(0,0-n);for(r=1;r<t;r++){i=n*Math.sin(r*2*Math.PI/t);s=-1*n*Math.cos(r*2*Math.PI/t);e.lineTo(i,s)}e.closePath();e.fillStrokeShape(this)}};Kinetic.Util.extend(Kinetic.RegularPolygon,Kinetic.Shape);Kinetic.Factory.addGetterSetter(Kinetic.RegularPolygon,"radius",0);Kinetic.Factory.addGetterSetter(Kinetic.RegularPolygon,"sides",0)})();(function(){Kinetic.Star=function(e){this.___init(e)};Kinetic.Star.prototype={___init:function(e){Kinetic.Shape.call(this,e);this.className="Star"},drawFunc:function(e){var t=e._context,n=this.attrs.innerRadius,r=this.attrs.outerRadius,i=this.attrs.numPoints;t.beginPath();t.moveTo(0,0-this.attrs.outerRadius);for(var s=1;s<i*2;s++){var o=s%2===0?r:n,u=o*Math.sin(s*Math.PI/i),a=-1*o*Math.cos(s*Math.PI/i);t.lineTo(u,a)}t.closePath();e.fillStrokeShape(this)}};Kinetic.Util.extend(Kinetic.Star,Kinetic.Shape);Kinetic.Factory.addGetterSetter(Kinetic.Star,"numPoints",0);Kinetic.Factory.addGetterSetter(Kinetic.Star,"innerRadius",0);Kinetic.Factory.addGetterSetter(Kinetic.Star,"outerRadius",0)})();(function(){var e=["fontFamily","fontSize","fontStyle","padding","lineHeight","text"],t="Change.kinetic",n="none",r="up",i="right",s="down",o="left",u="Label",a=e.length;Kinetic.Label=function(e){this.____init(e)};Kinetic.Label.prototype={____init:function(e){var t=this;this.className=u;Kinetic.Group.call(this,e);this.on("add.kinetic",function(e){t._addListeners(e.child);t._sync()})},getText:function(){return this.find("Text")[0]},getTag:function(){return this.find("Tag")[0]},_addListeners:function(n){var r=this,i,s=function(){r._sync()};for(i=0;i<a;i++)n.on(e[i]+t,s)},getWidth:function(){return this.getText().getWidth()},getHeight:function(){return this.getText().getHeight()},_sync:function(){var e=this.getText(),t=this.getTag(),n,u,a,f,l,c;if(e&&t){n=e.getWidth(),u=e.getHeight(),a=t.getPointerDirection(),f=t.getPointerWidth(),pointerHeight=t.getPointerHeight(),l=0,c=0;switch(a){case r:l=n/2;c=-1*pointerHeight;break;case i:l=n+f;c=u/2;break;case s:l=n/2;c=u+pointerHeight;break;case o:l=-1*f;c=u/2}t.setAttrs({x:-1*l,y:-1*c,width:n,height:u});e.setAttrs({x:-1*l,y:-1*c})}}};Kinetic.Util.extend(Kinetic.Label,Kinetic.Group);Kinetic.Tag=function(e){this.___init(e)};Kinetic.Tag.prototype={___init:function(e){Kinetic.Shape.call(this,e);this.className="Tag"},drawFunc:function(e){var t=this.getWidth(),n=this.getHeight(),u=this.getPointerDirection(),a=this.getPointerWidth(),f=this.getPointerHeight(),l=this.getCornerRadius();e.beginPath();e.moveTo(0,0);if(u===r){e.lineTo((t-a)/2,0);e.lineTo(t/2,-1*f);e.lineTo((t+a)/2,0)}e.lineTo(t,0);if(u===i){e.lineTo(t,(n-f)/2);e.lineTo(t+a,n/2);e.lineTo(t,(n+f)/2)}e.lineTo(t,n);if(u===s){e.lineTo((t+a)/2,n);e.lineTo(t/2,n+f);e.lineTo((t-a)/2,n)}e.lineTo(0,n);if(u===o){e.lineTo(0,(n+f)/2);e.lineTo(-1*a,n/2);e.lineTo(0,(n-f)/2)}e.closePath();e.fillStrokeShape(this)}};Kinetic.Util.extend(Kinetic.Tag,Kinetic.Shape);Kinetic.Factory.addGetterSetter(Kinetic.Tag,"pointerDirection",n);Kinetic.Factory.addGetterSetter(Kinetic.Tag,"pointerWidth",0);Kinetic.Factory.addGetterSetter(Kinetic.Tag,"pointerHeight",0);Kinetic.Factory.addGetterSetter(Kinetic.Tag,"cornerRadius",0)})();(function(){Kinetic.Filters.Grayscale=function(e){var t=e.data;for(var n=0;n<t.length;n+=4){var r=.34*t[n]+.5*t[n+1]+.16*t[n+2];t[n]=r;t[n+1]=r;t[n+2]=r}}})();(function(){Kinetic.Filters.Brighten=function(e){var t=this.getFilterBrightness(),n=e.data;for(var r=0;r<n.length;r+=4){n[r]+=t;n[r+1]+=t;n[r+2]+=t}};Kinetic.Factory.addFilterGetterSetter(Kinetic.Image,"filterBrightness",0)})();(function(){Kinetic.Filters.Invert=function(e){var t=e.data;for(var n=0;n<t.length;n+=4){t[n]=255-t[n];t[n+1]=255-t[n+1];t[n+2]=255-t[n+2]}}})();(function(){function e(){this.r=0;this.g=0;this.b=0;this.a=0;this.next=null}function r(r,i){var s=r.data,o=r.width,u=r.height,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_=i+i+1,D=o-1,P=u-1,H=i+1,B=H*(H+1)/2,j=new e,F=null,I=j,q=null,R=null,U=t[i],z=n[i];for(l=1;l<_;l++){I=I.next=new e;l==H&&(F=I)}I.next=j;d=p=0;for(f=0;f<u;f++){x=T=N=C=v=m=g=y=0;b=H*(k=s[p]);w=H*(L=s[p+1]);E=H*(A=s[p+2]);S=H*(O=s[p+3]);v+=B*k;m+=B*L;g+=B*A;y+=B*O;I=j;for(l=0;l<H;l++){I.r=k;I.g=L;I.b=A;I.a=O;I=I.next}for(l=1;l<H;l++){c=p+((D<l?D:l)<<2);v+=(I.r=k=s[c])*(M=H-l);m+=(I.g=L=s[c+1])*M;g+=(I.b=A=s[c+2])*M;y+=(I.a=O=s[c+3])*M;x+=k;T+=L;N+=A;C+=O;I=I.next}q=j;R=F;for(a=0;a<o;a++){s[p+3]=O=y*U>>z;if(O!==0){O=255/O;s[p]=(v*U>>z)*O;s[p+1]=(m*U>>z)*O;s[p+2]=(g*U>>z)*O}else s[p]=s[p+1]=s[p+2]=0;v-=b;m-=w;g-=E;y-=S;b-=q.r;w-=q.g;E-=q.b;S-=q.a;c=d+((c=a+i+1)<D?c:D)<<2;x+=q.r=s[c];T+=q.g=s[c+1];N+=q.b=s[c+2];C+=q.a=s[c+3];v+=x;m+=T;g+=N;y+=C;q=q.next;b+=k=R.r;w+=L=R.g;E+=A=R.b;S+=O=R.a;x-=k;T-=L;N-=A;C-=O;R=R.next;p+=4}d+=o}for(a=0;a<o;a++){T=N=C=x=m=g=y=v=0;p=a<<2;b=H*(k=s[p]);w=H*(L=s[p+1]);E=H*(A=s[p+2]);S=H*(O=s[p+3]);v+=B*k;m+=B*L;g+=B*A;y+=B*O;I=j;for(l=0;l<H;l++){I.r=k;I.g=L;I.b=A;I.a=O;I=I.next}h=o;for(l=1;l<=i;l++){p=h+a<<2;v+=(I.r=k=s[p])*(M=H-l);m+=(I.g=L=s[p+1])*M;g+=(I.b=A=s[p+2])*M;y+=(I.a=O=s[p+3])*M;x+=k;T+=L;N+=A;C+=O;I=I.next;l<P&&(h+=o)}p=a;q=j;R=F;for(f=0;f<u;f++){c=p<<2;s[c+3]=O=y*U>>z;if(O>0){O=255/O;s[c]=(v*U>>z)*O;s[c+1]=(m*U>>z)*O;s[c+2]=(g*U>>z)*O}else s[c]=s[c+1]=s[c+2]=0;v-=b;m-=w;g-=E;y-=S;b-=q.r;w-=q.g;E-=q.b;S-=q.a;c=a+((c=f+H)<P?c:P)*o<<2;v+=x+=q.r=s[c];m+=T+=q.g=s[c+1];g+=N+=q.b=s[c+2];y+=C+=q.a=s[c+3];q=q.next;b+=k=R.r;w+=L=R.g;E+=A=R.b;S+=O=R.a;x-=k;T-=L;N-=A;C-=O;R=R.next;p+=o}}}var t=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278
,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],n=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];Kinetic.Filters.Blur=function(e){var t=this.getFilterRadius()|0;t>0&&r(e,t)};Kinetic.Factory.addFilterGetterSetter(Kinetic.Image,"filterRadius",0)})();(function(){function e(e,t,n){var r=(n*e.width+t)*4,i=[];i.push(e.data[r++],e.data[r++],e.data[r++],e.data[r++]);return i}function t(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}function n(e){var t=[0,0,0];for(var n=0;n<e.length;n++){t[0]+=e[n][0];t[1]+=e[n][1];t[2]+=e[n][2]}t[0]/=e.length;t[1]/=e.length;t[2]/=e.length;return t}function r(r,i){var s=e(r,0,0),o=e(r,r.width-1,0),u=e(r,0,r.height-1),a=e(r,r.width-1,r.height-1),f=i||10;if(t(s,o)<f&&t(o,a)<f&&t(a,u)<f&&t(u,s)<f){var l=n([o,s,a,u]),c=[];for(var h=0;h<r.width*r.height;h++){var p=t(l,[r.data[h*4],r.data[h*4+1],r.data[h*4+2]]);c[h]=p<f?0:255}return c}}function i(e,t){for(var n=0;n<e.width*e.height;n++)e.data[4*n+3]=t[n]}function s(e,t,n){var r=[1,1,1,1,0,1,1,1,1],i=Math.round(Math.sqrt(r.length)),s=Math.floor(i/2),o=[];for(var u=0;u<n;u++)for(var a=0;a<t;a++){var f=u*t+a,l=0;for(var c=0;c<i;c++)for(var h=0;h<i;h++){var p=u+c-s,d=a+h-s;if(p>=0&&p<n&&d>=0&&d<t){var v=p*t+d,m=r[c*i+h];l+=e[v]*m}}o[f]=l===2040?255:0}return o}function o(e,t,n){var r=[1,1,1,1,1,1,1,1,1],i=Math.round(Math.sqrt(r.length)),s=Math.floor(i/2),o=[];for(var u=0;u<n;u++)for(var a=0;a<t;a++){var f=u*t+a,l=0;for(var c=0;c<i;c++)for(var h=0;h<i;h++){var p=u+c-s,d=a+h-s;if(p>=0&&p<n&&d>=0&&d<t){var v=p*t+d,m=r[c*i+h];l+=e[v]*m}}o[f]=l>=1020?255:0}return o}function u(e,t,n){var r=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],i=Math.round(Math.sqrt(r.length)),s=Math.floor(i/2),o=[];for(var u=0;u<n;u++)for(var a=0;a<t;a++){var f=u*t+a,l=0;for(var c=0;c<i;c++)for(var h=0;h<i;h++){var p=u+c-s,d=a+h-s;if(p>=0&&p<n&&d>=0&&d<t){var v=p*t+d,m=r[c*i+h];l+=e[v]*m}}o[f]=l}return o}Kinetic.Filters.Mask=function(e){var t=this.getFilterThreshold(),n=r(e,t);if(n){n=s(n,e.width,e.height);n=o(n,e.width,e.height);n=u(n,e.width,e.height);i(e,n)}return e};Kinetic.Factory.addFilterGetterSetter(Kinetic.Image,"filterThreshold",0)})();(function(){var e=function(e,t,n){e/=255;t/=255;n/=255;var r=Math.max(e,t,n),i=Math.min(e,t,n),s=r-i,o=s/2,u=s/(1-Math.abs(2*o-1)),a=0;r==e?a=(t-n)/s%6:r==t?a=(n-e)/s+2:r==n&&(a=(e-t)/s+4);return[(a*60+360)%360,u,o]},t=function(e,t,n,r){e/=255;t/=255;n/=255;var i=Math.max(e,t,n),s=Math.min(e,t,n),o=i-s,u=o/2,a=o/(1-Math.abs(2*u-1)),f=0;i==e?f=(t-n)/o%6:i==t?f=(n-e)/o+2:i==n&&(f=(e-t)/o+4);f*=60;f%=360;f+=r;f%=360;f/=60;var l=0,c=0,h=0,p=o*(1-Math.abs(f%2-1)),d=u-o/2;if(0<=f&&f<1){l=o;c=p}else if(1<=f&&f<2){c=o;l=p}else if(2<=f&&f<3){c=o;h=p}else if(3<=f&&f<4){h=o;c=p}else if(4<=f&&f<5){h=o;l=p}else if(5<=f&&f<6){l=o;h=p}l+=d;c+=d;h+=d;l=255*l;c=255*c;h=255*h;return[l,c,h]},n=function(e,n){var r=e.data,i;for(var s=0;s<r.length;s+=4){i=t(r[s+0],r[s+1],r[s+2],n);r[s+0]=i[0];r[s+1]=i[1];r[s+2]=i[2]}};Kinetic.Filters.ShiftHue=function(e){n(e,this.getFilterHueShiftDeg()%360)};Kinetic.Factory.addFilterGetterSetter(Kinetic.Image,"filterHueShiftDeg",0);Kinetic.Filters.Colorize=function(t){var r=t.data,i=this.getFilterColorizeColor(),s=e(i[0],i[1],i[2]),o=s[0];for(var u=0;u<r.length;u+=4){r[u+1]=0;r[u+2]=0}n(t,o)};Kinetic.Factory.addFilterGetterSetter(Kinetic.Image,"filterColorizeColor",[255,0,0])})();(function(){var e=function(e,t){var n=e.data,r=e.width,i=e.height,s=r*i,o,u=[];u.length=r*i*4;var a=t.length,f=t[0].length,l=Math.floor(t.length/2),c=Math.floor(t[0].length/2),h,p,d,v,m,g,y,b,w,E,S;for(g=0;g<i;g+=1)for(m=0;m<r;m+=1){h=0;p=0;d=0;v=0;for(E=0;E<a;E+=1)for(S=0;S<f;S+=1){y=(m+E-l)%r;y=y>0?y:-y;b=(g+E-c)%i;b=b>0?b:-b;w=(b*r+y)*4;h+=t[S][E]*n[w+0];p+=t[S][E]*n[w+1];d+=t[S][E]*n[w+2]}w=(g*r+m)*4;u[w+0]=h;u[w+1]=p;u[w+2]=d}var x=s*4;for(w=0;w<x;w+=4){n[w+0]=u[w+0];n[w+1]=u[w+1];n[w+2]=u[w+2]}},t=function(e,t,n){var r=e-t;return Math.pow(Math.E,-r*r/(2*n*n))},n=function(e,n,r){e%2===0&&(e+=1);var i=[],s,o,u;for(s=0;s<e;s+=1){u=[];for(o=0;o<e;o+=1)u.push(n*t(s,e/2,r)*t(o,e/2,r));i.push(u)}return i},r=function(e,n,r){e%2===0&&(e+=1);var i=[],s,o,u,a;for(s=0;s<e;s+=1){u=[];for(o=0;o<e;o+=1){g1=t(s,e/2,r)*t(o,e/2,r);g2=t(s,e/2,r*1.6)*t(o,e/2,r*1.6);u.push(n*(g2-g1))}i.push(u)}return i},i=function(e,t){var r=n(e,t,1),i=Math.floor(e/2);r[i][i]+=1-t;return r},s=function(e,t){var r=n(e,-t,1),i=Math.floor(e/2);r[i][i]+=1+t;return r};Kinetic.Factory.addFilterGetterSetter(Kinetic.Image,"filterAmount",50);Kinetic.Filters.UnsharpMask=function(t){e(t,s(5,this.getFilterAmount()/100))};Kinetic.Filters.SoftBlur=function(t){e(t,i(5,this.getFilterAmount()/100))};Kinetic.Filters.Edge=function(t){var n=this.getFilterAmount()/100;if(n===0)return;e(t,[[0,-1*n,0],[-1*n,1-n+4*n,-1*n],[0,-1*n,0]])};Kinetic.Filters.Emboss=function(t){var n=this.getFilterAmount()/100;if(n===0)return;e(t,[[-1*n,-0.5*n,0],[-0.5*n,1+.5*n,.5*n],[0,.5*n,1*n]])}})();Kinetic.Node.prototype.closest=function(e){var t=this.parent;while(t!==undefined){if(t.nodeType===e)return t;t=t.parent}return!1};Kinetic.Stage.prototype.createCopy=function(){var e=[],t=this.getChildren(),n;for(n=0;n<t.length;n++)e.push(t[n].clone());return e};Kinetic.Stage.prototype.getScaledWidth=function(){return Math.ceil(this.getWidth()/this.getScale().x)};Kinetic.Stage.prototype.getScaledHeight=function(){return Math.ceil(this.getHeight()/this.getScale().y)};Kinetic.Stage.prototype.getSaveWidth=function(){return this.im.saveWidth};Kinetic.Stage.prototype.getSaveHeight=function(){return this.im.saveHeight};Kinetic.Stage.prototype.getTotalDimensions=function(){var e=(this.getSaveHeight()/2-this.im.center.y)*this.getScale().y,t=e+this.getHeight()-this.getSaveHeight()*this.getScale().y,n=(this.getSaveWidth()/2-this.im.center.x)*this.getScale().x,r=n+this.getWidth()-this.getSaveWidth()*this.getScale().x;return{min:{x:n,y:e},max:{x:r,y:t},width:this.getScaledWidth(),height:this.getScaledHeight(),visibleWidth:Math.max(this.getSaveWidth(),this.getScaledWidth()*2-this.getSaveWidth()),visibleHeight:Math.max(this.getSaveHeight(),this.getScaledHeight()*2-this.getSaveHeight())}};Kinetic.Stage.prototype.loadCopy=function(e){var t;this.removeChildren();for(t=0;t<e.length;t++)this.add(e[t]);this.draw()};Kinetic.Stage.prototype.elementType="stage";Kinetic.Image.prototype.getImageData=function(){var e=new Kinetic.Canvas(this.attrs.image.width,this.attrs.image.height),t=e.getContext();t.drawImage(this.attrs.image,0,0);try{var n=t.getImageData(0,0,e.getWidth(),e.getHeight());return n}catch(r){Kinetic.Util.warn("Unable to get imageData.")}};Kinetic.Layer.prototype._cacheddraw=(new Kinetic.Layer).draw;Kinetic.Layer.prototype.draw=function(){if(typeof im=="undefined"||typeof im.trigger=="undefined")return this._cacheddraw();var e=this._cacheddraw();return e};Kinetic.Layer.prototype.elementType="layer";Kinetic.Group.prototype.elementType="group";Kinetic.Text.prototype.rasterize=function(e){var t=this.parent,n=this;this.toImage({callback:function(r){var i=new Kinetic.Image({image:r,x:n.getPosition().x,y:n.getPosition().y});n.remove();t.add(i).draw();e.callback(i)}})};var ImageEditor=function(e){"use strict";if(e===undefined)return this;e.pixelRatio=1;var t=this,n,r=function(e){return Math.round(e)};t.width=e.width;t.height=e.height;t.saveWidth=e.saveWidth||r(t.width/2);t.saveHeight=e.saveHeight||r(t.height/2);t.strictSize=e.saveWidth!==undefined?!0:!1;t.stage=new Kinetic.Stage(e);t.namespaces={};t.controlSets={};t.components={};t.settings=e;t.filters={};t.fileId=t.settings.fID;t.scale=1;t.crosshair=new Image;t.uniqid=t.stage.getContainer().id;t.editorContext=$(t.stage.getContainer()).parent();t.domContext=t.editorContext.parent();t.controlContext=t.domContext.children("div.controls");t.controlSetNamespaces=[];t.showLoader=$.fn.dialog.showLoader;t.hideLoader=$.fn.dialog.hideLoader;t.stage.im=t;t.stage.setX(.5);t.stage.setY(.5);t.stage.elementType="stage";t.crosshair.src="/concrete/images/image_editor/crosshair.png";t.center={x:Math.round(t.width/2),y:Math.round(t.height/2)};t.centerOffset={x:t.center.x,y:t.center.y};var i=function(e){return $(e,t.domContext)},s=function(){if(e.debug===!0&&typeof console!="undefined"){var t=arguments;t.length==1&&(t=t[0]);console.log(t)}},o=function(){if(e.debug===!0&&typeof console!="undefined"){var t=arguments;t.length==1&&(t=t[0]);console.warn(t)}},u=function(){if(typeof console!="undefined"){var e=arguments;e.length==1&&(e=e[0]);console.error("Image Editor Error: "+e)}};t.stage._setDraggable=t.stage.setDraggable;t.stage.setDraggable=function(e){o("setting draggable to "+e);return t.stage._setDraggable(e)};var a=function(){var e=this;e.history=[];e.pointer=-1;e.save=function(){t.fire("beforehistorysave");e.history=e.history.slice(0,e.pointer+1);e.history.push(t.stage.createCopy());e.movePointer(1);t.fire("historysave")};e.movePointer=function(t){e.pointer+=t;e.pointer<0&&(e.pointer=0);e.pointer>=e.history.length&&(e.pointer=e.history.length-1);return e.pointer};e.render=function(){t.fire("beforehistoryrender");t.stage.loadCopy(e.history[e.pointer]);t.fire("historyrender")};e.undo=function(){t.fire("beforehistoryundo");e.movePointer(-1);e.render();t.fire("historyundo")};e.redo=function(){t.fire("beforehistoryredo");e.movePointer(1);e.render();t.fire("historyredo")}};t.history=new a;t.bindEvent=t.bind=t.on=function(e,n,r){var i=r||t.stage.getContainer();i instanceof jQuery&&(i=i[0]);ccm_event.sub(e,n,i)};t.fireEvent=t.fire=t.trigger=function(e,n,r){var i=r||t.stage.getContainer();i instanceof jQuery&&(i=i[0]);ccm_event.pub(e,n,i)};t.addElement=function(e,n){var r=new Kinetic.Layer;e.elementType=n;r.elementType=n;r.add(e);t.stage.add(r);r.moveDown();t.stage.draw()};t.on("backgroundBuilt",function(){if(t.activeElement!==undefined&&t.activeElement.doppelganger!==undefined){t.foreground.add(t.activeElement.doppelganger);t.activeElement.doppelganger.setPosition(t.activeElement.getPosition())}});t.setActiveElement=function(e){if(e.defer)return t.setActiveElement(e.defer);if(t.activeElement==e)return;t.activeElement!==undefined&&t.activeElement.doppelganger!==undefined&&t.activeElement.doppelganger.remove();if(e===t.stage||e.nodeType=="Stage"){t.trigger("ChangeActiveAction",t.controlSetNamespaces.length?t.controlSetNamespaces[0]:undefined);$("div.control-sets",t.controlContext).find("h4.active").removeClass("active")}else if(e.doppelganger!==undefined){t.foreground.add(e.doppelganger);t.foreground.draw()}t.trigger("beforeChangeActiveElement",t.activeElement);t.alterCore("activeElement",e);t.trigger("changeActiveElement",e);t.stage.draw()};t.bind("ClickedElement",function(e){t.setActiveElement(e.eventData)});t.bind("stageChanged",function(e){(t.activeElement.getWidth()>t.stage.getScaledWidth()||t.activeElement.getHeight()>t.stage.getScaledHeight())&&t.setActiveElement(t.stage)});var f=i(t.stage.getContainer()).parent().children(".bottomBar");f.attr("unselectable","on");var l={};l.zoomIn=i("<div class='bottombarbutton plus'><i class='icon-plus'></i></div>");l.zoomOut=i("<div class='bottombarbutton'><i class='icon-minus'></i></div>");l.zoomIn.appendTo(f);l.zoomOut.appendTo(f);l.zoomIn.click(function(e){t.fire("zoomInClick",e)});l.zoomOut.click(function(e){t.fire("zoomOutClick",e)});var c=i("<div></div>").addClass("scale").text("100%");t.on("scaleChange",function(e){c.text(Math.round(t.scale*1e4)/100+"%")});c.click(function(){t.scale=1;t.stage.setScale(t.scale);var e=t.stage.getDragBoundFunc()({x:t.stage.getX(),y:t.stage.getY()});t.stage.setX(e.x);t.stage.setY(e.y);t.fire("scaleChange");t.buildBackground();t.stage.draw()});c.appendTo(f);var h=0,p=3e3,d=5/6;t.on("zoomInClick",function(e){var n=(-t.stage.getX()+t.stage.getWidth()/2)/t.scale,r=(-t.stage.getY()+t.stage.getHeight()/2)/t.scale;t.scale/=d;t.scale=Math.round(t.scale*1e3)/1e3;t.alterCore("scale",t.scale);var i=(-t.stage.getX()+t.stage.getWidth()/2)/t.scale,s=(-t.stage.getY()+t.stage.getHeight()/2)/t.scale;t.stage.setX(t.stage.getX()-(n-i)*t.scale);t.stage.setY(t.stage.getY()-(r-s)*t.scale);t.stage.setScale(t.scale);var o=t.stage.getDragBoundFunc()({x:t.stage.getX(),y:t.stage.getY()});t.stage.setX(o.x);t.stage.setY(o.y);t.fire("scaleChange");t.buildBackground();t.stage.draw()});t.on("zoomOutClick",function(e){var n=(-t.stage.getX()+t.stage.getWidth()/2)/t.scale,r=(-t.stage.getY()+t.stage.getHeight()/2)/t.scale;t.scale*=d;t.scale=Math.round(t.scale*1e3)/1e3;t.alterCore("scale",t.scale);var i=(-t.stage.getX()+t.stage.getWidth()/2)/t.scale,s=(-t.stage.getY()+t.stage.getHeight()/2)/t.scale;t.stage.setX(t.stage.getX()-(n-i)*t.scale);t.stage.setY(t.stage.getY()-(r-s)*t.scale);t.stage.setScale(t.scale);var o=t.stage.getDragBoundFunc()({x:t.stage.getX(),y:t.stage.getY()});t.stage.setX(o.x);t.stage.setY(o.y);t.fire("scaleChange");t.buildBackground();t.stage.draw()});var v={};v.width=i("<span/>").addClass("saveWidth");v.height=i("<span/>").addClass("saveHeight");v.crop=i('<div><i class="icon-resize-full"/></div>').addClass("bottombarbutton").addClass("crop");v.both=v.height.add(v.width).width(32).attr("contenteditable",!0);v.area=i("<span/>").css({"float":"right"});t.on("adjustedsavers",function(){v.width.text(t.saveWidth);v.height.text(t.saveHeight)});v.crop.click(function(){t.adjustSavers()});t.strictSize?v.both.attr("disabled","true"):v.both.keyup(function(e){t.fire("editedSize",e)});t.bind("editedSize",function(e){t.saveWidth=parseInt(v.width.text());t.saveHeight=parseInt(v.height.text());isNaN(t.saveWidth)&&(t.saveWidth=0);isNaN(t.saveHeight)&&(t.saveHeight=0);t.buildBackground()});t.bind("saveSizeChange",function(){v.width.text(t.saveWidth);v.height.text(t.saveHeight)});t.setCursor=function(e){$(t.stage.getContainer()).css("cursor",e)};t.save=function(){t.background.hide();t.stage.setScale(1);t.fire("ChangeActiveAction");t.fire("changeActiveComponent");t.background.hide();t.foreground.hide();$(t.stage.getContainer()).hide();var e=Math.round(t.center.x-t.saveWidth/2),n=Math.round(t.center.y-t.saveHeight/2),r=t.stage.getX(),i=t.stage.getY(),s=t.stage.getWidth(),o=t.stage.getHeight();t.stage.setX(-e);t.stage.setY(-n);t.stage.setWidth(Math.max(t.stage.getWidth(),t.saveWidth));t.stage.setHeight(Math.max(t.stage.getHeight(),t.saveHeight));t.stage.draw();t.showLoader("Saving..");t.stage.toDataURL({width:t.saveWidth,height:t.saveHeight,callback:function(e){var n=$("<img/>").attr("src",e);$.fn.dialog.open({element:$(n).width(250)});t.hideLoader();t.background.show();t.foreground.show();t.stage.setX(r);t.stage.setY(i);t.stage.setWidth(s);t.stage.setHeight(o);t.stage.setScale(t.scale);t.stage.draw();$(t.stage.getContainer()).show()}})};t.save=function(){t.fire("ChangeActiveAction");var e=t.stage.getPosition(),n=t.scale;t.stage.setPosition(-t.saveArea.getX(),-t.saveArea.getY());t.stage.setScale(1);t.background.hide();t.foreground.hide();t.stage.draw();t.stage.toDataURL({width:t.saveWidth,height:t.saveHeight,callback:function(r){t.stage.setPosition(e);t.background.show();t.foreground.show();t.stage.setScale(n);t.stage.draw();$.post("/index.php/tools/files/importers/imageeditor",{fID:t.fileId,imgData:r},function(e){var t=JSON.parse(e);t.error===1?alert(t.message):window.location=window.location})}})};t.actualPosition=function(e,n,r,i,s){var o=n-i,u=e-r,a=t.activeElement.getRotation()+Math.atan2(o,u),f=Math.sqrt(Math.pow(u,2)+Math.pow(o,2));return[r+f*Math.cos(a),i+f*Math.sin(a)]};t.getActualRect=function(e,n,r){var i=[],s=r.getRotation();i.push(t.actualPosition(r.getX(),r.getY(),e,n,s));i.push(t.actualPosition(r.getX()+r.getWidth()*r.getScaleX(),r.getY(),e,n,s));i.push(t.actualPosition(r.getX()+r.getWidth()*r.getScaleX(),r.getY()+r.getHeight()*r.getScaleY(),e,n,s));i.push(t.actualPosition(r.getX(),r.getY()+r.getHeight()*r.getScaleY(),e,n,s));return i};t.adjustSavers=function(e){if(t.activeElement.nodeType==="Stage")return;t.foreground.autoCrop=!1;t.background.autoCrop=!1;var n,r,i,s={min:{x:!1,y:!1},max:{x:!1,y:!1}},o=t.activeElement,u=o.parent,a=t.getActualRect(0,0,o);for(var i=a.length-1;i>=0;i--){var f=a[i],l=f[0]+u.getX(),c=f[1]+u.getY();if(l>s.max.x||s.max.x===!1)s.max.x=l;if(l<s.min.x||s.min.x===!1)s.min.x=l;if(c>s.max.y||s.max.y===!1)s.max.y=c;if(c<s.min.y||s.min.y===!1)s.min.y=c}var h={width:s.max.x-s.min.x,height:s.max.y-s.min.y};t.alterCore("saveWidth",Math.round(h.width));t.alterCore("saveHeight",Math.round(h.height));t.buildBackground();var p=[t.center.x-t.activeElement.getWidth()*t.activeElement.getScaleX()/2,t.center.y-t.activeElement.getHeight()*t.activeElement.getScaleY()/2],d=t.actualPosition(p[0],p[1],t.center.x,t.center.y,t.activeElement.getRotation());t.activeElement.parent.setPosition(d.map(Math.round));e!==!1&&t.fire("adjustedsavers");t.stage.draw()};t.bind("imageLoad",function(){setTimeout(t.adjustSavers,0)});t.extend=function(e,t){this[e]=t};t.alterCore=function(e,n){var r=t,i="core",s;if(t.namespace){var i=r.namespace;r=t.realIm}t[e]=n;for(s in t.controlSets)t.controlSets[s].im.extend(e,n);for(s in t.filters)t.filters[s].im.extend(e,n);for(s in t.components)t.components[s].im.extend(e,n)};t.clone=function(e){var n=new ImageEditor,r;n.realIm=t;for(r in t)n[r]=t[r];n.namespace=e;return n};t.addControlSet=function(e,n,r){jQuery&&r instanceof jQuery&&(r=r[0]);r.controlSet=function(t,n){t.disable=function(){t.enabled=!1;$(r).parent().parent().addClass("disabled")};t.enable=function(){t.enabled=!0;$(r).parent().parent().removeClass("disabled")};this.im=t;this.$=$;o("Loading ControlSet",t);try{(new Function("im","$",n)).call(this,t,$)}catch(i){console.log(i.stack);var s=i.stack.replace(/[\S\s]+at HTMLDivElement.eval.+?<anonymous>:(\d+:\d+)[\S\s]+/,"$1").split(":");if(s[1]&&!isNaN(parseInt(s[1]))){var a=n.split("\n"),f="Parse error at line #"+s[0]+" char #"+s[1]+" within "+e;f+="\n"+a[parseInt(s[0])-1];f+="\n"+(new Array(parseInt(s[1]))).join(" ")+"^";u(f)}else u('"'+i.message+'" in "'+t.namespace+'"')}return this};var i=t.clone(e),s=r.controlSet.call(r,i,n);t.controlSets[e]=s;return s};t.addFilter=function(e,n){var r=function(t,n){this.namespace=t.namespace;this.im=t;try{(new Function("im","$",n)).call(this,t,$)}catch(r){u(r);window.lastError=r;var i=r.stack.replace(/[\S\s]+at HTMLDivElement.eval.+?<anonymous>:(\d+:\d+)[\S\s]+/,"$1").split(":");if(i.length!=2){u(r.message);u(r.stack)}else{var s=n.split("\n"),o="Parse error at line #"+i[0]+" char #"+i[1]+" within "+e;o+="\n"+s[parseInt(i[0])-1];o+="\n"+(new Array(parseInt(i[1])||0)).join(" ")+"^";u(o)}}return this},i=t.clone(e),s=new r(i,n);t.filters[e]=s;return s};t.addComponent=function(e,n,r){jQuery&&r instanceof jQuery&&(r=r[0]);r.component=function(t,n){t.disable=function(){$(this).parent().parent().addClass("disabled")};t.enable=function(){$(this).parent().parent().removeClass("disabled")};this.im=t;o("Loading component",t);try{(new Function("im","$",n)).call(this,t,$)}catch(r){var i=r.stack.replace(/[\S\s]+at HTMLDivElement.eval.+?<anonymous>:(\d+:\d+)[\S\s]+/,"$1").split(":");if(i[1]&&!isNaN(parseInt(i[1]))){var s=n.split("\n"),a="Parse error at line #"+i[0]+" char #"+i[1]+" within "+e;a+="\n"+s[parseInt(i[0])-1];a+="\n"+(new Array(parseInt(i[1]))).join(" ")+"^";u(a)}else u('"'+r.message+'" in "'+t.namespace+'"')}return this};var i=t.clone(e),s=r.component.call(r,i,n);t.components[e]=s;return s};t.background=new Kinetic.Layer;t.foreground=new Kinetic.Layer;t.stage.add(t.background);t.stage.add(t.foreground);t.bgimage=new Image;t.saveArea=new Kinetic.Rect;t.background.add(t.saveArea);t.bind("load",function(){t.saveArea.setFillPatternImage(t.bgimage);t.saveArea.setFillPatternOffset([-(t.saveWidth/2),-(t.saveHeight/2)]);t.saveArea.setFillPatternScale(1/t.scale);t.saveArea.setFillPatternX(0);t.saveArea.setFillPatternY(0);t.saveArea.setFillPatternRepeat("repeat");t.background.on("click",function(){t.setActiveElement(t.stage)})},t.bgimage);t.bgimage.src="/concrete/images/testbg.png";t.buildBackground=function(){var e=(new Date).getTime(),n=t.stage.getTotalDimensions(),r=(n.max.x+n.visibleHeight+n.visibleWidth)*2;t.saveArea.setFillPatternOffset([-(t.saveWidth/2)*t.scale,-(t.saveHeight/2)*t.scale]);t.saveArea.setX(Math.round(t.center.x-t.saveWidth/2));t.saveArea.setY(Math.round(t.center.y-t.saveHeight/2));t.saveArea.setFillPatternScale(1/t.scale);t.saveArea.setWidth(t.saveWidth);t.saveArea.setHeight(t.saveHeight);if(!t.coverLayer){t.coverLayer=new Kinetic.Rect;t.coverLayer.setStroke("rgba(150,150,150,.5)");t.coverLayer.setFill("transparent");t.coverLayer.setListening(!1);t.coverLayer.setStrokeWidth(Math.max(n.width,n.height,500));t.foreground.add(t.coverLayer)}var i=Math.max(n.width,n.height)*2;t.coverLayer.setPosition(t.saveArea.getX()-i/2,t.saveArea.getY()-i/2);t.coverLayer.setSize(t.saveArea.getWidth()+i,t.saveArea.getHeight()+i);t.coverLayer.setStrokeWidth(i);t.fire("backgroundBuilt");t.saveArea.draw();t.coverLayer.draw()};t.buildBackground();t.on("stageChanged",t.buildBackground);t.stage.setDragBoundFunc(function(e){var n=t.stage.getTotalDimensions(),r=Math.max(n.max.x,n.min.x)-1,i=Math.min(n.max.x,n.min.x)+1,s=Math.max(n.max.y,n.min.y)-1,o=Math.min(n.max.y,n.min.y)+1;e.x=Math.floor(e.x);e.y=Math.floor(e.y);e.x>r&&(e.x=r);e.x<i&&(e.x=i);e.y>s&&(e.y=s);e.y<o&&(e.y=o);e.x=Math.floor(e.x);e.y=Math.floor(e.y);return e});t.setActiveElement(t.stage);t.stage.setDraggable(!0);t.autoCrop=!0;t.on("imageLoad",function(){var e=100,n=t.stage.getWidth()-e*2,r=t.stage.getHeight()-e*2;if(t.saveWidth<n&&t.saveHeight<r)return;var i=Math.max(t.saveWidth/n,t.saveHeight/r);t.stage.setX((t.stage.getWidth()-t.stage.getWidth()*t.stage.getScale().x)/2);t.stage.setY((t.stage.getHeight()-t.stage.getHeight()*t.stage.getScale().y)/2);var s=t.stage.getDragBoundFunc()({x:t.stage.getX(),y:t.stage.getY()});t.stage.setX(s.x);t.stage.setY(s.y);t.fire("scaleChange");t.fire("stageChanged");t.buildBackground()});t.fit=function(e,n){if(n===!1)return{width:t.saveWidth,height:t.saveHeight};var r=e.height,i=e.width;if(i>t.saveWidth){r/=i/t.saveWidth;i=t.saveWidth}if(r>t.saveHeight){i/=r/t.saveHeight;r=t.saveHeight}return{width:i,height:r}};if(e.src){t.showLoader("Loading Image..");var m=new Image,g=!1;t.bind("ControlSetsLoaded",function(){g=!0});t.bind("load",function(){if(!t.strictSize){t.saveWidth=m.width;t.saveHeight=m.height;t.fire("saveSizeChange");t.buildBackground()}var e={x:Math.floor(t.center.x-m.width/2),y:Math.floor(t.center.y-m.height/2)},n=new Kinetic.Image({image:m,x:0,y:0});t.addElement(n,"image");n.setPosition(e);t.fire("imageload");var r=function(){setTimeout(function(){t.setActiveElement(n);t.fire("changeActiveAction",t.controlSetNamespaces[0])},0)};g?r():t.bind("ControlSetsLoaded",r)},m);m.src=e.src}else t.fire("imageload");t.bind("imageload",function(){var n=e.controlsets||{},r=e.filters||{},i,o,u=0;s("Loading ControlSets");t.showLoader("Loading Control Sets..");t.fire("LoadingControlSets");for(i in n){var a="ControlSet_"+i;t.controlSetNamespaces.push(a);$.ajax(n[i].src,{dataType:"text",cache:!1,namespace:i,myns:a,beforeSend:function(){u++},success:function(e){u--;var r=t.addControlSet(this.myns,e,n[this.namespace].element);s(r);t.fire("controlSetLoad",r);0==u&&t.trigger("ControlSetsLoaded")},error:function(e,n,r){u--;0==u&&t.trigger("ControlSetsLoaded")}})}});t.bind("ControlSetsLoaded",function(){t.fire("LoadingComponents");t.showLoader("Loading Components..");var n=e.components||{},r,i=0;s("Loading Components");for(r in n){var o="Component_"+r;$.ajax(n[r].src,{dataType:"text",cache:!1,namespace:r,myns:o,beforeSend:function(){i++},success:function(e){i--;var r=t.addComponent(this.myns,e,n[this.namespace].element);s(r);t.fire("ComponentLoad",r);0==i&&t.trigger("ComponentsLoaded")},error:function(e,n,r){i--;0==i&&t.trigger("ComponentsLoaded")}})}0==i&&t.trigger("ComponentsLoaded")});t.bind("ComponentsLoaded",function(){s("Loading Filters");t.showLoader("Loading Filters..");var n=e.filters||{},r,i,o,u=0;t.fire("LoadingFilters");for(r in n){var a="Filter_"+r,f=n[r].name;i||(i=a);u++;$.ajax(n[r].src,{dataType:"text",cache:!1,namespace:r,myns:a,name:f,success:function(e){var n=t.addFilter(this.myns,e);n.name=this.name;t.fire("filterLoad",n);u--;0==u&&t.trigger("FiltersLoaded")},error:function(e,n,r){u--;0==u&&t.trigger("FiltersLoaded")}})}});t.bind("ChangeActiveAction",function(e){var n=e.eventData;if(n===t.activeControlSet)return;for(var r in t.controlSets){i(t.controlSets[r]);r!==n&&i(t.controlSets[r]).slideUp()}t.activeControlSet=n;t.alterCore("activeControlSet",n);if(!n){$("div.control-sets",t.controlContext).find("h4.active").removeClass("active");return}var s=$(t.controlSets[n]),o=s.show().height();if(s.length==0)return;s.hide().height(o).slideDown(function(){$(this).height("")})});t.bind("ChangeActiveComponent",function(e){var n=e.eventData;if(n===t.activeComponent)return;for(var r in t.components)r!==n&&i(t.components[r]).slideUp();t.activeComponent=n;t.alterCore("activeComponent",n);if(!n)return;var s=$(t.components[n]),o=s.show().height();if(s.length==0)return;s.hide().height(o).slideDown(function(){$(this).height("")})});t.bind("ChangeNavTab",function(e){s("changenavtab",e);t.trigger("ChangeActiveAction",e.eventData);t.trigger("ChangeActiveComponent",e.eventData);var n=i("div.editorcontrols");switch(e.eventData){case"add":n.children("div.control-sets").hide();n.children("div.components").show();break;case"edit":n.children("div.components").hide();n.children("div.control-sets").show()}});t.bind("FiltersLoaded",function(){t.hideLoader()});t.slideOut=$("<div/>").addClass("slideOut").css({width:0,"float":"right",height:"100%","overflow-x":"hidden",right:t.controlContext.width()-1,position:"absolute",background:"white","box-shadow":"black -20px 0 20px -25px"});t.slideOutContents=$("<div/>").appendTo(t.slideOut).width(300);t.showSlideOut=function(e,n){t.hideSlideOut(function(){t.slideOut.empty();t.slideOutContents=e.width(300);t.slideOut.append(t.slideOutContents);t.slideOut.addClass("active").addClass("sliding");t.slideOut.stop(1).slideOut(300,function(){t.slideOut.removeClass("sliding");typeof n=="function"&&n()})})};t.hideSlideOut=function(e){t.slideOut.addClass("sliding");t.slideOut.slideIn(300,function(){t.slideOut.css("border-right","0");t.slideOut.removeClass("active").removeClass("sliding");typeof e=="function"&&e()})};t.controlContext.after(t.slideOut);t.setActiveElement(t.stage);window.c5_image_editor=t;window.im=t;return t};$.fn.ImageEditor=function(e){e===undefined&&(e={});e.imageload=$.fn.dialog.hideLoader;var t=$(this);e.container=t[0];if(t.height()==0){setTimeout(function(){t.ImageEditor(e)},50);return}t.closest(".ui-dialog").find(".ui-resizable-handle").hide();t.height("-=30");$("div.editorcontrols").height(t.height()-90);t.width("-=330").parent().width("-=330").children("div.bottomBar").width("-=330");e.width===undefined&&(e.width=t.width());e.height===undefined&&(e.height=t.height());$.fn.dialog.showLoader();var n=new ImageEditor(e),r=n.domContext;n.on("ChangeActiveAction",function(e){e.eventData||$("h4.active",r).removeClass("active")});n.on("ChangeActiveComponent",function(e){e.eventData||$("h4.active",r).removeClass("active")});$("div.controls > div.controlscontainer",r).children("div.save").children("button.save").click(function(){n.save()}).end().children("button.cancel").click(function(){confirm("Are you certain?")&&$.fn.dialog.closeTop()});$("div.controls > div.controlscontainer",r).children("ul.nav").children().click(function(){if($(this).hasClass("active"))return!1;$("div.controls > div.controlscontainer",r).children("ul.nav").children().removeClass("active");$(this).addClass("active");n.trigger("ChangeNavTab",$(this).text().toLowerCase());return!1});$("div.controlset",r).find("div.control").children("div.contents").slideUp(0).end().end().find("h4").click(function(){if($(this).parent().hasClass("disabled"))return;$(this).addClass("active");$("div.controlset",r).find("h4").not($(this)).removeClass("active");var e=$(this).parent().attr("data-namespace");n.trigger("ChangeActiveAction","ControlSet_"+e)});$("div.component",r).find("div.control").children("div.contents").slideUp(0).hide().end().end().find("h4").click(function(){if($(this).hasClass("active"))return!1;$(this).addClass("active");$("div.component",r).children("h4").not($(this)).removeClass("active");var e=$(this).parent().attr("data-namespace");n.trigger("ChangeActiveComponent","Component_"+e)});$("div.components").hide();n.bind("imageload",$.fn.dialog.hideLoader);return n};$.fn.slideOut=function(e,t){var n=$(this),r=n.width(),i=300;n.css("overflow-y","auto");if(r==i){n.animate({width:i},0,t);return this}n.width(r).animate({width:i},e||300,t||function(){});return this};$.fn.slideIn=function(e,t){var n=$(this);n.css("overflow-y","hidden");if(n.width()===0){n.animate({width:0},0,t);return this}n.animate({width:0},e||300,t||function(){});return this};ImageEditor.prototype=ImageEditor.fn={filter:{grayscale:Kinetic.Filters.Grayscale,sepia:function(e){var t,n=e.data;for(t=0;t<n.length;t+=4){n[t]=n[t]*.393+n[t+1]*.769+n[t+2]*.189;n[t+1]=n[t]*.349+n[t+1]*.686+n[t+2]*.168;n[t+2]=n[t]*.272+n[t+1]*.534+n[t+2]*.131}},brightness:function(e,t){var n=t.level,r=e.data;for(var i=0;i<r.length;i+=4){r[i]+=n;r[i+1]+=n;r[i+2]+=n}},invert:function(e,t){var n=e.data;for(var r=0;r<n.length;r+=4){n[r]=255-n[r];n[r+1]=255-n[r+1];n[r+2]=255-n[r+2]}},restore:function(e,t){var n=t.level,r=e.data,i=t.imageData.data;for(var s=0;s<r.length;s+=4){r[s]=i[s];r[s+1]=i[s+1];r[s+2]=i[s+2]}}}};