(function(e,t){"use strict";e.extend(e.fn,{ccmconversation:function(t){return this.each(function(){var r=e(this),i=r.data("ccmconversation");i||r.data("ccmconversation",i=new n(r,t))})}});var n=function(e,t){this.publish("beforeInitializeConversation",{element:e,options:t});this.init(e,t);this.publish("initializeConversation",{element:e,options:t})};n.fn=n.prototype={publish:function(e,n){n=n||{};n.CCMConversation=this;t.ccm_event.publish(e,n)},init:function(t,n){var r=this;r.$element=t;r.options=e.extend({method:"ajax",displayMode:"threaded",paginate:!1,itemsPerPage:-1},n);var i=r.options.posttoken!=""?1:0,s=r.options.paginate?1:0,o=r.options.orderBy,u=r.options.enableOrdering;if(r.options.method=="ajax")r.$element.load(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:r.options.cnvID,enablePosting:i,itemsPerPage:r.options.itemsPerPage,paginate:s,displayMode:r.options.displayMode,orderBy:o,enableOrdering:u},function(e){r.attachBindings();r.publish("conversationLoaded")});else{r.attachBindings();r.finishSetup();r.publish("conversationLoaded")}},attachBindings:function(){var t=this,n=t.options.paginate?1:0,r=t.options.posttoken!=""?1:0;t.$replyholder=t.$element.find("div.ccm-conversation-add-reply");t.$newmessageform=t.$element.find("div.ccm-conversation-add-new-message form");t.$deleteholder=t.$element.find("div.ccm-conversation-delete-message");t.$messagelist=t.$element.find("div.ccm-conversation-message-list");t.$messagecnt=t.$element.find(".ccm-conversation-message-count");t.$postbuttons=t.$element.find("button[data-submit=conversation-message]");t.$sortselect=t.$element.find("select[data-sort=conversation-message-list]");t.$loadmore=t.$element.find("[data-load-page=conversation-message-list]");t.$messages=t.$element.find("div.ccm-conversation-messages");t.$newmessageform.dropzone({url:CCM_TOOLS_PATH+"/conversations/add_file"});t.$postbuttons.on("click",function(){t.submitForm(e(this));return!1});t.$element.on("click","a[data-toggle=conversation-reply]",function(){var n=t.$replyholder.appendTo(e(this).closest("div[data-conversation-message-id]"));n.attr("data-form","conversation-reply").show();n.find("button[data-submit=conversation-message]").attr("data-post-parent-id",e(this).attr("data-post-parent-id"));return!1});t.$element.on("click","a[data-submit=delete-conversation-message]",function(){var n=e(this);t.$deletedialog=t.$deleteholder.clone();t.$deletedialog.dialog?t.$deletedialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:t.$deleteholder.attr("data-dialog-title"),buttons:[{text:t.$deleteholder.attr("data-cancel-button-title"),"class":"btn pull-left",click:function(){t.$deletedialog.dialog("close")}},{text:t.$deleteholder.attr("data-confirm-button-title"),"class":"btn pull-right btn-danger",click:function(){t.deleteMessage(n.attr("data-conversation-message-id"))}}]}):confirm("Remove this message? Replies to it will not be removed.")&&t.deleteMessage(n.attr("data-conversation-message-id"));return!1});t.$element.on("change","select[data-sort=conversation-message-list]",function(){t.$messagelist.load(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:t.options.cnvID,task:"get_messages",enablePosting:r,displayMode:t.options.displayMode,itemsPerPage:t.options.itemsPerPage,paginate:n,orderBy:e(this).val(),enableOrdering:t.options.enableOrdering},function(e){t.$replyholder.appendTo(t.$element)})});t.$element.on("click","[data-load-page=conversation-message-list]",function(){var n=parseInt(t.$loadmore.attr("data-next-page")),i=parseInt(t.$loadmore.attr("data-total-pages")),s={cnvID:t.options.cnvID,itemsPerPage:t.options.itemsPerPage,displayMode:t.options.displayMode,enablePosting:r,page:n,orderBy:t.$sortselect.val()};e.ajax({type:"post",data:s,url:CCM_TOOLS_PATH+"/conversations/message_page",success:function(e){t.$messages.append(e);n+1>i?t.$loadmore.hide():t.$loadmore.attr("data-next-page",n+1)}})})},handlePostError:function(t,n){if(!n)var n=["An unspecified error occurred."];obj.publish("conversationPostError",{messages:n});var r="";e.each(n,function(e,t){r+=t+"<br>"});t.find("div.ccm-conversation-errors").html(r).show()},deleteMessage:function(t){var n=this;n.publish("conversationBeforeDeleteMessage",{msgID:t});var r=[{name:"cnvMessageID",value:t}];e.ajax({type:"post",data:r,url:CCM_TOOLS_PATH+"/conversations/delete_message",success:function(r){var i=e("div[data-conversation-message-id="+t+"]");i.length&&i.after(r).remove();n.updateCount();n.$deletedialog.dialog&&n.$deletedialog.dialog("close");n.publish("conversationDeleteMessage",{msgID:t})},error:function(e){n.publish("conversationDeleteMessageError",{msgID:t,error:arguments});alert("Something went wrong while deleting this message, please refresh and try again.")}})},addMessageFromJSON:function(t,n){var r=this;r.publish("conversationBeforeAddMessageFromJSON",{json:n,form:t});var i=r.options.posttoken!=""?1:0,s=[{name:"cnvMessageID",value:n.cnvMessageID},{name:"enablePosting",value:i},{name:"displayMode",value:r.options.displayMode}];e.ajax({type:"post",data:s,url:CCM_TOOLS_PATH+"/conversations/message_detail",success:function(i){var s=e("div[data-conversation-message-id="+n.cnvMessageParentID+"]");if(s.length){s.after(i);r.$replyholder.appendTo(r.$element);r.$replyholder.hide()}else{r.$messages.prepend(i);r.$element.find(".ccm-conversation-no-messages").hide()}r.publish("conversationAddMessageFromJSON",{json:n,form:t});r.updateCount()}})},updateCount:function(){var e=this;e.publish("conversationBeforeUpdateCount");e.$messagecnt.load(CCM_TOOLS_PATH+"/conversations/count_header",{cnvID:e.options.cnvID},function(){e.publish("conversationUpdateCount")})},submitForm:function(t){var n=this;n.publish("conversationBeforeSubmitForm");var r=t.closest("form");t.prop("disabled",!0);r.parent().addClass("ccm-conversation-form-submitted");var i=r.serializeArray(),s=t.attr("data-post-parent-id");i.push({name:"token",value:n.options.posttoken},{name:"cnvID",value:n.options.cnvID},{name:"cnvMessageParentID",value:s});e.ajax({dataType:"json",type:"post",data:i,url:CCM_TOOLS_PATH+"/conversations/add_message",success:function(e){if(!e){n.handlePostError(r);return!1}if(e.error){n.handlePostError(r,e.messages);return!1}n.addMessageFromJSON(r,e);n.publish("conversationSubmitForm")},error:function(e){n.handlePostError(r);return!1},complete:function(e){t.prop("disabled",!1);r.parent().closest(".ccm-conversation-form-submitted").removeClass("ccm-conversation-form-submitted")}})}}})(jQuery,window);