$.fn.ccmconversation=function(e){return $.each($(this),function(){var t=$(this),n=t.data("ccmconversation");n||t.data("ccmconversation",n=new CCMConversation(this,e))})};var CCMConversation=function(e,t){var n=this;n.$element=$(e);n.options=$.extend({method:"ajax"},t);var r=n.options.posttoken!=""?1:0;n.options.method=="ajax"?n.$element.load(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:n.options.cnvID,enablePosting:r},function(e){n._init()}):n.init()};CCMConversation.prototype._init=function(){var e=this;e.$replyholder=e.$element.find("div.ccm-conversation-add-reply");e.$deleteholder=e.$element.find("div.ccm-conversation-delete-message");e.$messagelist=e.$element.find("div.ccm-conversation-message-list");e.$messagecnt=e.$element.find(".ccm-conversation-message-count");e.$postbuttons=e.$element.find("button[data-submit=conversation-message]");e.$sortselect=e.$element.find("select[data-sort=conversation-message-list]");e.$postbuttons.unbind().on("click",function(){e._submitForm($(this));return!1});e.$element.find("a[data-toggle=conversation-reply]").unbind().on("click",function(){var t=e.$replyholder.appendTo($(this).closest("div[data-conversation-message-id]"));t.attr("data-form","conversation-reply").show();t.find("button[data-submit=conversation-message]").attr("data-post-parent-id",$(this).attr("data-post-parent-id"));return!1});e.$element.find("a[data-submit=delete-conversation-message]").unbind().on("click",function(){e.$deleteholder.dialog({modal:!0,title:e.$deleteholder.attr("data-dialog-title")})});e.$sortselect.unbind().on("change",function(){e.$messagelist.load(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:e.options.cnvID,task:"get_messages",orderBy:$(this).val()},function(t){e._init()})})};CCMConversation.prototype._handlePostError=function(e,t){if(!t)var t=["An unspecified error occurred."];var n="";$.each(t,function(e,t){n+=t+"<br>"});e.find("div.ccm-conversation-errors").html(n).show()};CCMConversation.prototype._addMessageFromJSON=function(e,t){var n=this,r=n.options.posttoken!=""?1:0,i=[{name:"cnvMessageID",value:t.cnvMessageID},{name:"enablePosting",value:r}];$.ajax({type:"post",data:i,url:CCM_TOOLS_PATH+"/conversations/message_detail",success:function(r){var i=$("div[data-conversation-message-id="+t.cnvMessageParentID+"]");e.find("textarea").val("");if(i.length){i.after(r);n.$replyholder.appendTo(n.$element);n.$replyholder.hide()}else{n.$element.find(".ccm-conversation-messages").prepend(r);n.$element.find(".ccm-conversation-no-messages").hide()}n._init();n._updateCount()}})};CCMConversation.prototype._updateCount=function(){this.$messagecnt.load(CCM_TOOLS_PATH+"/conversations/count_header",{cnvID:this.options.cnvID})};CCMConversation.prototype._submitForm=function(e){var t=this,n=e.closest("form");e.prop("disabled",!0);n.parent().addClass("ccm-conversation-form-submitted");var r=n.serializeArray(),i=e.attr("data-post-parent-id");r.push({name:"task",value:"add"},{name:"token",value:t.options.posttoken},{name:"cnvID",value:t.options.cnvID},{name:"cnvMessageParentID",value:i});$.ajax({dataType:"json",type:"post",data:r,url:CCM_TOOLS_PATH+"/conversations/messages",success:function(e){if(!e){t._handlePostError(n);return!1}if(e.error){t._handlePostError(n,e.messages);return!1}t._addMessageFromJSON(n,e)},error:function(e){t._handlePostError(n);return!1},complete:function(t){e.prop("disabled",!1);n.parent().closest(".ccm-conversation-form-submitted").removeClass("ccm-conversation-form-submitted")}})};