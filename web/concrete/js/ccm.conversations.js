(function(e,t){"use strict";e.extend(e.fn,{ccmconversation:function(t){return this.each(function(){var r=e(this),i=r.data("ccmconversation");i||r.data("ccmconversation",i=new n(r,t))})}});var n=function(e,t){this.publish("beforeInitializeConversation",{element:e,options:t});this.init(e,t);this.publish("initializeConversation",{element:e,options:t})};n.fn=n.prototype={publish:function(e,n){n=n||{};n.CCMConversation=this;t.ccm_event.publish(e,n)},init:function(n,r){var i=this;i.$element=n;i.options=e.extend({method:"ajax",paginate:!1,displayMode:"threaded",itemsPerPage:-1,activeUsers:[],uninitialized:!0},r);var s=i.options.posttoken!=""?1:0,o=i.options.paginate?1:0,u=i.options.orderBy,a=i.options.enableOrdering,f=i.options.displayPostingForm,l=i.options.insertNewMessages,c=i.options.enableCommentRating,h=i.options.commentRatingUserID,p=i.options.commentRatingIP,d=i.options.addMessageLabel?i.options.addMessageLabel:"",v=i.options.dateFormat,m=i.options.customDateFormat,g=i.options.blockAreaHandle,y=i.options.maxFiles,b=i.options.MaxFileSize,w=i.options.fileExtensions;if(i.options.method=="ajax")e.post(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:i.options.cnvID,cID:i.options.cID,blockID:i.options.blockID,enablePosting:s,itemsPerPage:i.options.itemsPerPage,addMessageLabel:d,paginate:o,displayMode:i.options.displayMode,orderBy:u,enableOrdering:a,displayPostingForm:f,insertNewMessages:l,enableCommentRating:c,commentRatingUserID:h,commentRatingIP:p,dateFormat:v,customDateFormat:m,blockAreaHandle:g},function(e){var n=t.obj;t.obj=i;i.$element.empty().append(e);t.obj=n;i.attachBindings();i.publish("conversationLoaded")});else{i.attachBindings();i.finishSetup();i.publish("conversationLoaded")}},mentionList:function(t,n,r){var i=this;if(!n)return;i.dropdown.parent.css({top:n.y,left:n.x});if(t.length==0){i.dropdown.handle.dropdown("toggle");i.dropdown.parent.remove();i.dropdown.active=!1;i.dropdown.activeItem=-1;return}i.dropdown.list.empty();t.slice(0,20).map(function(t){var n=e("<li/>"),s=e("<a/>").appendTo(n).text(t.getName());s.click(function(){ccm_event.fire("conversationsMentionSelect",{obj:i,item:t},r)});n.appendTo(i.dropdown.list)});if(!i.dropdown.active){i.dropdown.active=!0;i.dropdown.activeItem=-1;i.dropdown.parent.appendTo(i.$element);i.dropdown.handle.dropdown("toggle")}i.dropdown.activeItem>=0&&i.dropdown.list.children().eq(i.dropdown.activeItem).addClass("active")},attachBindings:function(){var n=this;n.$element.unbind(".cnv");if(n.options.uninitialized){n.options.uninitialized=!1;ccm_event.bind("conversationsMention",function(e){n.mentionList(e.eventData.items,e.eventData.coordinates||!1,e.eventData.bindTo||n.$element.get(0))},n.$element.get(0));n.dropdown={};n.dropdown.parent=e("<div/>").css({position:"absolute",height:0,width:0});n.dropdown.active=!1;n.dropdown.handle=e("<a/>").appendTo(n.dropdown.parent);n.dropdown.list=e("<ul/>").addClass("dropdown-menu").appendTo(n.dropdown.parent);n.dropdown.handle.dropdown();ccm_event.bind("conversationsTextareaKeydownUp",function(e){n.dropdown.activeItem==-1&&(n.dropdown.activeItem=n.dropdown.list.children().length);n.dropdown.activeItem-=1;n.dropdown.activeItem+=n.dropdown.list.children().length;n.dropdown.activeItem%=n.dropdown.list.children().length;n.dropdown.list.children().filter(".active").removeClass("active").end().eq(n.dropdown.activeItem).addClass("active")},n.$element.get(0));ccm_event.bind("conversationsTextareaKeydownDown",function(e){n.dropdown.activeItem+=1;n.dropdown.activeItem+=n.dropdown.list.children().length;n.dropdown.activeItem%=n.dropdown.list.children().length;n.dropdown.list.children().filter(".active").removeClass("active").end().eq(n.dropdown.activeItem).addClass("active")},n.$element.get(0));ccm_event.bind("conversationsTextareaKeydownEnter",function(e){n.dropdown.list.children().filter(".active").children("a").click()},n.$element.get(0));ccm_event.bind("conversationPostError",function(t){var n=t.eventData.form,r=t.eventData.messages,i="";e.each(r,function(e,t){i+=t+"<br>"});n.find("div.ccm-conversation-errors").html(i).show()});ccm_event.bind("conversationSubmitForm",function(e){e.eventData.form.find("div.ccm-conversation-errors").hide()})}var r=n.options.paginate?1:0,i=n.options.posttoken!=""?1:0,s=n.options.addMessageLabel?n.options.addMessageLabel:"";n.$replyholder=n.$element.find("div.ccm-conversation-add-reply");n.$newmessageform=n.$element.find("div.ccm-conversation-add-new-message form");n.$deleteholder=n.$element.find("div.ccm-conversation-delete-message");n.$attachmentdeleteholder=n.$element.find("div.ccm-conversation-delete-attachment");n.$permalinkholder=n.$element.find("div.ccm-conversation-message-permalink");n.$messagelist=n.$element.find("div.ccm-conversation-message-list");n.$messagecnt=n.$element.find(".ccm-conversation-message-count");n.$postbuttons=n.$element.find("button[data-submit=conversation-message]");n.$sortselect=n.$element.find("select[data-sort=conversation-message-list]");n.$loadmore=n.$element.find("[data-load-page=conversation-message-list]");n.$messages=n.$element.find("div.ccm-conversation-messages");n.$messagerating=n.$element.find("span.ccm-conversation-message-rating");n.$element.on("click.cnv","button[data-submit=conversation-message]",function(){n.submitForm(e(this));return!1});var o=1;n.$element.on("click.cnv","a[data-toggle=conversation-reply]",function(t){t.preventDefault();e(".ccm-conversation-attachment-container").each(function(){e(this).is(":visible")&&e(this).toggle()});var r=n.$replyholder.appendTo(e(this).closest("div[data-conversation-message-id]"));r.attr("data-form","conversation-reply").show();r.find("button[data-submit=conversation-message]").attr("data-post-parent-id",e(this).attr("data-post-parent-id"));r.attr("rel","new-reply"+o);o++;return!1});e(".ccm-conversation-attachment-container").hide();e(".ccm-conversation-add-new-message .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(t){t.preventDefault();e(".ccm-conversation-add-reply .ccm-conversation-attachment-container").is(":visible")&&e(".ccm-conversation-add-reply .ccm-conversation-attachment-container").toggle();e(".ccm-conversation-add-new-message .ccm-conversation-attachment-container").toggle()});e(".ccm-conversation-add-reply .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(t){t.preventDefault();e(".ccm-conversation-add-new-message .ccm-conversation-attachment-container").is(":visible")&&e(".ccm-conversation-add-new-message .ccm-conversation-attachment-container").toggle();e(".ccm-conversation-add-reply .ccm-conversation-attachment-container").toggle()});n.$element.on("click.cnv","a[data-submit=delete-conversation-message]",function(){var t=e(this);n.$deletedialog=n.$deleteholder.clone();n.$deletedialog.dialog?n.$deletedialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:n.$deleteholder.attr("data-dialog-title"),buttons:[{text:n.$deleteholder.attr("data-cancel-button-title"),"class":"btn pull-left",click:function(){n.$deletedialog.dialog("close")}},{text:n.$deleteholder.attr("data-confirm-button-title"),"class":"btn pull-right btn-danger",click:function(){n.deleteMessage(t.attr("data-conversation-message-id"))}}]}):confirm("Remove this message? Replies to it will not be removed.")&&n.deleteMessage(t.attr("data-conversation-message-id"));return!1});n.$element.on("click.cnv","a[data-submit=flag-conversation-message]",function(){var t=e(this);confirm("Are you sure you want to flag this messge as spam?")&&n.flagMessage(t.attr("data-conversation-message-id"));return!1});n.$element.on("change.cnv","select[data-sort=conversation-message-list]",function(){n.$messagelist.load(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:n.options.cnvID,task:"get_messages",cID:n.options.cID,blockID:n.options.blockID,enablePosting:i,displayMode:n.options.displayMode,itemsPerPage:n.options.itemsPerPage,paginate:r,addMessageLabel:s,orderBy:e(this).val(),enableOrdering:n.options.enableOrdering,displayPostingForm:n.options.displayPostingForm,insertNewMessages:n.options.insertNewMessages,enableCommentRating:n.options.enableCommentRating,dateFormat:n.options.dateFormat,customDateFormat:n.options.customDateFormat,blockAreaHandle:n.options.blockAreaHandle},function(t){n.$replyholder.appendTo(n.$element);e(".ccm-conversation-messages .dropdown-toggle").dropdown();n.attachBindings()})});n.$element.on("click.cnv","[data-load-page=conversation-message-list]",function(){var t=parseInt(n.$loadmore.attr("data-next-page")),r=parseInt(n.$loadmore.attr("data-total-pages")),o={cnvID:n.options.cnvID,cID:n.options.cID,blockID:n.options.blockID,itemsPerPage:n.options.itemsPerPage,displayMode:n.options.displayMode,blockAreaHandle:n.options.blockAreaHandle,enablePosting:i,addMessageLabel:s,page:t,orderBy:n.$sortselect.val(),enableCommentRating:n.options.enableCommentRating,dateFormat:n.options.dateFormat,customDateFormat:n.options.customDateFormat};e.ajax({type:"post",data:o,url:CCM_TOOLS_PATH+"/conversations/message_page",success:function(i){n.$messages.append(i);e(".ccm-conversation-messages .dropdown-toggle").dropdown();t+1>r?n.$loadmore.hide():n.$loadmore.attr("data-next-page",t+1)}})});n.$element.on("click.cnv",".conversation-rate-message",function(){var t=e(this).closest("[data-conversation-message-id]").attr("data-conversation-message-id"),r=e(this).attr("data-conversation-rating-type");n.$messagerating.load(CCM_TOOLS_PATH+"/conversations/rate");var i={cnvID:n.options.cnvID,cID:n.options.cID,blockID:n.options.blockID,cnvMessageID:t,cnvRatingTypeHandle:r,commentRatingUserID:n.options.commentRatingUserID,commentRatingIP:n.options.commentRatingIP};e.ajax({type:"post",data:i,url:CCM_TOOLS_PATH+"/conversations/rate",success:function(n){e('span[data-message-rating="'+t+'"]').load(CCM_TOOLS_PATH+"/conversations/get_rating",{cnvMessageID:t})}})});n.$element.on("click.cnv","a.share-permalink",function(){var r=e(this),i=e(this).attr("rel");n.$permalinkdialog=n.$permalinkholder.clone();n.$permalinkdialog.append("<textarea>"+i+"</textarea>");n.$permalinkdialog.find("textarea").click(function(){var n=e(this);n.select();t.setTimeout(function(){n.select()},1);n.mouseup(function(){n.unbind("mouseup");return!1})});n.$permalinkdialog.dialog&&n.$permalinkdialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:n.$permalinkholder.attr("data-dialog-title"),buttons:[{text:n.$permalinkholder.attr("data-cancel-button-title"),"class":"btn pull-left",click:function(){n.$permalinkdialog.dialog("close")}}]});return!1});n.$element.ccmconversationattachments(n);e(".dropdown-toggle").dropdown()},handlePostError:function(e,t){if(!t)var t=["An unspecified error occurred."];this.publish("conversationPostError",{form:e,messages:t})},deleteMessage:function(n){var r=this;r.publish("conversationBeforeDeleteMessage",{msgID:n});var i=[{name:"cnvMessageID",value:n}];e.ajax({type:"post",data:i,url:CCM_TOOLS_PATH+"/conversations/delete_message",success:function(t){var i=e("div[data-conversation-message-id="+n+"]");i.length&&i.after(t).remove();r.updateCount();r.$deletedialog.dialog&&r.$deletedialog.dialog("close");r.publish("conversationDeleteMessage",{msgID:n})},error:function(e){r.publish("conversationDeleteMessageError",{msgID:n,error:arguments});t.alert("Something went wrong while deleting this message, please refresh and try again.")}})},flagMessage:function(n){var r=this;r.publish("conversationBeforeFlagMessage",{msgID:n});var i=[{name:"cnvMessageID",value:n}];e.ajax({type:"post",data:i,url:CCM_TOOLS_PATH+"/conversations/flag_message",success:function(t){var i=e("div[data-conversation-message-id="+n+"]");i.length&&i.after(t).remove();r.updateCount();r.publish("conversationFlagMessage",{msgID:n})},error:function(e){r.publish("conversationFlageMessageError",{msgID:n,error:arguments});t.alert("Something went wrong while flagging this message, please refresh and try again.")}})},addMessageFromJSON:function(t,n){var r=this;r.publish("conversationBeforeAddMessageFromJSON",{json:n,form:t});var i=r.options.posttoken!=""?1:0,s=[{name:"cnvMessageID",value:n.cnvMessageID},{name:"enablePosting",value:i},{name:"displayMode",value:r.options.displayMode},{name:"enableCommentRating",value:r.options.enableCommentRating}];e.ajax({type:"post",data:s,url:CCM_TOOLS_PATH+"/conversations/message_detail",success:function(i){var s=e("div[data-conversation-message-id="+n.cnvMessageParentID+"]");if(s.length){s.after(i);r.$replyholder.appendTo(r.$element);r.$replyholder.hide()}else{r.options.insertNewMessages=="bottom"?r.$messages.append(i):r.$messages.prepend(i);r.$element.find(".ccm-conversation-no-messages").hide()}r.publish("conversationAddMessageFromJSON",{json:n,form:t});r.updateCount();var o=e("a#cnvMessage"+n.cnvMessageID).offset();e(".dropdown-toggle").dropdown();e("html, body").animate({scrollTop:o.top},800,"linear")}})},updateCount:function(){var e=this;e.publish("conversationBeforeUpdateCount");e.$messagecnt.load(CCM_TOOLS_PATH+"/conversations/count_header",{cnvID:e.options.cnvID},function(){e.publish("conversationUpdateCount")})},submitForm:function(t){var n=this;n.publish("conversationBeforeSubmitForm");var r=t.closest("form");t.prop("disabled",!0);r.parent().addClass("ccm-conversation-form-submitted");var i=r.serializeArray(),s=t.attr("data-post-parent-id");i.push({name:"token",value:n.options.posttoken},{name:"cnvID",value:n.options.cnvID},{name:"cnvMessageParentID",value:s},{name:"enableRating",value:s});e.ajax({dataType:"json",type:"post",data:i,url:CCM_TOOLS_PATH+"/conversations/add_message",success:function(t){if(!t){n.handlePostError(r);return!1}if(t.error){n.handlePostError(r,t.messages);return!1}e(".preview.processing").each(function(){e('input[rel="'+e(this).attr("rel")+'"]').remove()});e("form.dropzone").each(function(){var t=e(this).data("dropzone");e.each(t.files,function(e,n){t.removeFile(n)})});n.addMessageFromJSON(r,t);n.publish("conversationSubmitForm",{form:r,response:t})},error:function(e){n.handlePostError(r);return!1},complete:function(e){t.prop("disabled",!1);r.parent().closest(".ccm-conversation-form-submitted").removeClass("ccm-conversation-form-submitted")}})},tool:{setCaretPosition:function(e,t){if(e!=null)if(e.createTextRange){var n=e.createTextRange();n.move("character",t);n.select()}else if(e.selectionStart){e.focus();e.setSelectionRange(t,t)}else e.focus()},getCaretPosition:function(e){if(e.selectionStart)return e.selectionStart;if(document.selection){e.focus();var t=document.selection.createRange();if(t==null)return 0;var n=e.createTextRange(),r=n.duplicate();n.moveToBookmark(t.getBookmark());r.setEndPoint("EndToStart",n);return r.text.length}return 0},testMentionString:function(e){return/^@[a-z0-9]+$/.test(e)},getMentionMatches:function(e,t){return t.filter(function(t){return t.indexOf(e)>=0})},isSameConversation:function(e,t){return e.options.blockID===t.options.blockID&&e.options.cnvID===t.options.cnvID},MentionUser:function(e){this.getName=function(){return e}}}}})(jQuery,window);(function(e,t){var n={init:function(t){var n=t;n.$element.on("click.cnv","a[data-toggle=conversation-reply]",function(){e(".ccm-conversation-wrapper").ccmconversationattachments("clearDropzoneQueues")});n.$element.on("click.cnv","a.attachment-delete",function(t){t.preventDefault();e(this).ccmconversationattachments("attachmentDeleteTrigger",n)});if(n.$newmessageform.dropzone&&!e(n.$newmessageform).attr("data-dropzone-applied")){n.$newmessageform.dropzone({url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(t,r){var i=this;e(t.previewTemplate).click(function(){e('input[rel="'+e(this).attr("rel")+'"]').remove();i.removeFile(t)});var s=JSON.parse(r);if(!s.error)e('div[rel="'+s.tag+'"] form.main-reply-form').append('<input rel="'+s.timestamp+'" type="hidden" name="attachments[]" value="'+s.id+'" />');else{var o=e('.preview.processing[rel="'+s.timestamp+'"]').closest("form");n.handlePostError(o,[s.error]);e('.preview.processing[rel="'+s.timestamp+'"]').remove();o.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){e(this).html("")})}},sending:function(t,r,i){var s=[],o=this.files.length;if(n.options.maxFiles>0&&o>n.options.maxFiles){s.push("Too many files");var u=!0}var a=n.options.fileExtensions.split(",");if(t.name.split(".").pop()&&a.indexOf(t.name.split(".").pop())==-1){s.push("Invalid file extension");var f=!0}if(n.options.maxFileSize>0&&t.size>n.options.maxFileSize*1e6){s.push("Max file size exceeded");var l=!0}if(l||u||f){var c=this;e('input[rel="'+e(t.previewTemplate).attr("rel")+'"]').remove();t.processing=!1;var h=e(t.previewTemplate).parent(".dropzone");c.removeFile(t);n.handlePostError(h,s);h.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){e(this).html("")});var o=-1;return!1}e(t.previewTemplate).attr("rel",(new Date).getTime());i.append("timestamp",e(t.previewTemplate).attr("rel"));i.append("tag",e(n.$newmessageform).parent("div").attr("rel"));i.append("fileCount",this.files.length)},init:function(){e(this.element).data("dropzone",this)}});e(n.$newmessageform).attr("data-dropzone-applied","true")}e(n.$replyholder.find(".dropzone")).attr("data-dropzone-applied")||n.$replyholder.find(".dropzone").not('[data-drozpone-applied="true"]').dropzone({url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(t,r){var i=this;e(t.previewTemplate).click(function(){i.removeFile(t);e('input[rel="'+e(this).attr("rel")+'"]').remove()});var s=JSON.parse(r);if(!s.error)e(this.element).closest("div.ccm-conversation-add-reply").find("form.aux-reply-form").append('<input rel="'+s.timestamp+'" type="hidden" name="attachments[]" value="'+s.id+'" />');else{var o=e('.preview.processing[rel="'+s.timestamp+'"]').closest("form");n.handlePostError(o,[s.error]);e('.preview.processing[rel="'+s.timestamp+'"]').remove();o.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){e(this).html("")})}},sending:function(t,r,i){var s=this.files.length;if(n.options.maxFiles>0&&s>n.options.maxFiles){var o=this;e('input[rel="'+e(t.previewTemplate).attr("rel")+'"]').remove();t.processing=!1;o.removeFile(t);alert("too many attachments");var s=-1;return!1}e(t.previewTemplate).attr("rel",(new Date).getTime());i.append("timestamp",e(t.previewTemplate).attr("rel"));i.append("tag",e(n.$newmessageform).parent("div").attr("rel"));i.append("fileCount",e(n.$replyHolder).find('[name="attachments[]"]').length)},init:function(){e(this.element).data("dropzone",this)}});e(n.$replyholder.find(".dropzone")).attr("data-dropzone-applied","true");return e.each(e(this),function(t,n){e(this).find(".ccm-conversation-attachment-container").each(function(){e(this).is(":visible")&&e(this).toggle()})})},attachmentDeleteTrigger:function(t){var n=t,r=e(this);n.$attachmentdeletetdialog=n.$attachmentdeleteholder.clone();n.$attachmentdeletetdialog.dialog?n.$attachmentdeletetdialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:n.$attachmentdeletetdialog.attr("data-dialog-title"),buttons:[{text:n.$attachmentdeleteholder.attr("data-cancel-button-title"),"class":"btn pull-left",click:function(){n.$attachmentdeletetdialog.dialog("close")}},{text:n.$attachmentdeleteholder.attr("data-confirm-button-title"),"class":"btn pull-right btn-danger",click:function(){e(this).ccmconversationattachments("deleteAttachment",{cnvMessageAttachmentID:r.attr("rel"),cnvObj:n,dialogObj:n.$attachmentdeletetdialog})}}]}):confirm("Remove this message? Replies to it will not be removed.")&&e(this).ccmconversationattachments("deleteAttachment",{cnvMessageAttachmentID:r.attr("rel"),cnvObj:n,dialogObj:n.$attachmentdeletetdialog});return!1},clearDropzoneQueues:function(){e(".preview.processing").each(function(){e('input[rel="'+e(this).attr("rel")+'"]').remove()});e("form.dropzone").each(function(){var t=e(this).data("dropzone");e.each(t.files,function(e,n){t.removeFile(n)})})},deleteAttachment:function(n){var r=n.cnvMessageAttachmentID,i=n.cnvObj,s=n.dialogObj,o=[{name:"cnvMessageAttachmentID",value:r}];e.ajax({type:"post",data:o,url:CCM_TOOLS_PATH+"/conversations/delete_file",success:function(t){var n=JSON.parse(t);e('p[rel="'+n.attachmentID+'"]').parent(".attachment-container").fadeOut(300,function(){e(this).remove()});if(s.dialog){s.dialog("close");i.publish("conversationDeleteAttachment",{cnvMessageAttachmentID:r})}},error:function(e){i.publish("conversationDeleteAttachmentError",{cnvMessageAttachmentID:r,error:arguments});t.alert("Something went wrong while deleting this attachment, please refresh and try again.")}})}};e.fn.ccmconversationattachments=function(t){if(n[t])return n[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return n.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.tooltip")}})(jQuery,window);