(function(e,t){var n={saveinterval:!1,"private":{saveDraft:function(t,n){formData=t.serializeArray();e.ajax({dataType:"json",type:"post",data:formData,url:t.data("saveURL"),success:function(e){t.find(".ccm-composer-save-status").html('<div class="alert alert-info"><?=t("Page saved at ")?>'+e.time+"</div>");e.saveURL&&t.data("saveURL",e.saveURL);e.discardURL&&t.data("discardURL",e.discardURL);e.publishURL&&t.data("publishURL",e.publishURL);n&&n(e)}})}},init:function(r){var s=e.extend({autoSaveEnabled:!0,autoSaveTimeout:5e3,publishReturnMethod:"reload",onExit:function(){t.location.href=CCM_DISPATCHER_FILENAME+"/dashboard/composer/drafts"},onAfterDiscard:function(){t.location.href=CCM_DISPATCHER_FILENAME+"/dashboard/composer/drafts"},onAfterSaveAndExit:function(){t.location.href=CCM_DISPATCHER_FILENAME+"/dashboard/composer/drafts"}},r);return this.each(function(){var r=e(this);r.data("settings",s);r.data("saveURL",s.saveURL);r.data("discardURL",s.discardURL);r.data("publishURL",s.publishURL);s.autoSaveEnabled&&(n.saveinternal=setInterval(function(){n.private.saveDraft(r,function(e){if(parseInt(s.cmpDraftID)==0){r.find("button[data-composer-btn=permissions]").show();s.cmpDraftID=e.cmpDraftID}})},s.autoSaveTimeout));r.find("button[data-composer-btn=exit]").on("click",function(){s.onExit()});parseInt(s.cmpDraftID)>0&&r.find("button[data-composer-btn=permissions]").show();r.find("button[data-composer-btn=permissions]").on("click",function(){jQuery.fn.dialog.open({href:CCM_TOOLS_PATH+"/composer/draft/permissions?cmpDraftID="+s.cmpDraftID,width:400,height:280,title:ccmi18n.cmpDraftPermissionsTitle})});r.find("button[data-composer-btn=discard]").on("click",function(){r.data("discardURL")?e.ajax({type:"get",url:r.data("discardURL"),success:function(e){s.onAfterDiscard()}}):s.onAfterDiscard()});r.find("button[data-composer-btn=save]").on("click",function(){clearInterval(n.saveinterval);n.private.saveDraft(r,function(e){s.onAfterSaveAndExit()})});s.publishReturnMethod=="ajax"&&r.on("submit.composer",function(){return!1});r.find("button[data-composer-btn=publish]").on("click",function(){clearInterval(n.saveinterval);r.attr("action",r.data("publishURL"));s.publishReturnMethod=="ajax"&&r.on("submit.composer",function(){e(this).prop("disabled",!0);formData=r.serializeArray();e.ajax({type:"post",data:formData,dataType:"json",url:r.data("publishURL"),success:function(n){e(this).prop("disabled",!1);if(n.error){var r="";for(i=0;i<n.messages.length;i++)r+="<div>"+n.messages[i]+"</div>";e("#ccm-composer-error-list").show().html(r)}else{e("#ccm-composer-error-list").hide();n.redirectURL&&(t.location.href=n.redirectURL)}},complete:function(){r.unbind("submit.composer").on("submit.composer",function(){return!1});r.removeAttr("action")}});return!1});r.submit()})})}};e.fn.ccmcomposer=function(t){if(n[t])return n[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return n.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.ccmcomposer")}})(jQuery,window);