(function(e,t){var n={saveinterval:!1,"private":{saveDraft:function(t,n){formData=t.serializeArray();e.ajax({dataType:"json",type:"post",data:formData,url:t.data("saveURL"),success:function(e){t.find(".ccm-composer-save-status").html('<div class="alert alert-info"><?=t("Page saved at ")?>'+e.time+"</div>");e.saveurl&&t.data("saveURL",e.saveurl);e.discardurl&&t.data("discardURL",e.discardurl);e.publishurl&&t.data("publishURL",e.publishurl);n&&n()}})}},init:function(r){var s=e.extend({autoSaveEnabled:!0,autoSaveTimeout:5e3,publishReturnMethod:"reload",onExit:function(){t.location.href=CCM_DISPATCHER_FILENAME+"/dashboard/composer/drafts"},onAfterDiscard:function(){t.location.href=CCM_DISPATCHER_FILENAME+"/dashboard/composer/drafts"},onAfterSaveAndExit:function(){t.location.href=CCM_DISPATCHER_FILENAME+"/dashboard/composer/drafts"}},r);return this.each(function(){var t=e(this);t.data("settings",s);t.data("saveURL",s.saveURL);t.data("discardURL",s.discardURL);t.data("publishURL",s.publishURL);s.autoSaveEnabled&&(n.saveinternal=setInterval(function(){n.private.saveDraft(t)},s.autoSaveTimeout));t.find("button[data-composer-btn=exit]").on("click",function(){s.onExit()});t.find("button[data-composer-btn=discard]").on("click",function(){t.data("discardURL")?e.ajax({type:"get",url:t.data("discardURL"),success:function(e){s.onAfterDiscard()}}):s.onAfterDiscard()});t.find("button[data-composer-btn=save]").on("click",function(){clearInterval(n.saveinterval);n.private.saveDraft(t,function(){s.onAfterSaveAndExit()})});s.publishReturnMethod=="ajax"&&t.on("submit.composer",function(){return!1});t.find("button[data-composer-btn=publish]").on("click",function(){clearInterval(n.saveinterval);t.attr("action",t.data("publishURL"));s.publishReturnMethod=="ajax"&&t.on("submit.composer",function(){e(this).prop("disabled",!0);formData=t.serializeArray();e.ajax({type:"post",data:formData,dataType:"json",url:t.data("publishURL"),success:function(t){e(this).prop("disabled",!1);if(t.error){var n="";for(i=0;i<t.messages.length;i++)n+="<div>"+t.messages[i]+"</div>";e("#ccm-composer-error-list").show().html(n)}else e("#ccm-composer-error-list").hide()},complete:function(){t.unbind("submit.composer").on("submit.composer",function(){return!1});t.removeAttr("action")}});return!1});t.submit()})})}};e.fn.ccmcomposer=function(t){if(n[t])return n[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return n.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.ccmcomposer")}})(jQuery,window);