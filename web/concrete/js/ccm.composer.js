(function(e,t){var n={saveinterval:!1,"private":{saveDraft:function(n,r){formData=n.serializeArray();e.ajax({dataType:"json",type:"post",data:formData,url:n.data("saveURL"),success:function(e){n.find(".ccm-page-type-composer-form-save-status").html('<div class="alert alert-info">'+e.saveStatus+"</div>");e.saveURL&&n.data("saveURL",e.saveURL);e.viewURL&&n.data("viewURL",e.viewURL);e.discardURL&&n.data("discardURL",e.discardURL);e.publishURL&&n.data("publishURL",e.publishURL);var i=n.data("settings");if(i.pushStateOnSave&&e.viewURL!=i.viewURL&&t.history){t.history.replaceState({method:"loaddraft"},"",e.viewURL);i.viewURL=e.viewURL}r&&r(e)}})}},init:function(r){var s=e.extend({autoSaveEnabled:!0,autoSaveTimeout:5e3,pushStateOnSave:!1,publishReturnMethod:"reload",onPublish:!1,onExit:function(){t.location.href=CCM_DISPATCHER_FILENAME+"/dashboard/composer/drafts"},onAfterDiscard:function(){t.location.href=CCM_DISPATCHER_FILENAME+"/dashboard/composer/drafts"},onAfterSaveAndExit:function(){t.location.href=CCM_DISPATCHER_FILENAME+"/dashboard/composer/drafts"}},r);return this.each(function(){var t=e(this);t.data("settings",s);t.data("saveURL",s.saveURL);t.data("viewURL",s.viewURL);t.data("discardURL",s.discardURL);t.data("publishURL",s.publishURL);s.autoSaveEnabled&&(n.saveinternal=setInterval(function(){n.private.saveDraft(t,function(e){if(parseInt(s.cID)==0){t.find("button[data-page-type-composer-form-btn=permissions]").show();s.cID=e.cID}})},s.autoSaveTimeout));t.find("button[data-page-type-composer-form-btn=exit]").on("click",function(){s.onExit()});parseInt(s.cID)>0&&t.find("button[data-page-type-composer-form-btn=permissions]").show();t.find("button[data-page-type-composer-form-btn=discard]").on("click",function(){t.data("discardURL")?e.ajax({type:"get",url:t.data("discardURL"),success:function(e){s.onAfterDiscard()}}):s.onAfterDiscard()});t.find("button[data-page-type-composer-form-btn=save]").on("click",function(){clearInterval(n.saveinterval);n.private.saveDraft(t,function(e){s.onAfterSaveAndExit()})});s.publishReturnMethod=="ajax"&&t.on("submit.composer",function(){return!1});t.find("button[data-page-type-composer-form-btn=publish]").on("click",function(){clearInterval(n.saveinterval);t.attr("action",t.data("publishURL"));s.publishReturnMethod=="ajax"&&t.on("submit.composer",function(){e(this).prop("disabled",!0);formData=t.serializeArray();e.ajax({type:"post",data:formData,dataType:"json",url:t.data("publishURL"),success:function(t){e(this).prop("disabled",!1);if(t.error){var n="";for(i=0;i<t.messages.length;i++)n+="<div>"+t.messages[i]+"</div>";e("#ccm-page-type-composer-form-error-list").show().html(n)}else{e("#ccm-page-type-composer-form-error-list").hide();s.onPublish&&s.onPublish(t)}},complete:function(){t.unbind("submit.composer").on("submit.composer",function(){return!1});t.removeAttr("action")}});return!1});t.submit()})})}};e.fn.ccmcomposer=function(t){if(n[t])return n[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return n.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.ccmcomposer")}})(jQuery,window);