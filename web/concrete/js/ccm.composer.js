(function(e,t){var n={saveinterval:!1,"private":{saveDraft:function(r,i,s){var o=i.data("settings");formData=i.serializeArray();formData.push({name:"task",value:r},{name:"token",value:o.token},{name:"cID",value:o.cID});e.ajax({dataType:"json",type:"post",data:formData,url:i.data("saveURL"),error:function(e){n.private.handleAJAXGeneralError(e)},success:function(r){r.saveURL&&i.data("saveURL",r.saveURL);r.viewURL&&i.data("viewURL",r.viewURL);r.discardURL&&i.data("discardURL",r.discardURL);if(!n.private.handleAJAXResponseError(r,e("#ccm-page-type-composer-form-error-list"))){r.saveStatus&&e("#ccm-page-type-composer-form-save-status").html(r.saveStatus).show();if(o.autoSavePushViewState&&r.viewURL!=document.URL&&t.history){t.history.replaceState({method:"loaddraft"},"",r.viewURL);o.viewURL=r.viewURL}s&&s(r)}}})},handleAJAXGeneralError:function(e){ccmAlert.notice("Error",'<div class="alert alert-danger">'+e.responseText+"</div>")},handleAJAXResponseError:function(e,t){if(e.error==1){t?t.show().html(e.errors.join("<br>")):ccmAlert.notice("Error",'<div class="alert alert-danger">'+e.errors.join("<br>")+"</div>");return!0}}},init:function(r){var i=e.extend({cID:!1,token:!1,discardURL:CCM_TOOLS_PATH+"/pages/draft/discard",saveURL:CCM_TOOLS_PATH+"/pages/composer/save",onExit:function(){t.location.href=CCM_DISPATCHER_FILENAME+"/dashboard/composer/drafts"},onAfterDiscard:function(e){t.location.href=e.redirectURL},autoSaveEnabled:!0,autoSavePushViewState:!1,autoSaveTimeout:5e3,onAfterSaveAndExit:function(e){t.location.href=e.redirectURL},onAfterSaveAndPreview:function(e){t.location.href=e.redirectURL},onAfterPublish:function(e){t.location.href=e.redirectURL}},r);return this.each(function(){var t=e(this);t.data("settings",i);t.data("saveURL",i.saveURL);t.data("viewURL",i.viewURL);t.data("discardURL",i.discardURL);i.autoSaveEnabled&&(n.saveinternal=setInterval(function(){n.private.saveDraft("autosave",t,function(e){})},i.autoSaveTimeout));e("button[data-page-type-composer-form-btn=preview]").unbind().on("click",function(){clearInterval(n.saveinterval);n.private.saveDraft("preview",t,function(e){i.onAfterSaveAndPreview(e)})});e("button[data-page-type-composer-form-btn=exit]").unbind().on("click",function(){i.onExit()});e("button[data-page-type-composer-form-btn=discard]").unbind().on("click",function(){e.ajax({type:"post",dataType:"json",data:{token:i.token,cID:i.cID},url:t.data("discardURL"),success:function(e){n.private.handleAJAXResponseError(e)||i.onAfterDiscard(e)},error:function(e){n.private.handleAJAXGeneralError(e)}})});e("button[data-page-type-composer-form-btn=save]").unbind().on("click",function(){clearInterval(n.saveinterval);n.private.saveDraft("save",t,function(e){i.onAfterSaveAndExit(e)})});t.on("submit.composer",function(){return!1});e("button[data-page-type-composer-form-btn=publish]").unbind().on("click",function(){clearInterval(n.saveinterval);n.private.saveDraft("publish",t,function(e){i.onAfterPublish(e)})})})}};e.fn.ccmcomposer=function(t){if(n[t])return n[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return n.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.ccmcomposer")}})(jQuery,window);