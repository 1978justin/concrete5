!function(a,b){"use strict";function c(a,c){c=c||{},c=b.extend({items:[],columns:[],pagination:{},fields:[]},c),this.$element=a,this.$results=a.find("div[data-search-element=results]"),this.$resultsTableBody=this.$results.find("tbody"),this.$resultsTableHead=this.$results.find("thead"),this.$resultsPagination=this.$results.find("div.ccm-search-results-pagination"),this.options=c,this._templateSearchForm=_.template(a.find("script[data-template=search-form]").html()),this._templateAdvancedSearchFieldRow=_.template(a.find("script[data-template=search-field-row]").html()),this._templateSearchResultsTableHead=_.template(a.find("script[data-template=search-results-table-head]").html()),this._templateSearchResultsTableBody=_.template(a.find("script[data-template=search-results-table-body]").html()),this._templateSearchResultsPagination=_.template(a.find("script[data-template=search-results-pagination]").html()),this._templateSearchResultsMenu=_.template(a.find("script[data-template=search-results-menu]").html()),this.setupSearch(),this.setupCheckboxes(),this.setupBulkActions(),this.setupSort(),this.setupPagination(),this.setupAdvancedSearch(),this.setupCustomizeColumns(),this.updateResults(c)}c.prototype.ajaxUpdate=function(a,c,d){c=c||[];var e=this;jQuery.fn.dialog.showLoader(),b.ajax({type:"post",data:c,dataType:"json",url:a,complete:function(){jQuery.fn.dialog.hideLoader()},error:function(a){ccmAlert.notice(a)},success:function(a){d?d(a):e.updateResults(a)}})},c.prototype.setupMenus=function(){var a=this;a.$element.find("script[data-template=search-results-menu]").length&&(a.$element.find("[data-menu]").remove(),b.each(a.options.items,function(b,c){a.$results.append(a._templateSearchResultsMenu({item:c}))})),a.$element.find("tbody tr").ccmmenu()},c.prototype.setupCustomizeColumns=function(){var a=this;a.$element.on("click","a[data-search-toggle=customize]",function(){var c=b(this).attr("data-search-column-customize-url");return b.fn.dialog.open({width:480,height:400,href:c,modal:!0,title:ccmi18n.customizeSearch,onOpen:function(){var c=b("form[data-dialog-form=search-customize"),d=c.find("select[data-search-select-default-column]"),e=c.find("ul[data-search-column-list]");b("ul[data-search-column-list]").sortable({cursor:"move",opacity:.5}),c.on("click","input[type=checkbox]",function(){var a=b(this).parent().find("span").html(),f=b(this).attr("id");b(this).prop("checked")?0==c.find("li[data-field-order-column="+f+"]").length&&(d.append(b("<option>",{value:f,text:a})),d.prop("disabled",!1),e.append('<li data-field-order-column="'+f+'"><input type="hidden" name="column[]" value="'+f+'" />'+a+"</li>")):(e.find("li[data-field-order-column="+f+"]").remove(),d.find("option[value="+f+"]").remove(),0==e.find("li").length&&d.prop("disabled",!0))}),ccm_event.subscribe("AjaxFormSubmitSuccess",function(b){a.updateResults(b.eventData.result)},c.get(0))}}),!1})},c.prototype.updateResults=function(a){var c=this;c.$resultsTableHead.html(c._templateSearchResultsTableHead({columns:a.columns})),c.$resultsTableBody.html(c._templateSearchResultsTableBody({items:a.items})),c.$resultsPagination.html(c._templateSearchResultsPagination({pagination:a.pagination})),c.$advancedFields.html(""),b.each(a.fields,function(a,b){c.$advancedFields.append(c._templateAdvancedSearchFieldRow({field:b}))}),c.setupMenus()},c.prototype.setupAdvancedSearch=function(){var a=this;a.$advancedFields=a.$element.find("div.ccm-search-fields-advanced"),a.$element.on("click","a[data-search-toggle=advanced]",function(){return a.$advancedFields.append(a._templateAdvancedSearchFieldRow()),!1}),a.$element.on("change","select[data-search-field]",function(){var c=b(this).parent().find(".ccm-search-field-content");c.html("");var d=b(this).find(":selected").attr("data-search-field-url");d&&a.ajaxUpdate(d,!1,function(a){c.html(a.html)})}),a.$element.on("click","a[data-search-remove=search-field]",function(){var a=b(this).parent();return a.queue(function(){b(this).addClass("ccm-search-field-removing"),b(this).dequeue()}).delay(200).queue(function(){b(this).remove(),b(this).dequeue()}),!1})},c.prototype.setupSort=function(){var a=this;this.$element.on("click","thead th a",function(){return a.ajaxUpdate(b(this).attr("href")),!1})},c.prototype.setupSearch=function(){var a=this;a.$element.find("[data-search-element=wrapper]").html(a._templateSearchForm()),a.$element.on("submit","form[data-search-form]",function(){var c=b(this).serializeArray();return c.push({name:"submitSearch",value:"1"}),a.ajaxUpdate(b(this).attr("action"),c),!1})},c.prototype.setupBulkActions=function(){var a=this;a.$bulkActions=a.$element.find("select[data-bulk-action]"),a.$element.on("change","select[data-bulk-action]",function(){var c=b(this).find("option:selected"),d=c.attr("data-bulk-action-type"),e=[];b.each(a.$element.find("input[data-search-checkbox=individual]:checked"),function(a,c){e.push({name:"item[]",value:b(c).val()})}),"dialog"==d&&jQuery.fn.dialog.open({width:c.attr("data-bulk-action-dialog-width"),height:c.attr("data-bulk-action-dialog-height"),modal:!0,href:c.attr("data-bulk-action-url")+"?"+jQuery.param(e),title:c.attr("data-bulk-action-title")})})},c.prototype.setupPagination=function(){var a=this;this.$element.on("click","ul.pagination a",function(){return a.ajaxUpdate(b(this).attr("href")),!1})},c.prototype.setupCheckboxes=function(){var a=this;a.$element.on("click","input[data-search-checkbox=select-all]",function(){a.$element.find("input[data-search-checkbox=individual]").prop("checked",b(this).is(":checked")).trigger("change")}),a.$element.on("change","input[data-search-checkbox=individual]",function(){a.$element.find("input[data-search-checkbox=individual]:checked").length?a.$bulkActions.prop("disabled",!1):a.$bulkActions.prop("disabled",!0)})},b.fn.concreteAjaxSearch=function(a){return new c(this,a)}}(window,$);