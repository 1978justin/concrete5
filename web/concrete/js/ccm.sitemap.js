!function(a,b,c){"use strict";function d(a,e){var f=this;return e=e||{},e=b.extend({displayNodePagination:!1,cParentID:0,displaySingleLevel:!1},e),f.options=e,f.$element=a,f._sitemapMenuTemplate=c.template(d.getMenu()),f.setupTree(),f.setupTreeEvents(),f.$element}d.prototype={setupTree:function(){var a,c=this,d=!0;c.options.displaySingleLevel?(a=1==c.options.cParentID?2:3,d=!1):a=1,b(c.$element).dynatree({autoFocus:!1,cookieId:"ConcreteSitemap",cookie:{path:CCM_REL+"/"},persist:d,initAjax:{url:CCM_TOOLS_PATH+"/dashboard/sitemap_data",data:{displayNodePagination:c.options.displayNodePagination?1:0,cParentID:c.options.cParentID,displaySingleLevel:c.options.displaySingleLevel?1:0}},onPostInit:function(){c.options.displayNodePagination&&c.setupNodePagination(c.$element,c.options.cParentID)},selectMode:1,minExpandLevel:a,clickFolderMode:2,onLazyRead:function(a){c.options.displaySingleLevel?c.displaySingleLevel(a):c.reloadNode(a)},onExpand:function(a,b){a&&c.options.displaySingleLevel&&c.displaySingleLevel(b)},onClick:function(a,d){if("title"==a.getEventTargetType(d)&&a.data.cID)if(c.options.onSelectNode)c.options.onSelectNode(a);else{var e=c._sitemapMenuTemplate({options:c.options,data:a.data});if(e){var f=new ConcreteMenu(b(a.span),{menu:e,handle:"none"});f.show(d)}}else a.data.href&&(window.location.href=a.data.href)},fx:{height:"toggle",duration:200},dnd:{onDragStart:function(a){return a.data.cID?!0:!1},onDragStop:function(){},autoExpandMS:1e3,preventVoidMoves:!0,onDragEnter:function(){return!0},onDragOver:function(a,b,c){return a.parent.data.cID?a.data.cID||"after"!=c?a.isDescendantOf(b)?!1:!0:!1:!1},onDrop:function(a,b,d){a.parent.data.cID==b.parent.data.cID&&"over"!=d?(b.move(a,d),c.rescanDisplayOrder(b.parent)):c.selectMoveCopyTarget(b,a,d)}}})},setupTreeEvents:function(){var a=this;ccm_event.subscribe("SitemapDeleteRequestComplete",function(){var b=a.$element.dynatree("getActiveNode"),c=b.parent;a.reloadNode(c)})},rescanDisplayOrder:function(a){var c,d=a.getChildren(),e=[];for(a.setLazyNodeStatus(DTNodeStatus_Loading),c=0;c<d.length;c++){var f=d[c];e.push({name:"cID[]",value:f.data.cID})}b.concreteAjax({dataType:"json",type:"POST",data:e,url:CCM_TOOLS_PATH+"/dashboard/sitemap_update",success:function(b){a.setLazyNodeStatus(DTNodeStatus_Ok),ConcreteAlert.hud(b.message,"success")}})},selectMoveCopyTarget:function(a,c,d){var e=this,f=ccmi18n_sitemap.moveCopyPage;if(!d)var d="";var g=CCM_TOOLS_PATH+"/dashboard/sitemap_drag_request?origCID="+a.data.cID+"&destCID="+c.data.cID+"&dragMode="+d,h=350,i=350;b.fn.dialog.open({title:f,href:g,width:i,modal:!1,height:h,onOpen:function(){b("#ctaskMove").on("click",function(){b("#copyThisPage").get(0)&&(b("#copyThisPage").get(0).disabled=!0,b("#copyChildren").get(0).disabled=!0,b("#saveOldPagePath").attr("disabled",!1))}),b("#ctaskAlias").on("click",function(){b("#copyThisPage").get(0)&&(b("#copyThisPage").get(0).disabled=!0,b("#copyChildren").get(0).disabled=!0,b("#saveOldPagePath").attr("checked",!1),b("#saveOldPagePath").attr("disabled","disabled"))}),b("#ctaskCopy").on("click",function(){b("#copyThisPage").get(0)&&(b("#copyThisPage").get(0).disabled=!1,b("#copyThisPage").get(0).checked=!0,b("#copyChildren").get(0).disabled=!1,b("#saveOldPagePath").attr("checked",!1),b("#saveOldPagePath").attr("disabled","disabled"))})}}),ccm_event.subscribe("SitemapDragRequestComplete",function(){var a=c.parent;"over"==d&&(a=c),a.removeChildren(),e.reloadNode(a,function(){c.bExpanded||c.expand(!0)})})},setupNodePagination:function(a){var c=a.find("span.ccm-sitemap-explore-paging");if(a.find("div.ccm-pagination-bound").remove(),c.length){c.find("a").on("click",function(){var c=b(this).attr("href");return a.dynatree("option","initAjax",{url:c}),a.dynatree("getTree").reload(),!1}),c.find("div.ccm-pagination").addClass("ccm-pagination-bound").appendTo(a);var d=b.ui.dynatree.getNode(c);d.remove(),a.dynatree("option","onActivate",function(a){b(a.span).hasClass("ccm-sitemap-explore-paging")&&a.deactivate()})}},displaySingleLevel:function(a){var c=this,d=c.options,e=1==a.data.cID?2:3,f=c.$element.dynatree("getRoot");b(a.li).closest("[data-sitemap=container]").dynatree("option","minExpandLevel",e),f.removeChildren(),f.appendAjax({url:CCM_TOOLS_PATH+"/dashboard/sitemap_data",data:{displayNodePagination:d.displayNodePagination?1:0,cParentID:a.data.cID,displaySingleLevel:!0},success:function(){c.setupNodePagination(f.tree.$tree,a.data.key)}})},reloadNode:function(a,b){var c=this,d=c.options,e={url:CCM_TOOLS_PATH+"/dashboard/sitemap_data",data:{cParentID:a.data.cID,displayNodePagination:d.displayNodePagination?1:0},success:function(){b&&b()}};a.appendAjax(e)}},d.visit=function(a){window.location.href=CCM_DISPATCHER_FILENAME+"?cID="+a},d.exitEditMode=function(a){b.get(CCM_TOOLS_PATH+"/dashboard/sitemap_check_in?cID="+a+"&ccm_token="+CCM_SECURITY_TOKEN)},d.getMenu=function(){return'<div class="ccm-popover-file-menu popover fade" data-search-page-menu="<%=data.cID%>" data-search-menu="<%=data.cID%>"><div class="arrow"></div><div class="popover-inner"><ul class="dropdown-menu"><% if (data.isTrash && data.numSubpages) { %><li><a onclick="ConcreteSitemap.deleteForever(<%=data.cID%>)" href="javascript:void(0)">'+ccmi18n_sitemap.emptyTrash+"</a></li><% } else if (data.isInTrash) { %><li><a onclick=\"ccm_previewInternalTheme(<%=data.cID%>, false, '"+ccmi18n_sitemap.previewPage+'\')" href="javascript:void(0)">'+ccmi18n_sitemap.previewPage+'</a></li><li class="divider"></li><li><a onclick="ConcreteSitemap.deleteForever(<%=data.cID%>)" href="javascript:void(0)">'+ccmi18n_sitemap.deletePageForever+"</a></li><% } else if (data.cAlias == 'LINK' || data.cAlias == 'POINTER') { %><li><a onclick=\"window.location.href='"+CCM_DISPATCHER_FILENAME+'?cID=<%=data.cID%>\'" href="javascript:void(0)">'+ccmi18n_sitemap.visitExternalLink+'</a></li><% if (data.cAlias == \'LINK\' && data.canEditProperties) { %><li><a dialog-width="350" dialog-height="170" dialog-title="'+ccmi18n_sitemap.editExternalLink+'" dialog-modal="false" dialog-append-buttons="true" href="'+CCM_TOOLS_PATH+'/edit_collection_popup?rel=SITEMAP&cID=<%=data.cID%>&ctask=edit_external">'+ccmi18n_sitemap.editExternalLink+'</a></li><% } %><% if (data.canDelete) { %><li><a dialog-width="360" dialog-height="150" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.deleteExternalLink+'" href="'+CCM_TOOLS_PATH+'/edit_collection_popup?rel=SITEMAP&cID=<%=data.cID%>&ctask=delete_external">'+ccmi18n_sitemap.deleteExternalLink+'</a></li><% } %><% } else { %><li><a href="#" onclick="ConcreteSitemap.visit(<%=data.cID%>)">'+ccmi18n_sitemap.visitPage+'</a></li><% if (data.canEditPageProperties || data.canEditPageSpeedSettings || data.canEditPagePermissions || data.canEditPageDesign || data.canViewPageVersions || data.canDeletePage) { %><li class="divider"></li><% } %><% if (data.canEditPageProperties) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=data.cID%>)" dialog-width="850" dialog-height="360" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pagePropertiesTitle+'" href="'+CCM_TOOLS_PATH+'/edit_collection_popup?rel=SITEMAP&cID=<%=data.cID%>&ctask=edit_metadata">'+ccmi18n_sitemap.pageProperties+'</a></li><% } %><% if (data.canEditPageSpeedSettings) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=data.cID%>)" dialog-width="550" dialog-height="280" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.speedSettingsTitle+'" href="'+CCM_TOOLS_PATH+'/edit_collection_popup?rel=SITEMAP&cID=<%=data.cID%>&ctask=edit_speed_settings">'+ccmi18n_sitemap.speedSettings+'</a></li><% } %><% if (data.canEditPagePermissions) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=data.cID%>)" dialog-width="420" dialog-height="630" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.setPagePermissions+'" href="'+CCM_TOOLS_PATH+'/edit_collection_popup?rel=SITEMAP&cID=<%=data.cID%>&ctask=edit_permissions">'+ccmi18n_sitemap.setPagePermissions+'</a></li><% } %><% if (data.canEditPageDesign) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=data.cID%>)" dialog-width="610" dialog-height="405" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pageDesign+'" href="'+CCM_TOOLS_PATH+'/edit_collection_popup?rel=SITEMAP&cID=<%=data.cID%>&ctask=set_theme">'+ccmi18n_sitemap.pageDesign+'</a></li><% } %><% if (data.canViewPageVersions) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=data.cID%>)" dialog-width="640" dialog-height="340" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pageVersions+'" href="'+CCM_TOOLS_PATH+'/versions?cID=<%=data.cID%>">'+ccmi18n_sitemap.pageVersions+'</a></li><% } %><% if (data.canDeletePage) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=data.cID%>)" dialog-width="360" dialog-height="150" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.deletePage+'" href="'+CCM_DISPATCHER_FILENAME+'/system/dialogs/page/delete?cID=<%=data.cID%>">'+ccmi18n_sitemap.deletePage+'</a></li><% } %><% if (options.displaySingleLevel) { %><li class="divider"></li><li><a class="dialog-launch" dialog-width="90%" dialog-height="70%" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.moveCopyPage+'" href="'+CCM_TOOLS_PATH+"/sitemap_search_selector?sitemap_select_mode=move_copy_delete&cID=<%=data.cID%>>"+ccmi18n_sitemap.moveCopyPage+'</a></li><li><a href="'+CCM_DISPATCHER_FILENAME+'/dashboard/sitemap/explore?cNodeID=<%=data.cID%>&task=send_to_top">'+ccmi18n_sitemap.sendToTop+'</a></li><li><a href="'+CCM_DISPATCHER_FILENAME+'/dashboard/sitemap/explore?cNodeID=<%=data.cID%>&task=send_to_bottom">'+ccmi18n_sitemap.sendToBottom+'</a></li><% } %><% if (data.numSubpages > 0) { %><li class="divider"></li><li><a href="'+CCM_DISPATCHER_FILENAME+'/dashboard/sitemap/search/?selectedSearchField[]=parent&cParentAll=1&cParentIDSearchField=<%=data.cID%>">'+ccmi18n_sitemap.searchPages+'</a></li><% if (!options.displaySingleLevel) { %><li><a href="'+CCM_DISPATCHER_FILENAME+'/dashboard/sitemap/explore/-/<%=data.cID%>">'+ccmi18n_sitemap.explorePages+'</a></li><% } %><% } %><% if (data.canAddExternalLinks) { %><li class="divider"></li><li><a class="dialog-launch" dialog-width="350" dialog-modal="false" dialog-height="170" dialog-title="'+ccmi18n_sitemap.addExternalLink+'" dialog-modal="false" href="'+CCM_TOOLS_PATH+'/edit_collection_popup?rel=SITEMAP&cID=<%=data.cID%>&ctask=add_external">'+ccmi18n_sitemap.addExternalLink+"</a></li><% } %><% } %></ul></div></div>"},d.refreshCopyOperations=function(){ccm_triggerProgressiveOperation(CCM_TOOLS_PATH+"/dashboard/sitemap_copy_all",[],ccmi18n_sitemap.copyProgressTitle,function(){b(".ui-dialog-content").dialog("close"),window.location.reload()})},d.submitDragRequest=function(){var a=b("#origCID").val(),c=(b("#destParentID").val(),b("#destCID").val()),d=b("#dragMode").val(),e=b("#destSibling").val(),f=b("input[name=ctask]:checked").val(),g=b("input[name=copyAll]:checked").val(),h=b("input[name=saveOldPagePath]:checked").val(),i={origCID:a,destCID:c,ctask:f,ccm_token:CCM_SECURITY_TOKEN,copyAll:g,destSibling:e,dragMode:d,saveOldPagePath:h};if(1==g){var j=ccmi18n_sitemap.copyProgressTitle;ccm_triggerProgressiveOperation(CCM_TOOLS_PATH+"/dashboard/sitemap_copy_all",[{name:"origCID",value:a},{name:"destCID",value:c}],j,function(){b(".ui-dialog-content").dialog("close"),ccm_event.publish("SitemapDragRequestComplete",{task:f})})}else jQuery.fn.dialog.showLoader(),b.getJSON(CCM_TOOLS_PATH+"/dashboard/sitemap_drag_request",i,function(a){ccm_parseJSON(a,function(){jQuery.fn.dialog.closeAll(),jQuery.fn.dialog.hideLoader(),ConcreteAlert.hud(a.message,2e3),ccm_event.publish("SitemapDragRequestComplete",{task:f}),jQuery.fn.dialog.closeTop(),jQuery.fn.dialog.closeTop()})})},b.fn.concreteSitemap=function(a){return b.each(b(this),function(){new d(b(this),a)})},a.ConcreteSitemap=d}(this,$,_);