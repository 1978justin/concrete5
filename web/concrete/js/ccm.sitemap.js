/**
 * Sitemap proxy functions to dynatree
 */(function(e,t){var n={"private":{customEvents:[],reloadNode:function(e,t,n){var r=this,i={url:CCM_TOOLS_PATH+"/dashboard/sitemap_data",data:{cParentID:e.data.cID,displayNodePagination:t.displayNodePagination?1:0},success:function(){n&&n()}};e.appendAjax(i)},eventListenerExists:function(e,t){for(i=0;i<this.customEvents.length;i++){var n=this.customEvents[i];if(n.requestID==t&&n.eventName==e)return!0}return!1},setupNodePagination:function(t,n){var r=t.find("span.ccm-sitemap-explore-paging");t.find("div.ccm-pagination-bound").remove();if(r.length){r.find("a").on("click",function(){var n=e(this).attr("href");return t.dynatree("option","initAjax",{url:n}),t.dynatree("getTree").reload(),!1}),r.find("div.ccm-pagination").addClass("ccm-pagination-bound").appendTo(t);var i=e.ui.dynatree.getNode(r);i.remove()}},displaySingleLevel:function(t,r){if(t.data.cID==1)var i=2;else var i=3;var s=e(t.li).closest("[data-sitemap=container]").dynatree("getRoot");e(t.li).closest("[data-sitemap=container]").dynatree("option","minExpandLevel",i),s.removeChildren(),s.appendAjax({url:CCM_TOOLS_PATH+"/dashboard/sitemap_data",data:{displayNodePagination:r.displayNodePagination?1:0,cParentID:t.data.cID,displaySingleLevel:!0},success:function(){n.private.setupNodePagination(s.tree.$tree,t.data.key)}})},rescanDisplayOrder:function(t){t.setLazyNodeStatus(DTNodeStatus_Loading);var n=t.getChildren(),r=[];for(i=0;i<n.length;i++){var s=n[i];r.push({name:"cID[]",value:s.data.cID})}e.ajax({dataType:"json",type:"POST",data:r,url:CCM_TOOLS_PATH+"/dashboard/sitemap_update",success:function(e){ccm_parseJSON(e,function(){}),t.setLazyNodeStatus(DTNodeStatus_Ok)}})},selectMoveCopyTarget:function(t,r,i){var s=ccmi18n_sitemap.moveCopyPage;if(!i)var i="";var o=CCM_TOOLS_PATH+"/dashboard/sitemap_drag_request.php?origCID="+t.data.cID+"&destCID="+r.data.cID+"&dragMode="+i,u=350,a=350;e.fn.dialog.open({title:s,href:o,width:a,modal:!1,height:u,onOpen:function(){e("#ctaskMove").on("click",function(){e("#copyThisPage").get(0)&&(e("#copyThisPage").get(0).disabled=!0,e("#copyChildren").get(0).disabled=!0,e("#saveOldPagePath").attr("disabled",!1))}),e("#ctaskAlias").on("click",function(){e("#copyThisPage").get(0)&&(e("#copyThisPage").get(0).disabled=!0,e("#copyChildren").get(0).disabled=!0,e("#saveOldPagePath").attr("checked",!1),e("#saveOldPagePath").attr("disabled","disabled"))}),e("#ctaskCopy").on("click",function(){e("#copyThisPage").get(0)&&(e("#copyThisPage").get(0).disabled=!1,e("#copyThisPage").get(0).checked=!0,e("#copyChildren").get(0).disabled=!1,e("#saveOldPagePath").attr("checked",!1),e("#saveOldPagePath").attr("disabled","disabled"))})}}),e("[data-sitemap=container]").on("dragRequestComplete",function(s,o){o=="MOVE"&&t.remove();var u=r.parent;i=="over"&&(u=r),u.removeChildren(),n.private.reloadNode(u,e(this).data("options"),function(){r.bExpanded||r.expand(!0)}),e(this).unbind("dragRequestComplete")})}},getMenu:function(t,n){var r='<div class="ccm-sitemap-menu popover fade"><div class="arrow"></div><div class="popover-inner">';r+='<ul class="dropdown-menu">';if(t.isTrash&&t.numSubpages)r+="<li><a onclick=\"$.fn.ccmsitemap('deleteForever', this, "+t.cID+')" href="javascript:void(0)">'+ccmi18n_sitemap.emptyTrash+"</a></li>";else if(t.isInTrash)r+='<li><a onclick="ccm_previewInternalTheme('+t.cID+", false, '"+ccmi18n_sitemap.previewPage+'\')" href="javascript:void(0)">'+ccmi18n_sitemap.previewPage+"</a></li>",r+='<li class="divider"></li>',r+="<li><a onclick=\"$.fn.ccmsitemap('deleteForever', this, "+t.cID+')" href="javascript:void(0)">'+ccmi18n_sitemap.deletePageForever+"</a></li>";else if(t.cAlias=="LINK"||t.cAlias=="POINTER")r+="<li><a onclick=\"window.location.href='"+CCM_DISPATCHER_FILENAME+"?cID="+t.cID+'\'" href="javascript:void(0)">'+ccmi18n_sitemap.visitExternalLink+"</a></li>",t.cAlias=="LINK"&&t.canEditProperties&&(r+='<li><a dialog-width="350" dialog-height="170" dialog-title="'+ccmi18n_sitemap.editExternalLink+'" dialog-modal="false" dialog-append-buttons="true" href="'+CCM_TOOLS_PATH+"/edit_collection_popup.php?rel=SITEMAP&cID="+t.cID+'&ctask=edit_external">'+ccmi18n_sitemap.editExternalLink+"</a></li>"),t.canDelete&&(r+='<li><a dialog-width="360" dialog-height="150" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.deleteExternalLink+'" href="'+CCM_TOOLS_PATH+"/edit_collection_popup.php?rel=SITEMAP&cID="+t.cID+'&ctask=delete_external">'+ccmi18n_sitemap.deleteExternalLink+"</a></li>"),r+="<li><a onclick=\"$.fn.ccmsitemap('deleteForever', this, "+t.cID+')" href="javascript:void(0)">'+ccmi18n_sitemap.deletePageForever+"</a></li>";else{r+='<li><a href="'+CCM_DISPATCHER_FILENAME+"?cID="+t.cID+'">'+ccmi18n_sitemap.visitPage+"</a></li>";if(t.canEditPageProperties||t.canEditPageSpeedSettings||t.canEditPagePermissions||t.canEditPageDesign||t.canViewPageVersions||t.canDeletePage)r+='<li class="divider"></li>';t.canEditPageProperties&&(r+='<li><a class="dialog-launch" dialog-on-close="$.fn.ccmsitemap(\'exitEditMode\', '+t.cID+')" dialog-width="850" dialog-height="360" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pagePropertiesTitle+'" href="'+CCM_TOOLS_PATH+"/edit_collection_popup.php?rel=SITEMAP&cID="+t.cID+'&ctask=edit_metadata">'+ccmi18n_sitemap.pageProperties+"</a></li>"),t.canEditPageSpeedSettings&&(r+='<li><a class="dialog-launch" dialog-on-close="$.fn.ccmsitemap(\'exitEditMode\', '+t.cID+')" dialog-width="550" dialog-height="280" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.speedSettingsTitle+'" href="'+CCM_TOOLS_PATH+"/edit_collection_popup.php?rel=SITEMAP&cID="+t.cID+'&ctask=edit_speed_settings">'+ccmi18n_sitemap.speedSettings+"</a></li>"),t.canEditPagePermissions&&(r+='<li><a class="dialog-launch" dialog-on-close="$.fn.ccmsitemap(\'exitEditMode\', '+t.cID+')" dialog-width="420" dialog-height="630" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.setPagePermissions+'" href="'+CCM_TOOLS_PATH+"/edit_collection_popup.php?rel=SITEMAP&cID="+t.cID+'&ctask=edit_permissions">'+ccmi18n_sitemap.setPagePermissions+"</a></li>"),t.canEditPageDesign&&(r+='<li><a class="dialog-launch" dialog-on-close="$.fn.ccmsitemap(\'exitEditMode\', '+t.cID+')" dialog-width="610" dialog-height="405" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pageDesign+'" href="'+CCM_TOOLS_PATH+"/edit_collection_popup.php?rel=SITEMAP&cID="+t.cID+'&ctask=set_theme">'+ccmi18n_sitemap.pageDesign+"</a></li>"),t.canViewPageVersions&&(r+='<li><a class="dialog-launch" dialog-on-close="$.fn.ccmsitemap(\'exitEditMode\', '+t.cID+')" dialog-width="640" dialog-height="340" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pageVersions+'" href="'+CCM_TOOLS_PATH+"/versions.php?rel=SITEMAP&cID="+t.cID+'">'+ccmi18n_sitemap.pageVersions+"</a></li>"),t.canDeletePage&&(r+='<li><a class="dialog-launch" dialog-on-close="$.fn.ccmsitemap(\'exitEditMode\', '+t.cID+')" dialog-width="360" dialog-height="150" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.deletePage+'" href="'+CCM_TOOLS_PATH+"/edit_collection_popup.php?rel=SITEMAP&cID="+t.cID+'&ctask=delete">'+ccmi18n_sitemap.deletePage+"</a></li>"),n.displaySingleLevel&&(r+='<li class="divide"></li>',r+='<li><a class="dialog-launch" dialog-width="90%" dialog-height="70%" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.moveCopyPage+'" href="'+CCM_TOOLS_PATH+"/sitemap_search_selector?sitemap_select_mode=move_copy_delete&cID="+t.cID+'" id="menuMoveCopy'+t.cID+'">'+ccmi18n_sitemap.moveCopyPage+"</a></li>",r+='<li><a href="'+CCM_DISPATCHER_FILENAME+"/dashboard/sitemap/explore?cNodeID="+t.cID+'&task=send_to_top">'+ccmi18n_sitemap.sendToTop+"</a></li>",r+='<li><a href="'+CCM_DISPATCHER_FILENAME+"/dashboard/sitemap/explore?cNodeID="+t.cID+'&task=send_to_bottom">'+ccmi18n_sitemap.sendToBottom+"</a></li>");if(t.numSubpages>0){r+='<li class="divider"></li>';var i=CCM_DISPATCHER_FILENAME+"/dashboard/sitemap/search/?selectedSearchField[]=parent&cParentAll=1&cParentIDSearchField="+t.cID;r+='<li><a class="ccm-menu-icon ccm-icon-search-pages" href="'+i+'">'+ccmi18n_sitemap.searchPages+"</a></li>",n.displaySingleLevel||(r+='<li><a href="'+CCM_DISPATCHER_FILENAME+"/dashboard/sitemap/explore/-/"+t.cID+'">'+ccmi18n_sitemap.explorePages+"</a></li>")}if(t.canAddSubpages||t.canAddExternalLinks)r+='<li class="divider"></li>';t.canAddExternalLinks&&(r+='<li><a class="dialog-launch" dialog-width="350" dialog-modal="false" dialog-height="170" dialog-title="'+ccmi18n_sitemap.addExternalLink+'" dialog-modal="false" href="'+CCM_TOOLS_PATH+"/edit_collection_popup.php?rel=SITEMAP&cID="+t.cID+'&ctask=add_external">'+ccmi18n_sitemap.addExternalLink+"</a></li>")}r+="</ul></div></div>";var s=e(r);return s.find("li").length==0?!1:s},exitEditMode:function(t){e.get(CCM_TOOLS_PATH+"/dashboard/sitemap_check_in?cID="+t+"&ccm_token="+CCM_SECURITY_TOKEN)},highlight:function(t){var n=e("[data-sitemap=container]").dynatree("getTree"),r=n.getNodeByKey(t);e(r.span).find("a").hide().show("highlight")},deleteForever:function(t,n,r){var i=e("[data-sitemap=container]").dynatree("getActiveNode"),r=i.data.isTrash;if(r)var s=i,o=s.data.numSubpages-1;else var s=i.parent;var u=r?ccmi18n_sitemap.emptyTrash:ccmi18n_sitemap.deletePages,a=[];ccm_triggerProgressiveOperation(CCM_TOOLS_PATH+"/dashboard/sitemap_delete_forever",[{name:"cID",value:n}],u,function(){s.reloadChildren(),r&&(s.data.numSubpages=o),ccmAlert.hud(ccmi18n_sitemap.deletePageSuccessMsg,2e3)})},refreshCopyOperations:function(){var n=ccmi18n_sitemap.copyProgressTitle;ccm_triggerProgressiveOperation(CCM_TOOLS_PATH+"/dashboard/sitemap_copy_all",[],n,function(){e(".ui-dialog-content").dialog("close"),t.location.reload()})},triggerEvent:function(t,n,r){return r?e("[data-sitemap-request-id="+r+"]").trigger(t,n):e("[data-sitemap=container]").trigger(t,n)},submitDragRequest:function(){var t=e("#origCID").val(),n=e("#destParentID").val(),r=e("#destCID").val(),i=e("#dragMode").val(),s=e("#destSibling").val(),o=e("input[name=ctask]:checked").val(),u=e("input[name=copyAll]:checked").val(),a=e("input[name=saveOldPagePath]:checked").val();params={origCID:t,destCID:r,ctask:o,ccm_token:CCM_SECURITY_TOKEN,copyAll:u,destSibling:s,dragMode:i,saveOldPagePath:a};if(u==1){var f=ccmi18n_sitemap.copyProgressTitle;ccm_triggerProgressiveOperation(CCM_TOOLS_PATH+"/dashboard/sitemap_copy_all",[{name:"origCID",value:t},{name:"destCID",value:r}],f,function(){e(".ui-dialog-content").dialog("close"),e.fn.ccmsitemap("triggerEvent","dragRequestComplete",[o])})}else jQuery.fn.dialog.showLoader(),e.getJSON(CCM_TOOLS_PATH+"/dashboard/sitemap_drag_request.php",params,function(t){ccm_parseJSON(t,function(){jQuery.fn.dialog.closeAll(),jQuery.fn.dialog.hideLoader(),ccmAlert.hud(t.message,2e3),e.fn.ccmsitemap("triggerEvent","dragRequestComplete",[o]),jQuery.fn.dialog.closeTop(),jQuery.fn.dialog.closeTop()})})},onNodeSelected:function(e,t){n.private.customEvents.push({eventName:"selectNode",requestID:e,onComplete:t})},init:function(r){e("#ccm-show-all-pages-cb").on("click",function(){var t=e(this).get(0).checked==1?1:0;e.get(CCM_TOOLS_PATH+"/dashboard/sitemap_data.php?show_system="+t,function(e){location.reload()})});var s=e.extend({displayNodePagination:!1,cParentID:0,requestID:(new Date).getTime(),displaySingleLevel:!1},r),o=!0;if(s.displaySingleLevel){if(s.cParentID==1)var u=2;else var u=3;var o=!1}else var u=1;return e.fn.ccmmenu.enable(),this.each(function(){e(this).attr("data-sitemap","container").attr("data-sitemap-request-id",s.requestID);for(i=0;i<n.private.customEvents.length;i++){var r=n.private.customEvents[i];e("[data-sitemap-request-id="+r.requestID+"]").on("selectNode",function(e,t,n){return r.onComplete(n),!0})}var a=e(this);e(this).data("options",s),e(this).dynatree({autoFocus:!1,cookieId:"ccmsitemap",cookie:{path:CCM_REL+"/"},persist:o,initAjax:{url:CCM_TOOLS_PATH+"/dashboard/sitemap_data",data:{displayNodePagination:s.displayNodePagination?1:0,cParentID:s.cParentID,displaySingleLevel:s.displaySingleLevel?1:0}},onPostInit:function(){s.displayNodePagination&&n.private.setupNodePagination(a,s.cParentID)},selectMode:1,minExpandLevel:u,clickFolderMode:2,onLazyRead:function(e){s.displaySingleLevel?n.private.displaySingleLevel(e,s):n.private.reloadNode(e,s)},onExpand:function(e,t){e&&s.displaySingleLevel&&n.private.displaySingleLevel(t,s)},onClick:function(e,n){e.getEventTargetType(n)=="title"&&e.data.cID?ccm_event.publish("SitemapSelectNode",{mouseEvent:n,node:e,options:s}):e.data.href&&(t.location.href=e.data.href)},fx:{height:"toggle",duration:200},dnd:{onDragStart:function(e){return e.data.cID?!0:!1},onDragStop:function(e){},autoExpandMS:1e3,preventVoidMoves:!0,onDragEnter:function(e,t){return!0},onDragOver:function(e,t,n){return e.parent.data.cID?!e.data.cID&&n=="after"?!1:e.isDescendantOf(t)?!1:!0:!1},onDrop:function(e,t,r,i,s){e.parent.data.cID==t.parent.data.cID&&r!="over"?(t.move(e,r),n.private.rescanDisplayOrder(t.parent)):n.private.selectMoveCopyTarget(t,e,r)}}}),s.displayNodePagination&&e(this).dynatree("option","onActivate",function(t){e(t.span).hasClass("ccm-sitemap-explore-paging")&&t.deactivate()}),ccm_event.subscribe("SitemapSelectNode",function(t){var r=n.getMenu(t.eventData.node.data,t.eventData.options);r&&e.fn.ccmmenu.showmenu(t.eventData.mouseEvent,r)}),e(this).on("deleteRequestComplete",function(t,r){if(r.deferred)ccmAlert.hud(ccmi18n_sitemap.deletePageSuccessDeferredMsg,2e3,"delete_small",ccmi18n_sitemap.deletePage);else{ccmAlert.hud(ccmi18n_sitemap.deletePageSuccessMsg,2e3,"delete_small",ccmi18n_sitemap.deletePage);var i=e("[data-sitemap=container]").dynatree("getActiveNode"),s=i.parent;n.private.reloadNode(s,e(this).data("options"))}}),e(this).on("updateRequestComplete",function(t,n,r){var i=e("[data-sitemap=container]").dynatree("getTree"),s=i.getNodeByKey(n);s.setTitle(r)})})}};e.fn.ccmsitemap=function(t){if(n[t])return n[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return n.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.ccmsitemap")}})(jQuery,window);