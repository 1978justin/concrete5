!function(a,b){var c={"private":{customEvents:[],registerEvent:function(a,b,c){if(this.eventListenerExists(a,"onSelectNode"))for(i=0;i<this.customEvents.length;i++){var d=this.customEvents[i];d.requestID==a&&d.eventName==b&&(d.callback=c)}else this.customEvents.push({requestID:a,callback:c,eventName:b})},triggerEvent:function(a,b,c){for(i=0;i<this.customEvents.length;i++){var d=this.customEvents[i];d.requestID==a&&d.eventName==b&&d.callback.apply(null,c)}},reloadNode:function(a,b,c){var d={url:CCM_TOOLS_PATH+"/dashboard/sitemap_data",data:{cParentID:a.data.cID,displayNodePagination:b.displayNodePagination?1:0},success:function(){c&&c()}};a.appendAjax(d)},eventListenerExists:function(a,b){for(i=0;i<this.customEvents.length;i++){var c=this.customEvents[i];if(c.requestID==a&&c.eventName==b)return!0}return!1},setupNodePagination:function(b){var c=b.find("span.ccm-sitemap-explore-paging");if(b.find("div.ccm-pagination-bound").remove(),c.length){c.find("a").on("click",function(){var c=a(this).attr("href");return b.dynatree("option","initAjax",{url:c}),b.dynatree("getTree").reload(),!1}),c.find("div.ccm-pagination").addClass("ccm-pagination-bound").appendTo(b);var d=a.ui.dynatree.getNode(c);d.remove()}},displaySingleLevel:function(b,d){if(1==b.data.cID)var e=2;else var e=3;var f=a(b.li).closest("[data-sitemap=container]").dynatree("getRoot");a(b.li).closest("[data-sitemap=container]").dynatree("option","minExpandLevel",e),f.removeChildren(),f.appendAjax({url:CCM_TOOLS_PATH+"/dashboard/sitemap_data",data:{displayNodePagination:d.displayNodePagination?1:0,cParentID:b.data.cID,displaySingleLevel:!0},success:function(){c.private.setupNodePagination(f.tree.$tree,b.data.key)}})},rescanDisplayOrder:function(b){b.setLazyNodeStatus(DTNodeStatus_Loading);var c=b.getChildren(),d=[];for(i=0;i<c.length;i++){var e=c[i];d.push({name:"cID[]",value:e.data.cID})}a.ajax({dataType:"json",type:"POST",data:d,url:CCM_TOOLS_PATH+"/dashboard/sitemap_update",success:function(a){ccm_parseJSON(a,function(){}),b.setLazyNodeStatus(DTNodeStatus_Ok)}})},selectMoveCopyTarget:function(b,d,e){var f=ccmi18n_sitemap.moveCopyPage;if(!e)var e="";var g=CCM_TOOLS_PATH+"/dashboard/sitemap_drag_request?origCID="+b.data.cID+"&destCID="+d.data.cID+"&dragMode="+e,h=350,i=350;a.fn.dialog.open({title:f,href:g,width:i,modal:!1,height:h,onOpen:function(){a("#ctaskMove").on("click",function(){a("#copyThisPage").get(0)&&(a("#copyThisPage").get(0).disabled=!0,a("#copyChildren").get(0).disabled=!0,a("#saveOldPagePath").attr("disabled",!1))}),a("#ctaskAlias").on("click",function(){a("#copyThisPage").get(0)&&(a("#copyThisPage").get(0).disabled=!0,a("#copyChildren").get(0).disabled=!0,a("#saveOldPagePath").attr("checked",!1),a("#saveOldPagePath").attr("disabled","disabled"))}),a("#ctaskCopy").on("click",function(){a("#copyThisPage").get(0)&&(a("#copyThisPage").get(0).disabled=!1,a("#copyThisPage").get(0).checked=!0,a("#copyChildren").get(0).disabled=!1,a("#saveOldPagePath").attr("checked",!1),a("#saveOldPagePath").attr("disabled","disabled"))})}}),a("[data-sitemap=container]").on("dragRequestComplete",function(f,g){"MOVE"==g&&b.remove();var h=d.parent;"over"==e&&(h=d),h.removeChildren(),c.private.reloadNode(h,a(this).data("options"),function(){d.bExpanded||d.expand(!0)}),a(this).unbind("dragRequestComplete")})}},onSelectNode:function(a,b){c.private.registerEvent(a,"onSelectNode",b)},getMenu:function(b,c){var d='<div class="ccm-popover-menu popover fade"><div class="arrow"></div><div class="popover-inner">';if(d+='<ul class="dropdown-menu">',b.isTrash&&b.numSubpages)d+="<li><a onclick=\"$.fn.ccmsitemap('deleteForever', this, "+b.cID+')" href="javascript:void(0)">'+ccmi18n_sitemap.emptyTrash+"</a></li>";else if(b.isInTrash)d+='<li><a onclick="ccm_previewInternalTheme('+b.cID+", false, '"+ccmi18n_sitemap.previewPage+'\')" href="javascript:void(0)">'+ccmi18n_sitemap.previewPage+"</a></li>",d+='<li class="divider"></li>',d+="<li><a onclick=\"$.fn.ccmsitemap('deleteForever', this, "+b.cID+')" href="javascript:void(0)">'+ccmi18n_sitemap.deletePageForever+"</a></li>";else if("LINK"==b.cAlias||"POINTER"==b.cAlias)d+="<li><a onclick=\"window.location.href='"+CCM_DISPATCHER_FILENAME+"?cID="+b.cID+'\'" href="javascript:void(0)">'+ccmi18n_sitemap.visitExternalLink+"</a></li>","LINK"==b.cAlias&&b.canEditProperties&&(d+='<li><a dialog-width="350" dialog-height="170" dialog-title="'+ccmi18n_sitemap.editExternalLink+'" dialog-modal="false" dialog-append-buttons="true" href="'+CCM_TOOLS_PATH+"/edit_collection_popup?rel=SITEMAP&cID="+b.cID+'&ctask=edit_external">'+ccmi18n_sitemap.editExternalLink+"</a></li>"),b.canDelete&&(d+='<li><a dialog-width="360" dialog-height="150" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.deleteExternalLink+'" href="'+CCM_TOOLS_PATH+"/edit_collection_popup?rel=SITEMAP&cID="+b.cID+'&ctask=delete_external">'+ccmi18n_sitemap.deleteExternalLink+"</a></li>"),d+="<li><a onclick=\"$.fn.ccmsitemap('deleteForever', this, "+b.cID+')" href="javascript:void(0)">'+ccmi18n_sitemap.deletePageForever+"</a></li>";else{if(d+='<li><a href="'+CCM_DISPATCHER_FILENAME+"?cID="+b.cID+'">'+ccmi18n_sitemap.visitPage+"</a></li>",(b.canEditPageProperties||b.canEditPageSpeedSettings||b.canEditPagePermissions||b.canEditPageDesign||b.canViewPageVersions||b.canDeletePage)&&(d+='<li class="divider"></li>'),b.canEditPageProperties&&(d+='<li><a class="dialog-launch" dialog-on-close="$.fn.ccmsitemap(\'exitEditMode\', '+b.cID+')" dialog-width="850" dialog-height="360" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pagePropertiesTitle+'" href="'+CCM_TOOLS_PATH+"/edit_collection_popup?rel=SITEMAP&cID="+b.cID+'&ctask=edit_metadata">'+ccmi18n_sitemap.pageProperties+"</a></li>"),b.canEditPageSpeedSettings&&(d+='<li><a class="dialog-launch" dialog-on-close="$.fn.ccmsitemap(\'exitEditMode\', '+b.cID+')" dialog-width="550" dialog-height="280" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.speedSettingsTitle+'" href="'+CCM_TOOLS_PATH+"/edit_collection_popup?rel=SITEMAP&cID="+b.cID+'&ctask=edit_speed_settings">'+ccmi18n_sitemap.speedSettings+"</a></li>"),b.canEditPagePermissions&&(d+='<li><a class="dialog-launch" dialog-on-close="$.fn.ccmsitemap(\'exitEditMode\', '+b.cID+')" dialog-width="420" dialog-height="630" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.setPagePermissions+'" href="'+CCM_TOOLS_PATH+"/edit_collection_popup?rel=SITEMAP&cID="+b.cID+'&ctask=edit_permissions">'+ccmi18n_sitemap.setPagePermissions+"</a></li>"),b.canEditPageDesign&&(d+='<li><a class="dialog-launch" dialog-on-close="$.fn.ccmsitemap(\'exitEditMode\', '+b.cID+')" dialog-width="610" dialog-height="405" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pageDesign+'" href="'+CCM_TOOLS_PATH+"/edit_collection_popup?rel=SITEMAP&cID="+b.cID+'&ctask=set_theme">'+ccmi18n_sitemap.pageDesign+"</a></li>"),b.canViewPageVersions&&(d+='<li><a class="dialog-launch" dialog-on-close="$.fn.ccmsitemap(\'exitEditMode\', '+b.cID+')" dialog-width="640" dialog-height="340" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pageVersions+'" href="'+CCM_TOOLS_PATH+"/versions?rel=SITEMAP&cID="+b.cID+'">'+ccmi18n_sitemap.pageVersions+"</a></li>"),b.canDeletePage&&(d+='<li><a class="dialog-launch" dialog-on-close="$.fn.ccmsitemap(\'exitEditMode\', '+b.cID+')" dialog-width="360" dialog-height="150" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.deletePage+'" href="'+CCM_TOOLS_PATH+"/edit_collection_popup?rel=SITEMAP&cID="+b.cID+'&ctask=delete">'+ccmi18n_sitemap.deletePage+"</a></li>"),c.displaySingleLevel&&(d+='<li class="divide"></li>',d+='<li><a class="dialog-launch" dialog-width="90%" dialog-height="70%" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.moveCopyPage+'" href="'+CCM_TOOLS_PATH+"/sitemap_search_selector?sitemap_select_mode=move_copy_delete&cID="+b.cID+'" id="menuMoveCopy'+b.cID+'">'+ccmi18n_sitemap.moveCopyPage+"</a></li>",d+='<li><a href="'+CCM_DISPATCHER_FILENAME+"/dashboard/sitemap/explore?cNodeID="+b.cID+'&task=send_to_top">'+ccmi18n_sitemap.sendToTop+"</a></li>",d+='<li><a href="'+CCM_DISPATCHER_FILENAME+"/dashboard/sitemap/explore?cNodeID="+b.cID+'&task=send_to_bottom">'+ccmi18n_sitemap.sendToBottom+"</a></li>"),b.numSubpages>0){d+='<li class="divider"></li>';var e=CCM_DISPATCHER_FILENAME+"/dashboard/sitemap/search/?selectedSearchField[]=parent&cParentAll=1&cParentIDSearchField="+b.cID;d+='<li><a class="ccm-menu-icon ccm-icon-search-pages" href="'+e+'">'+ccmi18n_sitemap.searchPages+"</a></li>",c.displaySingleLevel||(d+='<li><a href="'+CCM_DISPATCHER_FILENAME+"/dashboard/sitemap/explore/-/"+b.cID+'">'+ccmi18n_sitemap.explorePages+"</a></li>")}(b.canAddSubpages||b.canAddExternalLinks)&&(d+='<li class="divider"></li>'),b.canAddExternalLinks&&(d+='<li><a class="dialog-launch" dialog-width="350" dialog-modal="false" dialog-height="170" dialog-title="'+ccmi18n_sitemap.addExternalLink+'" dialog-modal="false" href="'+CCM_TOOLS_PATH+"/edit_collection_popup?rel=SITEMAP&cID="+b.cID+'&ctask=add_external">'+ccmi18n_sitemap.addExternalLink+"</a></li>")}d+="</ul></div></div>";var f=a(d);return 0==f.find("li").length?!1:f},exitEditMode:function(b){a.get(CCM_TOOLS_PATH+"/dashboard/sitemap_check_in?cID="+b+"&ccm_token="+CCM_SECURITY_TOKEN)},highlight:function(b){var c=a("[data-sitemap=container]").dynatree("getTree"),d=c.getNodeByKey(b);a(d.span).find("a").hide().show("highlight")},deleteForever:function(b,c,d){var e=a("[data-sitemap=container]").dynatree("getActiveNode"),d=e.data.isTrash;if(d)var f=e,g=f.data.numSubpages-1;else var f=e.parent;var h=d?ccmi18n_sitemap.emptyTrash:ccmi18n_sitemap.deletePages;ccm_triggerProgressiveOperation(CCM_TOOLS_PATH+"/dashboard/sitemap_delete_forever",[{name:"cID",value:c}],h,function(){f.reloadChildren(),d&&(f.data.numSubpages=g),ccmAlert.hud(ccmi18n_sitemap.deletePageSuccessMsg,2e3)})},refreshCopyOperations:function(){var c=ccmi18n_sitemap.copyProgressTitle;ccm_triggerProgressiveOperation(CCM_TOOLS_PATH+"/dashboard/sitemap_copy_all",[],c,function(){a(".ui-dialog-content").dialog("close"),b.location.reload()})},triggerEvent:function(b,c,d){return d?a("[data-sitemap-request-id="+d+"]").trigger(b,c):a("[data-sitemap=container]").trigger(b,c)},submitDragRequest:function(){var b=a("#origCID").val(),c=(a("#destParentID").val(),a("#destCID").val()),d=a("#dragMode").val(),e=a("#destSibling").val(),f=a("input[name=ctask]:checked").val(),g=a("input[name=copyAll]:checked").val(),h=a("input[name=saveOldPagePath]:checked").val();if(params={origCID:b,destCID:c,ctask:f,ccm_token:CCM_SECURITY_TOKEN,copyAll:g,destSibling:e,dragMode:d,saveOldPagePath:h},1==g){var i=ccmi18n_sitemap.copyProgressTitle;ccm_triggerProgressiveOperation(CCM_TOOLS_PATH+"/dashboard/sitemap_copy_all",[{name:"origCID",value:b},{name:"destCID",value:c}],i,function(){a(".ui-dialog-content").dialog("close"),a.fn.ccmsitemap("triggerEvent","dragRequestComplete",[f])})}else jQuery.fn.dialog.showLoader(),a.getJSON(CCM_TOOLS_PATH+"/dashboard/sitemap_drag_request",params,function(b){ccm_parseJSON(b,function(){jQuery.fn.dialog.closeAll(),jQuery.fn.dialog.hideLoader(),ccmAlert.hud(b.message,2e3),a.fn.ccmsitemap("triggerEvent","dragRequestComplete",[f]),jQuery.fn.dialog.closeTop(),jQuery.fn.dialog.closeTop()})})},init:function(d){a("#ccm-show-all-pages-cb").on("click",function(){var b=1==a(this).get(0).checked?1:0;a.get(CCM_TOOLS_PATH+"/dashboard/sitemap_data?show_system="+b,function(){location.reload()})});var e=a.extend({displayNodePagination:!1,cParentID:0,requestID:(new Date).getTime(),displaySingleLevel:!1,onSelectNode:!1},d),f=!0;if(e.displaySingleLevel){if(1==e.cParentID)var g=2;else var g=3;var f=!1}else var g=1;return this.each(function(){a(this).attr("data-sitemap","container").attr("data-sitemap-request-id",e.requestID);var d=a(this);a(this).data("options",e),a(this).dynatree({autoFocus:!1,cookieId:"ccmsitemap",cookie:{path:CCM_REL+"/"},persist:f,initAjax:{url:CCM_TOOLS_PATH+"/dashboard/sitemap_data",data:{displayNodePagination:e.displayNodePagination?1:0,cParentID:e.cParentID,displaySingleLevel:e.displaySingleLevel?1:0}},onPostInit:function(){e.displayNodePagination&&c.private.setupNodePagination(d,e.cParentID)},selectMode:1,minExpandLevel:g,clickFolderMode:2,onLazyRead:function(a){e.displaySingleLevel?c.private.displaySingleLevel(a,e):c.private.reloadNode(a,e)},onExpand:function(a,b){a&&e.displaySingleLevel&&c.private.displaySingleLevel(b,e)},onClick:function(d,f){if("title"==d.getEventTargetType(f)&&d.data.cID)if(e.onSelectNode)e.onSelectNode(d);else if(c.private.eventListenerExists(e.requestID,"onSelectNode"))c.private.triggerEvent(e.requestID,"onSelectNode",[d]);else{var g=c.getMenu(d.data,e);if(g){var h=new ConcreteMenu(a(d.span),{menu:g,launcher:"none"});h.show(f)}}else d.data.href&&(b.location.href=d.data.href)},fx:{height:"toggle",duration:200},dnd:{onDragStart:function(a){return a.data.cID?!0:!1},onDragStop:function(){},autoExpandMS:1e3,preventVoidMoves:!0,onDragEnter:function(){return!0},onDragOver:function(a,b,c){return a.parent.data.cID?a.data.cID||"after"!=c?a.isDescendantOf(b)?!1:!0:!1:!1},onDrop:function(a,b,d){a.parent.data.cID==b.parent.data.cID&&"over"!=d?(b.move(a,d),c.private.rescanDisplayOrder(b.parent)):c.private.selectMoveCopyTarget(b,a,d)}}}),e.displayNodePagination&&a(this).dynatree("option","onActivate",function(b){a(b.span).hasClass("ccm-sitemap-explore-paging")&&b.deactivate()}),a(this).on("deleteRequestComplete",function(b,d){if(d.deferred)ccmAlert.hud(ccmi18n_sitemap.deletePageSuccessDeferredMsg,2e3,"delete_small",ccmi18n_sitemap.deletePage);else{ccmAlert.hud(ccmi18n_sitemap.deletePageSuccessMsg,2e3,"delete_small",ccmi18n_sitemap.deletePage);var e=a("[data-sitemap=container]").dynatree("getActiveNode"),f=e.parent;c.private.reloadNode(f,a(this).data("options"))}}),a(this).on("updateRequestComplete",function(b,c,d){var e=a("[data-sitemap=container]").dynatree("getTree"),f=e.getNodeByKey(c);f.setTitle(d)})})}};a.fn.ccmsitemap=function(b){return c[b]?c[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?(a.error("Method "+b+" does not exist on jQuery.ccmsitemap"),void 0):c.init.apply(this,arguments)}}(jQuery,window);