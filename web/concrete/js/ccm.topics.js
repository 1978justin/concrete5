!function(a){var b={"private":{dragRequest:function(b,c,d){var e=c.parent.data.key;"over"==d&&(e=c.data.key),jQuery.fn.dialog.showLoader();var f=[{name:"sourceTreeNodeID",value:b.data.key},{name:"treeNodeParentID",value:e}],g=c.parent.getChildren();if(g)for(i=0;i<g.length;i++){var h=g[i];f.push({name:"treeNodeID[]",value:h.data.key})}a.ajax({dataType:"json",type:"POST",data:f,url:CCM_TOOLS_PATH+"/tree/node/drag_request",success:function(a){ccm_parseJSON(a,function(){}),jQuery.fn.dialog.hideLoader()}})},getMenu:function(b,c){var d='<div class="ccm-topic-menu ccm-menu popover fade"><div class="arrow"></div><div class="inner"><div class="content" style="padding: 0px">';d+="<ul>",b.canAddTopicCategoryTreeNode&&(d+='<li><a class="dialog-launch" dialog-width="550" dialog-on-open="$(\'[data-topic-form=add-category-node]\').ccmtopicstree(\'initAddNodeForm\', '+c.treeID+');" dialog-height="80" dialog-modal="false" dialog-title="Add Category" href="'+CCM_DISPATCHER_FILENAME+"/tools/required/tree/node/add/topic_category?treeNodeParentID="+b.key+'">Add Category</a></li>'),b.canAddTopicTreeNode&&(d+='<li><a class="dialog-launch" dialog-width="550" dialog-on-open="$(\'[data-topic-form=add-topic-node]\').ccmtopicstree(\'initAddNodeForm\', '+c.treeID+');" dialog-height="80" dialog-modal="false" dialog-title="Add Topic" href="'+CCM_DISPATCHER_FILENAME+"/tools/required/tree/node/add/topic?treeNodeParentID="+b.key+'">Add Topic</a></li>'),b.canEditTreeNode&&"topic_category"==b.treeNodeTypeHandle&&(d+='<li><a class="dialog-launch" dialog-width="550" dialog-on-open="$(\'[data-topic-form=update-category-node]\').ccmtopicstree(\'initUpdateCategoryNodeForm\', '+c.treeID+');" dialog-height="80" dialog-modal="false" dialog-title="Edit Category" href="'+CCM_DISPATCHER_FILENAME+"/tools/required/tree/node/edit/topic_category?treeNodeID="+b.key+'">Edit Category</a></li>',d+="<li><a href=\"#\" onclick=\"$.fn.ccmtopicstree('cloneNode', 'node', "+c.treeID+","+b.key+')">Clone Category</a></li>'),b.canEditTreeNode&&"topic"==b.treeNodeTypeHandle&&(d+='<li><a class="dialog-launch" dialog-width="550" dialog-on-open="$(\'[data-topic-form=update-topic-node]\').ccmtopicstree(\'initUpdateTopicNodeForm\', '+c.treeID+');" dialog-height="80" dialog-modal="false" dialog-title="Edit Topic" href="'+CCM_DISPATCHER_FILENAME+"/tools/required/tree/node/edit/topic?treeNodeID="+b.key+'">Edit Topic</a></li>',d+="<li><a href=\"#\" onclick=\"$.fn.ccmtopicstree('cloneNode', 'node', "+c.treeID+","+b.key+')">Clone Topic</a></li>'),b.canEditTreeNodePermissions&&(d+='<li><a class="dialog-launch" dialog-width="480" dialog-height="380" dialog-modal="true" dialog-title="Edit Permissions" href="'+CCM_TOOLS_PATH+"/tree/node/permissions?treeNodeID="+b.key+'">Edit Permissions</a></li>'),b.treeNodeParentID>0&&"topic_category"==b.treeNodeTypeHandle&&b.canDeleteTreeNode&&(d+='<li><a class="dialog-launch" dialog-width="550" dialog-on-open="$(\'[data-topic-form=remove-tree-node]\').ccmtopicstree(\'initRemoveNodeForm\', '+c.treeID+');" dialog-height="140" dialog-modal="false" dialog-title="Remove" href="'+CCM_TOOLS_PATH+"/tree/node/remove?treeNodeID="+b.key+'">Delete Category</a></li>'),b.treeNodeParentID>0&&"topic"==b.treeNodeTypeHandle&&b.canDeleteTreeNode&&(d+='<li><a class="dialog-launch" dialog-width="550" dialog-on-open="$(\'[data-topic-form=remove-tree-node]\').ccmtopicstree(\'initRemoveNodeForm\', '+c.treeID+');" dialog-height="140" dialog-modal="false" dialog-title="Remove" href="'+CCM_TOOLS_PATH+"/tree/node/remove?treeNodeID="+b.key+'">Delete Topic</a></li>'),d+="</ul></div></div></div>";var e=a(d);return 0==e.find("li").length?!1:e},reloadNode:function(a,b){var c={url:CCM_TOOLS_PATH+"/tree/node/load",data:{treeNodeParentID:a.data.key},success:function(){b&&b()}};a.appendAjax(c)},setupDialogForm:function(b,c){b.closest(".ui-dialog").find("button[type=submit]").on("click",function(){b.trigger("submit")}),b.on("submit",function(){jQuery.fn.dialog.showLoader();var d=b.serializeArray();return a.ajax({dataType:"json",type:"post",data:d,url:b.attr("action"),success:function(a){1==a.error?ccmAlert.notice("Error",'<div class="alert alert-danger">'+a.messages.join("<br>")+"</div>"):(jQuery.fn.dialog.closeTop(),c(a))},error:function(a){ccmAlert.notice("Error",'<div class="alert alert-danger">'+a.responseText+"</div>")},complete:function(){jQuery.fn.dialog.hideLoader()}}),!1})}},initAddNodeForm:function(c){b.private.setupDialogForm(a(this),function(b){var d=a("[data-topic-tree="+c+"]");if(b.length)for(i=0;i<b.length;i++){var e=d.dynatree("getTree").getNodeByKey(b[i].treeNodeParentID);e.addChild(b[i])}else{var e=d.dynatree("getTree").getNodeByKey(b.treeNodeParentID);e.addChild(b)}e.expand()})},cloneNode:function(c,d,e){var f=a("[data-topic-tree="+d+"]");return a.ajax({dataType:"json",type:"post",data:{treeNodeID:e},url:CCM_TOOLS_PATH+"/tree/node/duplicate/"+c,success:function(a){if(1==a.error)ccmAlert.notice("Error",'<div class="alert alert-danger">'+a.messages.join("<br>")+"</div>");else{jQuery.fn.dialog.closeTop();var c=f.dynatree("getTree").getNodeByKey(a.treeNodeParentID);c.setLazyNodeStatus(DTNodeStatus_Loading),b.private.reloadNode(c,function(){c.setLazyNodeStatus(DTNodeStatus_Ok)})}},error:function(a){ccmAlert.notice("Error",'<div class="alert alert-danger">'+a.responseText+"</div>")},complete:function(){jQuery.fn.dialog.hideLoader()}}),!1},initUpdateCategoryNodeForm:function(c){b.private.setupDialogForm(a(this),function(b){var d=a("[data-topic-tree="+c+"]"),e=d.dynatree("getTree").getNodeByKey(b.key);e.data=b,e.render()})},initUpdateTopicNodeForm:function(c){b.private.setupDialogForm(a(this),function(b){var d=a("[data-topic-tree="+c+"]"),e=d.dynatree("getTree").getNodeByKey(b.key);e.data=b,e.render()})},initRemoveNodeForm:function(c){b.private.setupDialogForm(a(this),function(b){var d=a("[data-topic-tree="+c+"]"),e=d.dynatree("getTree").getNodeByKey(b.treeNodeID);e.remove()})},init:function(c){c.noMenu||a.fn.ccmmenu.enable();var c=a.extend({readonly:!1,chooseNodeInForm:!1,onSelect:!1,selectNodeByKey:!1},c),d=!1,e=!1;if(c.treeNodeParentID)var f={treeNodeParentID:c.treeNodeParentID};else var f={treeID:c.treeID};var g=!0;c.chooseNodeInForm&&(d=!0,g=!1,e={checkbox:"dynatree-radio"},c.selectNodeByKey&&(f.treeNodeSelectedID=c.selectNodeByKey)),"multiple"===c.chooseNodeInForm&&(d=!0,g=!1,e={checkbox:"dynatree-checkbox"},c.selectNodeByKey&&(f.treeNodeSelectedID=c.selectNodeByKey)),c.allChildren&&(f.allChildren=!0);var h=1;c.selectMode&&(h=c.selectMode);var i=2;return c.minExpandLevel&&(i=c.minExpandLevel),this.each(function(){if(c.treeNodeParentID)var g=CCM_TOOLS_PATH+"/tree/node/load";else var g=CCM_TOOLS_PATH+"/tree/load";var j=a(this);j.data("options",c),j.dynatree({autoFocus:!1,onSelect:function(a,b){c.chooseNodeInForm&&c.onSelect(a,b)},selectMode:h,checkbox:d,classNames:e,minExpandLevel:i,clickFolderMode:1,initAjax:{url:g,type:"post",data:f},onLazyRead:function(a){b.private.reloadNode(a)},onPostInit:function(){var b=j;if(c.readonly&&b.dynatree("disable"),c.chooseNodeInForm){var d=b.dynatree("getTree"),d=d.getSelectedNodes();if(d[0]){var e=d[0];c.onSelect(!0,e)}}if(d){a.map(d,function(a){a.makeVisible()})}},onClick:function(d,e){if(a.fn.ccmmenu.hide(e),"expander"==d.getEventTargetType(e))return!0;if(c.chooseNodeInForm&&"checkbox"!=d.getEventTargetType(e))return!1;if(!d.getEventTargetType(e))return!1;if(!c.chooseNodeInForm&&"title"==d.getEventTargetType(e)){var f=b.private.getMenu(d.data,c);f&&a.fn.ccmmenu.showmenu(e,f)}},dnd:{onDragStart:function(){return c.noDrag?!1:!0},onDragStop:function(){},autoExpandMS:1e3,preventVoidMoves:!0,onDragEnter:function(){return!0},onDragOver:function(a,b,c){a.data.treeNodeType;return"over"===c&&jQuery.inArray(a.data.treeNodeTypeHandle,["topic"])>-1?!1:a.isDescendantOf(b)?!1:!0},onDrop:function(a,c,d){c.move(a,d),b.private.dragRequest(c,a,d)}}})})}};a.fn.ccmtopicstree=function(c){return b[c]?b[c].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof c&&c?(a.error("Method "+c+" does not exist on jQuery.ccmtopicstree"),void 0):b.init.apply(this,arguments)}}(jQuery,window),$.fn.ccmmenu=function(){return $.fn.ccmmenu.enable(),$.each($(this),function(a,b){var c,d=$(b);if(!d.prop("has-menu")){d.prop("has-menu",!0),c=d.attr("data-menu-handle")?$(d.attr("data-menu-handle")):d;var e=$("#"+d.attr("data-menu"));d.$menu=e,d.highlightClass=d.attr("data-menu-highlight-class"),d.highlightOffset=9,d.attr("data-menu-highlight-offset")&&(d.highlightOffset=d.attr("data-menu-highlight-offset")),c.on("mousemove.ccmmenu",function(a){$.fn.ccmmenu.over(a,d,$(this))})}})},$.fn.ccmmenu.resetHighlight=function(){$.fn.ccmmenu.$highlighter.hide(),$("[data-menu-highlight-class]").each(function(){var a=$(this).attr("data-menu-highlight-class");$("."+a).removeClass(a)})},$.fn.ccmmenu.highlight=function(a){var b=a.offset(),c=b.top-$.fn.ccmmenu.$overmenu.highlightOffset,d=b.left-$.fn.ccmmenu.$overmenu.highlightOffset,e=a.outerWidth()+2*$.fn.ccmmenu.$overmenu.highlightOffset,f=a.outerHeight()+2*$.fn.ccmmenu.$overmenu.highlightOffset;$.fn.ccmmenu.$highlighter.css("width",e).css("height",f).css("top",c).css("left",d).css("border-top-left-radius",a.css("border-top-left-radius")).css("border-bottom-left-radius",a.css("border-bottom-left-radius")).css("border-top-right-radius",a.css("border-top-right-radius")).css("border-bottom-right-radius",a.css("border-bottom-right-radius")).removeClass().addClass($.fn.ccmmenu.$overmenu.highlightClass),$.fn.ccmmenu.$highlighter.show()},$.fn.ccmmenu.out=function(){$.fn.ccmmenu.isactive||($.fn.ccmmenu.$proxy.css("opacity",0),$(".ccm-parent-menu-item-active").removeClass("ccm-parent-menu-item-active"),$(".ccm-menu-item-active").removeClass("ccm-menu-item-active"))},$.fn.ccmmenu.reset=function(){$.fn.ccmmenu.disable(),$.fn.ccmmenu.enable()},$.fn.ccmmenu.enable=function(){$.fn.ccmmenu.isenabled=!0,0==$("#ccm-menu-click-proxy").length&&$(document.body).append($("<div />",{id:"ccm-menu-click-proxy"})),0==$("#ccm-menu-highlighter").length&&$(document.body).append($("<div />",{id:"ccm-menu-highlighter"})),0==$("#ccm-popover-menu-container").length&&$(document.body).append($("<div />",{id:"ccm-popover-menu-container","class":"ccm-ui"})),$.fn.ccmmenu.$proxy=$("#ccm-menu-click-proxy"),$.fn.ccmmenu.$highlighter=$("#ccm-menu-highlighter"),$.fn.ccmmenu.$holder=$("#ccm-popover-menu-container"),$.fn.ccmmenu.$proxy.on("mouseout.clickproxy",function(a){$.fn.ccmmenu.out(a)}),$.fn.ccmmenu.$proxy.on("mouseover.clickproxy",function(a){$.fn.ccmmenu.over(a)}),$.fn.ccmmenu.$proxy.unbind("click.clickproxy").on("click.clickproxy",function(a){$.fn.ccmmenu.showmenu(a,$.fn.ccmmenu.$overmenu.$menu),$.fn.ccmmenu.highlight($.fn.ccmmenu.$overmenu),$.fn.ccmmenu.$overmenu.addClass($.fn.ccmmenu.$overmenu.highlightClass)})},$.fn.ccmmenu.disable=function(){$.fn.ccmmenu.out(),$.fn.ccmmenu.isenabled=!1,$.fn.ccmmenu.$proxy.remove(),$.fn.ccmmenu.resetHighlight()},$.fn.ccmmenu.over=function(a,b,c){if($.fn.ccmmenu.isenabled&&!$.fn.ccmmenu.isactive){if($(".ccm-menu-item-active").removeClass("ccm-menu-item-active"),$(".ccm-parent-menu-item-active").removeClass("ccm-parent-menu-item-active"),c){var d=c.offset(),e=d.top-5,f=d.left-5,g=c.outerWidth()+10,h=c.outerHeight()+10;$.fn.ccmmenu.$proxy.css("width",g).css("height",h).css("top",e).css("left",f).css("border-top-left-radius",c.css("border-top-left-radius")).css("border-bottom-left-radius",c.css("border-bottom-left-radius")).css("border-top-right-radius",c.css("border-top-right-radius")).css("border-bottom-right-radius",c.css("border-bottom-right-radius")),$.fn.ccmmenu.$overmenu=b}$.fn.ccmmenu.$overmenu.addClass("ccm-menu-item-active"),$.fn.ccmmenu.$overmenu.parent().addClass("ccm-parent-menu-item-active")}},$.fn.ccmmenu.hide=function(a){a&&a.stopPropagation(),$.fn.ccmmenu.$proxy&&($.fn.ccmmenu.isactive=!1,$.fn.ccmmenu.$proxy.css("opacity",0),$.fn.ccmmenu.resetHighlight(),$.fn.ccmmenu.$holder.html(""),$(".ccm-menu-item-active").removeClass("ccm-menu-item-active"),$(".ccm-parent-menu-item-active").removeClass("ccm-parent-menu-item-active"),$(document).unbind("click.disableccmmenu"),$("div.popover").css("opacity",0).hide())},$.fn.ccmmenu.showmenu=function(a,b){a.stopPropagation(),$.fn.ccmmenu.isactive&&$("div.popover").css("opacity",0).hide(),$.fn.ccmmenu.isactive=!0;var c=b.clone(!0,!0);c.appendTo($.fn.ccmmenu.$holder),c.find(".dialog-launch").dialog();var d=a.pageX+2,e=a.pageY+2;c.css("opacity",0).show();var f=c.height(),g=c.width();$(window).height()<a.clientY+f+30?(e=e-f-10,d-=g/2,c.removeClass("bottom"),c.addClass("top")):(d-=g/2,e+=10,c.removeClass("top"),c.addClass("bottom")),c.css("top",e+"px"),c.css("left",d+"px"),c.show().css("opacity",1),c.find("a").click(function(a){$.fn.ccmmenu.hide(a)}),$(document).on("click.disableccmmenu",function(a){$.fn.ccmmenu.hide(a)})};